<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–°—ã—Ä–æ–º–∞–Ω–∏—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg-color:#F8EFDA;
      --text-color:#2E2A23;
      --hint-color:#8A7F6A;
      --link-color:#8B5E34;
      --button-color:linear-gradient(135deg,#82571c,#bd9952);
      --button-text-color:#ffffff;
      --secondary-bg-color:#FFF6E7;
      --header-bg-color:#FFF9EF;
      --section-bg-color:#ffffff;
      --border-color:#E7D8BF;
      --error-color:#E74C3C;
      --success-color:#2E8B57;
      --font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      --radius-lg:12px;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      background:radial-gradient(circle at top,#fff7eb 0,#F8EFDA 45%,#f3e4cb 100%);
      color:var(--text-color);
      font:16px var(--font-family);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    #app{display:flex;flex-direction:column;min-height:100vh;}

    header{
      background:rgba(255,249,239,0.96);
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border-color);
      padding:10px;
      position:sticky;
      top:0;
      z-index:3;
    }

    .user-profile{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
    .user-avatar{
      width:32px;height:32px;border-radius:50%;
      background:var(--secondary-bg-color);
      display:flex;align-items:center;justify-content:center;
      font-size:16px;color:var(--hint-color);overflow:hidden;
    }
    .user-avatar img{width:100%;height:100%;object-fit:cover;}
    .user-name{font-weight:600;font-size:14px;}

    .search-container{margin-bottom:8px;}
    #search-input{
      width:100%;padding:10px 12px;
      border:1px solid var(--border-color);
      border-radius:10px;
      background:var(--secondary-bg-color);
      color:var(--text-color);
      font-size:15px;
    }

    .filters-container{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .filters-container select,.filters-container label{font-size:13px;}
    #category-filter{
      padding:8px 10px;
      border:1px solid var(--border-color);
      border-radius:999px;
      background:var(--secondary-bg-color);
      color:var(--text-color);
      flex-grow:1;
    }
    #only-cheese-toggle,#favorites-toggle{
      display:flex;align-items:center;gap:4px;
      cursor:pointer;white-space:nowrap;
    }
    #only-cheese-toggle input,#favorites-toggle input{accent-color:#8B5E34;}

    .favorites-bar{
      display:none;
      gap:8px;
      overflow-x:auto;
      padding:6px 0 2px;
    }
    .fav-chip{
      background:#ffffff;
      border:1px solid var(--border-color);
      border-radius:14px;
      padding:6px 10px;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
    }

    main{
      flex-grow:1;
      padding:10px;
      padding-bottom:100px;
    }

    .section{margin-bottom:22px;}

    .section-title{
      font-size:14px;
      font-weight:800;
      margin:16px 4px 8px;
      padding:6px 12px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background:linear-gradient(135deg,#f3e2c3,#fdf5e5);
      color:#5a4122;
      box-shadow:0 3px 8px rgba(150,110,60,0.15);
    }
    .section-title::before{
      content:'‚óè';
      font-size:10px;
    }

    .product-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:12px;
    }

    .product-card{
      border:1px solid rgba(231,216,191,0.9);
      border-radius:var(--radius-lg);
      padding:10px;
      background:var(--section-bg-color);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      transition:transform .16s ease,box-shadow .16s ease,background .16s;
    }
    .product-card:hover{
      transform:translateY(-3px);
      box-shadow:0 6px 16px rgba(0,0,0,0.08);
      background:#fffdf7;
    }

    .product-thumb{
      width:100%;height:110px;
      border-radius:10px;
      background:var(--secondary-bg-color);
      display:flex;
      align-items:center;justify-content:center;
      overflow:hidden;
      margin-bottom:8px;
    }
    .product-thumb img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
    }

    .product-ico{font-size:40px;}
    .name{font-weight:700;font-size:14px;margin-bottom:4px;min-height:34px;}
    .product-row{
      display:flex;gap:6px;
      align-items:center;justify-content:space-between;
    }
    .price{color:var(--hint-color);font-size:13px;}
    .badge-piece{
      font-size:11px;
      color:#6b5c48;
      background:#F4E8D3;
      border:1px dashed #d9c6a6;
      padding:2px 6px;
      border-radius:8px;
      margin-left:auto;
    }

    .fav-btn{
      background:none;
      border:none;
      cursor:pointer;
      font-size:18px;
      color:#c78f5b;
      flex-shrink:0;
    }
    .fav-btn.active{color:#8B5E34;}

    .cart-footer{
      position:sticky;
      bottom:0;
      background:rgba(255,249,239,0.97);
      border-top:1px solid var(--border-color);
      padding:10px;
      display:flex;
      justify-content:center;
      align-items:center;
      z-index:2;
      backdrop-filter:blur(8px);
    }
    #open-cart-btn{
      background:var(--button-color);
      color:var(--button-text-color);
      padding:12px 24px;
      border-radius:24px;
      cursor:pointer;
      border:none;
      font-size:16px;
      font-weight:700;
      width:100%;
      max-width:520px;
      box-shadow:0 6px 16px rgba(130,87,28,0.38);
      transition:transform .08s,filter .18s,box-shadow .18s;
    }
    #open-cart-btn:hover{filter:brightness(1.06);}
    #open-cart-btn:active{transform:scale(.98);box-shadow:0 3px 8px rgba(130,87,28,0.3);}
    #open-cart-btn:disabled{
      background:#b7aa93;
      box-shadow:none;
      cursor:not-allowed;
    }

    dialog{
      border:1px solid var(--border-color);
      border-radius:var(--radius-lg);
      padding:0;
      background:var(--section-bg-color);
      color:var(--text-color);
      width:94vw;
      max-width:520px;
      max-height:88vh;
      overflow:hidden;
      box-shadow:0 12px 30px rgba(0,0,0,0.18);
    }
    dialog::backdrop{
      background:rgba(0,0,0,0.45);
      backdrop-filter:blur(5px);
    }

    .modal-header{
      padding:14px 16px;
      border-bottom:1px solid var(--border-color);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:linear-gradient(135deg,#fff6e5,#ffeeda);
      position:sticky;
      top:0;
      z-index:1;
    }
    .modal-header h2{margin:0;font-size:17px;}
    .modal-close{
      background:none;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:var(--hint-color);
      padding:0;
      line-height:1;
      border-radius:50%;
      width:32px;
      height:32px;
      display:grid;
      place-items:center;
    }
    .modal-close:hover{background:var(--secondary-bg-color);}
    .modal-body{
      padding:14px 16px;
      overflow-y:auto;
      max-height:76vh;
    }

    .form-group{margin-bottom:12px;}
    .form-group label{
      display:block;
      margin-bottom:6px;
      font-size:14px;
      font-weight:600;
    }
    .form-group select,
    .form-group input,
    .form-group textarea{
      width:100%;
      padding:10px;
      border:1px solid var(--border-color);
      border-radius:10px;
      background:var(--secondary-bg-color);
      color:var(--text-color);
      font-size:16px;
    }

    .product-desc{
      color:var(--hint-color);
      font-size:13px;
      margin:0 0 10px;
    }

    .custom-weight-block{
      border-radius:10px;
      padding:10px;
      background:#fff9ef;
      border:1px dashed var(--border-color);
    }
    .custom-weight-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .custom-weight-toggle{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }
    .custom-weight-toggle input{accent-color:#8B5E34;}
    #product-custom-weight[disabled]{
      opacity:.6;
      background:#f3e7d4;
    }

    .price-display{
      font-size:18px;
      font-weight:800;
      text-align:center;
      margin:12px 0;
    }
    .btn{
      padding:12px 20px;
      border:none;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      width:100%;
      transition:transform .08s,filter .18s,box-shadow .18s;
    }
    .btn:active{transform:scale(.98);}
    .btn-primary{
      background:var(--button-color);
      color:var(--button-text-color);
      box-shadow:0 5px 14px rgba(130,87,28,0.35);
    }
    .btn-primary:hover{filter:brightness(1.06);}
    .btn-secondary{
      background:var(--secondary-bg-color);
      color:var(--text-color);
      border:1px solid var(--border-color);
    }

    .cart-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid var(--border-color);
    }
    .cart-item:last-child{border-bottom:none;}
    .cart-item-info{flex-grow:1;padding-right:10px;}
    .cart-item-name{font-weight:800;font-size:14px;}
    .cart-item-variant{font-size:13px;color:var(--hint-color);margin-top:2px;}
    .cart-item-price{font-size:14px;margin-top:4px;}
    .discount-hint{color:var(--success-color);font-size:12px;margin-top:4px;}

    .qty-control{
      display:flex;
      align-items:center;
      border:1px solid var(--border-color);
      border-radius:10px;
      overflow:hidden;
    }
    .qty-control button{
      background:none;
      border:none;
      width:32px;
      height:32px;
      cursor:pointer;
      font-size:18px;
      color:var(--text-color);
      display:grid;
      place-items:center;
    }
    .qty-control button:hover{background:var(--secondary-bg-color);}
    .qty-control span{
      padding:0 10px;
      min-width:30px;
      text-align:center;
    }

    .cart-summary{
      margin-top:16px;
      padding-top:12px;
      border-top:2px solid var(--border-color);
      font-size:18px;
      font-weight:900;
      text-align:right;
    }

    .notice{font-size:12px;color:var(--hint-color);}
    .error-text{color:var(--error-color);font-size:13px;margin-top:6px;}
    .weighing-note{
      font-size:12px;
      color:#8b5e34;
      background:#fff2df;
      border:1px dashed #e9cda7;
      border-radius:10px;
      padding:8px 10px;
      margin-top:10px;
      text-align:right;
    }

    @media (max-width:480px){
      .modal-body{padding:12px 12px;}
      .section-title{margin-top:14px;}
      .custom-weight-header{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>

      <div class="search-container">
        <input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
      </div>

      <div class="filters-container">
        <select id="category-filter">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        </select>
        <label id="only-cheese-toggle">
          <input type="checkbox" id="only-cheese-checkbox" />
          <span>–¢–æ–ª—å–∫–æ —Å—ã—Ä—ã</span>
        </label>
        <label id="favorites-toggle">
          <input type="checkbox" id="only-fav-checkbox" />
          <span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
        </label>
      </div>

      <div class="favorites-bar" id="favorites-bar"></div>
    </header>

    <main id="main"></main>

    <footer class="cart-footer">
      <button id="open-cart-btn" disabled>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</button>
    </footer>
  </div>

  <!-- Product modal -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title"></h2>
      <button class="modal-close" onclick="closeProductModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="product-desc" id="product-modal-description"></div>

      <div class="form-group">
        <label for="product-variant-select">–í–∞—Ä–∏–∞–Ω—Ç</label>
        <select id="product-variant-select"></select>
        <div class="notice" id="piece-badge" style="display:none;margin-top:6px"></div>
      </div>

      <div class="form-group custom-weight-block" id="custom-weight-block" style="display:none">
        <div class="custom-weight-header">
          <label for="product-custom-weight">–°–≤–æ–π –≤–µ—Å (–≥—Ä–∞–º–º—ã)</label>
          <label class="custom-weight-toggle">
            <input type="checkbox" id="use-custom-weight-checkbox" />
            <span>–£–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –≤–µ—Å</span>
          </label>
        </div>
        <input type="number" id="product-custom-weight" min="50" step="50" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 350" disabled />
        <div class="notice">–®–∞–≥ 50 –≥, —Å–∫–∏–¥–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
      </div>

      <div class="form-group">
        <label for="product-qty-input">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input type="number" id="product-qty-input" value="1" min="1" />
      </div>

      <div class="form-group" id="tvorog-flavor-group" style="display:none">
        <label for="tvorog-flavor-select">–í–∫—É—Å</label>
        <select id="tvorog-flavor-select">
          <option value="–ö—É—Ä–∞–≥–∞">–ö—É—Ä–∞–≥–∞</option>
          <option value="–ò–∑—é–º">–ò–∑—é–º</option>
          <option value="–ß–µ—Ä–Ω–æ—Å–ª–∏–≤">–ß–µ—Ä–Ω–æ—Å–ª–∏–≤</option>
          <option value="–§–∏–Ω–∏–∫–∏">–§–∏–Ω–∏–∫–∏</option>
        </select>
      </div>

      <div class="price-display" id="product-modal-price">0 ‚ÇΩ</div>
      <button class="btn btn-primary" id="add-to-cart-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </dialog>

  <!-- Cart + checkout modal -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <button class="modal-close" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="modal-body" id="cart-modal-body"></div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // ============== CONFIG ==============
    const BACKEND = 'https://puzzlebot-webhook-handler1.onrender.com';
    const CURRENCY = 'RUB';
    const ROUND = Math.round;
    const DISCOUNT_THRESHOLDS = [
      { g:1000, rate:0.15 },
      { g:700,  rate:0.10 },
      { g:500,  rate:0.05 },
    ];
    const ONLY_CHEESE_FILTER_DEFAULT = false;
    const PAYLOAD_SCHEMA_VERSION = 'v2';
    const STORAGE_CART_KEY = 'syromania-cart';
    const STORAGE_CHECKOUT_KEY = 'syromania-checkout';
    const STORAGE_FAV_KEY = 'syromania-favorites';
    const PRODUCT_PLACEHOLDER_IMG = 'https://static.tildacdn.com/tild3134-3861-4539-a363-646133333238/__.webp';

    const fmtRub = n => new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ';

    // –ü—Ä–æ–º–æ–∫–æ–¥—ã (–ø—Ä–∏–º–µ—Ä, –ø–æ-—Ö–æ—Ä–æ—à–µ–º—É ‚Äî —Å –±—ç–∫–µ–Ω–¥–∞)
    const PROMO_CODES = {
      // 'SYR5': { type:'percent', value:5, note:'–°–∫–∏–¥–∫–∞ 5%' },
    };

    // ============== GROUPS ==============
    const GROUPS = [
      { id:'brined',   title:'–†–∞—Å—Å–æ–ª—å–Ω—ã–µ —Å—ã—Ä—ã' },
      { id:'soft',     title:'–ú—è–≥–∫–∏–µ —Å—ã—Ä—ã' },
      { id:'hard',     title:'–¢–≤—ë—Ä–¥—ã–µ —Å—ã—Ä—ã' },
      { id:'rolls',    title:'–°—ã—Ä–Ω—ã–µ —Ä—É–ª–µ—Ç—ã' },
      { id:'dairy',    title:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è' },
      { id:'sweets',   title:'–°–ª–∞–¥–æ—Å—Ç–∏' },
      { id:'bakery',   title:'–í—ã–ø–µ—á–∫–∞' },
    ];
    const CHEESE_GROUP_IDS = new Set(['brined','soft','hard','rolls']);

    // ============== DATA: PRODUCTS ==============
    const PRODUCTS = [
      // --- –†–∞—Å—Å–æ–ª—å–Ω—ã–µ / –º—è–≥–∫–∏–µ / —Ç–≤—ë—Ä–¥—ã–µ —Å—ã—Ä—ã ---
      { id:'mozzarella', name:'–ú–æ—Ü–∞—Ä–µ–ª–ª–∞', group:'brined', pricePerKg:2000, ico:'üßÄ',
        description:'–ú—è–≥–∫–∏–π —Ä–∞—Å—Å–æ–ª—å–Ω—ã–π —Å—ã—Ä. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 3‚Äì5 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/mozzarella.webp' },
      { id:'buratta', name:'–ë—É—Ä–∞—Ç—Ç–∞', group:'brined', pricePerKg:2100, ico:'üßÄ',
        description:'–ú–µ—à–æ—á–µ–∫ –∏–∑ –º–æ—Ü–∞—Ä–µ–ª–ª—ã —Å –Ω–∞—á–∏–Ω–∫–æ–π –∏–∑ —Å—Ç—Ä–∞—á–∞—Ç–µ–ª–ª—ã. –ò–¥–µ–∞–ª—å–Ω–∞ –∫ —Å–∞–ª–∞—Ç–∞–º. –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫.' },
      { id:'stracciatella', name:'–°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞', group:'brined', pricePerKg:2150, ico:'üßÄ',
        description:'–ù–∏—Ç–∏ –º–æ—Ü–∞—Ä–µ–ª–ª—ã –≤ —Å–ª–∏–≤–∫–∞—Ö. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 5‚Äì7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3832-6430-4462-b663-353438383930/stracciatella.webp' },
      { id:'ricotta', name:'–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞)', group:'soft', pricePerKg:1400, ico:'ü•õ',
        description:'–ù–µ–∂–Ω—ã–π —Å—ã—Ä –¥–ª—è –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ –∏ –±–ª—é–¥. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.' },
      { id:'ricotta-herbs', name:'–†–∏–∫–æ—Ç—Ç–∞ —Å —É–∫—Ä–æ–ø–æ–º –∏ –∑–µ–ª–µ–Ω—å—é', group:'soft', pricePerKg:1500, ico:'üåø',
        description:'–ù–µ–∂–Ω—ã–π, —Å–≤–µ–∂–∏–π, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.' },
      { id:'caciotta', name:'–ö–∞—á–æ—Ç—Ç–∞', group:'soft', pricePerKg:2200, ico:'üßÄ',
        description:'–ú—è–≥–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Å—ã—Ä. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6165-3265-4834-a236-366661346562/caciotta.webp' },
      { id:'caciotta-fenugreek', name:'–ö–∞—á–æ—Ç—Ç–∞ —Å –ø–∞–∂–∏—Ç–Ω–∏–∫–æ–º', group:'soft', pricePerKg:2250, ico:'üåø',
        description:'–û—Ä–µ—Ö–æ–≤—ã–π –ø—Ä–∏–≤–∫—É—Å –ø–∞–∂–∏—Ç–Ω–∏–∫–∞. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.' },
      { id:'hard-village', name:'–¢–≤—ë—Ä–¥—ã–π –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏', group:'hard', pricePerKg:1600, ico:'üßÄ',
        description:'–ì–æ—Ç–æ–≤–∏—Ç—Å—è –∏–∑ —Ç–≤–æ—Ä–æ–≥–∞ —Å –ø—Ä–∏–ø—Ä–∞–≤–∞–º–∏, –æ–±–∂–∞—Ä–∏–≤–∞–µ—Ç—Å—è. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/hard-village.webp' },
      { id:'hard-smoked', name:'–¢–≤—ë—Ä–¥—ã–π –∫–æ–ø—á—ë–Ω—ã–π', group:'hard', pricePerKg:1800, ico:'üí®',
        description:'–¢–≤–æ—Ä–æ–≥ —Å –ø—Ä–∏–ø—Ä–∞–≤–∞–º–∏, –æ–±–∂–∞—Ä–µ–Ω–Ω—ã–π –∏ –∫–æ–ø—á—ë–Ω—ã–π. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: –¥–æ 30 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6662-3930-4663-b132-316135626136/hard-smoked.webp' },

      { id:'rolls-olives-walnut', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–º–∞—Å–ª–∏–Ω—ã, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', group:'rolls', pricePerKg:1700, ico:'ü•ú',
        description:'–ó–∞–∫—É—Å–∫–∞ –∫ –ª—é–±–æ–º—É —Å—Ç–æ–ª—É. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-olives-walnut.webp' },
      { id:'rolls-apricot-cedar', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–∫—É—Ä–∞–≥–∞, –∫–µ–¥—Ä–æ–≤—ã–π –æ—Ä–µ—Ö)', group:'rolls', pricePerKg:1700, ico:'üçë',
        description:'–°–ª–µ–≥–∫–∞ —Å–ª–∞–¥–∫–æ–≤–∞—Ç—ã–π –≤–∫—É—Å. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-apricot-cedar.webp' },

      // –ê–¥—ã–≥–µ–π—Å–∫–∏–µ (–ø–∞–Ω–∏—Ä)
      { id:'panir-classic', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π (–ø–∞–Ω–∏—Ä) –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'soft', pricePerKg:1450, ico:'üßÄ',
        description:'–û—á–µ–Ω—å –Ω–µ–∂–Ω—ã–π, –º—è–≥–∫–∏–π, –º–æ–ª–æ—á–Ω—ã–π –≤–∫—É—Å. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-classic.webp' },
      { id:'panir-herbs', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π —Å –∑–µ–ª–µ–Ω—å—é (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1600, ico:'üåø',
        description:'–õ—ë–≥–∫–∏–π, —Å–≤–µ–∂–∏–π –≤–∫—É—Å. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-herbs.webp' },
      { id:'panir-spicy', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π —Å–æ —Å–ø–µ—Ü–∏—è–º–∏ (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1650, ico:'üå∂Ô∏è',
        description:'–ù–µ–∂–Ω—ã–π, –∞—Ä–æ–º–∞—Ç–Ω—ã–π, —Å–ø–µ—Ü–∏–∏ –≤ –º–µ—Ä—É. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-spicy.webp' },
      { id:'panir-smoked', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π –∫–æ–ø—á—ë–Ω—ã–π (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1700, ico:'üí®',
        description:'–ü—Ä–∏—è—Ç–Ω–∞—è –∫–æ–ø—á—ë–Ω–æ—Å—Ç—å, –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π –≤–∫—É—Å. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 30 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-smoked.webp' },

      // –°—É–ª—É–≥—É–Ω–∏ / –ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π / –•–∞–ª–ª—É–º–∏ / –ö–æ—Å–∏—á–∫–∞
      { id:'suluguni', name:'–°—É–ª—É–≥—É–Ω–∏', group:'brined', pricePerKg:1700, ico:'üßÄ',
        description:'–£–º–µ—Ä–µ–Ω–Ω–æ —Å–æ–ª—ë–Ω—ã–π, —Å–ª–æ–∏—Å—Ç—ã–π –∏ —ç–ª–∞—Å—Ç–∏—á–Ω—ã–π. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3238-3866-4366-a436-623236363261/suluguni.webp' },
      { id:'suluguni-smoked', name:'–°—É–ª—É–≥—É–Ω–∏ –∫–æ–ø—á—ë–Ω—ã–π', group:'brined', pricePerKg:1800, ico:'üí®',
        description:'–° –ª—ë–≥–∫–æ–π –∫–æ–ø—á—ë–Ω–æ—Å—Ç—å—é, –ø–ª–æ—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 30 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6435-3838-4463-b431-353765323333/suluguni-smoked.webp' },
      { id:'imeretian', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π', group:'brined', pricePerKg:1500, ico:'üßÄ',
        description:'–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π —Ä–∞—Å—Å–æ–ª—å–Ω—ã–π —Å—ã—Ä, –ø–æ–¥—Ö–æ–¥–∏—Ç –∫–æ –≤—Å–µ–º –±–ª—é–¥–∞–º. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/imeretian.webp' },
      { id:'imeretian-dill-garlic', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π —Å —É–∫—Ä–æ–ø–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º', group:'brined', pricePerKg:1600, ico:'üßÑ',
        description:'–°–≤–µ–∂–∏–π —Ä–∞—Å—Å–æ–ª—å–Ω—ã–π —Å—ã—Ä —Å –∑–µ–ª–µ–Ω—å—é –∏ —á–µ—Å–Ω–æ–∫–æ–º. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6435-3539-4337-a561-386438636230/__.webp' },

      { id:'halloumi', name:'–•–∞–ª–ª—É–º–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)', group:'brined', pricePerKg:1950, ico:'üî•',
        description:'–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –∂–∞—Ä–∫–∏ –∏–ª–∏ –±–µ–∑ –æ–±–∂–∞—Ä–∫–∏. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3161-6362-4130-b134-623331346238/halloumi.webp' },
      { id:'halloumi-paprika-oregano', name:'–•–∞–ª–ª—É–º–∏ —Å –ø–∞–ø—Ä–∏–∫–æ–π –∏ –æ—Ä–µ–≥–∞–Ω–æ', group:'brined', pricePerKg:2100, ico:'üå∂Ô∏è',
        description:'–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏–µ –Ω–æ—Ç–∫–∏, –æ—Ç–ª–∏—á–Ω–æ –∂–∞—Ä–∏—Ç—Å—è. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3133-6165-4134-b335-396662633262/halloumi-paprika-ore.webp' },
      { id:'halloumi-tomato-basil-garlic', name:'–•–∞–ª–ª—É–º–∏ —Ç–æ–º–∞—Ç-–±–∞–∑–∏–ª–∏–∫-—á–µ—Å–Ω–æ–∫', group:'brined', pricePerKg:2100, ico:'üçÖ',
        description:'–Ø—Ä–∫–∏–π –≤–∫—É—Å, —Ö—Ä—É—Å—Ç—è—â–∞—è –∫–æ—Ä–æ—á–∫–∞ –ø—Ä–∏ –∂–∞—Ä–∫–µ. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/halloumi-tomato-basil-garlic.webp' },
      { id:'halloumi-tomato-paprika', name:'–•–∞–ª–ª—É–º–∏ —Å –≤—è–ª–µ–Ω—ã–º–∏ –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ –∏ –ø–∞–ø—Ä–∏–∫–æ–π', group:'brined', pricePerKg:2100, ico:'üçÖ',
        description:'–ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –≤–∫—É—Å, —Ö–æ—Ä–æ—à –¥–ª—è –≥—Ä–∏–ª—è. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3863-3030-4439-a439-653238303862/halloumi-tomato-papr.webp' },

      { id:'kosichka', name:'–ö–æ—Å–∏—á–∫–∞ (1 —à—Ç ~200 –≥)', group:'brined', pricePerKg:1900, ico:'ü•®',
        description:'–°–ª–µ–≥–∫–∞ —Å–æ–ª—ë–Ω—ã–π —Å—ã—Ä, –ø–æ–¥—Ö–æ–¥–∏—Ç –∫–æ –≤—Å–µ–º—É. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.' },
      { id:'kosichka-smoked', name:'–ö–æ—Å–∏—á–∫–∞ –∫–æ–ø—á—ë–Ω–∞—è (1 —à—Ç ~200 –≥)', group:'brined', pricePerKg:2000, ico:'üí®',
        description:'–•–æ–ª–æ–¥–Ω–æ–µ –∫–æ–ø—á–µ–Ω–∏–µ, –ª—ë–≥–∫–∞—è —Å–æ–ª—ë–Ω–æ—Å—Ç—å. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 30 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/kosichka-smoked.webp' },
      { id:'spicy-klubok', name:'–ü—Ä—è–Ω—ã–µ –∫–ª—É–±–æ—á–∫–∏ (1 —à—Ç ~150 –≥)', group:'brined', pricePerKg:1950, ico:'üå∂Ô∏è',
        description:'–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∫—É—Å, –Ω–µ —Å–∏–ª—å–Ω–æ —Å–æ–ª—ë–Ω—ã–π. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3463-6166-4665-a439-323264653939/spicy-klubok.webp' },

      // --- –ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è ---
      { id:'milk', name:'–ú–æ–ª–æ–∫–æ', group:'dairy', pricePerL:150, ico:'ü•õ',
        description:'–ú–æ–ª–æ–∫–æ –æ—Ç–±–æ—Ä–Ω–æ–µ —Ü–µ–ª—å–Ω–æ–µ, –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω–æ–µ. –ö–∞–∫ –∏–∑ –¥–µ—Ç—Å—Ç–≤–∞! –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–µ.' },
      { id:'milk-topped', name:'–ú–æ–ª–æ–∫–æ —Ç–æ–ø–ª—ë–Ω–æ–µ', group:'dairy', pricePerL:250, ico:'ü•õ',
        description:'–ù–∞—Å—Ç–æ—è—â–µ–µ —Ü–µ–ª—å–Ω–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ –º–æ–ª–æ–∫–æ, –≥—É—Å—Ç–æ–≤–∞—Ç–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è. –°—Ä–æ–∫: 5‚Äì7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3839-3163-4066-a633-306366346631/milk-topped.webp' },
      { id:'yogurt', name:'–ô–æ–≥—É—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'dairy', pricePerL:260, ico:'ü•õ',
        description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –π–æ–≥—É—Ä—Ç –∏–∑ –º–æ–ª–æ–∫–∞ –∏ –∑–∞–∫–≤–∞—Å–∫–∏. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.' },
      { id:'ryazhenka', name:'–†—è–∂–µ–Ω–∫–∞', group:'dairy', pricePerL:280, ico:'ü•õ',
        description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Ä—è–∂–µ–Ω–∫–∞, –ª—é–±–∏–º—ã–π –¥–µ—Ç—Å–∫–∏–π –Ω–∞–ø–∏—Ç–æ–∫. –°—Ä–æ–∫: –¥–æ 5 —Å—É—Ç–æ–∫.' },
      { id:'misti-dahi', name:'–ú–∏—Å—Ç—Ö–∏-–î–∞—Ö–∏', group:'dairy', pricePerL:300, ico:'ü•õ',
        description:'–ö–∏—Å–ª–æ–º–æ–ª–æ—á–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.' },
      { id:'whey', name:'–°—ã–≤–æ—Ä–æ—Ç–∫–∞', group:'dairy', pricePerL:60, ico:'üíß',
        description:'–ù–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç –∏–∑ —Ç–≤–æ—Ä–æ–≥–∞/—Å—ã—Ä–∞. –°—Ä–æ–∫: 3 —Å—É—Ç–æ–∫.' },
      { id:'cream', name:'–°–ª–∏–≤–∫–∏ (33‚Äì36%)', group:'dairy', pricePerL:1450, ico:'ü•õ',
        description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ —Å–≤–µ–∂–∏–µ —Å–ª–∏–≤–∫–∏. –ù–∞ 3‚Äì4 —Å—É—Ç–∫–∏ –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å —Å–º–µ—Ç–∞–Ω–æ–π. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3163-3665-4636-a537-303830323163/cream.webp' },
      { id:'tvorog', name:'–¢–≤–æ—Ä–æ–≥', group:'dairy', pricePerKg:700, ico:'ü•õ',
        description:'–ù–µ–∂–Ω—ã–π —Ç–≤–æ—Ä–æ–≥ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ ¬´–∑—ë—Ä–Ω—ã—à–∫–∞–º–∏¬ª. –û—Ç–ª–∏—á–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –∑–∞–º–æ—Ä–æ–∑–∫—É. –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫.' },
      { id:'butter', name:'–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ (—à–∞—Ä ~200 –≥)', group:'dairy', pricePerKg:2100, ico:'üßà',
        description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ, –∫–∞–∫ —É –±–∞–±—É—à–∫–∏. –°—Ä–æ–∫: –¥–æ 180 —Å—É—Ç–æ–∫ –ø—Ä–∏ t‚â§+15 ¬∞C.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/butter.webp' },
      { id:'ghee', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ (–ì–•–ò)', group:'dairy', pricePerKg:2900, ico:'üßà',
        description:'–°–æ—Å—Ç–∞–≤: —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ, ~99% –∂–∏—Ä. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∂–∞—Ä–∫–∏. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: –±–æ–ª–µ–µ 10 –ª–µ—Ç.' },
      { id:'condensed-milk', name:'–°–≥—É—â–µ–Ω–∫–∞', group:'dairy', pricePerKg:1000, ico:'ü•õ',
        description:'–¶–µ–ª—å–Ω–æ–µ –º–æ–ª–æ–∫–æ –∏ —Ç—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä. –ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è –≤–∞—Ä—ë–Ω–∞—è —Å–≥—É—â—ë–Ω–∫–∞. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
      { id:'tvorozhnaya-massa', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞ (–∫—É—Ä–∞–≥–∞/–∏–∑—é–º/—á–µ—Ä–Ω–æ—Å–ª–∏–≤/—Ñ–∏–Ω–∏–∫–∏)', group:'dairy', pricePerKg:850, ico:'ü•õ',
        description:'–¢–≤–æ—Ä–æ–≥, —Å–ª–∏–≤–∫–∏, —Ç—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä –∏ –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª–∏. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6630-3237-4430-b461-313634376333/tvorozhnaya-massa_.webp' },

      // --- –°–ª–∞–¥–æ—Å—Ç–∏ ---
      { id:'sandesh-orange', name:'–°–∞–Ω–¥–µ—à (–∞–ø–µ–ª—å—Å–∏–Ω)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
        description:'–ú–æ–ª–æ–∫–æ, —Ç—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä, —Ü–µ–¥—Ä–∞ –∞–ø–µ–ª—å—Å–∏–Ω–∞. 5 —à—Ç. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-orange.webp' },
      { id:'sandesh-walnut', name:'–°–∞–Ω–¥–µ—à (–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
        description:'–ú–æ–ª–æ–∫–æ, —Å–∞—Ö–∞—Ä, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö. 5 —à—Ç. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-walnut.webp' },
      { id:'sandesh-carob', name:'–°–∞–Ω–¥–µ—à (–∫—ç—Ä–æ–±)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
        description:'–ú–æ–ª–æ–∫–æ, —Å–∞—Ö–∞—Ä, –∫—ç—Ä–æ–±, –∫–æ–∫–æ—Å. –®–æ–∫–æ–ª–∞–¥–Ω—ã–π –≤–∫—É—Å. 5 —à—Ç.', img:'https://static.tildacdn.com/tild6135-6337-4266-b764-613565386238/_.webp' },
      { id:'barfi-classic', name:'–ë—É—Ä—Ñ–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'sweets', pricePerUnit:350, ico:'üçÆ',
        description:'–ù–µ–∂–Ω–∞—è –º–æ–ª–æ—á–Ω–∞—è —Å–ª–∞–¥–æ—Å—Ç—å. 5 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.', img:'https://static.tildacdn.com/tild3430-3231-4562-b164-366638313434/barfi-classic.webp' },
      { id:'barfi-hazelnut', name:'–ë—É—Ä—Ñ–∏ —Ñ—É–Ω–¥—É–∫', group:'sweets', pricePerUnit:350, ico:'üçÆ',
        description:'–° —Ñ—É–Ω–¥—É–∫–æ–º, 5 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.', img:'https://static.tildacdn.com/tild3065-3332-4466-a536-353130343264/barfi-hazelnut.webp' },
      { id:'barfi-sesame', name:'–ë—É—Ä—Ñ–∏ –∫—É–Ω–∂—É—Ç–Ω—ã–π', group:'sweets', pricePerUnit:490, ico:'üçÆ',
        description:'–ö—É–Ω–∂—É—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è, 7 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.', img:'https://static.tildacdn.com/tild3439-6135-4861-a531-316233303166/_.webp' },
      { id:'halva', name:'–•–∞–ª–≤–∞', group:'sweets', pricePerUnit:200, ico:'üçÆ',
        description:'–¢—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä, –≤–æ–¥–∞, —Å–µ–º–µ–Ω–∞ –ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–∏–∫–∞, —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ. 0.2 –∫–≥. –°—Ä–æ–∫: 14 –¥–Ω–µ–π.', img:'https://static.tildacdn.com/tild3566-6566-4464-b531-306364646164/photo.webp' },
      { id:'potato-cake-5', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª (5 —à—Ç)', group:'sweets', pricePerUnit:400, ico:'üç∞',
        description:'–ò–∑ —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π –º—É–∫–∏ –∏ –¥–æ–º–∞—à–Ω–µ–π —Å–≥—É—â—ë–Ω–∫–∏.', img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },
      { id:'potato-cake-2', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª (2 —à—Ç)', group:'sweets', pricePerUnit:190, ico:'üç∞',
        description:'–ú–∏–Ω–∏-–Ω–∞–±–æ—Ä ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª.', img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },

      // --- –í—ã–ø–µ—á–∫–∞ ---
      { id:'cookies-nut', name:'–û—Ä–µ—Ö–æ–≤—ã–µ –ø–∞–ª—å—á–∏–∫–∏', group:'bakery', pricePerKg:700, ico:'üç™',
        description:'–ü–µ—á–µ–Ω—å–µ —Å —Ö—Ä—É—Å—Ç—è—â–∏–º–∏ –æ—Ä–µ—Ö–∞–º–∏.', img:'https://static.tildacdn.com/tild3035-6230-4434-b363-303434366630/cookies-nut.webp' },
      { id:'muffin-plain', name:'–ö–µ–∫—Å—ã –æ–±—ã—á–Ω—ã–µ', group:'bakery', pricePerKg:500, ico:'üßÅ',
        description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∫–µ–∫—Å—ã.' },
      { id:'muffin-carob', name:'–ö–µ–∫—Å—ã –∫—ç—Ä–æ–±–æ–≤—ã–µ', group:'bakery', pricePerKg:550, ico:'üßÅ',
        description:'–° –∫—ç—Ä–æ–±–æ–º –≤–º–µ—Å—Ç–æ –∫–∞–∫–∞–æ.' },
      { id:'muffin-raisin', name:'–ö–µ–∫—Å—ã –∏–∑—é–º', group:'bakery', pricePerKg:550, ico:'üßÅ',
        description:'–ö–µ–∫—Å—ã —Å –∏–∑—é–º–æ–º.', img:'https://static.tildacdn.com/tild3465-3162-4436-a235-363763383339/muffin-raisin.webp' },
      { id:'bliny-10', name:'–ë–ª–∏–Ω—ã (10 —à—Ç)', group:'bakery', pricePerUnit:330, ico:'ü•û',
        description:'–î–æ–º–∞—à–Ω–∏–µ –±–ª–∏–Ω—ã, 10 —à—Ç—É–∫.' },
      { id:'bliny-5', name:'–ë–ª–∏–Ω—ã (5 —à—Ç)', group:'bakery', pricePerUnit:220, ico:'ü•û',
        description:'–î–æ–º–∞—à–Ω–∏–µ –±–ª–∏–Ω—ã, 5 —à—Ç—É–∫.' },
      { id:'bliny-tvorog-5', name:'–ë–ª–∏–Ω—ã —Ç–≤–æ—Ä–æ–≥/—Ç–≤–æ—Ä–æ–≥-–∏–∑—é–º (5 —à—Ç)', group:'bakery', pricePerUnit:300, ico:'ü•û',
        description:'–ë–ª–∏–Ω—ã —Å —Ç–≤–æ—Ä–æ–∂–Ω–æ–π –Ω–∞—á–∏–Ω–∫–æ–π.' },
      { id:'syrniki-10', name:'–°—ã—Ä–Ω–∏–∫–∏ (10 —à—Ç)', group:'bakery', pricePerUnit:520, ico:'ü•û',
        description:'–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏, 10 —à—Ç—É–∫.' },
      { id:'syrniki-5', name:'–°—ã—Ä–Ω–∏–∫–∏ (5 —à—Ç)', group:'bakery', pricePerUnit:280, ico:'ü•û',
        description:'–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏, 5 —à—Ç—É–∫.' },
      { id:'chapati-10', name:'–ß–∞–ø–∞—Ç–∏ (10 —à—Ç)', group:'bakery', pricePerUnit:270, ico:'ü´ì',
        description:'–ü—à–µ–Ω–∏—á–Ω–∞—è –∏ —Ä–∂–∞–Ω–∞—è –º—É–∫–∞, –≤–æ–¥–∞, —Å–æ–ª—å, —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ. –°—Ä–æ–∫: 2 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6332-6239-4538-b839-356132356236/chapati-10.webp' },
      { id:'chapati-wholewheat-10', name:'–ß–∞–ø–∞—Ç–∏ (—Ü/–∑ –º—É–∫–∞) (10 —à—Ç)', group:'bakery', pricePerUnit:320, ico:'ü´ì',
        description:'–ò–∑ —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–æ–π –º—É–∫–∏. –°—Ä–æ–∫: 2 —Å—É—Ç–æ–∫.' },
    ];

    // ============== VARIANT RULES ==============
    const VARIANT_RULES = {
      // –°—ã—Ä—ã / —Ä–∞—Å—Å–æ–ª—å–Ω—ã–µ / –º—è–≥–∫–∏–µ / —Ç–≤—ë—Ä–¥—ã–µ
      'mozzarella':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
      'buratta':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },
      'stracciatella':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','500 –≥'] },
      'ricotta':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','450 –≥'] },
      'ricotta-herbs':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','450 –≥'] },
      'caciotta':{ type:'weight', unit:'–≥', step:50, min:200, max:1500 },
      'caciotta-fenugreek':{ type:'weight', unit:'–≥', step:50, min:200, max:1500 },
      'hard-village':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
      'hard-smoked':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
      'rolls-olives-walnut':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },
      'rolls-apricot-cedar':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },

      'panir-classic':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
      'panir-herbs':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
      'panir-spicy':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
      'panir-smoked':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },

      'suluguni':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },
      'suluguni-smoked':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },
      'imeretian':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },
      'imeretian-dill-garlic':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },

      'halloumi':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },
      'halloumi-paprika-oregano':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },
      'halloumi-tomato-basil-garlic':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },
      'halloumi-tomato-paprika':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },

      'kosichka':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
      'kosichka-smoked':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
      'spicy-klubok':{ type:'fixed', options:['1 —à—Ç (150 –≥)'] },

      // –ú–æ–ª–æ—á–∫–∞
      'milk':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
      'milk-topped':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
      'yogurt':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
      'ryazhenka':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
      'misti-dahi':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
      'whey':{ type:'fixed', options:['1 –ª'] },
      'cream':{ type:'fixed', options:['0.2 –ª','0.5 –ª','1 –ª'] },
      'tvorog':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
      'butter':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
      'ghee':{ type:'fixed', options:['200 –≥','500 –≥','1000 –≥'] },
      'condensed-milk':{ type:'weight', unit:'–≥', step:100, min:200, max:2000 },
      'tvorozhnaya-massa':{ type:'weight', unit:'–≥', step:100, min:200, max:2000 },

      // –°–ª–∞–¥–æ—Å—Ç–∏ / –≤—ã–ø–µ—á–∫–∞
      'sandesh-orange':{ type:'fixed', options:['5 —à—Ç'] },
      'sandesh-walnut':{ type:'fixed', options:['5 —à—Ç'] },
      'sandesh-carob':{ type:'fixed', options:['5 —à—Ç'] },
      'barfi-classic':{ type:'fixed', options:['5 —à—Ç'] },
      'barfi-hazelnut':{ type:'fixed', options:['5 —à—Ç'] },
      'barfi-sesame':{ type:'fixed', options:['7 —à—Ç'] },
      'halva':{ type:'fixed', options:['0.2 –∫–≥'] },
      'potato-cake-5':{ type:'fixed', options:['5 —à—Ç'] },
      'potato-cake-2':{ type:'fixed', options:['2 —à—Ç'] },

      'cookies-nut':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
      'muffin-plain':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
      'muffin-carob':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
      'muffin-raisin':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },

      'bliny-10':{ type:'fixed', options:['10 —à—Ç'] },
      'bliny-5':{ type:'fixed', options:['5 —à—Ç'] },
      'bliny-tvorog-5':{ type:'fixed', options:['5 —à—Ç'] },
      'syrniki-10':{ type:'fixed', options:['10 —à—Ç'] },
      'syrniki-5':{ type:'fixed', options:['5 —à—Ç'] },

      'chapati-10':{ type:'fixed', options:['10 —à—Ç'] },
      'chapati-wholewheat-10':{ type:'fixed', options:['10 —à—Ç'] },
    };

    // ============== STATE ==============
    let cart = [];
    let favorites = new Set();
    let currentProduct = null;
    let filteredProducts = [];
    let checkoutState = { phone:'', address:'', comment:'', promo:'', city:'–ü–µ–Ω–∑–∞' };

    // ============== INIT ==============
    document.addEventListener('DOMContentLoaded', init);

    function init(){
      loadState();
      setupEventListeners();
      setupTelegramWebApp();
      renderUserProfile();
      populateCategoryFilter();
      document.getElementById('only-cheese-checkbox').checked = ONLY_CHEESE_FILTER_DEFAULT;
      refreshFavoritesBar();
      filterAndRender();
      updateCartUI();
    }

    function loadState(){
      try{ const savedCart = localStorage.getItem(STORAGE_CART_KEY); if(savedCart) cart = JSON.parse(savedCart); }catch{}
      try{ const savedFav = localStorage.getItem(STORAGE_FAV_KEY); if(savedFav) favorites = new Set(JSON.parse(savedFav)); }catch{}
      try{ const savedCheckout = localStorage.getItem(STORAGE_CHECKOUT_KEY); if(savedCheckout) checkoutState = JSON.parse(savedCheckout); }catch{}
    }
    function saveState(){
      try{ localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(cart)); }catch{}
      try{ localStorage.setItem(STORAGE_FAV_KEY, JSON.stringify([...favorites])); }catch{}
      try{ localStorage.setItem(STORAGE_CHECKOUT_KEY, JSON.stringify(checkoutState)); }catch{}
    }

    // ============== TELEGRAM ==============
    function setupTelegramWebApp(){
      if(window.Telegram && window.Telegram.WebApp){
        const webApp = window.Telegram.WebApp;
        webApp.ready();
        webApp.expand();
        webApp.MainButton.setText('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑').onClick(()=>openCartModal()).hide();
        webApp.BackButton.onClick(()=>{
          const pm = document.getElementById('product-modal');
          const cm = document.getElementById('cart-modal');
          if(cm.open) closeCartModal();
          else if(pm.open) closeProductModal();
        });
      }
    }

    // ============== EVENT LISTENERS ==============
    function setupEventListeners(){
      el('search-input').addEventListener('input', filterAndRender);
      el('category-filter').addEventListener('change', filterAndRender);
      el('only-cheese-checkbox').addEventListener('change', filterAndRender);
      el('only-fav-checkbox').addEventListener('change', filterAndRender);

      el('open-cart-btn').addEventListener('click', openCartModal);
      el('add-to-cart-btn').addEventListener('click', addToCart);
      el('product-variant-select').addEventListener('change', ()=>{ updateProductModalPrice(); });
      el('product-qty-input').addEventListener('input', ()=>{ updateProductModalPrice(); });
      el('product-custom-weight').addEventListener('input', ()=>{ updateProductModalPrice(); });
      el('use-custom-weight-checkbox').addEventListener('change', ()=>{
        const input = el('product-custom-weight');
        const use = el('use-custom-weight-checkbox').checked;
        input.disabled = !use;
        if(use && !input.value){
          // –ø–æ–¥—Å—Ç–∞–≤–∏–º –±–ª–∏–∂–∞–π—à–∏–π –≤–µ—Å –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–∞
          const baseGrams = extractGrams(el('product-variant-select').value) || 200;
          const rounded = Math.max(50, Math.round(baseGrams / 50) * 50);
          input.value = rounded;
        }
        updateProductModalPrice();
      });
    }

    // ============== HEADER & FILTERS ==============
    function renderUserProfile(){
      const box = el('user-profile');
      const ua = window.Telegram?.WebApp?.initDataUnsafe?.user;
      if(ua){
        box.innerHTML = `
          <div class="user-avatar">
            <img src="${ua.photo_url||''}" alt="Avatar"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <span style="display:none;">${(ua.first_name||'U').charAt(0).toUpperCase()}</span>
          </div>
          <div class="user-name">${ua.first_name||''}</div>
        `;
      } else {
        box.style.display = 'none';
      }
    }

    function populateCategoryFilter(){
      const select = el('category-filter');
      GROUPS.forEach(g=>{
        const o = document.createElement('option');
        o.value = g.id;
        o.textContent = g.title;
        select.appendChild(o);
      });
    }

    function filterAndRender(){
      const term = el('search-input').value.trim().toLowerCase();
      const groupSel = el('category-filter').value;
      const onlyCheese = el('only-cheese-checkbox').checked;
      const onlyFav = el('only-fav-checkbox').checked;

      filteredProducts = PRODUCTS.filter(p=>{
        const inTerm   = !term || p.name.toLowerCase().includes(term);
        const inGroup  = !groupSel || p.group === groupSel;
        const inCheese = !onlyCheese || CHEESE_GROUP_IDS.has(p.group);
        const inFav    = !onlyFav || favorites.has(p.id);
        return hasPrice(p) && inTerm && inGroup && inCheese && inFav;
      });

      const showSections = (term==='' && !groupSel && !onlyFav && !onlyCheese);
      renderMain(showSections);
    }

    function renderMain(showSections){
      const main = el('main');
      main.innerHTML = '';
      if(filteredProducts.length === 0){
        main.innerHTML = '<p style="text-align:center;color:var(--hint-color)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
        return;
      }

      if(showSections){
        for(const g of GROUPS){
          const items = filteredProducts.filter(p=>p.group === g.id);
          if(items.length === 0) continue;
          const section = document.createElement('section');
          section.className = 'section';
          section.innerHTML = `<div class="section-title">${g.title}</div>`;
          const grid = document.createElement('div');
          grid.className = 'product-grid';
          items.forEach(p=>grid.appendChild(productCard(p)));
          section.appendChild(grid);
          main.appendChild(section);
        }
      } else {
        const grid = document.createElement('div');
        grid.className = 'product-grid';
        filteredProducts.forEach(p=>grid.appendChild(productCard(p)));
        main.appendChild(grid);
      }
    }

    function productCard(p){
      const card = document.createElement('div');
      card.className = 'product-card';
      card.onclick = (e)=>{
        if(e.target.closest('.fav-btn')) return;
        openProductModal(p.id);
      };

      const priceText = getPriceText(p);
      const approx = approxPieceBadgeText(p);
      const favActive = favorites.has(p.id) ? 'active' : '';
      const imgSrc = p.img || PRODUCT_PLACEHOLDER_IMG;

      card.innerHTML = `
        <div class="product-thumb">
          <img src="${imgSrc}" alt="${escapeHtml(p.name)}" onerror="this.src='${PRODUCT_PLACEHOLDER_IMG}'" />
        </div>
        <div class="name">${p.name}</div>
        <div class="product-row">
          <div class="price">${priceText}</div>
          ${approx ? `<div class="badge-piece">${approx}</div>` : ''}
          <button class="fav-btn ${favActive}" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
            onclick="toggleFavorite('${p.id}');event.stopPropagation()">
            ${favActive ? '‚ô•' : '‚ô°'}
          </button>
        </div>
      `;
      return card;
    }

    function refreshFavoritesBar(){
      const bar = el('favorites-bar');
      bar.innerHTML = '';
      if(favorites.size === 0){
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'flex';
      [...favorites].slice(0,30).forEach(id=>{
        const p = PRODUCTS.find(x=>x.id===id);
        if(!p) return;
        const chip = document.createElement('div');
        chip.className = 'fav-chip';
        chip.textContent = p.name;
        chip.onclick = ()=>openProductModal(id);
        bar.appendChild(chip);
      });
    }

    function toggleFavorite(id){
      if(favorites.has(id)) favorites.delete(id);
      else favorites.add(id);
      saveState();
      refreshFavoritesBar();
      filterAndRender();
    }

    // ============== PRODUCT MODAL ==============
    function openProductModal(productId){
      currentProduct = PRODUCTS.find(p=>p.id === productId);
      if(!currentProduct) return;

      el('product-modal-title').textContent = currentProduct.name;
      el('product-modal-description').textContent = currentProduct.description || '';

      renderVariantSelector();
      configureCustomWeightVisibility();
      configureFlavorSelector();
      updateProductModalPrice();

      el('product-modal').showModal();
      window.Telegram?.WebApp?.BackButton.show();
    }

    function closeProductModal(){
      el('product-modal').close();
      currentProduct = null;
      window.Telegram?.WebApp?.BackButton.hide();
    }

    function renderVariantSelector(){
      const select = el('product-variant-select');
      const pieceBadge = el('piece-badge');
      select.innerHTML = '';
      pieceBadge.style.display = 'none';
      pieceBadge.textContent = '';

      const rule = VARIANT_RULES[currentProduct.id];
      if(!rule){
        select.innerHTML = '<option>–í–∞—Ä–∏–∞–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</option>';
        return;
      }

      if(rule.type === 'fixed'){
        rule.options.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          select.appendChild(o);
        });

        // –±–µ–π–¥–∂ "‚âà –∑–∞ 1 —à—Ç" –¥–ª—è –∫–≥-—Å—ã—Ä–æ–≤ —Å –≤–∞—Ä–∏–∞–Ω—Ç–æ–º "1 —à—Ç (...)"
        const approx = approxPieceBadgeText(currentProduct);
        if(approx){
          pieceBadge.style.display = 'block';
          pieceBadge.textContent = approx;
        }
      } else if(rule.type === 'weight'){
        for(let v = rule.min; v <= rule.max; v += rule.step){
          const o = document.createElement('option');
          o.value = `${v} ${rule.unit}`;
          o.textContent = `${v} ${rule.unit}`;
          select.appendChild(o);
        }
      }

      // —Å–±—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–µ—Å–∞
      el('product-qty-input').value = 1;
      const cwCheckbox = el('use-custom-weight-checkbox');
      const cwInput = el('product-custom-weight');
      cwCheckbox.checked = false;
      cwInput.disabled = true;
      cwInput.value = '';
    }

    function configureCustomWeightVisibility(){
      const block = el('custom-weight-block');
      if(currentProduct && currentProduct.pricePerKg){
        block.style.display = 'block';
      } else {
        block.style.display = 'none';
      }
    }

    function configureFlavorSelector(){
      const group = el('tvorog-flavor-group');
      if(currentProduct && currentProduct.id === 'tvorozhnaya-massa'){
        group.style.display = 'block';
      } else {
        group.style.display = 'none';
      }
    }

    // ============== CART LOGIC ==============
    function addToCart(){
      if(!currentProduct) return;
      const selection = getSelectedVariantAndQty();
      const variant = selection.variant;
      const qty = selection.qty;

      const idx = cart.findIndex(i=>i.id===currentProduct.id && i.variant===variant);
      if(idx > -1){
        cart[idx].qty += qty;
      } else {
        cart.push({
          id: currentProduct.id,
          name: currentProduct.name,
          group: currentProduct.group,
          variant,
          qty
        });
      }

      saveState();
      updateCartUI();
      closeProductModal();
      window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('medium');
    }

    function updateCartUI(){
      const totalCount = cart.reduce((s,i)=>s+i.qty,0);
      const totalSum = cart.reduce((s,i)=>s+calculatePrice(i.id,i.variant,i.qty).finalPrice,0);
      const btn = el('open-cart-btn');

      if(cart.length > 0){
        btn.disabled = false;
        btn.textContent = `–ö–æ—Ä–∑–∏–Ω–∞ (${totalCount}) ‚Äî ${fmtRub(totalSum)}`;
        window.Telegram?.WebApp?.MainButton.show();
      } else {
        btn.disabled = true;
        btn.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
        window.Telegram?.WebApp?.MainButton.hide();
      }
    }

    function openCartModal(){
      renderCartModal();
      el('cart-modal').showModal();
      window.Telegram?.WebApp?.BackButton.show();
    }

    function closeCartModal(){
      el('cart-modal').close();
      window.Telegram?.WebApp?.BackButton.hide();
    }

    function renderCartModal(){
      const body = el('cart-modal-body');
      body.innerHTML = '';

      if(cart.length === 0){
        body.innerHTML = '<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>';
        return;
      }

      let total = 0;
      cart.forEach((item,idx)=>{
        const price = calculatePrice(item.id,item.variant,item.qty);
        total += price.finalPrice;
        const rate = getDiscountRateForProduct(item.id);
        const hint = rate>0 ? `<div class="discount-hint">–°–∫–∏–¥–∫–∞ ${Math.round(rate*100)}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞</div>` : '';

        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-variant">${escapeHtml(item.variant)}</div>
            <div class="cart-item-price">${fmtRub(price.finalPrice)}</div>
            ${hint}
          </div>
          <div class="cart-item-controls">
            <div class="qty-control">
              <button onclick="changeItemQty(${idx},-1)">‚àí</button>
              <span>${item.qty}</span>
              <button onclick="changeItemQty(${idx},1)">+</button>
            </div>
          </div>
        `;
        body.appendChild(div);
      });

      const summary = document.createElement('div');
      summary.className = 'cart-summary';
      summary.textContent = `–ò—Ç–æ–≥–æ: ${fmtRub(total)}`;
      body.appendChild(summary);

      // –ü—Ä–æ–º–æ–∫–æ–¥
      const promoWrap = document.createElement('div');
      promoWrap.style.marginTop = '10px';
      promoWrap.innerHTML = `
        <div class="form-group" style="margin-bottom:6px">
          <label for="checkout-promo">–ü—Ä–æ–º–æ–∫–æ–¥</label>
          <input id="checkout-promo" placeholder="–ï—Å–ª–∏ –µ—Å—Ç—å" />
          <div class="notice">–ü—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –±—ç–∫–µ–Ω–¥–µ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) –∏–ª–∏ –≤ –∫–æ–¥–µ.</div>
        </div>
      `;
      body.appendChild(promoWrap);

      // –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∞
      const checkout = document.createElement('div');
      checkout.innerHTML = `
        <div class="section-title" style="margin-top:16px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="form-group">
          <label for="checkout-city">–ì–æ—Ä–æ–¥</label>
          <select id="checkout-city">
            <option value="–ü–µ–Ω–∑–∞">–ü–µ–Ω–∑–∞</option>
            <option value="–ú–æ—Å–∫–≤–∞">–ú–æ—Å–∫–≤–∞</option>
          </select>
          <div class="notice">–ï—Å–ª–∏ –≤—ã –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞ ‚Äî —É–∫–∞–∂–∏—Ç–µ —ç—Ç–æ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.</div>
        </div>
        <div class="form-group">
          <label for="checkout-phone">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏</label>
          <input type="tel" id="checkout-phone" inputmode="tel" placeholder="+7 999 999-99-99" />
          <div class="notice">–§–æ—Ä–º–∞—Ç –ª—é–±–æ–π: 8999..., +7..., –ø—Ä–æ–±–µ–ª—ã –∏ —Å–∫–æ–±–∫–∏ –Ω–µ –≤–∞–∂–Ω—ã ‚Äî –º—ã –ø—Ä–∏–≤–µ–¥—ë–º –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É.</div>
        </div>
        <div class="form-group">
          <label for="checkout-address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
          <textarea id="checkout-address" rows="3" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥/—ç—Ç–∞–∂/–∫–≤."></textarea>
        </div>
        <div class="form-group">
          <label for="checkout-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
          <textarea id="checkout-comment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç–∞–≤–∫–æ–π, –±–µ–∑ —á–µ—Å–Ω–æ–∫–∞ –∏ —Ç.–ø."></textarea>
        </div>
        <div id="checkout-errors" class="error-text" style="display:none"></div>
      `;
      body.appendChild(checkout);

      // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      el('checkout-phone').value = checkoutState.phone || '';
      el('checkout-address').value = checkoutState.address || '';
      el('checkout-comment').value = checkoutState.comment || '';
      el('checkout-promo').value = checkoutState.promo || '';
      el('checkout-city').value = checkoutState.city || '–ü–µ–Ω–∑–∞';

      el('checkout-phone').addEventListener('input',()=>{ checkoutState.phone = el('checkout-phone').value; saveState(); });
      el('checkout-address').addEventListener('input',()=>{ checkoutState.address = el('checkout-address').value; saveState(); });
      el('checkout-comment').addEventListener('input',()=>{ checkoutState.comment = el('checkout-comment').value; saveState(); });
      el('checkout-promo').addEventListener('input',()=>{ checkoutState.promo = el('checkout-promo').value.trim(); saveState(); });
      el('checkout-city').addEventListener('change',()=>{ checkoutState.city = el('checkout-city').value; saveState(); });

      // –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-primary';
      sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
      sendBtn.onclick = sendOrder;
      body.appendChild(sendBtn);

      // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø—Ä–æ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—ã—Ä—ã)
      if(hasCheeseInCart()){
        const note = document.createElement('div');
        note.className = 'weighing-note';
        note.textContent = '–ö–æ–Ω–µ—á–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è —Å—ã—Ä–æ–≤ –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∞–≤–∫–∏.';
        body.appendChild(note);
      }
    }

    function changeItemQty(index,delta){
      cart[index].qty += delta;
      if(cart[index].qty <= 0) cart.splice(index,1);
      saveState();
      updateCartUI();
      renderCartModal();
    }

    // ============== PRICING / WEIGHT HELPERS ==============
    function hasPrice(p){
      return p.pricePerKg || p.pricePerL || p.pricePerUnit;
    }

    function getPriceText(p){
      if(p.pricePerKg) return `${fmtRub(p.pricePerKg)} / –∫–≥`;
      if(p.pricePerL)  return `${fmtRub(p.pricePerL)} / –ª`;
      if(p.pricePerUnit) return fmtRub(p.pricePerUnit);
      return '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    }

    function approxPieceBadgeText(p){
      if(!p.pricePerKg) return '';
      if(!CHEESE_GROUP_IDS.has(p.group)) return '';
      const rule = VARIANT_RULES[p.id];
      if(!rule || rule.type !== 'fixed') return '';

      const opt = rule.options.find(o=>/—à—Ç/i.test(o) && /(\d+)\s*–≥/i.test(o));
      if(!opt) return '';

      const grams = extractGrams(opt);
      if(!grams) return '';
      let approx = Math.round(p.pricePerKg * grams / 1000);
      let text = `‚âà ${fmtRub(approx)} –∑–∞ 1 —à—Ç`;
      if(p.id.startsWith('halloumi')){
        text += ' (–≤–µ—Å ~200‚Äì250 –≥)';
      }
      return text;
    }

    function getSelectedVariantAndQty(){
      const qty = Math.max(1, parseInt(el('product-qty-input').value) || 1);
      let variant = el('product-variant-select').value || '';
      const prod = currentProduct;

      if(prod && prod.pricePerKg){
        const useCustom = el('use-custom-weight-checkbox').checked;
        const cw = parseInt(el('product-custom-weight').value) || 0;
        if(useCustom && cw > 0){
          const normalized = Math.max(50, Math.round(cw / 50) * 50);
          variant = `${normalized} –≥ (—Å–≤–æ–π –≤–µ—Å)`;
        }
      }

      if(prod && prod.id === 'tvorozhnaya-massa'){
        const flavor = el('tvorog-flavor-select').value;
        if(flavor) variant = `${variant} ‚Ä¢ ${flavor}`;
      }

      return { variant, qty };
    }

    function extractGrams(variant){
      if(!variant) return 0;
      const m = variant.match(/(?:^|\()\s*[~¬±]?\s*(\d+(?:\.\d+)?)\s*(–≥|–∫–≥)\b/i);
      if(!m) return 0;
      const val = parseFloat(m[1]);
      const unit = m[2].toLowerCase();
      return unit === '–∫–≥' ? val * 1000 : val;
    }

    function extractLiters(variant){
      const m = variant && variant.match(/(\d+(?:\.\d+)?)\s*–ª/i);
      return m ? parseFloat(m[1]) : 0;
    }

    function calculatePrice(productId, variant, qty){
      const p = PRODUCTS.find(x=>x.id===productId);
      if(!p) return { basePrice:0, finalPrice:0, discountRate:0 };
      const rule = VARIANT_RULES[productId];
      let base = 0;

      if(rule && rule.type==='fixed' && p.pricePerUnit && !p.pricePerKg && !p.pricePerL){
        base = p.pricePerUnit * qty;
      } else {
        if(p.pricePerKg){
          let grams = extractGrams(variant) || 0;
          base = (grams / 1000) * p.pricePerKg * qty;
        } else if(p.pricePerL){
          const liters = extractLiters(variant) || 0;
          base = liters * p.pricePerL * qty;
        } else if(p.pricePerUnit){
          base = p.pricePerUnit * qty;
        }
      }

      const discountRate = getDiscountRateForProduct(productId);
      const discounted = base * (1 - discountRate);
      return { basePrice: ROUND(base), finalPrice: ROUND(discounted), discountRate };
    }

    function getDiscountRateForProduct(productId){
      const prod = PRODUCTS.find(p=>p.id===productId);
      if(!prod || !CHEESE_GROUP_IDS.has(prod.group)) return 0;

      const totalGr = cart.filter(i=>i.id===productId).reduce((sum,i)=>{
        const grams = extractGrams(i.variant) || 0;
        return sum + grams * i.qty;
      },0);

      let rate = 0;
      for(const t of DISCOUNT_THRESHOLDS){
        if(totalGr >= t.g) rate = t.rate;
      }
      return rate;
    }

    function updateProductModalPrice(){
      if(!currentProduct) return;
      const { variant, qty } = getSelectedVariantAndQty();
      const { finalPrice } = calculatePrice(currentProduct.id, variant, qty);
      el('product-modal-price').textContent = fmtRub(finalPrice);

      // –û–±–Ω–æ–≤–ª—è–µ–º –±–µ–π–¥–∂ "‚âà –∑–∞ 1 —à—Ç" –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
      const pieceBadge = el('piece-badge');
      if(currentProduct.pricePerKg && /—à—Ç/i.test(variant)){
        const grams = extractGrams(variant);
        if(grams > 0){
          let text = `‚âà ${fmtRub(currentProduct.pricePerKg * grams / 1000)} –∑–∞ 1 —à—Ç`;
          if(currentProduct.id.startsWith('halloumi')) text += ' (–≤–µ—Å ~200‚Äì250 –≥)';
          pieceBadge.style.display = 'block';
          pieceBadge.textContent = text;
        }
      }
    }

    function hasCheeseInCart(){
      return cart.some(i=>{
        const p = PRODUCTS.find(x=>x.id===i.id);
        return p && CHEESE_GROUP_IDS.has(p.group);
      });
    }

    // ============== CHECKOUT & ORDER ==============
    function normalizePhone(input){
      if(!input) return '';
      const digits = (''+input).replace(/\D+/g,'');
      if(digits.length===11 && (digits.startsWith('7') || digits.startsWith('8'))) return '+7'+digits.slice(1);
      if(digits.length===10) return '+7'+digits;
      if((''+input).trim().startsWith('+')) return '+'+digits;
      return digits ? '+'+digits : '';
    }

    function getCheckoutData(){
      const phoneRaw = (el('checkout-phone').value || '').trim();
      const phone = normalizePhone(phoneRaw);
      const address = (el('checkout-address').value || '').trim();
      const comment = (el('checkout-comment').value || '').trim();
      const promo = (el('checkout-promo').value || '').trim().toUpperCase();
      const city = el('checkout-city').value || '–ü–µ–Ω–∑–∞';

      checkoutState = { phone:phoneRaw, address, comment, promo, city };
      saveState();
      return { phoneRaw, phone, address, comment, promo, city };
    }

    function validateCheckout(data){
      const errs = [];
      if(!data.phone) errs.push('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏.');
      if(data.address.length < 5) errs.push('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
      return errs;
    }

    function showCheckoutErrors(errors){
      const box = el('checkout-errors');
      if(!errors || errors.length === 0){
        box.style.display = 'none';
        box.textContent = '';
        return;
      }
      box.style.display = 'block';
      box.textContent = errors.join(' ');
    }

    function applyPromo(total, code){
      if(!code) return { total, applied:null };
      const promo = PROMO_CODES[code];
      if(!promo) return { total, applied:null };
      let newTotal = total;
      if(promo.type === 'percent') newTotal = total * (1 - promo.value/100);
      if(promo.type === 'fixed') newTotal = Math.max(0, total - promo.value);
      return { total: ROUND(newTotal), applied: promo };
    }

    function sendOrder(){
      if(cart.length === 0) return;

      const contact = getCheckoutData();
      const errors = validateCheckout(contact);
      if(errors.length){
        showCheckoutErrors(errors);
        window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
        return;
      }
      showCheckoutErrors([]);

      const payload = {
        type:'cart',
        source:'miniapp',
        currency:CURRENCY,
        items:[],
        total:0,
        contact:{
          phone:contact.phone,
          phone_raw:contact.phoneRaw,
          address:contact.address,
          comment:contact.comment,
          promo:contact.promo,
          city:contact.city,
        },
        meta:{ ts:Date.now(), schema_ver:PAYLOAD_SCHEMA_VERSION }
      };

      let grand = 0;
      cart.forEach(i=>{
        const price = calculatePrice(i.id,i.variant,i.qty);
        grand += price.finalPrice;
        payload.items.push({
          id:i.id,
          name:i.name,
          group:i.group,
          variant:i.variant,
          qty:i.qty,
          unit_price_base: price.basePrice / Math.max(i.qty,1),
          discount_rate: price.discountRate,
          unit_price: price.finalPrice / Math.max(i.qty,1),
          line_total: price.finalPrice,
        });
      });

      const promoRes = applyPromo(grand, contact.promo ? contact.promo.toUpperCase() : '');
      payload.total = promoRes.total;
      if(promoRes.applied) payload.promo_applied = promoRes.applied;

      if(window.Telegram?.WebApp){
        const tg = window.Telegram.WebApp;
        payload.telegram = { platform:tg.platform, init_data:!!tg.initData };
        const u = tg.initDataUnsafe?.user;
        if(u){
          payload.telegram.user = {
            id:u.id,
            username:u.username,
            first_name:u.first_name,
            last_name:u.last_name,
          };
        }
      }

      axios.post(`${BACKEND}/order`, payload)
        .then(()=>{
          window.Telegram?.WebApp?.showAlert?.('–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç. –ú—ã —Å–≤—è–∂–µ–º—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
          window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
          cart = [];
          saveState();
          updateCartUI();
          closeCartModal();
          window.Telegram?.WebApp?.close?.();
        })
        .catch(()=>{
          window.Telegram?.WebApp?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
        });
    }

    // ============== HELPERS ==============
    function el(id){ return document.getElementById(id); }

    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // —Å—Ä–∞–∑—É –Ω–∞—Ä–∏—Å—É–µ–º —Ñ–∞–≤–æ—Ä–∏—Ç—ã, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å
    refreshFavoritesBar();
  </script>
</body>
</html>
