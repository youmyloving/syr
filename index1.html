<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–°—ã—Ä–æ–º–∞–Ω–∏—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg-color:#F8EFDA;--text-color:#2E2A23;--hint-color:#8A7F6A;--link-color:#8B5E34;
      --button-color:#8B5E34;--button-text-color:#fff;--secondary-bg-color:#FFF6E7;
      --header-bg-color:#FFF9EF;--section-bg-color:#fff;--border-color:#E7D8BF;
      --error-color:#E74C3C;--success-color:#2E8B57;--font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      --radius-lg:12px
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg-color);color:var(--text-color);font:16px var(--font-family);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    #app{display:flex;flex-direction:column;min-height:100vh}
    header{background:var(--header-bg-color);border-bottom:1px solid var(--border-color);padding:10px;position:sticky;top:0;z-index:3}
    .user-profile{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--secondary-bg-color);display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--hint-color);overflow:hidden}
    .user-avatar img{width:100%;height:100%;object-fit:cover}
    .user-name{font-weight:600}
    .search-container{margin-bottom:10px}
    #search-input{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--secondary-bg-color);color:var(--text-color);font-size:16px}
    .filters-container{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .filters-container select,.filters-container label{font-size:14px}
    #category-filter{padding:8px;border:1px solid var(--border-color);border-radius:10px;background:var(--secondary-bg-color);color:var(--text-color);flex-grow:1}
    #only-cheese-toggle,#favorites-toggle{display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap}
    main{flex-grow:1;padding:10px;padding-bottom:100px}
    .section{margin-bottom:20px}
    .section-title{font-size:17px;font-weight:800;margin:10px 0 8px;opacity:.95}
    .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}
    .product-card{border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:12px;background:var(--section-bg-color);cursor:pointer;display:flex;flex-direction:column;transition:transform .18s ease,box-shadow .18s ease}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .product-thumb{width:100%;height:110px;border-radius:10px;background:var(--secondary-bg-color);display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px}
    .product-thumb img{width:100%;height:100%;object-fit:cover}
    .product-ico{font-size:40px}
    .product-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .name{font-weight:700;font-size:14px;margin-bottom:6px;min-height:36px}
    .price{color:var(--hint-color);font-size:13px}
    .badge-piece{font-size:11px;color:#6b5c48;background:#F4E8D3;border:1px dashed #d9c6a6;padding:2px 6px;border-radius:8px;margin-left:auto}
    .fav-btn{background:none;border:none;cursor:pointer;font-size:18px;color:#c78f5b}
    .fav-btn.active{color:#8B5E34}
    .favorites-bar{display:flex;gap:8px;overflow:auto;padding:6px 0}
    .fav-chip{background:#fff;border:1px solid var(--border-color);border-radius:14px;padding:6px 10px;font-size:13px;white-space:nowrap;cursor:pointer}
    .cart-footer{position:sticky;bottom:0;background:var(--header-bg-color);border-top:1px solid var(--border-color);padding:10px;display:flex;justify-content:center;align-items:center;z-index:2}
    #open-cart-btn{background:var(--button-color);color:var(--button-text-color);padding:12px 24px;border-radius:24px;cursor:pointer;border:none;font-size:16px;font-weight:700;width:100%;max-width:520px;transition:filter .2s}
    #open-cart-btn:hover{filter:brightness(108%)}
    #open-cart-btn:disabled{background:var(--hint-color);cursor:not-allowed}
    dialog{border:1px solid var(--border-color);border-radius:var(--radius-lg);padding:0;background:var(--section-bg-color);color:var(--text-color);width:92vw;max-width:520px;max-height:86vh;overflow:hidden;box-shadow:0 12px 30px rgba(0,0,0,.18)}
    dialog::backdrop{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
    .modal-header{padding:14px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;background:var(--header-bg-color);position:sticky;top:0;z-index:1}
    .modal-header h2{margin:0;font-size:18px}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--hint-color);padding:0;line-height:1;border-radius:50%;width:32px;height:32px;display:grid;place-items:center}
    .modal-close:hover{background:var(--secondary-bg-color)}
    .modal-body{padding:14px 16px;overflow-y:auto;max-height:70vh}
    .form-group{margin-bottom:12px}
    .form-group label{display:block;margin-bottom:6px;font-size:14px;font-weight:600}
    .form-group select,.form-group input,.form-group textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--secondary-bg-color);color:var(--text-color);font-size:16px}
    .form-row{display:flex;gap:10px}.form-row .form-group{flex:1}
    .product-desc{color:var(--hint-color);font-size:13px;margin:6px 0 10px}
    .price-display{font-size:18px;font-weight:800;text-align:center;margin:12px 0}
    .btn{padding:12px 20px;border:none;border-radius:10px;font-size:16px;font-weight:800;cursor:pointer;width:100%;transition:transform .08s,filter .18s}
    .btn:active{transform:scale(.98)}
    .btn-primary{background:var(--button-color);color:var(--button-text-color)}
    .btn-primary:hover{filter:brightness(108%)}
    .btn-secondary{background:var(--secondary-bg-color);color:var(--text-color);border:1px solid var(--border-color)}
    .btn-secondary:hover{background:#fdeed6}
    .cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border-color)}
    .cart-item:last-child{border-bottom:none}
    .cart-item-info{flex-grow:1;padding-right:10px}
    .cart-item-name{font-weight:800}
    .cart-item-variant{font-size:13px;color:var(--hint-color)}
    .cart-item-price{font-size:14px}
    .discount-hint{color:var(--success-color);font-size:12px;margin-top:4px}
    .qty-control{display:flex;align-items:center;border:1px solid var(--border-color);border-radius:10px;overflow:hidden}
    .qty-control button{background:none;border:none;width:32px;height:32px;cursor:pointer;font-size:18px;color:var(--text-color);display:grid;place-items:center}
    .qty-control button:hover{background:var(--secondary-bg-color)}
    .qty-control span{padding:0 10px;min-width:30px;text-align:center}
    .cart-summary{margin-top:16px;padding-top:12px;border-top:2px solid var(--border-color);font-size:18px;font-weight:900;text-align:right}
    .notice{font-size:12px;color:var(--hint-color)}
    .error-text{color:var(--error-color);font-size:13px;margin-top:6px}
    .weighing-note{font-size:12px;color:#8b5e34;background:#fff2df;border:1px dashed #e9cda7;border-radius:10px;padding:8px 10px;margin-top:8px;text-align:right}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>
      <div class="search-container">
        <input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." />
      </div>
      <div class="filters-container">
        <select id="category-filter"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
        <label id="only-cheese-toggle"><input type="checkbox" id="only-cheese-checkbox"/><span>–¢–æ–ª—å–∫–æ —Å—ã—Ä—ã</span></label>
        <label id="favorites-toggle"><input type="checkbox" id="only-fav-checkbox"/><span>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span></label>
      </div>
      <div class="favorites-bar" id="favorites-bar" style="display:none"></div>
    </header>

    <main id="main"></main>

    <footer class="cart-footer">
      <button id="open-cart-btn" disabled>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</button>
    </footer>
  </div>

  <!-- Product modal -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title"></h2>
      <button class="modal-close" onclick="closeProductModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="product-desc" id="product-modal-description"></div>

      <div class="form-group">
        <label for="product-variant-select">–í–∞—Ä–∏–∞–Ω—Ç</label>
        <select id="product-variant-select"></select>
        <div class="notice" id="piece-badge" style="display:none;margin-top:6px"></div>
      </div>

      <!-- –í–ö–õ–Æ–ß–ò–¢–¨ –°–í–û–ô –í–ï–° -->
      <div class="form-group" id="custom-weight-toggle-row" style="display:none">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="use-custom-weight-checkbox" />
          <span>–í—ã–±—Ä–∞—Ç—å —Å–≤–æ–π –≤–µ—Å</span>
        </label>
        <div class="notice">–î–æ—Å—Ç—É–ø–Ω–æ –¥–∞–∂–µ –¥–ª—è ¬´1 —à—Ç¬ª ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –ø–æ —Ü–µ–Ω–µ –∑–∞ –∫–≥.</div>
      </div>

      <div class="form-row" id="custom-weight-row" style="display:none">
        <div class="form-group">
          <label for="product-custom-weight">–°–≤–æ–π –≤–µ—Å (–≥—Ä–∞–º–º—ã)</label>
          <input type="number" id="product-custom-weight" min="10" step="10" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 350" />
          <div class="notice">–¶–µ–Ω–∞ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</div>
        </div>
        <div class="form-group">
          <label for="product-qty-input">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input type="number" id="product-qty-input" value="1" min="1" />
        </div>
      </div>

      <!-- –î–æ–ø. –æ–ø—Ü–∏–∏ (–í–∫—É—Å) -->
      <div class="form-group" id="extra-option-group" style="display:none">
        <label for="extra-option-select" id="extra-option-label">–í—ã–±—Ä–∞—Ç—å –æ–ø—Ü–∏—é</label>
        <select id="extra-option-select"></select>
      </div>

      <div class="price-display" id="product-modal-price">0 ‚ÇΩ</div>
      <button class="btn btn-primary" id="add-to-cart-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </dialog>

  <!-- Cart + checkout modal -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <button class="modal-close" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="modal-body" id="cart-modal-body"></div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
  // ===== CONFIG =====
  const BACKEND = 'https://puzzlebot-webhook-handler1.onrender.com';
  const CURRENCY = 'RUB';
  const ROUND = Math.round;
  const DISCOUNT_THRESHOLDS = [ { g:1000, rate:0.15 }, { g:700, rate:0.10 }, { g:500, rate:0.05 } ];
  const ONLY_CHEESE_FILTER_DEFAULT = false;
  const PAYLOAD_SCHEMA_VERSION = 'v2';
  const STORAGE_CART_KEY = 'syromania-cart';
  const STORAGE_CHECKOUT_KEY = 'syromania-checkout';
  const STORAGE_FAV_KEY = 'syromania-favorites';
  const fmtRub = (n)=> new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' ‚ÇΩ';

  // –ü—Ä–æ–º–æ–∫–æ–¥—ã (–ø—Ä–∏–º–µ—Ä): —Ö—Ä–∞–Ω–∏—Ç—å –ª—É—á—à–µ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ, –Ω–æ –º–æ–∂–Ω–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ.
  const PROMO_CODES = {
    // 'SYR5': { type:'percent', value:5, note:'–°–∫–∏–¥–∫–∞ 5%' },
    // 'HELLOSYR': { type:'fixed', value:100, note:'-100 ‚ÇΩ' },
  };

  // ===== GROUPS =====
  const GROUPS = [
    { id:'brined',   title:'–†–∞—Å—Å–æ–ª—å–Ω—ã–µ —Å—ã—Ä—ã' },
    { id:'soft',     title:'–ú—è–≥–∫–∏–µ —Å—ã—Ä—ã' },
    { id:'hard',     title:'–¢–≤—ë—Ä–¥—ã–µ —Å—ã—Ä—ã' },
    { id:'rolls',    title:'–°—ã—Ä–Ω—ã–µ —Ä—É–ª–µ—Ç—ã' },
    { id:'dairy',    title:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è' },
    { id:'sweets',   title:'–°–ª–∞–¥–æ—Å—Ç–∏' },
    { id:'bakery',   title:'–í—ã–ø–µ—á–∫–∞' },
  ];
  const CHEESE_GROUP_IDS = new Set(['brined','soft','hard','rolls']);

  // ===== DATA =====
  // –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ü–µ–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏—è –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const PRODUCTS = [
    // -------- –°–´–†–´ (–†–∞—Å—Å–æ–ª—å–Ω—ã–µ) --------
    { id:'mozzarella', name:'–ú–æ—Ü–∞—Ä–µ–ª–ª–∞', group:'brined', pricePerKg:2000, ico:'üßÄ',
      description:'–ù–µ–∂–Ω–∞—è –º–æ—Ü–∞—Ä–µ–ª–ª–∞. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è: 3‚Äì5 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/mozzarella.webp' },
    { id:'buratta', name:'–ë—É—Ä–∞—Ç—Ç–∞', group:'brined', pricePerKg:2100, ico:'üßÄ',
      description:'–ú–µ—à–æ—á–µ–∫ –∏–∑ –º–æ—Ü–∞—Ä–µ–ª–ª—ã —Å –Ω–∞—á–∏–Ω–∫–æ–π –∏–∑ —Å—Ç—Ä–∞—á–∞—Ç–µ–ª–ª—ã. –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/mozzarella-2.webp' },
    { id:'stracciatella', name:'–°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞', group:'brined', pricePerKg:2150, ico:'üßÄ',
      description:'–ù–∏—Ç–∏ –º–æ—Ü–∞—Ä–µ–ª–ª—ã –≤ —Å–ª–∏–≤–∫–∞—Ö. –°—Ä–æ–∫: 5‚Äì7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3832-6430-4462-b663-353438383930/stracciatella.webp' },
    { id:'ricotta', name:'–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞)', group:'soft', pricePerKg:1400, ico:'ü•õ',
      description:'–ù–µ–∂–Ω—ã–π —Å—ã—Ä –¥–ª—è –±—É—Ç–µ—Ä–±—Ä–æ–¥–æ–≤ –∏ –±–ª—é–¥. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'ricotta-herbs', name:'–†–∏–∫–æ—Ç—Ç–∞ —Å —É–∫—Ä–æ–ø–æ–º –∏ –∑–µ–ª–µ–Ω—å—é', group:'soft', pricePerKg:1500, ico:'üåø',
      description:'–°–≤–µ–∂–∏–π, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤–∫—É—Å. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'caciotta', name:'–ö–∞—á–æ—Ç—Ç–∞', group:'soft', pricePerKg:2200, ico:'üßÄ',
      description:'–ú—è–≥–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Å—ã—Ä. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6165-3265-4834-a236-366661346562/caciotta.webp' },
    { id:'caciotta-fenugreek', name:'–ö–∞—á–æ—Ç—Ç–∞ —Å –ø–∞–∂–∏—Ç–Ω–∏–∫–æ–º', group:'soft', pricePerKg:2250, ico:'üåø',
      description:'–° –æ—Ä–µ—Ö–æ–≤—ã–º –ø—Ä–∏–≤–∫—É—Å–æ–º –ø–∞–∂–∏—Ç–Ω–∏–∫–∞. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'hard-village', name:'–¢–≤—ë—Ä–¥—ã–π –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏', group:'hard', pricePerKg:1600, ico:'üßÄ',
      description:'–ò–∑ —Ç–≤–æ—Ä–æ–≥–∞ —Å –ø—Ä–∏–ø—Ä–∞–≤–∞–º–∏, –æ–±–∂–∞—Ä–∏–≤–∞–µ—Ç—Å—è. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/hard-village.webp' },
    { id:'hard-smoked', name:'–¢–≤—ë—Ä–¥—ã–π –∫–æ–ø—á—ë–Ω—ã–π', group:'hard', pricePerKg:1800, ico:'üí®',
      description:'–û–±–∂–∞—Ä–µ–Ω –∏ –∫–æ–ø—á—ë–Ω, –Ω–µ–∂–Ω–∞—è –∫–æ–ø—á—ë–Ω–æ—Å—Ç—å. –°—Ä–æ–∫: –¥–æ 30 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6662-3930-4663-b132-316135626136/hard-smoked.webp' },
    { id:'rolls-olives-walnut', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–º–∞—Å–ª–∏–Ω—ã, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', group:'rolls', pricePerKg:1700, ico:'ü•ú',
      description:'–ó–∞–∫—É—Å–∫–∞ –∫ –ª—é–±–æ–º—É —Å—Ç–æ–ª—É. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-olives-walnut.webp' },
    { id:'rolls-apricot-cedar', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–∫—É—Ä–∞–≥–∞, –∫–µ–¥—Ä–æ–≤—ã–π –æ—Ä–µ—Ö)', group:'rolls', pricePerKg:1700, ico:'üçë',
      description:'–°–ª–µ–≥–∫–∞ —Å–ª–∞–¥–∫–æ–≤–∞—Ç—ã–π –≤–∫—É—Å. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-apricot-cedar.webp' },

    // –ê–¥—ã–≥–µ–π—Å–∫–∏–µ (–ø–∞–Ω–∏—Ä)
    { id:'panir-classic', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π (–ø–∞–Ω–∏—Ä) –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'soft', pricePerKg:1450, ico:'üßÄ',
      description:'–û—á–µ–Ω—å –Ω–µ–∂–Ω—ã–π, –º–æ–ª–æ—á–Ω—ã–π –≤–∫—É—Å. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-classic.webp' },
    { id:'panir-herbs', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π —Å –∑–µ–ª–µ–Ω—å—é (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1600, ico:'üåø',
      description:'–õ—ë–≥–∫–∏–π –∏ —Å–≤–µ–∂–∏–π. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-herbs.webp' },
    { id:'panir-spicy', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π —Å–æ —Å–ø–µ—Ü–∏—è–º–∏ (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1650, ico:'üå∂Ô∏è',
      description:'–ê—Ä–æ–º–∞—Ç–Ω—ã–π, –±–µ–∑ –æ—Å—Ç—Ä–æ—Ç—ã. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-spicy.webp' },
    { id:'panir-smoked', name:'–ê–¥—ã–≥–µ–π—Å–∫–∏–π –∫–æ–ø—á—ë–Ω—ã–π (–ø–∞–Ω–∏—Ä)', group:'soft', pricePerKg:1700, ico:'üí®',
      description:'–ì–∞—Ä–º–æ–Ω–∏—á–Ω–∞—è –∫–æ–ø—á—ë–Ω–æ—Å—Ç—å. –°—Ä–æ–∫: 30 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-smoked.webp' },

    // –°—É–ª—É–≥—É–Ω–∏ / –ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π / –•–∞–ª–ª—É–º–∏ / –ö–æ—Å–∏—á–∫–∞
    { id:'suluguni', name:'–°—É–ª—É–≥—É–Ω–∏', group:'brined', pricePerKg:1700, ico:'üßÄ',
      description:'–°–ª–æ–∏—Å—Ç—ã–π, —ç–ª–∞—Å—Ç–∏—á–Ω—ã–π. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3238-3866-4366-a436-623236363261/suluguni.webp' },
    { id:'suluguni-smoked', name:'–°—É–ª—É–≥—É–Ω–∏ –∫–æ–ø—á—ë–Ω—ã–π', group:'brined', pricePerKg:1800, ico:'üí®',
      description:'–° –ª—ë–≥–∫–æ–π –∫–æ–ø—á—ë–Ω–æ—Å—Ç—å—é. –°—Ä–æ–∫: 30 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6435-3838-4463-b431-353765323333/suluguni-smoked.webp' },
    { id:'imeretian', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π', group:'brined', pricePerKg:1500, ico:'üßÄ',
      description:'–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π —Ä–∞—Å—Å–æ–ª—å–Ω—ã–π —Å—ã—Ä. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/imeretian.webp' },
    { id:'imeretian-dill-garlic', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π —Å —É–∫—Ä–æ–ø–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º', group:'brined', pricePerKg:1600, ico:'üßÑ',
      description:'–ê—Ä–æ–º–∞—Ç –∑–µ–ª–µ–Ω–∏ –∏ —á–µ—Å–Ω–æ–∫–∞. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'halloumi', name:'–•–∞–ª–ª—É–º–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)', group:'brined', pricePerKg:1950, ico:'üî•',
      description:'–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –∂–∞—Ä–∫–∏ –∏–ª–∏ –±–µ–∑ –Ω–µ—ë. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3161-6362-4130-b134-623331346238/halloumi.webp' },
    { id:'halloumi-paprika-oregano', name:'–•–∞–ª–ª—É–º–∏ —Å –ø–∞–ø—Ä–∏–∫–æ–π –∏ –æ—Ä–µ–≥–∞–Ω–æ', group:'brined', pricePerKg:2100, ico:'üå∂Ô∏è',
      description:'–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏–µ –Ω–æ—Ç–∫–∏. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3133-6165-4134-b335-396662633262/halloumi-paprika-ore.webp' },
    { id:'halloumi-tomato-basil-garlic', name:'–•–∞–ª–ª—É–º–∏ —Ç–æ–º–∞—Ç-–±–∞–∑–∏–ª–∏–∫-—á–µ—Å–Ω–æ–∫', group:'brined', pricePerKg:2100, ico:'üçÖ',
      description:'–û—Ç–ª–∏—á–µ–Ω –¥–ª—è –∂–∞—Ä–∫–∏. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/halloumi-tomato-basil-garlic.webp' },
    { id:'halloumi-tomato-paprika', name:'–•–∞–ª–ª—É–º–∏ —Å –≤—è–ª–µ–Ω—ã–º–∏ –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ –∏ –ø–∞–ø—Ä–∏–∫–æ–π', group:'brined', pricePerKg:2100, ico:'üçÖ',
      description:'–Ø—Ä–∫–∏–π –≤–∫—É—Å, —Ö–æ—Ä–æ—à–æ –∂–∞—Ä–∏—Ç—Å—è. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3863-3030-4439-a439-653238303862/halloumi-tomato-papr.webp' },
    { id:'kosichka', name:'–ö–æ—Å–∏—á–∫–∞ (1 —à—Ç ~200 –≥)', group:'brined', pricePerKg:1900, ico:'ü•®',
      description:'–°–ª–µ–≥–∫–∞ —Å–æ–ª—ë–Ω–∞—è, –ø–æ–¥—Ö–æ–¥–∏—Ç –∫–æ –≤—Å–µ–º—É. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'kosichka-smoked', name:'–ö–æ—Å–∏—á–∫–∞ –∫–æ–ø—á—ë–Ω–∞—è (1 —à—Ç ~200 –≥)', group:'brined', pricePerKg:2000, ico:'üí®',
      description:'–•–æ–ª–æ–¥–Ω–æ–µ –∫–æ–ø—á–µ–Ω–∏–µ. –°—Ä–æ–∫: 30 —Å—É—Ç–æ–∫.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/kosichka-smoked.webp' },
    { id:'spicy-klubok', name:'–ü—Ä—è–Ω—ã–µ –∫–ª—É–±–æ—á–∫–∏ (1 —à—Ç ~150 –≥)', group:'brined', pricePerKg:1950, ico:'üå∂Ô∏è',
      description:'–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∫—É—Å, —É–º–µ—Ä–µ–Ω–Ω–∞—è —Å–æ–ª—å. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3463-6166-4665-a439-323264653939/spicy-klubok.webp' },

    // -------- –ú–û–õ–û–ß–ö–ê --------
    { id:'milk', name:'–ú–æ–ª–æ–∫–æ', group:'dairy', pricePerL:150, ico:'ü•õ',
      description:'–ú–æ–ª–æ–∫–æ –æ—Ç–±–æ—Ä–Ω–æ–µ, –æ—Ö–ª–∞–∂–¥—ë–Ω–Ω–æ–µ. –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫.' },
    { id:'milk-topped', name:'–ú–æ–ª–æ–∫–æ —Ç–æ–ø–ª—ë–Ω–æ–µ', group:'dairy', pricePerL:250, ico:'ü•õ',
      description:'–¶–µ–ª—å–Ω–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ, –≥—É—Å—Ç–æ–≤–∞—Ç–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü–∏—è. –°—Ä–æ–∫: 5‚Äì7 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3839-3163-4066-a633-306366346631/milk-topped.webp' },
    { id:'yogurt', name:'–ô–æ–≥—É—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'dairy', pricePerL:260, ico:'ü•õ',
      description:'–¢–æ–ª—å–∫–æ –º–æ–ª–æ–∫–æ –∏ –∑–∞–∫–≤–∞—Å–∫–∞. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.' },
    { id:'ryazhenka', name:'–†—è–∂–µ–Ω–∫–∞', group:'dairy', pricePerL:280, ico:'ü•õ',
      description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Ä—è–∂–µ–Ω–∫–∞. –°—Ä–æ–∫: –¥–æ 5 —Å—É—Ç–æ–∫.' },
    { id:'misti-dahi', name:'–ú–∏—Å—Ç—Ö–∏-–î–∞—Ö–∏', group:'dairy', pricePerL:300, ico:'ü•õ',
      description:'–ö–∏—Å–ª–æ–º–æ–ª–æ—á–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.' },
    { id:'whey', name:'–°—ã–≤–æ—Ä–æ—Ç–∫–∞', group:'dairy', pricePerL:60, ico:'üíß',
      description:'–ù–∏–∑–∫–æ–∫–∞–ª–æ—Ä–∏–π–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç. –°—Ä–æ–∫: 3 —Å—É—Ç–æ–∫.' },
    { id:'cream', name:'–°–ª–∏–≤–∫–∏ (33‚Äì36%)', group:'dairy', pricePerL:1450, ico:'ü•õ',
      description:'–°–≤–µ–∂–∏–µ —Å–ª–∏–≤–∫–∏, –Ω–∞ 3‚Äì4 —Å—É—Ç–∫–∏ –º–æ–≥—É—Ç —Å—Ç–∞—Ç—å —Å–º–µ—Ç–∞–Ω–æ–π. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild3163-3665-4636-a537-303830323163/cream.webp' },
    { id:'tvorog', name:'–¢–≤–æ—Ä–æ–≥', group:'dairy', pricePerKg:700, ico:'ü•õ',
      description:'–ù–µ–∂–Ω—ã–π, –∑–µ—Ä–Ω–∏—Å—Ç–æ—Å—Ç—å ¬´–∫–∞–∫ –Ω–∞–¥–æ¬ª. –°—Ä–æ–∫: 3‚Äì5 —Å—É—Ç–æ–∫, –≤—ã–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–º–æ—Ä–æ–∑–∫—É.', img:'https://static.tildacdn.com/tild3136-3730-4134-b466-613138343764/tvorog.webp' },
    { id:'butter', name:'–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ (—à–∞—Ä ~200 –≥)', group:'dairy', pricePerKg:2100, ico:'üßà',
      description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ, –≤—Ä—É—á–Ω—É—é. –°—Ä–æ–∫: –¥–æ 180 —Å—É—Ç–æ–∫ –ø—Ä–∏ ‚â§ +15 ¬∞C.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/butter.webp' },
    { id:'ghee', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ (–ì–•–ò)', group:'dairy', pricePerKg:2900, ico:'üßà',
      description:'~99% –º–æ–ª–æ—á–Ω—ã–π –∂–∏—Ä, –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –∂–∞—Ä–∫–∏. –°—Ä–æ–∫: >10 –ª–µ—Ç.' },
    { id:'condensed-milk', name:'–°–≥—É—â–µ–Ω–∫–∞', group:'dairy', pricePerKg:1000, ico:'ü•õ',
      description:'–ú–æ–ª–æ–∫–æ + —Ç—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä. –°—Ä–æ–∫: 7 —Å—É—Ç–æ–∫.' },
    { id:'tvorozhnaya-massa', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞', group:'dairy', pricePerKg:850, ico:'ü•õ',
      description:'–¢–≤–æ—Ä–æ–≥, —Å–ª–∏–≤–∫–∏, —Ç—Ä–æ—Å—Ç–Ω–∏–∫–æ–≤—ã–π —Å–∞—Ö–∞—Ä + –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ–ª–∏. –°—Ä–æ–∫: 5 —Å—É—Ç–æ–∫.', img:'https://static.tildacdn.com/tild6630-3237-4430-b461-313634376333/tvorozhnaya-massa_.webp' },

    // -------- –°–õ–ê–î–û–°–¢–ò --------
    { id:'sandesh-orange', name:'–°–∞–Ω–¥–µ—à (–∞–ø–µ–ª—å—Å–∏–Ω)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
      description:'–ú–æ–ª–æ–∫–æ, —Å–∞—Ö–∞—Ä, —Ü–µ–¥—Ä–∞ –∞–ø–µ–ª—å—Å–∏–Ω–∞. 5 —à—Ç.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-orange.webp' },
    { id:'sandesh-walnut', name:'–°–∞–Ω–¥–µ—à (–≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
      description:'–ú–æ–ª–æ–∫–æ, —Å–∞—Ö–∞—Ä, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö. 5 —à—Ç.', img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-walnut.webp' },
    { id:'sandesh-carob', name:'–°–∞–Ω–¥–µ—à (–∫—ç—Ä–æ–±)', group:'sweets', pricePerUnit:300, ico:'üçÆ',
      description:'–ú–æ–ª–æ–∫–æ, —Å–∞—Ö–∞—Ä, –∫—ç—Ä–æ–±, –∫–æ–∫–æ—Å. 5 —à—Ç.' },
    { id:'barfi-classic', name:'–ë—É—Ä—Ñ–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', group:'sweets', pricePerUnit:350, ico:'üçÆ',
      description:'5 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.', img:'https://static.tildacdn.com/tild3430-3231-4562-b164-366638313434/barfi-classic.webp' },
    { id:'barfi-hazelnut', name:'–ë—É—Ä—Ñ–∏ —Ñ—É–Ω–¥—É–∫', group:'sweets', pricePerUnit:350, ico:'üçÆ',
      description:'5 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.', img:'https://static.tildacdn.com/tild3065-3332-4466-a536-353130343264/barfi-hazelnut.webp' },
    { id:'barfi-sesame', name:'–ë—É—Ä—Ñ–∏ –∫—É–Ω–∂—É—Ç–Ω—ã–π', group:'sweets', pricePerUnit:490, ico:'üçÆ',
      description:'7 —à—Ç –≤ –Ω–∞–±–æ—Ä–µ.' },
    { id:'halva', name:'–•–∞–ª–≤–∞', group:'sweets', pricePerUnit:200, ico:'üçÆ',
      description:'–°–µ–º–µ—á–∫–∏, –º–∞—Å–ª–æ, –≤–æ–¥–∞, —Å–∞—Ö–∞—Ä. 0.2 –∫–≥.' },
    { id:'potato-cake-5', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª (5 —à—Ç)', group:'sweets', pricePerUnit:400, ico:'üç∞',
      description:'–¶/–∑ –º—É–∫–∞ –∏ –¥–æ–º–∞—à–Ω—è—è —Å–≥—É—â—ë–Ω–∫–∞.', img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },
    { id:'potato-cake-2', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª (2 —à—Ç)', group:'sweets', pricePerUnit:190, ico:'üç∞',
      description:'–¶/–∑ –º—É–∫–∞ –∏ –¥–æ–º–∞—à–Ω—è—è —Å–≥—É—â—ë–Ω–∫–∞.', img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },

    // -------- –í–´–ü–ï–ß–ö–ê --------
    { id:'cookies-nut', name:'–û—Ä–µ—Ö–æ–≤—ã–µ –ø–∞–ª—å—á–∏–∫–∏', group:'bakery', pricePerKg:700, ico:'üç™',
      description:'–•—Ä—É—Å—Ç—è—â–∏–µ –æ—Ä–µ—Ö–∏.', img:'https://static.tildacdn.com/tild3035-6230-4434-b363-303434366630/cookies-nut.webp' },
    { id:'muffin-plain', name:'–ö–µ–∫—Å—ã –æ–±—ã—á–Ω—ã–µ', group:'bakery', pricePerKg:500, ico:'üßÅ',
      description:'–ü—Ä–æ—Å—Ç—ã–µ –∏ –≤–∫—É—Å–Ω—ã–µ.' },
    { id:'muffin-carob', name:'–ö–µ–∫—Å—ã –∫—ç—Ä–æ–±–æ–≤—ã–µ', group:'bakery', pricePerKg:550, ico:'üßÅ',
      description:'–° –∫—ç—Ä–æ–±–æ–º.' },
    { id:'muffin-raisin', name:'–ö–µ–∫—Å—ã –∏–∑—é–º', group:'bakery', pricePerKg:550, ico:'üßÅ',
      description:'–° –∏–∑—é–º–æ–º.', img:'https://static.tildacdn.com/tild3465-3162-4436-a235-363763383339/muffin-raisin.webp' },
    { id:'bliny-10', name:'–ë–ª–∏–Ω—ã (10 —à—Ç)', group:'bakery', pricePerUnit:330, ico:'ü•û',
      description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –±–ª–∏–Ω—ã.' },
    { id:'bliny-5', name:'–ë–ª–∏–Ω—ã (5 —à—Ç)', group:'bakery', pricePerUnit:220, ico:'ü•û',
      description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –±–ª–∏–Ω—ã.' },
    { id:'bliny-tvorog-5', name:'–ë–ª–∏–Ω—ã —Ç–≤–æ—Ä–æ–≥/—Ç–≤–æ—Ä–æ–≥-–∏–∑—é–º (5 —à—Ç)', group:'bakery', pricePerUnit:300, ico:'ü•û',
      description:'–° –Ω–∞—á–∏–Ω–∫–æ–π –∏–∑ —Ç–≤–æ—Ä–æ–≥–∞.' },
    { id:'syrniki-10', name:'–°—ã—Ä–Ω–∏–∫–∏ (10 —à—Ç)', group:'bakery', pricePerUnit:520, ico:'ü•û',
      description:'–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏.' },
    { id:'syrniki-5', name:'–°—ã—Ä–Ω–∏–∫–∏ (5 —à—Ç)', group:'bakery', pricePerUnit:280, ico:'ü•û',
      description:'–î–æ–º–∞—à–Ω–∏–µ —Å—ã—Ä–Ω–∏–∫–∏.' },
    { id:'chapati-10', name:'–ß–∞–ø–∞—Ç–∏ (10 —à—Ç)', group:'bakery', pricePerUnit:270, ico:'ü´ì',
      description:'–ü—à–µ–Ω–∏—á–Ω–∞—è/—Ä–∂–∞–Ω–∞—è –º—É–∫–∞, –≤–æ–¥–∞, —Å–æ–ª—å, –º–∞—Å–ª–æ.', img:'https://static.tildacdn.com/tild6332-6239-4538-b839-356132356236/chapati-10.webp' },
    { id:'chapati-wholewheat-10', name:'–ß–∞–ø–∞—Ç–∏ (—Ü/–∑ –º—É–∫–∞) (10 —à—Ç)', group:'bakery', pricePerUnit:320, ico:'ü´ì',
      description:'–¶–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–∞—è –º—É–∫–∞.' },
  ];

  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–í–∫—É—Å¬ª)
  const EXTRA_OPTIONS = {
    'tvorozhnaya-massa': { label:'–í—ã–±—Ä–∞—Ç—å –≤–∫—É—Å', options:['–ò–∑—é–º','–§–∏–Ω–∏–∫','–ß–µ—Ä–Ω–æ—Å–ª–∏–≤','–ö—É—Ä–∞–≥–∞'] },
  };

  // –í–∞—Ä–∏–∞–Ω—Ç—ã
  const VARIANT_RULES = {
    // –†–∞—Å—Å–æ–ª—å–Ω—ã–µ/–º—è–≥–∫–∏–µ/—Ç–≤—ë—Ä–¥—ã–µ
    'mozzarella':{ type:'fixed', options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)'] },
    'buratta':{ type:'fixed', options:['1 —à—Ç (250 –≥)'] },
    'stracciatella':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','500 –≥'] },
    'ricotta':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','450 –≥'] },
    'ricotta-herbs':{ type:'fixed', options:['200 –≥','250 –≥','300 –≥','450 –≥'] },
    'caciotta':{ type:'weight', unit:'–≥', step:50, min:200, max:1500 },
    'caciotta-fenugreek':{ type:'weight', unit:'–≥', step:50, min:200, max:1500 },
    'hard-village':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
    'hard-smoked':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
    'rolls-olives-walnut':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },
    'rolls-apricot-cedar':{ type:'weight', unit:'–≥', step:50, min:100, max:2000 },

    'panir-classic':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
    'panir-herbs':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
    'panir-spicy':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },
    'panir-smoked':{ type:'fixed', options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥'] },

    'suluguni':{ type:'weight', unit:'–≥', step:100, min:100, max:2000 },
    'suluguni-smoked':{ type:'weight', unit:'–≥', step:100, min:100, max:2000 },
    'imeretian':{ type:'weight', unit:'–≥', step:100, min:100, max:2000 },
    'imeretian-dill-garlic':{ type:'weight', unit:'–≥', step:100, min:100, max:2000 },

    'halloumi':{ type:'fixed', options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)'] },
    'halloumi-paprika-oregano':{ type:'fixed', options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)'] },
    'halloumi-tomato-basil-garlic':{ type:'fixed', options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)'] },
    'halloumi-tomato-paprika':{ type:'fixed', options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)'] },

    'kosichka':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
    'kosichka-smoked':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
    'spicy-klubok':{ type:'fixed', options:['1 —à—Ç (150 –≥)'] },

    // –ú–æ–ª–æ—á–∫–∞
    'milk':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
    'milk-topped':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
    'yogurt':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
    'ryazhenka':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
    'misti-dahi':{ type:'fixed', options:['0.5 –ª','1 –ª'] },
    'whey':{ type:'fixed', options:['1 –ª'] },
    'cream':{ type:'fixed', options:['0.2 –ª','0.5 –ª','1 –ª'] },
    'tvorog':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
    'butter':{ type:'fixed', options:['1 —à—Ç (200 –≥)'] },
    'ghee':{ type:'fixed', options:['200 –≥','500 –≥','1000 –≥'] },
    'condensed-milk':{ type:'weight', unit:'–≥', step:100, min:200, max:2000 },
    'tvorozhnaya-massa':{ type:'weight', unit:'–≥', step:100, min:200, max:2000 },

    // –°–ª–∞–¥–æ—Å—Ç–∏/–≤—ã–ø–µ—á–∫–∞
    'sandesh-orange':{ type:'fixed', options:['5 —à—Ç'] },
    'sandesh-walnut':{ type:'fixed', options:['5 —à—Ç'] },
    'sandesh-carob':{ type:'fixed', options:['5 —à—Ç'] },
    'barfi-classic':{ type:'fixed', options:['5 —à—Ç'] },
    'barfi-hazelnut':{ type:'fixed', options:['5 —à—Ç'] },
    'barfi-sesame':{ type:'fixed', options:['7 —à—Ç'] },
    'halva':{ type:'fixed', options:['0.2 –∫–≥'] },
    'potato-cake-5':{ type:'fixed', options:['5 —à—Ç'] },
    'potato-cake-2':{ type:'fixed', options:['2 —à—Ç'] },

    'cookies-nut':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
    'muffin-plain':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
    'muffin-carob':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },
    'muffin-raisin':{ type:'weight', unit:'–≥', step:250, min:250, max:2000 },

    'bliny-10':{ type:'fixed', options:['10 —à—Ç'] },
    'bliny-5':{ type:'fixed', options:['5 —à—Ç'] },
    'bliny-tvorog-5':{ type:'fixed', options:['5 —à—Ç'] },
    'syrniki-10':{ type:'fixed', options:['10 —à—Ç'] },
    'syrniki-5':{ type:'fixed', options:['5 —à—Ç'] },

    'chapati-10':{ type:'fixed', options:['10 —à—Ç'] },
    'chapati-wholewheat-10':{ type:'fixed', options:['10 —à—Ç'] },
  };

  // ===== STATE =====
  let cart = [];
  let favorites = new Set();
  let currentProduct = null;
  let filteredProducts = [];
  let checkoutState = { phone:'', address:'', comment:'', promo:'' };

  // ===== INIT =====
  document.addEventListener('DOMContentLoaded', init);
  function init(){
    loadState();
    setupEventListeners();
    setupTelegramWebApp();
    renderUserProfile();
    populateCategoryFilter();
    document.getElementById('only-cheese-checkbox').checked = ONLY_CHEESE_FILTER_DEFAULT;
    refreshFavoritesBar();
    filterAndRender();
    updateCartUI();
  }

  function loadState(){
    try{ const savedCart = localStorage.getItem(STORAGE_CART_KEY); if(savedCart) cart = JSON.parse(savedCart) }catch{ cart=[] }
    try{ const savedFav = localStorage.getItem(STORAGE_FAV_KEY); if(savedFav) favorites = new Set(JSON.parse(savedFav)) }catch{}
    try{ const savedCheckout = localStorage.getItem(STORAGE_CHECKOUT_KEY); if(savedCheckout) checkoutState = JSON.parse(savedCheckout) }catch{}
  }
  function saveState(){
    try{ localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(cart)) }catch{}
    try{ localStorage.setItem(STORAGE_FAV_KEY, JSON.stringify([...favorites])) }catch{}
    try{ localStorage.setItem(STORAGE_CHECKOUT_KEY, JSON.stringify(checkoutState)) }catch{}
  }

  // ===== TELEGRAM =====
  function setupTelegramWebApp(){
    if(window.Telegram && window.Telegram.WebApp){
      const webApp = window.Telegram.WebApp;
      webApp.ready(); webApp.expand();
      webApp.MainButton.setText('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑').onClick(()=> openCartModal()).hide();
      webApp.BackButton.onClick(()=>{
        const pm = document.getElementById('product-modal');
        const cm = document.getElementById('cart-modal');
        if(cm.open) closeCartModal(); else if(pm.open) closeProductModal();
      });
    }
  }

  // ===== UI HOOKS =====
  function setupEventListeners(){
    el('search-input').addEventListener('input', filterAndRender);
    el('category-filter').addEventListener('change', filterAndRender);
    el('only-cheese-checkbox').addEventListener('change', filterAndRender);
    el('only-fav-checkbox').addEventListener('change', filterAndRender);
    el('open-cart-btn').addEventListener('click', openCartModal);
    el('add-to-cart-btn').addEventListener('click', addToCart);
    el('product-variant-select').addEventListener('change', updateProductModalPrice);
    // —á–µ–∫–±–æ–∫—Å –∏ –ø–æ–ª–µ –≤–µ—Å–∞ –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ ‚Äî –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ renderVariantSelector()
  }

  // ===== HEADER =====
  function renderUserProfile(){
    const box = el('user-profile');
    const ua = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if(ua){
      box.innerHTML = `
        <div class="user-avatar">
          <img src="${ua.photo_url||''}" alt="Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>
          <span style="display:none;">${(ua.first_name||'U').charAt(0).toUpperCase()}</span>
        </div>
        <div class="user-name">${ua.first_name||''}</div>`;
    } else box.style.display='none';
  }

  // ===== FILTERS & MAIN RENDER =====
  function populateCategoryFilter(){
    const select = el('category-filter');
    GROUPS.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.title; select.appendChild(o) });
  }
  function filterAndRender(){
    const term = el('search-input').value.trim().toLowerCase();
    const groupSel = el('category-filter').value;
    const onlyCheese = el('only-cheese-checkbox').checked;
    const onlyFav = el('only-fav-checkbox').checked;
    filteredProducts = PRODUCTS.filter(p=>{
      const inTerm = !term || p.name.toLowerCase().includes(term);
      const inGroup = !groupSel || p.group===groupSel;
      const inCheese = !onlyCheese || CHEESE_GROUP_IDS.has(p.group);
      const inFav = !onlyFav || favorites.has(p.id);
      return hasPrice(p) && inTerm && inGroup && inCheese && inFav;
    });
    renderMain(term==='' && !groupSel && !onlyFav && !onlyCheese);
  }

  function renderMain(showSections){
    const main = el('main'); main.innerHTML='';
    if(filteredProducts.length===0){
      main.innerHTML = '<p style="text-align:center;color:var(--hint-color)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'; return;
    }
    if(showSections){
      for(const g of GROUPS){
        const items = filteredProducts.filter(p=>p.group===g.id);
        if(items.length===0) continue;
        const section = document.createElement('section'); section.className='section';
        section.innerHTML = `<div class="section-title">${g.title}</div>`;
        const grid = document.createElement('div'); grid.className='product-grid';
        items.forEach(p=> grid.appendChild(productCard(p)));
        section.appendChild(grid);
        main.appendChild(section);
      }
    } else {
      const grid = document.createElement('div'); grid.className='product-grid';
      filteredProducts.forEach(p=> grid.appendChild(productCard(p)));
      main.appendChild(grid);
    }
  }

  function productCard(p){
    const card = document.createElement('div'); card.className='product-card';
    card.onclick = (e)=>{ if(e.target.closest('.fav-btn')) return; openProductModal(p.id) };
    const priceText = getPriceText(p);
    const approx = approxPieceBadgeText(p);
    const favActive = favorites.has(p.id) ? 'active' : '';
    card.innerHTML = `
      <div class="product-thumb">
        ${p.img ? `<img src="${p.img}" alt="${escapeHtml(p.name)}" onerror="this.remove();"/>` : `<div class="product-ico">${p.ico||'üì¶'}</div>`}
      </div>
      <div class="name">${p.name}</div>
      <div class="product-row">
        <div class="price">${priceText}</div>
        ${approx ? `<div class="badge-piece">${approx}</div>`:''}
        <button class="fav-btn ${favActive}" title="–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" onclick="toggleFavorite('${p.id}');event.stopPropagation()">${favActive?'‚ô•':'‚ô°'}</button>
      </div>`;
    return card;
  }

  function refreshFavoritesBar(){
    const bar = el('favorites-bar'); bar.innerHTML='';
    if(favorites.size===0){ bar.style.display='none'; return; }
    bar.style.display='';
    [...favorites].slice(0,30).forEach(id=>{
      const p = PRODUCTS.find(x=>x.id===id); if(!p) return;
      const chip = document.createElement('div'); chip.className='fav-chip'; chip.textContent = p.name;
      chip.onclick = ()=> openProductModal(id);
      bar.appendChild(chip);
    });
  }

  function toggleFavorite(id){
    if(favorites.has(id)) favorites.delete(id); else favorites.add(id);
    saveState(); refreshFavoritesBar(); filterAndRender();
  }

  // ===== PRODUCT MODAL =====
  function openProductModal(productId){
    currentProduct = PRODUCTS.find(p=>p.id===productId); if(!currentProduct) return;
    const m = el('product-modal');
    el('product-modal-title').textContent = currentProduct.name;
    el('product-modal-description').textContent = currentProduct.description || '';
    renderVariantSelector();
    updateProductModalPrice();
    m.showModal();
    window.Telegram?.WebApp?.BackButton.show();
  }
  function closeProductModal(){
    el('product-modal').close(); currentProduct = null;
    window.Telegram?.WebApp?.BackButton.hide();
  }

  function renderVariantSelector(){
    const select = el('product-variant-select'); select.innerHTML='';
    const rule = VARIANT_RULES[currentProduct.id];
    const pieceBadge = el('piece-badge'); pieceBadge.style.display='none'; pieceBadge.textContent='';
    const cwToggleRow = el('custom-weight-toggle-row');
    const cwRow = el('custom-weight-row');
    const cwInput = el('product-custom-weight');
    const qtyInput = el('product-qty-input');
    const extra = EXTRA_OPTIONS[currentProduct.id];
    const extraGroup = el('extra-option-group');
    const extraSelect = el('extra-option-select');
    const extraLabel = el('extra-option-label');

    // –í–∫—É—Å/–¥–æ–ø-–æ–ø—Ü–∏–∏
    extraGroup.style.display = extra ? '' : 'none';
    if(extra){
      extraLabel.textContent = extra.label || '–û–ø—Ü–∏—è';
      extraSelect.innerHTML='';
      extra.options.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; extraSelect.appendChild(o); });
      extraSelect.onchange = updateProductModalPrice;
    }

    if(!rule){ select.innerHTML='<option>–í–∞—Ä–∏–∞–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</option>'; cwToggleRow.style.display='none'; cwRow.style.display='none'; return }

    if(rule.type==='fixed'){
      rule.options.forEach(opt=>{
        const o=document.createElement('option'); o.value=opt; o.textContent=opt; select.appendChild(o);
      });
      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ¬´—Å–≤–æ–π –≤–µ—Å¬ª, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∫–≥
      cwToggleRow.style.display = currentProduct.pricePerKg ? '' : 'none';
      cwRow.style.display = 'none';
      const useCw = el('use-custom-weight-checkbox');
      useCw.checked = false;
      useCw.onchange = ()=>{
        cwRow.style.display = useCw.checked ? '' : 'none';
        updateProductModalPrice();
      };
      cwInput.value = '';
      cwInput.oninput = updateProductModalPrice;

      qtyInput.value = 1;
      qtyInput.oninput = updateProductModalPrice;

      // –±–µ–π–¥–∂ ¬´‚âà –∑–∞ 1 —à—Ç¬ª
      const maybe = approxPieceBadgeText(currentProduct);
      if(maybe){ pieceBadge.style.display=''; pieceBadge.textContent = maybe }
    } else if(rule.type==='weight'){
      for(let v=rule.min; v<=rule.max; v+=rule.step){
        const o=document.createElement('option'); o.value=`${v} ${rule.unit}`; o.textContent=`${v} ${rule.unit}`; select.appendChild(o);
      }
      // –¥–ª—è –≤–µ—Å–æ–≤—ã—Ö –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–∂–µ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å ¬´—Å–≤–æ–π –≤–µ—Å¬ª
      cwToggleRow.style.display = currentProduct.pricePerKg ? '' : 'none';
      cwRow.style.display = 'none';
      const useCw = el('use-custom-weight-checkbox');
      useCw.checked = false;
      useCw.onchange = ()=>{
        cwRow.style.display = useCw.checked ? '' : 'none';
        updateProductModalPrice();
      };
      cwInput.value = '';
      cwInput.oninput = updateProductModalPrice;

      qtyInput.value = 1;
      qtyInput.oninput = updateProductModalPrice;
    }
  }

  // ===== CART LOGIC =====
  function addToCart(){
    if(!currentProduct) return;
    const {variant, qty} = getSelectedVariantAndQty();
    const idx = cart.findIndex(i=> i.id===currentProduct.id && i.variant===variant);
    if(idx>-1) cart[idx].qty += qty;
    else cart.push({ id:currentProduct.id, name:currentProduct.name, group:currentProduct.group, variant, qty });
    saveState(); updateCartUI(); closeProductModal();
    window.Telegram?.WebApp?.HapticFeedback?.impactOccurred('medium');
  }

  function updateCartUI(){
    const totalCount = cart.reduce((s,i)=> s+i.qty, 0);
    const totalSum = cart.reduce((s,i)=> s+calculatePrice(i.id,i.variant,i.qty).finalPrice, 0);
    const btn = el('open-cart-btn');
    if(cart.length>0){
      btn.disabled=false; btn.textContent = `–ö–æ—Ä–∑–∏–Ω–∞ (${totalCount}) ‚Äî ${fmtRub(totalSum)}`;
      window.Telegram?.WebApp?.MainButton.show();
    } else {
      btn.disabled=true; btn.textContent='–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
      window.Telegram?.WebApp?.MainButton.hide();
    }
  }

  function openCartModal(){ renderCartModal(); el('cart-modal').showModal(); window.Telegram?.WebApp?.BackButton.show() }
  function closeCartModal(){ el('cart-modal').close(); window.Telegram?.WebApp?.BackButton.hide() }

  function renderCartModal(){
    const body = el('cart-modal-body'); body.innerHTML='';
    if(cart.length===0){ body.innerHTML='<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>'; return }

    let total = 0;
    cart.forEach((item,idx)=>{
      const price = calculatePrice(item.id,item.variant,item.qty); total += price.finalPrice;
      const rate = getDiscountRateForProduct(item.id);
      const hint = rate>0 ? `<div class="discount-hint">–°–∫–∏–¥–∫–∞ ${Math.round(rate*100)}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞</div>` : '';
      const div = document.createElement('div'); div.className='cart-item';
      div.innerHTML = `
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-variant">${escapeHtml(item.variant)}</div>
          <div class="cart-item-price">${fmtRub(price.finalPrice)}</div>
          ${hint}
        </div>
        <div class="cart-item-controls">
          <div class="qty-control">
            <button onclick="changeItemQty(${idx},-1)">‚àí</button>
            <span>${item.qty}</span>
            <button onclick="changeItemQty(${idx},1)">+</button>
          </div>
        </div>`;
      body.appendChild(div);
    });

    // –°—É–º–º–∞ + –ø—Ä–æ–º–æ–∫–æ–¥
    const wrap = document.createElement('div'); wrap.className='cart-summary';
    const promoBlock = `
      <div style="text-align:left;margin:10px 0 0">
        <label for="checkout-promo" style="font-weight:700;font-size:13px">–ü—Ä–æ–º–æ–∫–æ–¥</label>
        <input id="checkout-promo" placeholder="–ï—Å–ª–∏ –µ—Å—Ç—å" style="width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;background:var(--secondary-bg-color);color:var(--text-color);font-size:16px;margin-top:4px" />
        <div class="notice">–ü—Ä–æ–º–æ–∫–æ–¥—ã –ª—É—á—à–µ —Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å/–æ—Ç–º–µ–Ω–∞), –Ω–æ –º–æ–∂–Ω–æ –∏ –ª–æ–∫–∞–ª—å–Ω–æ (—Å–º. PROMO_CODES).</div>
      </div>`;
    wrap.innerHTML = `–ò—Ç–æ–≥–æ: ${fmtRub(total)}${promoBlock}`;
    body.appendChild(wrap);

    // –ö–æ–Ω—Ç–∞–∫—Ç—ã/–¥–æ—Å—Ç–∞–≤–∫–∞
    const checkout = document.createElement('div');
    checkout.innerHTML = `
      <div class="section-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –¥–æ—Å—Ç–∞–≤–∫–∞</div>
      <div class="form-group">
        <label for="checkout-phone">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏</label>
        <input type="tel" id="checkout-phone" inputmode="tel" placeholder="+7 999 999-99-99" />
        <div class="notice">–ú–æ–∂–Ω–æ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ: 8999..., +7..., –ø—Ä–æ–±–µ–ª—ã/—Å–∫–æ–±–∫–∏ –Ω–µ –≤–∞–∂–Ω—ã ‚Äî –ø—Ä–∏–≤–µ–¥—ë–º –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É.</div>
      </div>
      <div class="form-group">
        <label for="checkout-address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</label>
        <textarea id="checkout-address" rows="3" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥/—ç—Ç–∞–∂/–∫–≤."></textarea>
      </div>
      <div class="form-group">
        <label for="checkout-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
        <textarea id="checkout-comment" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç–∞–≤–∫–æ–π, –±–µ–∑ —á–µ—Å–Ω–æ–∫–∞ –∏ —Ç.–ø."></textarea>
      </div>
      <div id="checkout-errors" class="error-text" style="display:none"></div>
    `;
    body.appendChild(checkout);

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ
    el('checkout-phone').value = checkoutState.phone || '';
    el('checkout-address').value = checkoutState.address || '';
    el('checkout-comment').value = checkoutState.comment || '';
    el('checkout-promo').value = checkoutState.promo || '';
    el('checkout-phone').addEventListener('input',()=>{ checkoutState.phone = el('checkout-phone').value; saveState() });
    el('checkout-address').addEventListener('input',()=>{ checkoutState.address = el('checkout-address').value; saveState() });
    el('checkout-comment').addEventListener('input',()=>{ checkoutState.comment = el('checkout-comment').value; saveState() });
    el('checkout-promo').addEventListener('input',()=>{ checkoutState.promo = el('checkout-promo').value.trim(); saveState() });

    // –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    const sendBtn = document.createElement('button'); sendBtn.className='btn btn-primary'; sendBtn.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
    sendBtn.onclick = sendOrder;
    body.appendChild(sendBtn);

    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø—Ä–æ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –≤ –∫–æ—Ä–∑–∏–Ω–µ –µ—Å—Ç—å —Å—ã—Ä—ã)
    if(hasCheeseInCart()){
      const note = document.createElement('div'); note.className='weighing-note';
      note.textContent = '–ö–æ–Ω–µ—á–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞ –±—É–¥–µ—Ç —É—Ç–æ—á–Ω–µ–Ω–∞ –ø–æ—Å–ª–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∞–≤–∫–∏ (–¥–ª—è —Å—ã—Ä–æ–≤).';
      body.appendChild(note);
    }
  }

  function changeItemQty(index,delta){
    cart[index].qty += delta; if(cart[index].qty<=0) cart.splice(index,1);
    saveState(); updateCartUI(); renderCartModal();
  }

  // ===== PRICING =====
  function hasPrice(p){ return p.pricePerKg || p.pricePerL || p.pricePerUnit }
  function getPriceText(p){
    if(p.pricePerKg) return `${fmtRub(p.pricePerKg)} / –∫–≥`;
    if(p.pricePerL) return `${fmtRub(p.pricePerL)} / –ª`;
    if(p.pricePerUnit) return `${fmtRub(p.pricePerUnit)}`;
    return '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
  }

  function approxPieceBadgeText(p){
    if(!p.pricePerKg) return '';
    const rule = VARIANT_RULES[p.id]; if(!rule || rule.type!=='fixed') return '';
    const opt = rule.options.find(o=> /–≥/i.test(o));
    if(!opt) return '';
    const grams = extractGrams(opt); if(!grams) return '';
    const approx = Math.round(p.pricePerKg * grams / 1000);
    return `‚âà ${fmtRub(approx)} –∑–∞ 1 —à—Ç`;
  }

  function getSelectedVariantAndQty(){
    const rule = VARIANT_RULES[currentProduct.id];
    const qty = Math.max(1, parseInt(el('product-qty-input').value)||1);
    let variant = el('product-variant-select').value;

    // custom weight?
    const useCw = el('use-custom-weight-checkbox');
    if(currentProduct.pricePerKg && useCw && useCw.checked){
      const custom = Math.max(0, parseInt(el('product-custom-weight').value)||0);
      if(custom>0) variant = `${custom} –≥`;
    }

    // –≤–∫—É—Å/–æ–ø—Ü–∏—è
    const extra = EXTRA_OPTIONS[currentProduct.id];
    if(extra){
      const val = el('extra-option-select').value;
      if(val) variant = `${variant} ‚Ä¢ –≤–∫—É—Å: ${val}`;
    }
    return { variant, qty };
  }

  function extractGrams(variant){
    const m = (variant||'').match(/(?:\(|^|\s)[~¬±]?\s*(\d+(?:\.\d+)?)\s*(–≥|–∫–≥)\s*\)?/i);
    if(!m) return 0;
    const val = parseFloat(m[1]); const unit = m[2].toLowerCase();
    return unit==='–∫–≥' ? val*1000 : val;
  }
  function extractLiters(variant){
    const m = (variant||'').match(/(\d+(?:\.\d+)?)\s*–ª/i); return m? parseFloat(m[1]) : 0;
  }

  function calculatePrice(productId, variant, qty){
    const p = PRODUCTS.find(x=>x.id===productId); if(!p) return {basePrice:0, finalPrice:0, discountRate:0};
    let base=0;

    if(p.pricePerKg){
      const grams = extractGrams(variant) || 0;
      base = (grams/1000) * p.pricePerKg * qty;
    } else if(p.pricePerL){
      const liters = extractLiters(variant) || 0;
      base = liters * p.pricePerL * qty;
    } else if(p.pricePerUnit){
      base = p.pricePerUnit * qty;
    }

    const discountRate = getDiscountRateForProduct(productId);
    const discounted = base * (1 - discountRate);
    return { basePrice: ROUND(base), finalPrice: ROUND(discounted), discountRate };
  }

  function getDiscountRateForProduct(productId){
    const prod = PRODUCTS.find(p=>p.id===productId);
    if(!prod || !CHEESE_GROUP_IDS.has(prod.group)) return 0;
    const totalGr = cart.filter(i=>i.id===productId).reduce((sum,i)=>{
      const grams = extractGrams(i.variant) || 0; return sum + grams * i.qty;
    },0);
    let rate=0; for(const t of DISCOUNT_THRESHOLDS){ if(totalGr>=t.g) rate=t.rate }
    return rate;
  }

  function updateProductModalPrice(){
    if(!currentProduct) return;
    const selectVal = el('product-variant-select').value || '';
    const useCw = el('use-custom-weight-checkbox');
    const grams = (useCw && useCw.checked && currentProduct.pricePerKg)
      ? Math.max(0, parseInt(el('product-custom-weight').value)||0)
      : extractGrams(selectVal);

    const qty = Math.max(1, parseInt(el('product-qty-input').value)||1);

    let variantForCalc = selectVal;
    if(useCw && useCw.checked && currentProduct.pricePerKg && grams>0){
      variantForCalc = `${grams} –≥`;
    }
    const { finalPrice } = calculatePrice(currentProduct.id, variantForCalc, qty);
    el('product-modal-price').textContent = fmtRub(finalPrice);

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –±–µ–π–¥–∂ ¬´‚âà –∑–∞ 1 —à—Ç¬ª
    const pieceBadge = el('piece-badge');
    pieceBadge.style.display='none';
    if(currentProduct.pricePerKg && /—à—Ç/i.test(selectVal) && !((useCw && useCw.checked))){
      const g = extractGrams(selectVal);
      if(g>0){ pieceBadge.style.display=''; pieceBadge.textContent = `‚âà ${fmtRub(currentProduct.pricePerKg * g/1000)} –∑–∞ 1 —à—Ç`; }
    }
  }

  function hasCheeseInCart(){
    return cart.some(i => {
      const p = PRODUCTS.find(x=>x.id===i.id);
      return p && CHEESE_GROUP_IDS.has(p.group);
    });
  }

  // ===== CHECKOUT =====
  function normalizePhone(input){
    if(!input) return '';
    const digits = (''+input).replace(/\D+/g,'');
    if(digits.length===11 && (digits.startsWith('7')||digits.startsWith('8'))) return '+7'+digits.slice(1);
    if(digits.length===10) return '+7'+digits;
    if((''+input).trim().startsWith('+')) return '+'+digits;
    return digits? ('+'+digits) : '';
  }
  function getCheckoutData(){
    const phoneRaw = (el('checkout-phone').value||'').trim();
    const phone = normalizePhone(phoneRaw);
    const address = (el('checkout-address').value||'').trim();
    const comment = (el('checkout-comment').value||'').trim();
    const promo = (el('checkout-promo').value||'').trim().toUpperCase();
    checkoutState = { phone:phoneRaw,address,comment,promo }; saveState();
    return { phoneRaw, phone, address, comment, promo };
  }
  function validateCheckout(data){
    const errs=[]; if(!data.phone) errs.push('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏.');
    if(data.address.length<5) errs.push('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.');
    return errs;
  }
  function showCheckoutErrors(errors){
    const box = el('checkout-errors');
    if(!errors || errors.length===0){ box.style.display='none'; box.textContent=''; return }
    box.style.display='block'; box.textContent = errors.join(' ');
  }

  function applyPromo(total, code){
    if(!code) return { total, applied:null };
    const promo = PROMO_CODES[code]; if(!promo) return { total, applied:null };
    let newTotal = total;
    if(promo.type==='percent') newTotal = total * (1 - promo.value/100);
    if(promo.type==='fixed') newTotal = Math.max(0, total - promo.value);
    return { total: ROUND(newTotal), applied: promo };
  }

  function sendOrder(){
    if(cart.length===0) return;
    const contact = getCheckoutData();
    const errors = validateCheckout(contact);
    if(errors.length){ showCheckoutErrors(errors); window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error'); return }
    showCheckoutErrors([]);

    const payload={ type:'cart', source:'miniapp', currency:CURRENCY, items:[], total:0,
      contact:{ phone:contact.phone, phone_raw:contact.phoneRaw, address:contact.address, comment:contact.comment, promo:contact.promo },
      meta:{ ts:Date.now(), schema_ver:PAYLOAD_SCHEMA_VERSION }
    };

    let grand=0;
    cart.forEach(i=>{
      const price = calculatePrice(i.id,i.variant,i.qty); grand += price.finalPrice;
      payload.items.push({
        id:i.id, name:i.name, group:i.group, variant:i.variant, qty:i.qty,
        unit_price_base: price.basePrice/Math.max(i.qty,1),
        discount_rate: price.discountRate,
        unit_price: price.finalPrice/Math.max(i.qty,1),
        line_total: price.finalPrice
      });
    });

    const promoRes = applyPromo(grand, contact.promo ? contact.promo.toUpperCase() : '');
    payload.total = promoRes.total;
    if(promoRes.applied){ payload.promo_applied = promoRes.applied }

    if(window.Telegram?.WebApp){
      const tg = window.Telegram.WebApp; payload.telegram = { platform:tg.platform, init_data:!!tg.initData };
      const u = tg.initDataUnsafe?.user; if(u){ payload.telegram.user = { id:u.id, username:u.username, first_name:u.first_name, last_name:u.last_name } }
    }

    axios.post(`${BACKEND}/order`, payload).then(()=>{
      window.Telegram?.WebApp?.showAlert?.('–°–ø–∞—Å–∏–±–æ! –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç. –ú—ã —Å–≤—è–∂–µ–º—Å—è –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.');
      window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('success');
      cart=[]; saveState(); updateCartUI(); closeCartModal(); window.Telegram?.WebApp?.close?.();
    }).catch(()=>{
      window.Telegram?.WebApp?.showAlert?.('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      window.Telegram?.WebApp?.HapticFeedback?.notificationOccurred('error');
    });
  }

  // ===== HELPERS =====
  function el(id){ return document.getElementById(id) }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }

  </script>
</body>
</html>
