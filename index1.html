<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–°—ã—Ä–æ–º–∞–Ω–∏—è ‚Äî –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<link rel="preconnect" href="https://telegram.org" />
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg: #ffffff;
  --text: #111111;
  --muted: #6b7280;
  --card: #f8f9fb;
  --accent: #2563eb;
  --accent-contrast: #ffffff;
  --border: #e5e7eb;
  --danger: #b91c1c;
  --ok: #166534;
  --shadow: 0 2px 10px rgba(0,0,0,.08);
  --radius: 16px;
  --gap: 12px;
  --focus: 2px solid #2563ebaa;
}
html,body{height:100%}
body{
  margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
  background: var(--bg); color: var(--text);
}
header{
  position: sticky; top: 0; z-index: 5;
  padding: 12px; background: var(--bg); border-bottom: 1px solid var(--border);
  display:grid; gap: var(--gap);
}
.header-row{display:grid; grid-template-columns: 1fr auto; gap: var(--gap); align-items:center}
.filters{display:grid; grid-template-columns: 1fr 1fr auto; gap: var(--gap)}
.search{
  display:flex; align-items:center; gap:8px; background: var(--card);
  padding:10px 12px; border-radius: var(--radius); border:1px solid var(--border);
}
.search input{flex:1; border:none; outline:none; background:transparent; color:var(--text)}
select, button, input[type="number"], input[type="text"], textarea{
  border:1px solid var(--border); background:var(--bg); color:var(--text);
  border-radius: 10px; padding:10px 12px; font-size: 14px;
}
button{cursor:pointer}
button.primary{
  background: var(--accent); color: var(--accent-contrast); border-color: transparent;
}
button.ghost{background: var(--card)}
button.danger{ background: #fee2e2; border-color: #fecaca; color: var(--danger) }
kbd.badge{
  font-family: inherit; font-weight: 600; border:1px solid var(--border);
  background: var(--card); color: var(--muted); padding:3px 8px; border-radius: 999px; font-size:12px;
}
main{ padding: 12px; padding-bottom: 100px; }
.grid{
  display:grid; gap: var(--gap);
  grid-template-columns: repeat( auto-fit, minmax(240px, 1fr) );
}
.card{
  background: var(--card); border:1px solid var(--border); border-radius: var(--radius);
  box-shadow: var(--shadow); padding: 12px; display:flex; flex-direction: column; gap: 8px;
}
.card h3{margin:0; font-size: 16px}
.card .muted{color:var(--muted); font-size: 12px}
.card .price{font-weight:700}
.card .pic{
  width: 64px; height:64px; display:grid; place-items:center; font-size:32px; border-radius: 12px;
  background: var(--bg); border:1px solid var(--border);
}
.card footer{ display:flex; gap:8px; align-items:center; justify-content: space-between; margin-top:auto }

.tags{display:flex; gap:6px; flex-wrap:wrap}
.tag{font-size:12px; background: var(--bg); border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px}

/* floating cart bar */
.cart-bar{
  position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 10;
  display:flex; align-items:center; justify-content:space-between; gap: 10px;
  background: var(--bg); border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow);
  padding: 10px 12px;
}
.cart-bar .summary{ display:flex; align-items:center; gap:10px; font-weight:600 }
.cart-bar .summary .chip{
  background: var(--card); border:1px solid var(--border); padding:3px 8px; border-radius:999px; font-size:12px; color:var(--muted)
}

dialog{ border: none; border-radius: 16px; padding:0; box-shadow: 0 20px 60px rgba(0,0,0,.2); width:min(720px, 95vw) }
dialog::backdrop{ background: rgba(0,0,0,.4) }
.modal{
  background: var(--bg); color: var(--text); border:1px solid var(--border); border-radius: 16px; padding: 16px; max-height: 85vh; overflow:auto
}
.modal header{ position: sticky; top: -16px; background: var(--bg); border-bottom:1px solid var(--border); margin:-16px; margin-bottom:16px; padding:16px; border-top-left-radius:16px; border-top-right-radius:16px }
.modal footer{ position: sticky; bottom:-16px; background: var(--bg); border-top:1px solid var(--border); margin:-16px; margin-top:16px; padding:16px; border-bottom-left-radius:16px; border-bottom-right-radius:16px; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
.modal .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; align-items: end }
.modal .row .full{ grid-column: 1 / -1 }

.table{ width:100%; border-collapse: collapse; }
.table th, .table td{ padding: 10px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle }
.table th{ font-size:12px; color: var(--muted); font-weight:600 }
.table .qty{ display:flex; align-items:center; gap:6px }
.table .qty input{ width:70px }

hr{ border: none; height:1px; background: var(--border); margin: 8px 0 }

.notice{ font-size: 12px; color: var(--muted) }
.muted{ color: var(--muted) }
.right{ margin-left:auto }
.center{ text-align:center }

/* focus */
:focus-visible{ outline: var(--focus); outline-offset: 2px }

/* dark mode from Telegram theme */
.tg-dark{
  --bg: #0e1621;
  --text: #f5f7fb;
  --muted: #a9b4c2;
  --card: #17212b;
  --accent: #5ea1ff;
  --accent-contrast: #0b1220;
  --border: #253241;
  --danger: #fca5a5;
  --ok: #34d399;
  --shadow: 0 8px 24px rgba(0,0,0,.4);
}

/* small helpers */
.hidden{ display:none !important }
</style>
</head>
<body>
<header>
  <div class="header-row">
    <div class="search" role="search">
      <span aria-hidden="true">üîé</span>
      <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶" autocomplete="off" />
    </div>
    <button id="resetFilters" class="ghost" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">–°–±—Ä–æ—Å</button>
  </div>
  <div class="filters">
    <select id="catFilter" aria-label="–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      <option value="–°—ã—Ä—ã">–°—ã—Ä—ã</option>
      <option value="–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è">–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è</option>
      <option value="–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞">–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞</option>
    </select>
    <label style="display:flex;align-items:center;gap:8px">
      <input id="onlyCheese" type="checkbox" />
      –¢–æ–ª—å–∫–æ —Å—ã—Ä—ã
    </label>
    <div class="tags" aria-live="polite" id="activeFilters"></div>
  </div>
</header>

<main>
  <div class="grid" id="grid" aria-live="polite"></div>
</main>

<!-- Product modal -->
<dialog id="productDialog">
  <div class="modal">
    <header>
      <div style="display:flex; gap:12px; align-items:center">
        <div class="pic" id="prodPic" aria-hidden="true">üßÄ</div>
        <div>
          <div id="prodCat" class="muted"></div>
          <h2 id="prodName" style="margin:4px 0 6px 0; font-size:20px">‚Äî</h2>
          <div id="prodSku" class="muted"></div>
        </div>
        <button id="closeProduct" class="right ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </header>

    <div id="prodDesc" class="notice" style="margin-bottom:8px"></div>

    <div class="row">
      <label class="full">–í–∞—Ä–∏–∞–Ω—Ç
        <select id="variantSelect"></select>
      </label>
      <label>–ö–æ–ª-–≤–æ
        <input id="variantQty" type="number" value="1" min="1" step="1" />
      </label>
      <div class="full">
        <div id="variantPrice" class="price">‚Äî ‚ÇΩ</div>
        <div id="variantPriceNote" class="notice"></div>
      </div>
    </div>

    <footer>
      <div>
        <div id="discountHint" class="notice"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="addToCart" class="primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </footer>
  </div>
</dialog>

<!-- Cart modal -->
<dialog id="cartDialog" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
  <div class="modal">
    <header style="display:flex;align-items:center;gap:8px">
      <h2 style="margin:0">–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <span class="right notice" id="cartDiscountFlag"></span>
      <button id="closeCart" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
    </header>

    <div id="cartEmpty" class="center muted hidden">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>

    <table class="table" id="cartTable" aria-label="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã">
      <thead>
        <tr><th>–¢–æ–≤–∞—Ä</th><th>–í–∞—Ä–∏–∞–Ω—Ç</th><th>–¶–µ–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–°—É–º–º–∞</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="orderExtras" class="hidden">
      <hr />
      <div class="row">
        <label class="full">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É
          <textarea id="orderComment" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫ 18:00, –Ω–µ –∑–≤–æ–Ω–∏—Ç—å"></textarea>
        </label>
      </div>
    </div>

    <footer>
      <div>
        <div class="notice" id="cartNote"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="clearCart" class="danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <div style="font-weight:700">–ò—Ç–æ–≥–æ: <span id="cartTotal">0 ‚ÇΩ</span> <kbd class="badge" id="cartCount">0 –ø–æ–∑.</kbd></div>
        <button id="sendCart" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </footer>
  </div>
</dialog>

<!-- Floating bar -->
<div class="cart-bar" id="cartBar" role="button" tabindex="0" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">
  <div class="summary">
    <span>üß∫</span>
    <span id="barText">0 –ø–æ–∑–∏—Ü–∏–π</span>
    <span class="chip" id="barSum">0 ‚ÇΩ</span>
  </div>
  <button class="primary" id="barSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<script>
/* =========================
   –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
========================= */
const CONFIG = {
  CURRENCY: 'RUB',
  ROUND: Math.round,
  DISCOUNT_THRESHOLDS: [ {g:1000, rate:0.15}, {g:700, rate:0.10}, {g:500, rate:0.05} ],
  ONLY_CHEESE_FILTER_DEFAULT: false,
  PAYLOAD_SCHEMA_VERSION: 'v1',
  SHOW_COMMENT_FIELD: true,        // —Ñ–ª–∞–≥: –ø–æ–ª–µ "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É" –≤ –∫–æ—Ä–∑–∏–Ω–µ
  ENABLE_CITY_SELECT: false,       // —Ñ–ª–∞–≥: –≤—ã–±–æ—Ä –≥–æ—Ä–æ–¥–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  BAKERY_STEP_G: 250,              // —à–∞–≥ –¥–ª—è –≤—ã–ø–µ—á–∫–∏/–ø–µ—á–µ–Ω—å—è –ø–æ –∫–≥
  MAX_G_DEFAULT: 1000,             // –º–∞–∫—Å–∏–º—É–º, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –∏–Ω–æ–µ
  PUZZLEBOT_HINT: true,            // –ø–æ–ª–æ–∂–∏–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ payload.meta
  WEBHOOK_HINT: 'srv-d42e1s3ipnbc73c8tgeg', // –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∫–∞–∫ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –≤ meta
};
/* =========================
   –¢–µ–ª–µ–≥—Ä–∞–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ (–±–µ–∑ –ø–∞–¥–µ–Ω–∏–π)
========================= */
const tg = (function(){
  const env = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
  const fallback = {
    ready(){ console.log('[preview] ready'); },
    expand(){},
    close(){ console.log('[preview] close requested'); },
    colorScheme: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
    themeParams: {},
    MainButton: {
      isVisible:false,
      text:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
      show(){ this.isVisible=true; console.log('[preview] MainButton show') },
      hide(){ this.isVisible=false; console.log('[preview] MainButton hide') },
      onClick(cb){ this._cb = cb },
      offClick(){ this._cb=null },
      setText(txt){ this.text=txt },
      enable(){}, disable(){}, color:'#2481cc', textColor:'#fff'
    },
    sendData(payload){
      alert('–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä: –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞ (—Å–∏–º—É–ª—è—Ü–∏—è). –°–º. –∫–æ–Ω—Å–æ–ª—å.');
      console.log('sendData payload:', payload);
    }
  };
  return env || fallback;
})();
document.body.classList.toggle('tg-dark', tg.colorScheme === 'dark');
document.body.classList.toggle('tg-light', tg.colorScheme !== 'dark');
applyThemeParams(tg.themeParams||{});
tg.ready(); tg.expand();

/* ============ –¢–µ–º–∞ –∏–∑ Telegram ============ */
function applyThemeParams(params){
  if(!params) return;
  const map = {
    bg_color:'--bg', text_color:'--text', secondary_bg_color:'--card', hint_color:'--muted',
    button_color:'--accent', button_text_color:'--accent-contrast'
  };
  for(const k in map){
    if(params[k]){
      document.documentElement.style.setProperty(map[k], params[k]);
    }
  }
}

/* =========================
   –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
========================= */
/** –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
const CAT = {
  CHEESE: '–°—ã—Ä—ã',
  DAIRY: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è',
  SWEETS: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞',
};
/** –ò–∫–æ–Ω–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º/—Ç–æ–≤–∞—Ä–∞–º (–∑–∞–≥–ª—É—à–∫–∏) */
const ICO = { [CAT.CHEESE]:'üßÄ', [CAT.DAIRY]:'ü•õ', [CAT.SWEETS]:'üç™' };

/** PRODUCTS: id, name, cat, pricePerKg|pricePerL|pricePerUnit, description?, ico? */
const PRODUCTS = [
  // ===== –°–´–†–´ (—Ü–µ–Ω—ã –∑–∞ –∫–≥) =====
  {id:'paneer_classic', name:'–ü–∞–Ω–∏—Ä / –ê–¥—ã–≥–µ–π—Å–∫–∏–π ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:CAT.CHEESE, pricePerKg:1200, ico:'üßÄ'},
  {id:'paneer_herbs', name:'–ü–∞–Ω–∏—Ä / –ê–¥—ã–≥–µ–π—Å–∫–∏–π ‚Äî —Å –∑–µ–ª–µ–Ω—å—é', cat:CAT.CHEESE, pricePerKg:1300, ico:'üßÄ'},
  {id:'paneer_spice', name:'–ü–∞–Ω–∏—Ä / –ê–¥—ã–≥–µ–π—Å–∫–∏–π ‚Äî —Å –ø—Ä—è–Ω–æ—Å—Ç—è–º–∏', cat:CAT.CHEESE, pricePerKg:1350, ico:'üßÄ'},
  {id:'paneer_smoked', name:'–ü–∞–Ω–∏—Ä / –ê–¥—ã–≥–µ–π—Å–∫–∏–π ‚Äî –∫–æ–ø—á—ë–Ω—ã–π', cat:CAT.CHEESE, pricePerKg:1400, ico:'üßÄ'},

  {id:'suluguni', name:'–°—É–ª—É–≥—É–Ω–∏', cat:CAT.CHEESE, pricePerKg:1400},
  {id:'suluguni_smoked', name:'–°—É–ª—É–≥—É–Ω–∏ –∫–æ–ø—á—ë–Ω—ã–π', cat:CAT.CHEESE, pricePerKg:1550},

  {id:'imeretinsky', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π', cat:CAT.CHEESE, pricePerKg:1300},
  {id:'imeretinsky_dill_garlic', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π —Å —É–∫—Ä–æ–ø–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º', cat:CAT.CHEESE, pricePerKg:1400},

  {id:'halloumi_classic', name:'–•–∞–ª–ª—É–º–∏ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:CAT.CHEESE, pricePerKg:1650},
  {id:'halloumi_spicy_mix1', name:'–•–∞–ª–ª—É–º–∏ ‚Äî –ø–∞–ø—Ä–∏–∫–∞ –∏ –æ—Ä–µ–≥–∞–Ω–æ', cat:CAT.CHEESE, pricePerKg:1800},
  {id:'halloumi_mix_tbg', name:'–•–∞–ª–ª—É–º–∏ ‚Äî —Ç–æ–º–∞—Ç, –±–∞–∑–∏–ª–∏–∫, —á–µ—Å–Ω–æ–∫', cat:CAT.CHEESE, pricePerKg:1800},
  {id:'halloumi_sundried', name:'–•–∞–ª–ª—É–º–∏ ‚Äî —Å –≤—è–ª–µ–Ω—ã–º–∏ –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ –∏ –ø–∞–ø—Ä–∏–∫–æ–π', cat:CAT.CHEESE, pricePerKg:1800},

  {id:'kosichka', name:'–ö–æ—Å–∏—á–∫–∞', cat:CAT.CHEESE, pricePerKg:1600},
  {id:'kosichka_smoked', name:'–ö–æ—Å–∏—á–∫–∞ –∫–æ–ø—á—ë–Ω–∞—è', cat:CAT.CHEESE, pricePerKg:1750},

  {id:'spicy_ball', name:'–ü—Ä—è–Ω—ã–π –∫–ª—É–±–æ–∫', cat:CAT.CHEESE, pricePerKg:1680},

  {id:'mozzarella', name:'–ú–æ—Ü–∞—Ä–µ–ª–ª–∞', cat:CAT.CHEESE, pricePerKg:1700},
  {id:'burrata', name:'–ë—É—Ä–∞—Ç—Ç–∞', cat:CAT.CHEESE, pricePerKg:1800},

  {id:'stracciatella', name:'–°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞', cat:CAT.CHEESE, pricePerKg:1850},

  {id:'ricotta', name:'–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞)', cat:CAT.CHEESE, pricePerKg:1100},
  {id:'ricotta_herbs', name:'–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞) —Å —É–∫—Ä–æ–ø–æ–º –∏ –∑–µ–ª–µ–Ω—å—é', cat:CAT.CHEESE, pricePerKg:1200},

  {id:'caciotta', name:'–ö–∞—á–æ—Ç—Ç–∞', cat:CAT.CHEESE, pricePerKg:2150},
  {id:'caciotta_fenugreek', name:'–ö–∞—á–æ—Ç—Ç–∞ —Å –ø–∞–∂–∏—Ç–Ω–∏–∫–æ–º', cat:CAT.CHEESE, pricePerKg:2250},

  {id:'hard_rural', name:'–¢–≤—ë—Ä–¥—ã–π –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏', cat:CAT.CHEESE, pricePerKg:1400},
  {id:'hard_smoked', name:'–¢–≤—ë—Ä–¥—ã–π –∫–æ–ø—á—ë–Ω—ã–π', cat:CAT.CHEESE, pricePerKg:1600},

  {id:'cheese_roll_olives_walnut', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–º–∞—Å–ª–∏–Ω—ã –∏ –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', cat:CAT.CHEESE, pricePerKg:1550},
  {id:'cheese_roll_apricot_pine', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–∫—É—Ä–∞–≥–∞ –∏ –∫–µ–¥—Ä–æ–≤—ã–µ)', cat:CAT.CHEESE, pricePerKg:1550},

  // ===== –ú–û–õ–û–ß–ù–ê–Ø –ü–†–û–î–£–ö–¶–ò–Ø =====
  {id:'milk', name:'–ú–æ–ª–æ–∫–æ', cat:CAT.DAIRY, pricePerL:100, ico:'ü•õ'},
  {id:'baked_milk', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–æ–ª–æ–∫–æ', cat:CAT.DAIRY, pricePerL:200},
  {id:'yogurt', name:'–ô–æ–≥—É—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:CAT.DAIRY, pricePerL:230},
  {id:'ryazhenka', name:'–†—è–∂–µ–Ω–∫–∞', cat:CAT.DAIRY, pricePerL:250},
  {id:'whey', name:'–°—ã–≤–æ—Ä–æ—Ç–∫–∞', cat:CAT.DAIRY, pricePerL:50},

  {id:'cream', name:'–°–ª–∏–≤–∫–∏', cat:CAT.DAIRY, pricePerL:1200},
  {id:'curd', name:'–¢–≤–æ—Ä–æ–≥', cat:CAT.DAIRY, pricePerKg:500},

  {id:'butter', name:'–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', cat:CAT.DAIRY, pricePerKg:1800, description:'–î–æ—Å—Ç—É–ø–µ–Ω —Ñ–∏–∫—Å-–ø–∞–∫ 1 —à—Ç (200 –≥) = 360 ‚ÇΩ' },
  {id:'ghee', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ (–ì–•–ò)', cat:CAT.DAIRY, pricePerKg:2300},

  {id:'condensed', name:'–°–≥—É—â—ë–Ω–∫–∞', cat:CAT.DAIRY, pricePerKg:850},
  {id:'curd_mass_apricot', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞ ‚Äî –∫—É—Ä–∞–≥–∞', cat:CAT.DAIRY, pricePerKg:700},
  {id:'curd_mass_raisins', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞ ‚Äî –∏–∑—é–º', cat:CAT.DAIRY, pricePerKg:700},
  {id:'curd_mass_prunes', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞ ‚Äî —á–µ—Ä–Ω–æ—Å–ª–∏–≤', cat:CAT.DAIRY, pricePerKg:700},
  {id:'curd_mass_dates', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞ ‚Äî —Ñ–∏–Ω–∏–∫–∏', cat:CAT.DAIRY, pricePerKg:700},

  {id:'mishti_dahi', name:'–ú–∏—Å—Ç—Ö–∏ –î–∞—Ö–∏', cat:CAT.DAIRY, /* TODO_PRICE */ },

  // ===== –°–õ–ê–î–û–°–¢–ò –ò –í–´–ü–ï–ß–ö–ê =====
  // –ü–µ—á–µ–Ω—å–µ (—Ü–µ–Ω–∞ –∑–∞ –∫–≥, –ø—Ä–æ–¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–Ω–æ 250 –≥)
  {id:'cookie_curd', name:'–ü–µ—á–µ–Ω—å–µ —Ç–≤–æ—Ä–æ–∂–Ω–æ–µ', cat:CAT.SWEETS, pricePerKg:600, ico:'üç™'},
  {id:'cookie_oat', name:'–ü–µ—á–µ–Ω—å–µ –æ–≤—Å—è–Ω–æ–µ', cat:CAT.SWEETS, pricePerKg:600},
  {id:'cookie_nut_fingers', name:'–û—Ä–µ—Ö–æ–≤—ã–µ –ø–∞–ª—å—á–∏–∫–∏', cat:CAT.SWEETS, pricePerKg:700},
  {id:'cookie_carob', name:'–ü–µ—á–µ–Ω—å–µ –∫—ç—Ä–±–æ–≤–æ–µ', cat:CAT.SWEETS, pricePerKg:600},
  {id:'cookie_shortbread', name:'–ü–µ—á–µ–Ω—å–µ –ø–µ—Å–æ—á–Ω–æ–µ', cat:CAT.SWEETS, pricePerKg:600},

  // –ö–µ–∫—Å—ã (—Ü–µ–Ω–∞ –∑–∞ –∫–≥, —à–∞–≥ 250 –≥)
  {id:'muffin_plain', name:'–ö–µ–∫—Å—ã –æ–±—ã—á–Ω—ã–µ', cat:CAT.SWEETS, pricePerKg:500, ico:'üßÅ'},
  {id:'muffin_carob', name:'–ö–µ–∫—Å—ã –∫—ç—Ä–æ–±–æ–≤—ã–µ', cat:CAT.SWEETS, pricePerKg:550},
  {id:'muffin_raisins', name:'–ö–µ–∫—Å—ã —Å –∏–∑—é–º–æ–º', cat:CAT.SWEETS, pricePerKg:550},

  // –ö–µ–∫—Å—ã –º–∏–∫—Å ‚Äî —Ñ–∏–∫—Å-–ø–∞–∫–∏
  {id:'muffin_mix_plain_raisins', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∏–∑—é–º)', cat:CAT.SWEETS, pricePerUnit:280, description:'–ü–∞–∫–µ—Ç 0.5 –∫–≥', _fixed:{label:'0.5 –∫–≥', price:280}},
  {id:'muffin_mix_plain_carob', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∫—ç—Ä–æ–±)', cat:CAT.SWEETS, pricePerUnit:300, description:'–ü–∞–∫–µ—Ç 0.5 –∫–≥', _fixed:{label:'0.5 –∫–≥', price:300}},
  {id:'muffin_mix_raisins_carob', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–∏–∑—é–º+–∫—ç—Ä–æ–±)', cat:CAT.SWEETS, pricePerUnit:300, description:'–ü–∞–∫–µ—Ç 0.5 –∫–≥', _fixed:{label:'0.5 –∫–≥', price:300}},

  // –ò–Ω–¥–∏–π—Å–∫–∏–µ —Å–ª–∞–¥–æ—Å—Ç–∏ / –≤—ã–ø–µ—á–∫–∞ (—Ñ–∏–∫—Å-–ø–∞–∫–µ—Ç—ã)
  {id:'sandesh_orange', name:'–°–∞–Ω–¥–µ—à ‚Äî –∞–ø–µ–ª—å—Å–∏–Ω', cat:CAT.SWEETS, pricePerUnit:250, description:'5 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:5, label:'5 —à—Ç', price:250}},
  {id:'sandesh_walnut', name:'–°–∞–Ω–¥–µ—à ‚Äî –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö', cat:CAT.SWEETS, pricePerUnit:250, description:'5 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:5, label:'5 —à—Ç', price:250}},
  {id:'sandesh_carob', name:'–°–∞–Ω–¥–µ—à ‚Äî –∫—ç—Ä–æ–±', cat:CAT.SWEETS, pricePerUnit:250, description:'5 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:5, label:'5 —à—Ç', price:250}},

  {id:'burfi_classic', name:'–ë—É—Ä—Ñ–∏ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:CAT.SWEETS, pricePerUnit:300, description:'5 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:5, label:'5 —à—Ç', price:300}},
  {id:'burfi_hazelnut', name:'–ë—É—Ä—Ñ–∏ ‚Äî —Ñ—É–Ω–¥—É–∫', cat:CAT.SWEETS, pricePerUnit:300, description:'5 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:5, label:'5 —à—Ç', price:300}},
  {id:'burfi_sesame', name:'–ë—É—Ä—Ñ–∏ ‚Äî –∫—É–Ω–∂—É—Ç–Ω—ã–π', cat:CAT.SWEETS, pricePerUnit:420, description:'7 —à—Ç / –ø–∞–∫–µ—Ç', _countPack:{count:7, label:'7 —à—Ç', price:420}},

  {id:'halva', name:'–•–∞–ª–≤–∞', cat:CAT.SWEETS, pricePerUnit:200, description:'0.2 –∫–≥ —Ñ–∏–∫—Å-–ø–∞–∫', _fixed:{label:'0.2 –∫–≥', price:200}},
  {id:'potato_pastry', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª', cat:CAT.SWEETS, pricePerUnit:330, description:'5 —à—Ç –∏–ª–∏ 2 —à—Ç', _multiPacks:[{label:'5 —à—Ç', price:330}, {label:'2 —à—Ç', price:155}]},
  {id:'cottage_casserole_plain', name:'–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è', cat:CAT.SWEETS, pricePerUnit:260, description:'250 –≥ —Ñ–∏–∫—Å-–ø–∞–∫', _fixed:{label:'250 –≥', price:260}},
  {id:'cottage_casserole_raisins', name:'–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è —Å –∏–∑—é–º–æ–º', cat:CAT.SWEETS, pricePerUnit:260, description:'250 –≥ —Ñ–∏–∫—Å-–ø–∞–∫', _fixed:{label:'250 –≥', price:260}},
  {id:'crazy_cake', name:'–ö—Ä–µ–π–∑–∏-–∫–µ–π–∫', cat:CAT.SWEETS, pricePerUnit:600, _countPack:{count:1, label:'1 —à—Ç', price:600}},
  {id:'coconut_kuchen', name:'–ö–æ–∫–æ—Å–æ–≤—ã–π –∫—É—Ö–µ–Ω', cat:CAT.SWEETS, pricePerUnit:1800, _multiPacks:[{label:'1 –∫–≥', price:1800}, {label:'0.5 –∫–≥', price:1000}]},
  {id:'napoleon', name:'–¢–æ—Ä—Ç ¬´–ù–∞–ø–æ–ª–µ–æ–Ω¬ª', cat:CAT.SWEETS, pricePerUnit:1300, description:'–ü–∞–∫–µ—Ç—ã: 1+ –∫–≥ / 0.5+ –∫–≥', _multiPacks:[{label:'1+ –∫–≥', price:1300}, {label:'0.5+ –∫–≥', price:750}]},
  {id:'apple_pie', name:'–Ø–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥', cat:CAT.SWEETS, pricePerUnit:560, _fixed:{label:'900 –≥', price:560}},
  {id:'pancakes_10', name:'–ë–ª–∏–Ω—ã ‚Äî 10 —à—Ç', cat:CAT.SWEETS, pricePerUnit:330, _countPack:{count:10, label:'10 —à—Ç', price:330}},
  {id:'pancakes_5', name:'–ë–ª–∏–Ω—ã ‚Äî 5 —à—Ç', cat:CAT.SWEETS, pricePerUnit:220, _countPack:{count:5, label:'5 —à—Ç', price:220}},
  {id:'pancakes_curd', name:'–ë–ª–∏–Ω—ã —Å —Ç–≤–æ—Ä–æ–≥–æ–º', cat:CAT.SWEETS, pricePerUnit:300, _countPack:{count:5, label:'5 —à—Ç', price:300}},
  {id:'pancakes_curd_raisins', name:'–ë–ª–∏–Ω—ã —Ç–≤–æ—Ä–æ–≥-–∏–∑—é–º', cat:CAT.SWEETS, pricePerUnit:300, _countPack:{count:5, label:'5 —à—Ç', price:300}},
  {id:'syrniki_10', name:'–°—ã—Ä–Ω–∏–∫–∏ ‚Äî 10 —à—Ç', cat:CAT.SWEETS, pricePerUnit:520, _countPack:{count:10, label:'10 —à—Ç', price:520}},
  {id:'syrniki_5', name:'–°—ã—Ä–Ω–∏–∫–∏ ‚Äî 5 —à—Ç', cat:CAT.SWEETS, pricePerUnit:280, _countPack:{count:5, label:'5 —à—Ç', price:280}},
  {id:'chapati_10', name:'–ß–∞–ø–∞—Ç–∏ ‚Äî 10 —à—Ç', cat:CAT.SWEETS, pricePerUnit:270, _countPack:{count:10, label:'10 —à—Ç', price:270}},
  {id:'chapati_wg_10', name:'–ß–∞–ø–∞—Ç–∏ (—Ü/–∑ –º—É–∫–∞) ‚Äî 10 —à—Ç', cat:CAT.SWEETS, pricePerUnit:320, _countPack:{count:10, label:'10 —à—Ç', price:320}},
];

/** –ü—Ä–∞–≤–∏–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ */
const VARIANT_RULES = {
  // –ü–∞–Ω–∏—Ä/–ê–¥—ã–≥–µ–π—Å–∫–∏–π ‚Äî —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≥—Ä–∞–º–º—ã
  paneer_classic:          {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  paneer_herbs:            {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  paneer_spice:            {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  paneer_smoked:           {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  // –°—É–ª—É–≥—É–Ω–∏ / –ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π ‚Äî —à–∞–≥ 100 –≥
  suluguni:                {type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:100},
  suluguni_smoked:         {type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:100},
  imeretinsky:             {type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:100},
  imeretinsky_dill_garlic: {type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:100},
  // –•–∞–ª–ª—É–º–∏ ‚Äî 1 —à—Ç 200/250 –≥
  halloumi_classic:        {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200,250]},
  halloumi_spicy_mix1:     {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200,250]},
  halloumi_mix_tbg:        {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200,250]},
  halloumi_sundried:       {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200,250]},
  // –ö–æ—Å–∏—á–∫–∏/–∫–ª—É–±–æ–∫/–º–æ—Ü–∞—Ä–µ–ª–ª–∞/–±—É—Ä–∞—Ç—Ç–∞
  kosichka:                {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200]},
  kosichka_smoked:         {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200]},
  spicy_ball:              {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[150]},
  mozzarella:              {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[200]},
  burrata:                 {type:'COUNT_FIXED_WEIGHT_CHOICES', gramsPerUnit:[250]},
  // –°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ
  stracciatella:           {type:'WEIGHT_CHOICES', grams:[200,250,300,500]},
  // –†–∏–∫–æ—Ç—Ç–∞ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ
  ricotta:                 {type:'WEIGHT_CHOICES', grams:[200,250,300,450]},
  ricotta_herbs:           {type:'WEIGHT_CHOICES', grams:[200,250,300,450]},
  // –ö–∞—á–æ—Ç—Ç–∞ ‚Äî –æ—Ç 200 –≥ —à–∞–≥ 100 –≥
  caciotta:                {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  caciotta_fenugreek:      {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  // –¢–≤—ë—Ä–¥—ã–µ ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ
  hard_rural:              {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  hard_smoked:             {type:'WEIGHT_CHOICES', grams:[200,300,400,500,1000]},
  // –†—É–ª–µ—Ç—ã ‚Äî –æ—Ç 100 –≥ —à–∞–≥ 50 –≥
  cheese_roll_olives_walnut:{type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:50},
  cheese_roll_apricot_pine: {type:'WEIGHT_STEP', minG:100, maxG:1000, stepG:50},

  // –ú–û–õ–û–ß–ö–ê
  milk:        {type:'LITER_CHOICES', liters:[0.5,1]},
  baked_milk:  {type:'LITER_CHOICES', liters:[0.5,1]},
  yogurt:      {type:'LITER_CHOICES', liters:[0.5,1]},
  ryazhenka:   {type:'LITER_CHOICES', liters:[0.5,1]},
  whey:        {type:'LITER_CHOICES', liters:[1]},

  cream:       {type:'LITER_CHOICES', liters:[0.2,0.5,1]},
  curd:        {type:'WEIGHT_CHOICES', grams:[500,1000,1500,2000]},
  butter:      {type:'WEIGHT_CHOICES_PLUS_FIXED', grams:[200,300,400,500,1000], fixed:{label:'1 —à—Ç (200 –≥)', price:360}},
  ghee:        {type:'WEIGHT_CHOICES', grams:[200,500,1000]},
  condensed:   {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  curd_mass_apricot: {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  curd_mass_raisins: {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  curd_mass_prunes:  {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  curd_mass_dates:   {type:'WEIGHT_STEP', minG:200, maxG:1000, stepG:100},
  mishti_dahi: {type:'HIDE_NO_PRICE'},

  // –°–õ–ê–î–û–°–¢–ò/–í–´–ü–ï–ß–ö–ê
  cookie_curd:         {type:'BAKERY_BY_KG_250G'},
  cookie_oat:          {type:'BAKERY_BY_KG_250G'},
  cookie_nut_fingers:  {type:'BAKERY_BY_KG_250G'},
  cookie_carob:        {type:'BAKERY_BY_KG_250G'},
  cookie_shortbread:   {type:'BAKERY_BY_KG_250G'},

  muffin_plain:        {type:'BAKERY_BY_KG_250G'},
  muffin_carob:        {type:'BAKERY_BY_KG_250G'},
  muffin_raisins:      {type:'BAKERY_BY_KG_250G'},

  muffin_mix_plain_raisins: {type:'FIXED_PACK'},
  muffin_mix_plain_carob:   {type:'FIXED_PACK'},
  muffin_mix_raisins_carob: {type:'FIXED_PACK'},

  sandesh_orange: {type:'COUNT_PACK'},
  sandesh_walnut: {type:'COUNT_PACK'},
  sandesh_carob:  {type:'COUNT_PACK'},

  burfi_classic: {type:'COUNT_PACK'},
  burfi_hazelnut:{type:'COUNT_PACK'},
  burfi_sesame:  {type:'COUNT_PACK'},

  halva: {type:'FIXED_PACK'},
  potato_pastry: {type:'MULTI_PACKS'},
  cottage_casserole_plain: {type:'FIXED_PACK'},
  cottage_casserole_raisins:{type:'FIXED_PACK'},
  crazy_cake: {type:'COUNT_PACK'},
  coconut_kuchen: {type:'MULTI_PACKS'},
  napoleon: {type:'MULTI_PACKS'},
  apple_pie: {type:'FIXED_PACK'},
  pancakes_10: {type:'COUNT_PACK'},
  pancakes_5: {type:'COUNT_PACK'},
  pancakes_curd: {type:'COUNT_PACK'},
  pancakes_curd_raisins: {type:'COUNT_PACK'},
  syrniki_10: {type:'COUNT_PACK'},
  syrniki_5: {type:'COUNT_PACK'},
  chapati_10: {type:'COUNT_PACK'},
  chapati_wg_10: {type:'COUNT_PACK'},
};

/* =========================
   –£—Ç–∏–ª–∏—Ç—ã
========================= */
const fmtRub = (v)=> `${CONFIG.ROUND(v).toLocaleString('ru-RU')} ‚ÇΩ`;
const clamp = (n, a, b)=> Math.max(a, Math.min(b, n));

/** –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ */
function buildVariants(product){
  const rule = VARIANT_RULES[product.id];
  if(!rule){
    console.warn('–ù–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:', product.id);
    return [];
  }
  const variants = [];
  const addWeight = (g)=> variants.push({key:`g${g}`, label:`${g} –≥`, type:'weight', grams:g});
  const addVolume = (l)=> variants.push({key:`l${l}`, label:`${l} –ª`, type:'volume', liters:l});
  const addUnitWeight = (g)=> variants.push({key:`u${g}`, label:`1 —à—Ç (${g} –≥)`, type:'unit_weight', grams:g, units:1});
  const addFixed = (label, price)=> variants.push({key:`f${label}`, label, type:'fixed', fixedPrice:price});
  switch(rule.type){
    case 'WEIGHT_CHOICES':
      rule.grams.forEach(addWeight); break;
    case 'WEIGHT_STEP':{
      const max = rule.maxG ?? CONFIG.MAX_G_DEFAULT;
      for(let g = rule.minG; g <= max; g += rule.stepG) addWeight(g);
      break;
    }
    case 'COUNT_FIXED_WEIGHT_CHOICES':
      rule.gramsPerUnit.forEach(addUnitWeight); break;
    case 'WEIGHT_CHOICES_PLUS_FIXED':
      rule.grams.forEach(addWeight);
      if(rule.fixed) addFixed(rule.fixed.label, rule.fixed.price);
      break;
    case 'LITER_CHOICES':
      rule.liters.forEach(addVolume); break;
    case 'BAKERY_BY_KG_250G':{
      for(let g = CONFIG.BAKERY_STEP_G; g <= 2000; g += CONFIG.BAKERY_STEP_G) addWeight(g);
      break;
    }
    case 'FIXED_PACK':{
      const f = product._fixed; if(f) addFixed(f.label, f.price); break;
    }
    case 'MULTI_PACKS':{
      const arr = product._multiPacks||[]; arr.forEach(p=> addFixed(p.label, p.price)); break;
    }
    case 'COUNT_PACK':{
      const c = product._countPack; if(c) addFixed(c.label, c.price); break;
    }
    case 'HIDE_NO_PRICE':
      return [];
    default:
      console.warn('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø—Ä–∞–≤–∏–ª:', rule.type);
  }
  return variants;
}

/** –¶–µ–Ω–∞ –∑–∞ 1 –µ–¥–∏–Ω–∏—Ü—É –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–æ —Å–∫–∏–¥–∫–∏ */
function unitBasePrice(product, variant){
  if(variant.type === 'fixed') return CONFIG.ROUND(variant.fixedPrice);
  if(product.pricePerKg && (variant.type === 'weight' || variant.type === 'unit_weight')){
    const grams = (variant.type === 'unit_weight') ? variant.grams : variant.grams;
    return CONFIG.ROUND(product.pricePerKg * (grams/1000));
  }
  if(product.pricePerL && variant.type === 'volume'){
    return CONFIG.ROUND(product.pricePerL * variant.liters);
  }
  if(product.pricePerUnit && variant.type === 'count'){ // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–π—á–∞—Å
    return CONFIG.ROUND(product.pricePerUnit);
  }
  if(product.pricePerUnit && variant.type === 'fixed'){
    return CONFIG.ROUND(variant.fixedPrice ?? product.pricePerUnit);
  }
  // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–Ω—É
  return NaN;
}

/** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–∏—è –≤ ¬´—Å–∫–∏–¥–∫–µ –Ω–∞ —Å—ã—Ä¬ª */
function isCheeseDiscountEligible(product, variant){
  if(product.cat !== CAT.CHEESE) return false;
  // –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ø–æ–∑–∏—Ü–∏—è–º, —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö (–≤–∫–ª—é—á–∞—è 1 —à—Ç (N –≥))
  return (variant.type === 'weight' || variant.type === 'unit_weight');
}

/** –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö */
function makeCartKey(pid, vkey){ return `${pid}__${vkey}` }

/* =========================
   –°–æ—Å—Ç–æ—è–Ω–∏–µ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage)
========================= */
const LS = {
  load(){
    try{
      const raw = localStorage.getItem('syromania_cart_v1');
      return raw ? JSON.parse(raw) : {lines:{}, createdAt: Date.now()};
    }catch(e){ console.warn('localStorage load error', e); return {lines:{}, createdAt: Date.now()} }
  },
  save(state){
    try{ localStorage.setItem('syromania_cart_v1', JSON.stringify(state)); }catch(e){ console.warn('localStorage save error', e) }
  }
};
let CART = LS.load(); // { lines: { [key]: {pid, vkey, qty} }, createdAt }

/* =========================
   –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
========================= */
const grid = document.getElementById('grid');
const qInput = document.getElementById('q');
const catFilter = document.getElementById('catFilter');
const onlyCheese = document.getElementById('onlyCheese');
const activeFilters = document.getElementById('activeFilters');
document.getElementById('resetFilters').addEventListener('click', ()=>{
  qInput.value=''; catFilter.value=''; onlyCheese.checked=CONFIG.ONLY_CHEESE_FILTER_DEFAULT; renderCatalog();
});

onlyCheese.checked = CONFIG.ONLY_CHEESE_FILTER_DEFAULT;

// –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ —Ü–µ–Ω—ã (TODO_PRICE)
const CATALOG = PRODUCTS.filter(p=>{
  const hasPrice = (typeof p.pricePerKg === 'number') || (typeof p.pricePerL === 'number') || (typeof p.pricePerUnit === 'number') || p._fixed || p._multiPacks || p._countPack;
  if(p.id === 'mishti_dahi' || !hasPrice){
    console.warn('TODO_PRICE:', p.id);
    return false;
  }
  return true;
});

function iconFor(product){ return product.ico || ICO[product.cat] || 'üõçÔ∏è' }

function minDisplayPrice(product){
  const vs = buildVariants(product);
  let min = Infinity;
  for(const v of vs){
    const base = unitBasePrice(product, v);
    if(Number.isFinite(base)) min = Math.min(min, base);
  }
  if(min === Infinity) return null;
  return fmtRub(min);
}

function renderCatalog(){
  // –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã UI
  activeFilters.innerHTML = '';
  if(qInput.value.trim()) activeFilters.appendChild(tag(`–ü–æ–∏—Å–∫: ‚Äú${qInput.value.trim()}‚Äù`));
  if(catFilter.value) activeFilters.appendChild(tag(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${catFilter.value}`));
  if(onlyCheese.checked) activeFilters.appendChild(tag('–¢–æ–ª—å–∫–æ —Å—ã—Ä—ã'));
  // —Å–ø–∏—Å–æ–∫
  grid.innerHTML = '';
  const query = qInput.value.trim().toLowerCase();
  const list = CATALOG.filter(p=>{
    if(onlyCheese.checked && p.cat !== CAT.CHEESE) return false;
    if(catFilter.value && p.cat !== catFilter.value) return false;
    if(query && !(`${p.name} ${p.cat}`.toLowerCase().includes(query))) return false;
    const variants = buildVariants(p);
    return variants.length > 0;
  });
  for(const p of list){
    const card = document.createElement('article');
    card.className = 'card';
    const minP = minDisplayPrice(p);
    card.innerHTML = `
      <div class="pic" aria-hidden="true">${iconFor(p)}</div>
      <h3>${escapeHtml(p.name)}</h3>
      <div class="muted">${p.cat}</div>
      <div class="tags">${priceBadge(p)}</div>
      ${p.description ? `<div class="notice">${escapeHtml(p.description)}</div>` : ''}
      <footer>
        <span class="price">${minP ? `–æ—Ç ${minP}` : ''}</span>
        <button class="primary" data-open="${p.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
      </footer>
    `;
    grid.appendChild(card);
  }
  // focusable cards
  grid.querySelectorAll('button[data-open]').forEach(btn=>{
    btn.addEventListener('click', ()=> openProduct(btn.getAttribute('data-open')));
  });
}
function priceBadge(product){
  let badge = '';
  if(product.pricePerKg) badge = `<span class="tag">—Ç–∞—Ä–∏—Ñ: ${fmtRub(product.pricePerKg)} / –∫–≥</span>`;
  else if(product.pricePerL) badge = `<span class="tag">—Ç–∞—Ä–∏—Ñ: ${fmtRub(product.pricePerL)} / –ª</span>`;
  else if(product.pricePerUnit) badge = `<span class="tag">${fmtRub(product.pricePerUnit)} / –ø–∞–∫–µ—Ç</span>`;
  return badge;
}
function tag(text){ const k=document.createElement('kbd'); k.className='badge'; k.textContent=text; return k }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }

qInput.addEventListener('input', renderCatalog);
catFilter.addEventListener('change', renderCatalog);
onlyCheese.addEventListener('change', renderCatalog);

/* =========================
   –ú–æ–¥–∞–ª —Ç–æ–≤–∞—Ä–∞
========================= */
const productDialog = document.getElementById('productDialog');
const closeProductBtn = document.getElementById('closeProduct');
const prodPic = document.getElementById('prodPic');
const prodCat = document.getElementById('prodCat');
const prodName = document.getElementById('prodName');
const prodSku = document.getElementById('prodSku');
const prodDesc = document.getElementById('prodDesc');
const variantSelect = document.getElementById('variantSelect');
const variantQty = document.getElementById('variantQty');
const variantPrice = document.getElementById('variantPrice');
const variantPriceNote = document.getElementById('variantPriceNote');
const discountHint = document.getElementById('discountHint');
const addToCartBtn = document.getElementById('addToCart');

let CURRENT_PRODUCT = null;
let CURRENT_VARIANTS = [];
function openProduct(pid){
  const p = CATALOG.find(x=>x.id===pid);
  if(!p) return;
  CURRENT_PRODUCT = p;
  CURRENT_VARIANTS = buildVariants(p);
  prodPic.textContent = iconFor(p);
  prodCat.textContent = p.cat;
  prodName.textContent = p.name;
  prodSku.textContent = `–ê—Ä—Ç–∏–∫—É–ª: ${p.id}`;
  prodDesc.textContent = p.description || '';
  variantSelect.innerHTML = '';
  CURRENT_VARIANTS.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v.key; opt.textContent = v.label;
    variantSelect.appendChild(opt);
  });
  variantQty.value = 1;
  updateVariantPriceUI();
  productDialog.showModal();
  addToCartBtn.disabled = false;
}
function currentVariant(){
  const key = variantSelect.value;
  return CURRENT_VARIANTS.find(v=>v.key===key);
}
variantSelect.addEventListener('change', updateVariantPriceUI);
variantQty.addEventListener('input', ()=>{ variantQty.value = Math.max(1, parseInt(variantQty.value||'1',10)); updateVariantPriceUI(); });
closeProductBtn.addEventListener('click', ()=> productDialog.close());

function updateVariantPriceUI(){
  const p = CURRENT_PRODUCT; if(!p) return;
  const v = currentVariant(); if(!v){ variantPrice.textContent='‚Äî'; addToCartBtn.disabled = true; return; }
  const qty = parseInt(variantQty.value||'1', 10);
  const base = unitBasePrice(p, v);
  if(!Number.isFinite(base)){ variantPrice.textContent='–û—à–∏–±–∫–∞ —Ü–µ–Ω—ã'; addToCartBtn.disabled = true; return; }
  const rates = computeDiscountRatesPreviewWithItem(p, v, qty);
  const rate = rates[p.id] || 0;
  const up = CONFIG.ROUND(base * (1 - rate));
  variantPrice.textContent = `${fmtRub(up)} √ó ${qty} = ${fmtRub(up * qty)}`;
  const note = [];
  if(p.pricePerKg && (v.type==='weight'||v.type==='unit_weight')) note.push('–¶–µ–Ω–∞ —Ä–∞—Å—á—ë—Ç–Ω–∞—è –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ /–∫–≥');
  if(p.pricePerL && v.type==='volume') note.push('–¶–µ–Ω–∞ —Ä–∞—Å—á—ë—Ç–Ω–∞—è –∏–∑ —Ç–∞—Ä–∏—Ñ–∞ /–ª');
  variantPriceNote.textContent = note.join(' ‚Ä¢ ');
  if(rate>0){
    discountHint.textContent = `–°–∫–∏–¥–∫–∞ –Ω–∞ —ç—Ç–æ—Ç –≤–∏–¥ —Å—ã—Ä–∞: ${(rate*100)|0}%`;
  }else{
    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–æ –∫–∞–∫–æ–π –≥—Ä–∞–Ω–∏—Ü—ã –æ—Å—Ç–∞–ª–æ—Å—å
    if(isCheeseDiscountEligible(p,v)){
      const curG = currentCheeseGramsById(p.id);
      const vG = (v.type==='unit_weight'||v.type==='weight') ? v.grams : 0;
      const totalG = curG + vG*qty;
      const next = CONFIG.DISCOUNT_THRESHOLDS.slice().reverse().find(th=> totalG < th.g);
      if(next){
        discountHint.textContent = `–î–æ–±–∞–≤—å—Ç–µ –µ—â—ë ${(next.g - totalG)} –≥ —ç—Ç–æ–≥–æ —Å—ã—Ä–∞ –¥–ª—è —Å–∫–∏–¥–∫–∏ ${(CONFIG.DISCOUNT_THRESHOLDS.find(x=>x.g===next.g).rate*100)|0}%`;
      }else{
        discountHint.textContent = '';
      }
    }else{
      discountHint.textContent = '';
    }
  }
}
addToCartBtn.addEventListener('click', ()=>{
  const p = CURRENT_PRODUCT; const v = currentVariant();
  if(!p || !v){ variantSelect.focus(); return; }
  const qty = clamp(parseInt(variantQty.value||'1', 10), 1, 999);
  const key = makeCartKey(p.id, v.key);
  if(!CART.lines[key]) CART.lines[key] = {pid:p.id, vkey:v.key, qty:0};
  CART.lines[key].qty += qty;
  LS.save(CART);
  productDialog.close();
  renderCartBar();
});

/* =========================
   –°–∫–∏–¥–∫–∏ –Ω–∞ —Å—ã—Ä: —Ä–∞—Å—á—ë—Ç –ø–æ –∫–æ—Ä–∑–∏–Ω–µ
========================= */
function currentCheeseGramsById(pid){
  let grams = 0;
  for(const k in CART.lines){
    const line = CART.lines[k];
    if(line.pid !== pid) continue;
    const product = CATALOG.find(p=>p.id===line.pid);
    if(!product) continue;
    const variant = buildVariants(product).find(v=>v.key===line.vkey);
    if(!variant) continue;
    if(isCheeseDiscountEligible(product, variant)){
      const gPerUnit = variant.grams;
      grams += gPerUnit * line.qty;
    }
  }
  return grams;
}
function computeDiscountRates(){
  // –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≥—Ä–∞–º–º—ã –ø–æ id –ø—Ä–æ–¥—É–∫—Ç–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—ã—Ä–æ–≤
  const gramsById = {};
  for(const k in CART.lines){
    const line = CART.lines[k];
    const p = CATALOG.find(x=>x.id===line.pid); if(!p) continue;
    const v = buildVariants(p).find(v=>v.key===line.vkey); if(!v) continue;
    if(isCheeseDiscountEligible(p, v)){
      gramsById[p.id] = (gramsById[p.id]||0) + (v.grams * line.qty);
    }
  }
  const rates = {};
  for(const pid in gramsById){
    const g = gramsById[pid];
    let rate = 0;
    for(const th of CONFIG.DISCOUNT_THRESHOLDS){
      if(g >= th.g){ rate = Math.max(rate, th.rate); }
    }
    rates[pid] = rate;
  }
  return rates;
}
// –ø—Ä–µ–≤—å—é —Å —É—á—ë—Ç–æ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
function computeDiscountRatesPreviewWithItem(product, variant, qty){
  const tmp = JSON.parse(JSON.stringify(CART));
  const key = makeCartKey(product.id, variant.key);
  if(!tmp.lines[key]) tmp.lines[key] = {pid:product.id, vkey:variant.key, qty:0};
  tmp.lines[key].qty += qty;
  const gramsById = {};
  for(const k in tmp.lines){
    const line = tmp.lines[k];
    const p = CATALOG.find(x=>x.id===line.pid); if(!p) continue;
    const v = buildVariants(p).find(v=>v.key===line.vkey); if(!v) continue;
    if(isCheeseDiscountEligible(p, v)){
      gramsById[p.id] = (gramsById[p.id]||0) + (v.grams * line.qty);
    }
  }
  const rates = {};
  for(const pid in gramsById){
    const g = gramsById[pid];
    let rate = 0;
    for(const th of CONFIG.DISCOUNT_THRESHOLDS){
      if(g >= th.g){ rate = Math.max(rate, th.rate); }
    }
    rates[pid] = rate;
  }
  return rates;
}

/* =========================
   –ö–æ—Ä–∑–∏–Ω–∞ ‚Äî —Ä–∞—Å—á—ë—Ç –∏ UI
========================= */
const cartBar = document.getElementById('cartBar');
const barText = document.getElementById('barText');
const barSum = document.getElementById('barSum');
const barSend = document.getElementById('barSend');
const cartDialog = document.getElementById('cartDialog');
const cartTableBody = document.querySelector('#cartTable tbody');
const cartEmpty = document.getElementById('cartEmpty');
const cartTotalEl = document.getElementById('cartTotal');
const cartCountEl = document.getElementById('cartCount');
const cartNote = document.getElementById('cartNote');
const cartDiscountFlag = document.getElementById('cartDiscountFlag');
const orderExtras = document.getElementById('orderExtras');
const orderComment = document.getElementById('orderComment');

document.getElementById('closeCart').addEventListener('click', ()=> cartDialog.close());
document.getElementById('clearCart').addEventListener('click', ()=>{
  CART.lines = {}; LS.save(CART); renderCartBar(); if(cartDialog.open) renderCartModal();
});
cartBar.addEventListener('click', ()=> { renderCartModal(); cartDialog.showModal(); });
cartBar.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); cartBar.click(); }});
barSend.addEventListener('click', ()=> { renderCartModal(); sendCart(); });
document.getElementById('sendCart').addEventListener('click', sendCart);

function enrichLine(line){
  const p = CATALOG.find(x=>x.id===line.pid);
  if(!p) return null;
  const v = buildVariants(p).find(v=>v.key===line.vkey);
  if(!v) return null;
  const baseUnit = unitBasePrice(p, v);
  const rates = computeDiscountRates();
  const rate = isCheeseDiscountEligible(p, v) ? (rates[p.id]||0) : 0;
  const unit = CONFIG.ROUND(baseUnit * (1 - rate));
  const total = unit * line.qty;
  return { ...line, product:p, variant:v, unitBase: baseUnit, discountRate: rate, unitPrice: unit, lineTotal: total };
}
function cartSummary(){
  const items = [];
  for(const k in CART.lines){
    const e = enrichLine(CART.lines[k]);
    if(e) items.push(e);
  }
  const total = items.reduce((s,i)=> s + i.lineTotal, 0);
  const count = items.reduce((s,i)=> s + i.qty, 0);
  const anyDiscount = items.some(i=> i.discountRate>0);
  return {items, total, count, anyDiscount};
}
function renderCartBar(){
  const {total, count} = cartSummary();
  barText.textContent = count ? `${count} –ø–æ–∑.` : '0 –ø–æ–∑–∏—Ü–∏–π';
  barSum.textContent = fmtRub(total);
  updateMainButton(count, total);
}
function renderCartModal(){
  orderExtras.classList.toggle('hidden', !CONFIG.SHOW_COMMENT_FIELD);
  const {items, total, count, anyDiscount} = cartSummary();
  cartEmpty.classList.toggle('hidden', items.length>0);
  cartTableBody.innerHTML = '';
  for(const it of items){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="min-width:160px"><div style="font-weight:600">${escapeHtml(it.product.name)}</div><div class="muted">${it.product.cat}</div></td>
      <td>${escapeHtml(it.variant.label)}</td>
      <td><div>${fmtRub(it.unitPrice)}</div><div class="notice">${it.discountRate>0 ? `—Å–∫–∏–¥–∫–∞ ${(it.discountRate*100)|0}%` : ''}</div></td>
      <td class="qty">
        <button class="ghost" data-dec="${it.pid}__${it.vkey}" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
        <input type="number" min="1" value="${it.qty}" data-qty="${it.pid}__${it.vkey}">
        <button class="ghost" data-inc="${it.pid}__${it.vkey}" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
      </td>
      <td>${fmtRub(it.lineTotal)}</td>
      <td><button class="ghost" data-del="${it.pid}__${it.vkey}" aria-label="–£–¥–∞–ª–∏—Ç—å">‚úï</button></td>
    `;
    cartTableBody.appendChild(tr);
  }
  cartTotalEl.textContent = fmtRub(total);
  cartCountEl.textContent = `${count} –ø–æ–∑.`;
  cartDiscountFlag.textContent = anyDiscount ? '–ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Å–∫–∏–¥–∫–∏ –Ω–∞ —Å—ã—Ä' : '';
  cartNote.textContent = '–°–∫–∏–¥–∫–∏ –Ω–∞ —Å—ã—Ä: ‚â•500 –≥ ‚Äî 5%, ‚â•700 –≥ ‚Äî 10%, ‚â•1000 –≥ ‚Äî 15% (–ø–æ –æ–¥–Ω–æ–º—É –≤–∏–¥—É).';

  // handlers
  cartTableBody.querySelectorAll('button[data-dec]').forEach(b=> b.addEventListener('click', onDec));
  cartTableBody.querySelectorAll('button[data-inc]').forEach(b=> b.addEventListener('click', onInc));
  cartTableBody.querySelectorAll('button[data-del]').forEach(b=> b.addEventListener('click', onDel));
  cartTableBody.querySelectorAll('input[data-qty]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const key = inp.getAttribute('data-qty');
      const n = clamp(parseInt(inp.value||'1',10), 1, 999);
      CART.lines[key].qty = n; LS.save(CART); renderCartModal(); renderCartBar();
    });
  });
}
function onDec(e){ const key = e.currentTarget.getAttribute('data-dec'); if(!CART.lines[key]) return; CART.lines[key].qty = Math.max(1, CART.lines[key].qty-1); LS.save(CART); renderCartModal(); renderCartBar(); }
function onInc(e){ const key = e.currentTarget.getAttribute('data-inc'); if(!CART.lines[key]) return; CART.lines[key].qty = Math.min(999, CART.lines[key].qty+1); LS.save(CART); renderCartModal(); renderCartBar(); }
function onDel(e){ const key = e.currentTarget.getAttribute('data-del'); delete CART.lines[key]; LS.save(CART); renderCartModal(); renderCartBar(); }

/* =========================
   –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞ (Telegram.WebApp.sendData)
========================= */
function buildPayload(){
  const {items, total} = cartSummary();
  const itemsOut = items.map(it=>({
    id: it.product.id,
    name: it.product.name,
    cat: it.product.cat,
    variant: it.variant.label,
    qty: it.qty,
    unit_price_base: it.unitBase,
    discount_rate: it.discountRate,
    unit_price: it.unitPrice,
    line_total: it.lineTotal
  }));
  const meta = {
    ts: Date.now(),
    schema_ver: CONFIG.PAYLOAD_SCHEMA_VERSION,
    puzzlebot_hint: CONFIG.PUZZLEBOT_HINT ? { target:'inline_button->bot', webhook_hint: CONFIG.WEBHOOK_HINT } : undefined,
  };
  const comment = CONFIG.SHOW_COMMENT_FIELD ? (orderComment.value||'') : '';
  const payload = {
    type: 'cart',
    source: 'miniapp',
    currency: 'RUB',
    items: itemsOut,
    total,
    comment,
    meta
  };
  return payload;
}
function sendCart(){
  const {count} = cartSummary();
  if(count===0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return; }
  const payload = JSON.stringify( buildPayload() );
  try{
    tg.sendData(payload);
  }catch(err){
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –°–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å.'); console.error(err); console.log('payload:', payload);
  }
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
  try{ tg.close(); }catch(e){ /* preview mode */ }
}

/* =========================
   Telegram MainButton
========================= */
function updateMainButton(count, total){
  const text = count ? `–û—Ç–ø—Ä–∞–≤–∏—Ç—å ‚Ä¢ ${fmtRub(total)}` : '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
  try{
    tg.MainButton.setText(text);
    if(count){ tg.MainButton.show(); } else { tg.MainButton.hide(); }
    tg.MainButton.offClick?.();
    tg.MainButton.onClick(()=> sendCart());
  }catch(e){ /* preview fallback */ }
}

/* =========================
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
========================= */
renderCatalog();
renderCartBar();

/* =========================
   –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã (–∫–æ–Ω—Å–æ–ª—å)
   ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ–π—Å–æ–≤ (4)
========================= */
(function runTests(){
  const clone = (x)=> JSON.parse(JSON.stringify(x));
  function add(pid, vkey, qty){ const k = makeCartKey(pid, vkey); if(!CART.lines[k]) CART.lines[k]={pid, vkey, qty:0}; CART.lines[k].qty+=qty }
  const original = clone(CART);

  // –ö–µ–π—Å A ‚Äî –ö–∞—á–æ—Ç—Ç–∞ 2150 ‚ÇΩ/–∫–≥; 200 –≥ √ó1 –∏ 300 –≥ √ó1 -> –∏—Ç–æ–≥ 1022 ‚ÇΩ
  CART.lines = {};
  const caciotta = CATALOG.find(p=>p.id==='caciotta'); const v200 = buildVariants(caciotta).find(v=>v.grams===200);
  const v300 = buildVariants(caciotta).find(v=>v.grams===300);
  add('caciotta', v200.key, 1); add('caciotta', v300.key, 1);
  let sumA = cartSummary().total;
  console.log('[TEST A] –æ–∂–∏–¥–∞–µ–º–æ 1022 ‚ÇΩ ->', sumA, 'OK?', sumA===1022);

  // –ö–µ–π—Å B ‚Äî –°—É–ª—É–≥—É–Ω–∏ 1400 ‚ÇΩ/–∫–≥; 250 –≥ √ó2 –∏ 300 –≥ √ó1 -> 1008 ‚ÇΩ
  CART.lines = {};
  const sul = CATALOG.find(p=>p.id==='suluguni');
  const v250s = buildVariants(sul).find(v=>v.grams===200) ? null : null; // ensure search below
  const v250 = buildVariants(sul).find(v=>v.grams===250);
  const v300b = buildVariants(sul).find(v=>v.grams===300);
  add('suluguni', v250.key, 2); add('suluguni', v300b.key, 1);
  let sumB = cartSummary().total;
  console.log('[TEST B] –æ–∂–∏–¥–∞–µ–º–æ 1008 ‚ÇΩ ->', sumB, 'OK?', sumB===1008);

  // –ö–µ–π—Å C ‚Äî –•–∞–ª–ª—É–º–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π (1 —à—Ç, 250 –≥) -> 413 ‚ÇΩ
  CART.lines = {};
  const hal = CATALOG.find(p=>p.id==='halloumi_classic');
  const v250u = buildVariants(hal).find(v=>v.type==='unit_weight' && v.grams===250);
  add('halloumi_classic', v250u.key, 1);
  let sumC = cartSummary().total;
  console.log('[TEST C] –æ–∂–∏–¥–∞–µ–º–æ 413 ‚ÇΩ ->', sumC, 'OK?', sumC===413);

  // –ö–µ–π—Å D ‚Äî –ô–æ–≥—É—Ä—Ç 0.5 –ª -> 115 ‚ÇΩ
  CART.lines = {};
  const yog = CATALOG.find(p=>p.id==='yogurt');
  const v05 = buildVariants(yog).find(v=>v.type==='volume' && v.liters===0.5);
  add('yogurt', v05.key, 1);
  let sumD = cartSummary().total;
  console.log('[TEST D] –æ–∂–∏–¥–∞–µ–º–æ 115 ‚ÇΩ ->', sumD, 'OK?', sumD===115);

  CART = original; LS.save(CART); renderCartBar();
})();

/* =========================
   –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: —Ñ–æ–∫—É—Å –Ω–∞ Esc ‚Äî –∑–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫
========================= */
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){
    if(productDialog.open) productDialog.close();
    if(cartDialog.open) cartDialog.close();
  }
});
</script>
</body>
</html>
