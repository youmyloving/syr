<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Сыромания</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #F8EFDA;
      --text-color: #2E2A23;
      --hint-color: #8A7F6A;
      --link-color: #8B5E34;
      --button-text-color: #ffffff;
      --secondary-bg-color: #FFF6E7;
      --header-bg-color: #FFF9EF;
      --section-bg-color: #ffffff;
      --border-color: #E7D8BF;
      --error-color: #E74C3C;
      --success-color: #2E8B57;
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      --radius-lg: 12px;

      --accent-start: #82571c;
      --accent-end: #bd9952;
      --accent-gradient: linear-gradient(135deg, #82571c, #bd9952);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background-color: var(--bg-color);
      background-image:
        radial-gradient(circle at 0 0, rgba(189,153,82,0.15), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(130,87,28,0.10), transparent 55%);
      color: var(--text-color);
      font-family: var(--font-family);
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background-color: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color);
      padding: 10px 10px 8px;
      flex-shrink: 0;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--secondary-bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--hint-color);
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-name {
      font-weight: 600;
    }

    .location-strip {
      font-size: 12px;
      color: var(--hint-color);
      margin-bottom: 6px;
    }

    .search-container {
      margin-bottom: 8px;
    }

    #search-input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      font-size: 16px;
    }

    .filters-container {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .filters-container select,
    .filters-container label {
      font-size: 13px;
    }

    #category-filter {
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      flex-grow: 1;
    }

    #only-cheese-toggle,
    #favorites-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .favorites-bar {
      display: none;
      gap: 8px;
      overflow-x: auto;
      padding: 6px 0 0;
      margin-top: 4px;
    }

    .fav-chip {
      background: #ffffff;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 6px 10px;
      font-size: 13px;
      white-space: nowrap;
      cursor: pointer;
    }

    main {
      flex-grow: 1;
      padding: 10px;
      padding-bottom: 100px;
    }

    .section {
      margin-bottom: 22px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 800;
      margin: 16px 0 10px;
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 246, 231, 0.95);
      box-shadow: 0 0 0 1px rgba(189,153,82,0.15);
    }

    .section-title::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-image: var(--accent-gradient);
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .product-card {
      border-radius: var(--radius-lg);
      padding: 10px;
      background-color: var(--section-bg-color);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.04);
      border: 1px solid rgba(231,216,191,0.9);
    }

    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }

    .product-thumb {
      width: 100%;
      height: 110px;
      border-radius: 10px;
      background: var(--secondary-bg-color);
      overflow: hidden;
      margin-bottom: 8px;
    }

    .product-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .name {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
      min-height: 32px;
    }

    .product-row {
      display: flex;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .price {
      color: var(--hint-color);
      font-size: 13px;
      max-width: 60%;
    }

    .badge-piece {
      font-size: 11px;
      color: #6b5c48;
      background: #F4E8D3;
      border: 1px dashed #d9c6a6;
      padding: 2px 6px;
      border-radius: 8px;
      margin-left: auto;
      text-align: right;
    }

    .fav-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #c78f5b;
      flex-shrink: 0;
    }

    .fav-btn.active {
      color: #8B5E34;
    }

    .cart-footer {
      position: sticky;
      bottom: 0;
      background-color: var(--header-bg-color);
      border-top: 1px solid var(--border-color);
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
      z-index: 2;
    }

    #open-cart-btn {
      background-image: var(--accent-gradient);
      color: var(--button-text-color);
      padding: 12px 24px;
      border-radius: 24px;
      cursor: pointer;
      border: none;
      font-size: 16px;
      font-weight: 700;
      width: 100%;
      max-width: 520px;
      transition: filter 0.18s;
    }

    #open-cart-btn:hover {
      filter: brightness(1.05);
    }

    #open-cart-btn:disabled {
      background-image: none;
      background-color: var(--hint-color);
      cursor: not-allowed;
    }

    dialog {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 0;
      background-color: var(--section-bg-color);
      color: var(--text-color);
      width: 92vw;
      max-width: 520px;
      max-height: 86vh;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }

    dialog::backdrop {
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
    }

    .modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--header-bg-color);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--hint-color);
      padding: 0;
      line-height: 1;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: grid;
      place-items: center;
    }

    .modal-close:hover {
      background-color: var(--secondary-bg-color);
    }

    .modal-body {
      padding: 14px 16px 16px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      font-weight: 600;
    }

    .form-group select,
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      font-size: 16px;
    }

    .product-desc {
      color: var(--hint-color);
      font-size: 13px;
      margin: 2px 0 10px;
    }

    .notice {
      font-size: 12px;
      color: var(--hint-color);
    }

    .variant-extra {
      margin-top: 4px;
    }

    .custom-weight-group {
      margin-top: 6px;
    }

    .custom-weight-input.is-disabled {
      opacity: 0.6;
    }

    .custom-weight-footer {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .checkbox-line {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .price-display {
      font-size: 18px;
      font-weight: 800;
      text-align: center;
      margin: 14px 0 10px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      width: 100%;
      transition: transform 0.08s, filter 0.18s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background-image: var(--accent-gradient);
      color: var(--button-text-color);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
    }

    .btn-secondary {
      background-color: var(--secondary-bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background-color: #fdeed6;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-info {
      flex-grow: 1;
      padding-right: 10px;
    }

    .cart-item-name {
      font-weight: 800;
    }

    .cart-item-variant {
      font-size: 13px;
      color: var(--hint-color);
    }

    .cart-item-price {
      font-size: 14px;
    }

    .discount-hint {
      color: var(--success-color);
      font-size: 12px;
      margin-top: 4px;
    }

    .qty-control {
      display: flex;
      align-items: center;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      overflow: hidden;
    }

    .qty-control button {
      background: none;
      border: none;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      color: var(--text-color);
      display: grid;
      place-items: center;
    }

    .qty-control button:hover {
      background-color: var(--secondary-bg-color);
    }

    .qty-control span {
      padding: 0 10px;
      min-width: 30px;
      text-align: center;
    }

    .cart-summary {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 2px solid var(--border-color);
      font-size: 18px;
      font-weight: 900;
      text-align: right;
    }

    .error-text {
      color: var(--error-color);
      font-size: 13px;
      margin-top: 6px;
    }

    .weighing-note {
      font-size: 12px;
      color: #8b5e34;
      background: #fff2df;
      border: 1px dashed #e9cda7;
      border-radius: 10px;
      padding: 8px 10px;
      margin-top: 10px;
      text-align: right;
    }

    @media (max-width: 480px) {
      .product-thumb { height: 100px; }
      .modal-body { padding-bottom: 18px; }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>
      <div class="location-strip">Принимаем заказы в <strong>Пензе</strong> и <strong>Москве</strong>.</div>

      <div class="search-container">
        <input type="search" id="search-input" placeholder="Поиск по названию..." />
      </div>

      <div class="filters-container">
        <select id="category-filter">
          <option value="">Все категории</option>
        </select>
        <label id="only-cheese-toggle">
          <input type="checkbox" id="only-cheese-checkbox" />
          <span>Только сыры</span>
        </label>
        <label id="favorites-toggle">
          <input type="checkbox" id="only-fav-checkbox" />
          <span>Избранное</span>
        </label>
      </div>

      <div class="favorites-bar" id="favorites-bar"></div>
    </header>

    <main id="main"></main>

    <footer class="cart-footer">
      <button id="open-cart-btn" disabled>Корзина пуста</button>
    </footer>
  </div>

  <!-- Product modal -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title"></h2>
      <button class="modal-close" onclick="closeProductModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="product-desc" id="product-modal-description"></div>

      <div class="form-group">
        <label for="product-variant-select">Вариант</label>
        <select id="product-variant-select"></select>
        <div class="notice variant-extra" id="variant-hint"></div>
        <div class="notice" id="piece-badge" style="display:none;margin-top:4px"></div>
      </div>

      <div class="form-group" id="flavour-group" style="display:none">
        <label for="product-flavour-select">Вкус</label>
        <select id="product-flavour-select"></select>
      </div>

      <div class="form-group custom-weight-group" id="custom-weight-group" style="display:none">
        <label for="product-custom-weight">Свой вес, г</label>
        <input
          type="number"
          id="product-custom-weight"
          class="custom-weight-input is-disabled"
          min="10"
          step="50"
          placeholder="Например, 350"
          disabled
        />
        <div class="custom-weight-footer">
          <label class="checkbox-line">
            <input type="checkbox" id="use-custom-weight-checkbox" />
            <span>Указать свой вес</span>
          </label>
          <div class="notice">Можно ввести любой вес (например, 202 г). Скидки по сырам считаются автоматически.</div>
        </div>
      </div>

      <div class="form-group">
        <label for="product-qty-input">Количество</label>
        <input type="number" id="product-qty-input" value="1" min="1" />
      </div>

      <div class="price-display" id="product-modal-price">0 ₽</div>
      <button class="btn btn-primary" id="add-to-cart-btn">Добавить в корзину</button>
    </div>
  </dialog>

  <!-- Cart + checkout modal -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>Корзина</h2>
      <button class="modal-close" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="modal-body" id="cart-modal-body"></div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // ===== CONFIG =====
    const BACKEND = 'https://puzzlebot-webhook-handler1.onrender.com';
    const CURRENCY = 'RUB';
    const ROUND = Math.round;
    const DISCOUNT_THRESHOLDS = [
      { g: 1000, rate: 0.15 },
      { g:  700, rate: 0.10 },
      { g:  500, rate: 0.05 },
    ];
    const ONLY_CHEESE_FILTER_DEFAULT = false;
    const PAYLOAD_SCHEMA_VERSION = 'v2';
    const STORAGE_CART_KEY = 'syromania-cart';
    const STORAGE_CHECKOUT_KEY = 'syromania-checkout';
    const STORAGE_FAV_KEY = 'syromania-favorites';
    const DEFAULT_IMG = 'https://static.tildacdn.com/tild3134-3861-4539-a363-646133333238/__.webp';

    function fmtRub(n) {
      return new Intl.NumberFormat('ru-RU').format(Math.round(n || 0)) + ' ₽';
    }

    // Промокоды — сейчас пусто. Лучше держать на бэкенде.
    const PROMO_CODES = {
      // 'SYR5': { type: 'percent', value: 5, note: 'Скидка 5%' },
      // 'HELLOSYR': { type: 'fixed', value: 100, note: '-100 ₽' },
    };

    // ===== GROUPS =====
    const GROUPS = [
      { id: 'brined',  title: 'Рассольные сыры' },
      { id: 'soft',    title: 'Мягкие сыры' },
      { id: 'hard',    title: 'Твёрдые сыры' },
      { id: 'rolls',   title: 'Сырные рулеты' },
      { id: 'dairy',   title: 'Молочная продукция' },
      { id: 'sweets',  title: 'Сладости' },
      { id: 'bakery',  title: 'Выпечка' },
    ];
    const CHEESE_GROUP_IDS = new Set(['brined','soft','hard','rolls']);

    // ===== DATA: PRODUCTS =====
    const PRODUCTS = [
      // --- Рассольные / мягкие / твёрдые сыры ---
      { id:'mozzarella', name:'Моцарелла', group:'brined', pricePerKg:2000,
        description:'Моцарелла с нежной текстурой. Идеальна для салатов и запекания. Срок хранения: 3–5 суток в холодильнике.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/mozzarella.webp' },

      { id:'buratta', name:'Буратта', group:'brined', pricePerKg:2100,
        description:'Мешочек из моцареллы с начинкой из страчателлы. Идеальна к салатам с зеленью и томатами. Срок хранения: 3–5 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/mozzarella-2.webp' },

      { id:'stracciatella', name:'Страчателла', group:'brined', pricePerKg:2150,
        description:'Нити моцареллы в сливках. Срок хранения: 5–7 суток в холодильнике.',
        img:'https://static.tildacdn.com/tild3832-6430-4462-b663-353438383930/stracciatella.webp' },

      { id:'ricotta', name:'Творожный сыр (рикотта)', group:'soft', pricePerKg:1400,
        description:'Нежный сыр, подходит и к бутербродам, и к блюдам. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/ricotta.webp' },

      { id:'ricotta-herbs', name:'Рикотта с укропом и зеленью', group:'soft', pricePerKg:1500,
        description:'Нежный, свежий, универсальный — лучше попробовать! Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/ricotta-herbs.webp' },

      { id:'caciotta', name:'Качотта', group:'soft', pricePerKg:2200,
        description:'Мягкий итальянский сыр. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild6165-3265-4834-a236-366661346562/caciotta.webp' },

      { id:'caciotta-fenugreek', name:'Качотта с пажитником', group:'soft', pricePerKg:2250,
        description:'С ореховым привкусом пажитника. Срок хранения: 7 суток.',
        img: null },

      { id:'hard-village', name:'Твёрдый по-деревенски', group:'hard', pricePerKg:1600,
        description:'Готовится из творога с приправами, обжаривается. Срок хранения: 7 суток в холодильнике.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/hard-village.webp' },

      { id:'hard-smoked', name:'Твёрдый копчёный', group:'hard', pricePerKg:1800,
        description:'Готовится из творога с приправами, обжаривается и коптится. Нежный копчёный вкус. Срок хранения: до 30 суток.',
        img:'https://static.tildacdn.com/tild6662-3930-4663-b132-316135626136/hard-smoked.webp' },

      { id:'rolls-olives-walnut', name:'Сырный рулет (маслины, грецкий орех)', group:'rolls', pricePerKg:1700,
        description:'Можно подать как закуску к любому столу. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-olives-walnut.webp' },

      { id:'rolls-apricot-cedar', name:'Сырный рулет (курага, кедровый орех)', group:'rolls', pricePerKg:1700,
        description:'Слегка сладковатый благодаря творожному сыру, кураге и орехам. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/rolls-apricot-cedar.webp' },

      // Адыгейские
      { id:'panir-classic', name:'Адыгейский (панир) классический', group:'soft', pricePerKg:1450,
        description:'Очень нежный, мягкий, молочный вкус. Сыр, который нравится всем. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-classic.webp' },

      { id:'panir-herbs', name:'Адыгейский с зеленью (панир)', group:'soft', pricePerKg:1600,
        description:'Лёгкий, свежий, будто глоток прохладной воды в жару. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-herbs.webp' },

      { id:'panir-spicy', name:'Адыгейский со специями (панир)', group:'soft', pricePerKg:1650,
        description:'Вкус не острый, но очень ароматный, специи подобраны в меру. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-spicy.webp' },

      { id:'panir-smoked', name:'Адыгейский копчёный (панир)', group:'soft', pricePerKg:1700,
        description:'Приятный аромат копчёности, вкус гармоничный, без резкости. Срок хранения: 30 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/panir-smoked.webp' },

      // Сулугуни / Имеретинский / Халлуми / Косичка / Пряные клубочки
      { id:'suluguni', name:'Сулугуни', group:'brined', pricePerKg:1700,
        description:'Умеренно солёный вкус, плотная, слоистая и эластичная консистенция. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild3238-3866-4366-a436-623236363261/suluguni.webp' },

      { id:'suluguni-smoked', name:'Сулугуни копчёный', group:'brined', pricePerKg:1800,
        description:'С лёгкой копчёностью, плотная и эластичная структура. Срок хранения: 30 суток.',
        img:'https://static.tildacdn.com/tild6435-3838-4463-b431-353765323333/suluguni-smoked.webp' },

      { id:'imeretian', name:'Имеретинский', group:'brined', pricePerKg:1500,
        description:'Прекрасный рассольный сыр, подходит ко всем блюдам. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/imeretian.webp' },

      { id:'imeretian-dill-garlic', name:'Имеретинский с укропом и чесноком', group:'brined', pricePerKg:1600,
        description:'Свежий рассольный сыр с ароматной зеленью и чесноком. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild6435-3539-4337-a561-386438636230/__.webp' },

      { id:'halloumi', name:'Халлуми (классический)', group:'brined', pricePerKg:1950,
        description:'Идеален для жарки на сковороде или гриле — появляется хрустящая корочка. Можно есть и без обжарки. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild3161-6362-4130-b134-623331346238/halloumi.webp' },

      { id:'halloumi-paprika-oregano', name:'Халлуми с паприкой и орегано', group:'brined', pricePerKg:2100,
        description:'Идеален для жарки, с ароматом паприки и орегано. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild3133-6165-4134-b335-396662633262/halloumi-paprika-ore.webp' },

      { id:'halloumi-tomato-basil-garlic', name:'Халлуми томат-базилик-чеснок', group:'brined', pricePerKg:2100,
        description:'С яркими томатными нотками, хорошо жарится до корочки. Срок хранения: 7 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/halloumi-tomato-basil-garlic.webp' },

      { id:'halloumi-tomato-paprika', name:'Халлуми с вялеными помидорами и паприкой', group:'brined', pricePerKg:2100,
        description:'Яркий вкус с вялеными томатами и паприкой. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild3863-3030-4439-a439-653238303862/halloumi-tomato-papr.webp' },

      { id:'kosichka', name:'Косичка (1 шт ~200 г)', group:'brined', pricePerKg:1900,
        description:'Слегка солёный сыр в виде косички. Срок хранения: 7 суток.',
        img:null },

      { id:'kosichka-smoked', name:'Косичка копчёная (1 шт ~200 г)', group:'brined', pricePerKg:2000,
        description:'Косичка холодного копчения, лёгкая солёность. Срок хранения: 30 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/kosichka-smoked.webp' },

      { id:'spicy-klubok', name:'Пряные клубочки (1 шт ~150 г)', group:'brined', pricePerKg:1950,
        description:'Нестандартный вкусный сыр, не сильно солёный, нравится всем. Срок хранения: 7 суток.',
        img:'https://static.tildacdn.com/tild3463-6166-4665-a439-323264653939/spicy-klubok.webp' },

      // --- Молочная продукция ---
      { id:'milk', name:'Молоко', group:'dairy', pricePerL:150,
        description:'Молоко отборное цельное, охлаждённое. Как из детства! Срок хранения: 3–5 суток в холодильнике.',
        img:'https://static.tildacdn.com/tild3136-3730-4134-b466-613138343764/tvorog.webp' },

      { id:'milk-topped', name:'Молоко топлёное', group:'dairy', pricePerL:250,
        description:'Настоящее цельное топлёное молоко, густоватая консистенция. Попробовав однажды — уже не разлюбишь! Срок хранения: 5–7 суток.',
        img:'https://static.tildacdn.com/tild3839-3163-4066-a633-306366346631/milk-topped.webp' },

      { id:'yogurt', name:'Йогурт классический', group:'dairy', pricePerL:260,
        description:'Настоящий йогурт из отборного молока и натуральной закваски. Нежный вкус с лёгкой кислинкой. Срок хранения: 5 суток.',
        img:null },

      { id:'ryazhenka', name:'Ряженка', group:'dairy', pricePerL:280,
        description:'Натуральная ряженка из молока. Один из любимых напитков детей. Срок хранения: до 5 суток.',
        img:null },

      { id:'misti-dahi', name:'Мистхи-Дахи', group:'dairy', pricePerL:300,
        description:'Кисломолочный напиток. Срок хранения: 5 суток в холодильнике.',
        img:null },

      { id:'whey', name:'Сыворотка', group:'dairy', pricePerL:60,
        description:'Молочный низкокалорийный продукт, получаемый при изготовлении творога или сыра. Срок хранения: 3 суток в холодильнике.',
        img:null },

      { id:'cream', name:'Сливки (33–36%)', group:'dairy', pricePerL:1450,
        description:'Состав: цельное молоко. Натуральные свежие сливки. Срок хранения: 5 суток. На 3–4 сутки могут стать сметаной.',
        img:'https://static.tildacdn.com/tild3163-3665-4636-a537-303830323163/cream.webp' },

      { id:'tvorog', name:'Творог', group:'dairy', pricePerKg:700,
        description:'Творожный нежный вкус, «зёрнышки» именно такие, какими и должны быть. Отлично переносит заморозку. Срок хранения: 3–5 суток.',
        img:'https://static.tildacdn.com/tild3136-3730-4134-b466-613138343764/tvorog.webp' },

      { id:'butter', name:'Масло сливочное (шар ~200 г)', group:'dairy', pricePerKg:2100,
        description:'Натуральное сливочное масло, как делала бабушка: из отборного молока, всё вручную. Без сахара и соли. Срок хранения: до 180 суток при t ≤ +15 °C.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/butter.webp' },

      { id:'ghee', name:'Топлёное масло (ГХИ)', group:'dairy', pricePerKg:2900,
        description:'Состав: сливочное масло, жирность ~99%. Идеально для жарки — не пригорает. Срок хранения: более 10 лет.',
        img:null },

      { id:'condensed-milk', name:'Сгущенка', group:'dairy', pricePerKg:1000,
        description:'Варёная сгущёнка: цельное молоко и тростниковый сахар. Густая, карамельная. Срок хранения: 7 суток.',
        img:null },

      { id:'tvorozhnaya-massa', name:'Творожная масса', group:'dairy', pricePerKg:850,
        description:'Творог, сливки, тростниковый сахар и натуральные добавки. Идеальный завтрак или десерт. Срок хранения: 5 суток.',
        img:'https://static.tildacdn.com/tild6630-3237-4430-b461-313634376333/tvorozhnaya-massa_.webp',
        flavours:['Курага','Изюм','Чернослив','Финики'] },

      // --- Сладости ---
      { id:'sandesh-orange', name:'Сандеш (апельсин)', group:'sweets', pricePerUnit:300,
        description:'Нежный творожный десерт. Состав: молоко, тростниковый сахар, цедра апельсина. 5 шт в наборе. Срок хранения: 5 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-orange.webp' },

      { id:'sandesh-walnut', name:'Сандеш (грецкий орех)', group:'sweets', pricePerUnit:300,
        description:'Творожный десерт с грецким орехом. 5 шт в наборе. Срок хранения: 5 суток.',
        img:'https://raw.githubusercontent.com/youmyloving/syr/main/sandesh-walnut.webp' },

      { id:'sandesh-carob', name:'Сандеш (кэроб)', group:'sweets', pricePerUnit:300,
        description:'Творожный десерт с шоколадным вкусом благодаря кэробу и кокосу. 5 шт в наборе. Срок хранения: 5 суток.',
        img:'https://static.tildacdn.com/tild6135-6337-4266-b764-613565386238/_.webp' },

      { id:'barfi-classic', name:'Бурфи классический', group:'sweets', pricePerUnit:350,
        description:'Нежный молочный десерт. 5 шт в наборе.',
        img:'https://static.tildacdn.com/tild3430-3231-4562-b164-366638313434/barfi-classic.webp' },

      { id:'barfi-hazelnut', name:'Бурфи фундук', group:'sweets', pricePerUnit:350,
        description:'Бурфи с фундуком. 5 шт в наборе.',
        img:'https://static.tildacdn.com/tild3065-3332-4466-a536-353130343264/barfi-hazelnut.webp' },

      { id:'barfi-sesame', name:'Бурфи кунжутный', group:'sweets', pricePerUnit:490,
        description:'Десерт на основе кунжута. 7 шт в наборе.',
        img:'https://static.tildacdn.com/tild3439-6135-4861-a531-316233303166/_.webp' },

      { id:'halva', name:'Халва', group:'sweets', pricePerUnit:200,
        description:'Настоящая халва. Состав: тростниковый сахар, вода, семена подсолнечника, сливочное масло. Срок хранения: 14 дней.',
        img:'https://static.tildacdn.com/tild3566-6566-4464-b531-306364646164/photo.webp' },

      { id:'potato-cake-5', name:'Пирожное «Картошка» (5 шт)', group:'sweets', pricePerUnit:400,
        description:'Из цельнозерновой муки и домашней сгущёнки. 5 шт.',
        img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },

      { id:'potato-cake-2', name:'Пирожное «Картошка» (2 шт)', group:'sweets', pricePerUnit:190,
        description:'Из цельнозерновой муки и домашней сгущёнки. 2 шт.',
        img:'https://static.tildacdn.com/tild3961-6133-4632-b162-396333663962/potato-cake-2.webp' },

      // --- Выпечка ---
      { id:'cookies-nut', name:'Ореховые пальчики', group:'bakery', pricePerKg:700,
        description:'Печенье с хрустящими орехами.',
        img:'https://static.tildacdn.com/tild3035-6230-4434-b363-303434366630/cookies-nut.webp' },

      { id:'muffin-plain', name:'Кексы обычные', group:'bakery', pricePerKg:500,
        description:'Простые и очень домашние кексы.',
        img:null },

      { id:'muffin-carob', name:'Кексы кэробовые', group:'bakery', pricePerKg:550,
        description:'Кексы с кэробом вместо какао.',
        img:null },

      { id:'muffin-raisin', name:'Кексы изюм', group:'bakery', pricePerKg:550,
        description:'Кексы с изюмом.',
        img:'https://static.tildacdn.com/tild3465-3162-4436-a235-363763383339/muffin-raisin.webp' },

      { id:'bliny-10', name:'Блины (10 шт)', group:'bakery', pricePerUnit:330,
        description:'Классические тонкие блины, 10 шт.',
        img:null },

      { id:'bliny-5', name:'Блины (5 шт)', group:'bakery', pricePerUnit:220,
        description:'Классические тонкие блины, 5 шт.',
        img:null },

      { id:'bliny-tvorog-5', name:'Блины творог/творог-изюм (5 шт)', group:'bakery', pricePerUnit:300,
        description:'Блины с начинкой из творога или творога с изюмом, 5 шт.',
        img:null },

      { id:'syrniki-10', name:'Сырники (10 шт)', group:'bakery', pricePerUnit:520,
        description:'Домашние сырники, 10 шт.',
        img:null },

      { id:'syrniki-5', name:'Сырники (5 шт)', group:'bakery', pricePerUnit:280,
        description:'Домашние сырники, 5 шт.',
        img:null },

      { id:'chapati-10', name:'Чапати (10 шт)', group:'bakery', pricePerUnit:270,
        description:'Пшеничная и ржаная мука, вода, соль, сливочное масло. 10 шт. Срок хранения: 2 суток в холодильнике.',
        img:'https://static.tildacdn.com/tild6332-6239-4538-b839-356132356236/chapati-10.webp' },

      { id:'chapati-wholewheat-10', name:'Чапати (ц/з мука) (10 шт)', group:'bakery', pricePerUnit:320,
        description:'Чапати из цельнозерновой муки, 10 шт.',
        img:null },
    ];

    // ===== VARIANT RULES =====
    const VARIANT_RULES = {
      // сыры
      'mozzarella': { type:'fixed', options:['1 шт (200 г)'] },
      'buratta': { type:'fixed', options:['1 шт (250 г)'] },
      'stracciatella': { type:'fixed', options:['200 г','250 г','300 г','500 г'] },
      'ricotta': { type:'fixed', options:['200 г','250 г','300 г','450 г'] },
      'ricotta-herbs': { type:'fixed', options:['200 г','250 г','300 г','450 г'] },
      'caciotta': { type:'weight', unit:'г', step:50, min:200, max:1500 },
      'caciotta-fenugreek': { type:'weight', unit:'г', step:50, min:200, max:1500 },
      'hard-village': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },
      'hard-smoked': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },
      'rolls-olives-walnut': { type:'weight', unit:'г', step:50, min:100, max:2000 },
      'rolls-apricot-cedar': { type:'weight', unit:'г', step:50, min:100, max:2000 },

      'panir-classic': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },
      'panir-herbs': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },
      'panir-spicy': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },
      'panir-smoked': { type:'fixed', options:['200 г','300 г','400 г','500 г','1000 г'] },

      'suluguni': { type:'weight', unit:'г', step:100, min:100, max:2000 },
      'suluguni-smoked': { type:'weight', unit:'г', step:100, min:100, max:2000 },
      'imeretian': { type:'weight', unit:'г', step:100, min:100, max:2000 },
      'imeretian-dill-garlic': { type:'weight', unit:'г', step:100, min:100, max:2000 },

      'halloumi': { type:'fixed', options:['1 шт (250 г)'] },
      'halloumi-paprika-oregano': { type:'fixed', options:['1 шт (250 г)'] },
      'halloumi-tomato-basil-garlic': { type:'fixed', options:['1 шт (250 г)'] },
      'halloumi-tomato-paprika': { type:'fixed', options:['1 шт (250 г)'] },

      'kosichka': { type:'fixed', options:['1 шт (200 г)'] },
      'kosichka-smoked': { type:'fixed', options:['1 шт (200 г)'] },
      'spicy-klubok': { type:'fixed', options:['1 шт (150 г)'] },

      // молочка
      'milk': { type:'fixed', options:['0.5 л','1 л'] },
      'milk-topped': { type:'fixed', options:['0.5 л','1 л'] },
      'yogurt': { type:'fixed', options:['0.5 л','1 л'] },
      'ryazhenka': { type:'fixed', options:['0.5 л','1 л'] },
      'misti-dahi': { type:'fixed', options:['0.5 л','1 л'] },
      'whey': { type:'fixed', options:['1 л'] },
      'cream': { type:'fixed', options:['0.2 л','0.5 л','1 л'] },
      'tvorog': { type:'weight', unit:'г', step:250, min:250, max:2000 },
      'butter': { type:'fixed', options:['1 шт (200 г)'] },
      'ghee': { type:'fixed', options:['200 г','500 г','1000 г'] },
      'condensed-milk': { type:'weight', unit:'г', step:100, min:200, max:2000 },
      'tvorozhnaya-massa': { type:'weight', unit:'г', step:100, min:200, max:2000 },

      // сладости
      'sandesh-orange': { type:'fixed', options:['5 шт'] },
      'sandesh-walnut': { type:'fixed', options:['5 шт'] },
      'sandesh-carob': { type:'fixed', options:['5 шт'] },
      'barfi-classic': { type:'fixed', options:['5 шт'] },
      'barfi-hazelnut': { type:'fixed', options:['5 шт'] },
      'barfi-sesame': { type:'fixed', options:['7 шт'] },
      'halva': { type:'fixed', options:['0.2 кг'] },
      'potato-cake-5': { type:'fixed', options:['5 шт'] },
      'potato-cake-2': { type:'fixed', options:['2 шт'] },

      // выпечка
      'cookies-nut': { type:'weight', unit:'г', step:250, min:250, max:2000 },
      'muffin-plain': { type:'weight', unit:'г', step:250, min:250, max:2000 },
      'muffin-carob': { type:'weight', unit:'г', step:250, min:250, max:2000 },
      'muffin-raisin': { type:'weight', unit:'г', step:250, min:250, max:2000 },

      'bliny-10': { type:'fixed', options:['10 шт'] },
      'bliny-5': { type:'fixed', options:['5 шт'] },
      'bliny-tvorog-5': { type:'fixed', options:['5 шт'] },
      'syrniki-10': { type:'fixed', options:['10 шт'] },
      'syrniki-5': { type:'fixed', options:['5 шт'] },
      'chapati-10': { type:'fixed', options:['10 шт'] },
      'chapati-wholewheat-10': { type:'fixed', options:['10 шт'] },
    };

    // ===== STATE =====
    let cart = [];
    let favorites = new Set();
    let currentProduct = null;
    let filteredProducts = [];
    let checkoutState = { phone:'', address:'', comment:'', promo:'' };

    // ===== HELPERS =====
    function el(id) { return document.getElementById(id); }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m] || m));
    }

    function extractGrams(text) {
      if (!text) return 0;
      const m = String(text).match(/(\d+(?:[.,]\d+)?)\s*(г|кг)/i);
      if (!m) return 0;
      const val = parseFloat(m[1].replace(',', '.'));
      if (isNaN(val)) return 0;
      return m[2].toLowerCase() === 'кг' ? val * 1000 : val;
    }

    function extractLiters(text) {
      if (!text) return 0;
      const m = String(text).match(/(\d+(?:[.,]\d+)?)\s*л/i);
      if (!m) return 0;
      const val = parseFloat(m[1].replace(',', '.'));
      return isNaN(val) ? 0 : val;
    }

    function hasPrice(p) {
      return !!(p.pricePerKg || p.pricePerL || p.pricePerUnit);
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      loadState();
      setupEventListeners();
      setupTelegramWebApp();
      renderUserProfile();
      populateCategoryFilter();
      el('only-cheese-checkbox').checked = ONLY_CHEESE_FILTER_DEFAULT;
      refreshFavoritesBar();
      filterAndRender();
      updateCartUI();
    }

    function loadState() {
      try {
        const savedCart = localStorage.getItem(STORAGE_CART_KEY);
        if (savedCart) cart = JSON.parse(savedCart);
      } catch (e) { cart = []; }

      try {
        const savedFav = localStorage.getItem(STORAGE_FAV_KEY);
        if (savedFav) favorites = new Set(JSON.parse(savedFav));
      } catch (e) {}

      try {
        const savedCheckout = localStorage.getItem(STORAGE_CHECKOUT_KEY);
        if (savedCheckout) checkoutState = JSON.parse(savedCheckout);
      } catch (e) {}
    }

    function saveState() {
      try { localStorage.setItem(STORAGE_CART_KEY, JSON.stringify(cart)); } catch (e) {}
      try { localStorage.setItem(STORAGE_FAV_KEY, JSON.stringify([...favorites])); } catch (e) {}
      try { localStorage.setItem(STORAGE_CHECKOUT_KEY, JSON.stringify(checkoutState)); } catch (e) {}
    }

    // ===== TELEGRAM =====
    function setupTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        const webApp = window.Telegram.WebApp;
        webApp.ready();
        webApp.expand();

        webApp.MainButton.setText('Оформить заказ').onClick(function() {
          openCartModal();
        }).hide();

        webApp.BackButton.onClick(function() {
          const pm = el('product-modal');
          const cm = el('cart-modal');
          if (cm.open) closeCartModal();
          else if (pm.open) closeProductModal();
        });
      }
    }

    function renderUserProfile() {
      const box = el('user-profile');
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
        const ua = window.Telegram.WebApp.initDataUnsafe.user;
        box.innerHTML = `
          <div class="user-avatar">
            <img src="${ua.photo_url || ''}" alt="Avatar"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"/>
            <span style="display:none;">${(ua.first_name || 'U').charAt(0).toUpperCase()}</span>
          </div>
          <div class="user-name">${ua.first_name || ''}</div>`;
      } else {
        box.style.display = 'none';
      }
    }

    // ===== EVENTS =====
    function setupEventListeners() {
      el('search-input').addEventListener('input', filterAndRender);
      el('category-filter').addEventListener('change', filterAndRender);
      el('only-cheese-checkbox').addEventListener('change', filterAndRender);
      el('only-fav-checkbox').addEventListener('change', filterAndRender);

      el('open-cart-btn').addEventListener('click', openCartModal);
      el('add-to-cart-btn').addEventListener('click', addToCart);

      el('product-variant-select').addEventListener('change', updateProductModalPrice);
      el('product-qty-input').addEventListener('input', updateProductModalPrice);

      const cwInput = el('product-custom-weight');
      const cwCheckbox = el('use-custom-weight-checkbox');
      if (cwInput) {
        cwInput.addEventListener('input', function () {
          if (!currentProduct || !currentProduct.pricePerKg) return;
          updateProductModalPrice();
        });
      }
      if (cwCheckbox) {
        cwCheckbox.addEventListener('change', function () {
          if (!currentProduct || !currentProduct.pricePerKg) {
            cwCheckbox.checked = false;
            return;
          }
          const input = el('product-custom-weight');
          if (cwCheckbox.checked) {
            input.disabled = false;
            input.classList.remove('is-disabled');
            if (!input.value) {
              const rule = VARIANT_RULES[currentProduct.id];
              let def = 200;
              if (rule) {
                const selVal = el('product-variant-select').value;
                const g = extractGrams(selVal);
                if (g > 0) def = g;
              }
              input.value = def;
            }
          } else {
            input.disabled = true;
            input.classList.add('is-disabled');
          }
          updateProductModalPrice();
        });
      }
    }

    // ===== FILTER + RENDER MAIN =====
    function populateCategoryFilter() {
      const sel = el('category-filter');
      GROUPS.forEach(g => {
        const o = document.createElement('option');
        o.value = g.id;
        o.textContent = g.title;
        sel.appendChild(o);
      });
    }

    function filterAndRender() {
      const term = el('search-input').value.trim().toLowerCase();
      const groupSel = el('category-filter').value;
      const onlyCheese = el('only-cheese-checkbox').checked;
      const onlyFav = el('only-fav-checkbox').checked;

      filteredProducts = PRODUCTS.filter(p => {
        if (!hasPrice(p)) return false;
        const inTerm = !term || p.name.toLowerCase().includes(term);
        const inGroup = !groupSel || p.group === groupSel;
        const inCheese = !onlyCheese || CHEESE_GROUP_IDS.has(p.group);
        const inFav = !onlyFav || favorites.has(p.id);
        return inTerm && inGroup && inCheese && inFav;
      });

      const showSections = (term === '' && !groupSel && !onlyFav && !onlyCheese);
      renderMain(showSections);
    }

    function renderMain(showSections) {
      const main = el('main');
      main.innerHTML = '';
      if (!filteredProducts.length) {
        main.innerHTML = '<p style="text-align:center;color:var(--hint-color)">Ничего не найдено</p>';
        return;
      }

      if (showSections) {
        for (const g of GROUPS) {
          const items = filteredProducts.filter(p => p.group === g.id);
          if (!items.length) continue;
          const section = document.createElement('section');
          section.className = 'section';
          section.innerHTML = `<div class="section-title">${g.title}</div>`;
          const grid = document.createElement('div');
          grid.className = 'product-grid';
          items.forEach(p => grid.appendChild(productCard(p)));
          section.appendChild(grid);
          main.appendChild(section);
        }
      } else {
        const grid = document.createElement('div');
        grid.className = 'product-grid';
        filteredProducts.forEach(p => grid.appendChild(productCard(p)));
        main.appendChild(grid);
      }
    }

    function productCard(p) {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.onclick = function (e) {
        if (e.target.closest('.fav-btn')) return;
        openProductModal(p.id);
      };

      const priceText = getPriceText(p);
      const approx = approxPieceBadgeText(p);
      const favActive = favorites.has(p.id) ? 'active' : '';
      const imgUrl = p.img || DEFAULT_IMG;

      card.innerHTML = `
        <div class="product-thumb">
          <img src="${imgUrl}" alt="${escapeHtml(p.name)}" loading="lazy"
               onerror="this.src='${DEFAULT_IMG}'" />
        </div>
        <div class="name">${p.name}</div>
        <div class="product-row">
          <div class="price">${priceText}</div>
          ${approx ? `<div class="badge-piece">${approx}</div>` : ''}
          <button class="fav-btn ${favActive}" title="В избранное"
            onclick="toggleFavorite('${p.id}');event.stopPropagation()">
            ${favActive ? '♥' : '♡'}
          </button>
        </div>`;
      return card;
    }

    function getPriceText(p) {
      if (p.pricePerKg) return fmtRub(p.pricePerKg) + ' / кг';
      if (p.pricePerL) return fmtRub(p.pricePerL) + ' / л';
      if (p.pricePerUnit) return fmtRub(p.pricePerUnit);
      return 'Цена не указана';
    }

    function approxPieceBadgeText(p) {
      if (!p.pricePerKg) return '';
      const rule = VARIANT_RULES[p.id];
      if (!rule || rule.type !== 'fixed') return '';
      const opt = rule.options.find(o => /шт/i.test(o) && /г/i.test(o));
      if (!opt) return '';
      const grams = extractGrams(opt);
      if (!grams) return '';
      const approxOne = Math.round(p.pricePerKg * grams / 1000);
      const halloumiIds = ['halloumi','halloumi-paprika-oregano','halloumi-tomato-basil-garlic','halloumi-tomato-paprika'];
      if (halloumiIds.includes(p.id)) {
        return `≈ ${fmtRub(approxOne)} за 1 шт (вес 200–250 г)`;
      }
      return `≈ ${fmtRub(approxOne)} за 1 шт`;
    }

    // ===== FAVORITES =====
    function toggleFavorite(id) {
      if (favorites.has(id)) favorites.delete(id);
      else favorites.add(id);
      saveState();
      refreshFavoritesBar();
      filterAndRender();
    }

    function refreshFavoritesBar() {
      const bar = el('favorites-bar');
      bar.innerHTML = '';
      if (!favorites.size) {
        bar.style.display = 'none';
        return;
      }
      bar.style.display = 'flex';
      [...favorites].slice(0, 30).forEach(id => {
        const p = PRODUCTS.find(x => x.id === id);
        if (!p) return;
        const chip = document.createElement('div');
        chip.className = 'fav-chip';
        chip.textContent = p.name;
        chip.onclick = function () { openProductModal(id); };
        bar.appendChild(chip);
      });
    }

    // ===== PRODUCT MODAL =====
    function openProductModal(productId) {
      currentProduct = PRODUCTS.find(p => p.id === productId);
      if (!currentProduct) return;
      el('product-modal-title').textContent = currentProduct.name;
      el('product-modal-description').textContent = currentProduct.description || '';

      renderVariantSelector();

      // вкусы (для творожной массы)
      const flavourGroup = el('flavour-group');
      const flavourSelect = el('product-flavour-select');
      if (currentProduct.flavours && currentProduct.flavours.length && flavourGroup && flavourSelect) {
        flavourGroup.style.display = 'block';
        flavourSelect.innerHTML = '';
        currentProduct.flavours.forEach(fl => {
          const o = document.createElement('option');
          o.value = fl;
          o.textContent = fl;
          flavourSelect.appendChild(o);
        });
      } else if (flavourGroup) {
        flavourGroup.style.display = 'none';
      }

      // свой вес
      const cwGroup = el('custom-weight-group');
      const cwInput = el('product-custom-weight');
      const cwCheckbox = el('use-custom-weight-checkbox');
      if (currentProduct.pricePerKg && cwGroup && cwInput && cwCheckbox) {
        cwGroup.style.display = 'block';
        cwInput.disabled = true;
        cwInput.classList.add('is-disabled');
        cwInput.value = '';
        cwCheckbox.checked = false;
      } else if (cwGroup) {
        cwGroup.style.display = 'none';
      }

      el('product-qty-input').value = 1;
      updateProductModalPrice();

      el('product-modal').showModal();
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
        window.Telegram.WebApp.BackButton.show();
      }
    }

    function closeProductModal() {
      el('product-modal').close();
      currentProduct = null;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
        window.Telegram.WebApp.BackButton.hide();
      }
    }

    function renderVariantSelector() {
      const select = el('product-variant-select');
      const rule = VARIANT_RULES[currentProduct.id];
      const pieceBadge = el('piece-badge');
      const hint = el('variant-hint');
      select.innerHTML = '';
      if (pieceBadge) { pieceBadge.style.display = 'none'; pieceBadge.textContent = ''; }
      if (hint) hint.textContent = '';

      if (!rule) {
        const o = document.createElement('option');
        o.value = '';
        o.textContent = 'Вариант не задан';
        select.appendChild(o);
        return;
      }

      if (rule.type === 'fixed') {
        rule.options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          select.appendChild(o);
        });
        if (currentProduct.pricePerKg && hint) {
          hint.textContent = 'Можно выбрать из списка или указать свой вес ниже.';
        }
        const approx = approxPieceBadgeText(currentProduct);
        if (approx && pieceBadge) {
          pieceBadge.style.display = 'block';
          pieceBadge.textContent = approx;
        }
      } else if (rule.type === 'weight') {
        for (let v = rule.min; v <= rule.max; v += rule.step) {
          const o = document.createElement('option');
          o.value = v + ' ' + rule.unit;
          o.textContent = v + ' ' + rule.unit;
          select.appendChild(o);
        }
        if (hint) {
          hint.textContent = 'Шаг по умолчанию: ' + rule.step + ' г. Можно указать свой вес ниже.';
        }
      }
    }

    function getSelectedVariantAndQty() {
      const qtyInput = el('product-qty-input');
      const select = el('product-variant-select');
      let variant = select ? select.value : '';
      let qty = qtyInput ? parseInt(qtyInput.value, 10) : 1;
      if (!qty || qty < 1) qty = 1;

      if (currentProduct && currentProduct.pricePerKg) {
        const cwCheckbox = el('use-custom-weight-checkbox');
        const cwInput = el('product-custom-weight');
        if (cwCheckbox && cwInput && cwCheckbox.checked) {
          const grams = parseFloat((cwInput.value || '').replace(',', '.'));
          if (!isNaN(grams) && grams > 0) {
            variant = grams + ' г';
          }
        }
      }

      if (currentProduct && currentProduct.flavours && currentProduct.flavours.length) {
        const flavourSelect = el('product-flavour-select');
        const flavourVal = flavourSelect ? flavourSelect.value : '';
        if (flavourVal) {
          variant = variant + ' (вкус: ' + flavourVal + ')';
        }
      }

      return { variant, qty };
    }

    function updateProductModalPrice() {
      if (!currentProduct) return;
      const sel = getSelectedVariantAndQty();
      if (!sel.variant) {
        el('product-modal-price').textContent = 'Уточним цену';
        return;
      }
      const price = calculatePrice(currentProduct.id, sel.variant, sel.qty);
      el('product-modal-price').textContent = fmtRub(price.finalPrice || price.basePrice || 0);

      // обновим бейдж для штучных
      const pieceBadge = el('piece-badge');
      if (pieceBadge && currentProduct.pricePerKg && /шт/i.test(sel.variant)) {
        const grams = extractGrams(sel.variant);
        if (grams > 0) {
          let txt = '≈ ' + fmtRub(currentProduct.pricePerKg * grams / 1000) + ' за 1 шт';
          const halloumiIds = ['halloumi','halloumi-paprika-oregano','halloumi-tomato-basil-garlic','halloumi-tomato-paprika'];
          if (halloumiIds.includes(currentProduct.id)) {
            txt += ' (вес 200–250 г)';
          }
          pieceBadge.style.display = 'block';
          pieceBadge.textContent = txt;
        }
      }
    }

    // ===== CART =====
    function addToCart() {
      if (!currentProduct) return;
      const { variant, qty } = getSelectedVariantAndQty();
      if (!variant) return;

      const idx = cart.findIndex(i => i.id === currentProduct.id && i.variant === variant);
      if (idx > -1) cart[idx].qty += qty;
      else cart.push({ id: currentProduct.id, name: currentProduct.name, group: currentProduct.group, variant, qty });

      saveState();
      updateCartUI();
      closeProductModal();

      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
        window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      }
    }

    function calculatePrice(productId, variant, qty) {
      const p = PRODUCTS.find(x => x.id === productId);
      if (!p) return { basePrice:0, finalPrice:0, discountRate:0 };
      qty = Math.max(1, qty || 1);

      let base = 0;
      if (p.pricePerKg) {
        const grams = extractGrams(variant);
        if (!grams) return { basePrice:0, finalPrice:0, discountRate:0 };
        base = p.pricePerKg * grams / 1000 * qty;
      } else if (p.pricePerL) {
        const liters = extractLiters(variant);
        if (!liters) return { basePrice:0, finalPrice:0, discountRate:0 };
        base = p.pricePerL * liters * qty;
      } else if (p.pricePerUnit) {
        base = p.pricePerUnit * qty;
      } else {
        return { basePrice:0, finalPrice:0, discountRate:0 };
      }

      const discountRate = getDiscountRateForProduct(productId);
      const final = base * (1 - discountRate);
      return { basePrice: ROUND(base), finalPrice: ROUND(final), discountRate };
    }

    function getDiscountRateForProduct(productId) {
      const prod = PRODUCTS.find(p => p.id === productId);
      if (!prod || !CHEESE_GROUP_IDS.has(prod.group)) return 0;

      let totalGrams = 0;
      cart.forEach(item => {
        if (item.id !== productId) return;
        const grams = extractGrams(item.variant);
        if (grams > 0) totalGrams += grams * item.qty;
      });

      let rate = 0;
      DISCOUNT_THRESHOLDS.forEach(t => {
        if (totalGrams >= t.g) rate = t.rate;
      });
      return rate;
    }

    function updateCartUI() {
      let totalCount = 0;
      let totalSum = 0;
      cart.forEach(i => {
        totalCount += i.qty;
        const price = calculatePrice(i.id, i.variant, i.qty);
        totalSum += price.finalPrice;
      });

      const btn = el('open-cart-btn');
      if (cart.length) {
        btn.disabled = false;
        btn.textContent = 'Корзина (' + totalCount + ') — ' + fmtRub(totalSum);
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
          window.Telegram.WebApp.MainButton.show();
        }
      } else {
        btn.disabled = true;
        btn.textContent = 'Корзина пуста';
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.MainButton) {
          window.Telegram.WebApp.MainButton.hide();
        }
      }
    }

    function openCartModal() {
      renderCartModal();
      el('cart-modal').showModal();
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
        window.Telegram.WebApp.BackButton.show();
      }
    }

    function closeCartModal() {
      el('cart-modal').close();
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.BackButton) {
        window.Telegram.WebApp.BackButton.hide();
      }
    }

    function renderCartModal() {
      const body = el('cart-modal-body');
      body.innerHTML = '';

      if (!cart.length) {
        body.innerHTML = '<p>Корзина пуста</p>';
        return;
      }

      let total = 0;
      cart.forEach((item, idx) => {
        const price = calculatePrice(item.id, item.variant, item.qty);
        total += price.finalPrice;

        const rate = getDiscountRateForProduct(item.id);
        const hint = rate > 0
          ? '<div class="discount-hint">Скидка ' + Math.round(rate * 100) + '% применена</div>'
          : '';

        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div class="cart-item-info">
            <div class="cart-item-name">${escapeHtml(item.name)}</div>
            <div class="cart-item-variant">${escapeHtml(item.variant)}</div>
            <div class="cart-item-price">${fmtRub(price.finalPrice)}</div>
            ${hint}
          </div>
          <div class="cart-item-controls">
            <div class="qty-control">
              <button onclick="changeItemQty(${idx}, -1)">−</button>
              <span>${item.qty}</span>
              <button onclick="changeItemQty(${idx}, 1)">+</button>
            </div>
          </div>`;
        body.appendChild(div);
      });

      const summaryWrap = document.createElement('div');
      summaryWrap.className = 'cart-summary';
      summaryWrap.innerHTML = 'Итого: ' + fmtRub(total) + `
        <div style="text-align:left;margin:10px 0 0">
          <label for="checkout-promo" style="font-weight:700;font-size:13px">Промокод</label>
          <input id="checkout-promo" placeholder="Если есть"
            style="width:100%;padding:10px;border:1px solid var(--border-color);border-radius:10px;
            background:var(--secondary-bg-color);color:var(--text-color);font-size:16px;margin-top:4px" />
          <div class="notice">Промокоды можно хранить на бэкенде (надёжнее) или в коде (см. PROMO_CODES).</div>
        </div>`;
      body.appendChild(summaryWrap);

      const checkout = document.createElement('div');
      checkout.innerHTML = `
        <div class="section-title" style="margin-top:18px;">Контакты и доставка</div>
        <div class="form-group">
          <label for="checkout-phone">Телефон для связи</label>
          <input type="tel" id="checkout-phone" inputmode="tel" placeholder="+7 999 999-99-99" />
          <div class="notice">Можно 8999..., +7..., с пробелами и скобками — мы приведём к стандарту.</div>
        </div>
        <div class="form-group">
          <label for="checkout-address">Адрес доставки</label>
          <textarea id="checkout-address" rows="3" placeholder="Город, улица, дом, подъезд/этаж/кв."></textarea>
        </div>
        <div class="form-group">
          <label for="checkout-comment">Комментарий к заказу</label>
          <textarea id="checkout-comment" rows="3" placeholder="Например: позвонить перед доставкой, без чеснока и т.п."></textarea>
        </div>
        <div id="checkout-errors" class="error-text" style="display:none"></div>
      `;
      body.appendChild(checkout);

      // восстановим сохранённые значения
      el('checkout-phone').value = checkoutState.phone || '';
      el('checkout-address').value = checkoutState.address || '';
      el('checkout-comment').value = checkoutState.comment || '';
      el('checkout-promo').value = checkoutState.promo || '';

      el('checkout-phone').addEventListener('input', function () {
        checkoutState.phone = el('checkout-phone').value;
        saveState();
      });
      el('checkout-address').addEventListener('input', function () {
        checkoutState.address = el('checkout-address').value;
        saveState();
      });
      el('checkout-comment').addEventListener('input', function () {
        checkoutState.comment = el('checkout-comment').value;
        saveState();
      });
      el('checkout-promo').addEventListener('input', function () {
        checkoutState.promo = el('checkout-promo').value.trim();
        saveState();
      });

      const sendBtn = document.createElement('button');
      sendBtn.className = 'btn btn-primary';
      sendBtn.textContent = 'Отправить заказ';
      sendBtn.onclick = sendOrder;
      body.appendChild(sendBtn);

      if (hasCheeseInCart()) {
        const note = document.createElement('div');
        note.className = 'weighing-note';
        note.textContent = 'Конечная сумма по сырам будет уточнена после фактического взвешивания в день доставки.';
        body.appendChild(note);
      }
    }

    function changeItemQty(index, delta) {
      cart[index].qty += delta;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      saveState();
      updateCartUI();
      renderCartModal();
    }

    function hasCheeseInCart() {
      return cart.some(i => {
        const p = PRODUCTS.find(x => x.id === i.id);
        return p && CHEESE_GROUP_IDS.has(p.group);
      });
    }

    // ===== CHECKOUT =====
    function normalizePhone(input) {
      if (!input) return '';
      const digits = String(input).replace(/\D+/g, '');
      if (digits.length === 11 && (digits.startsWith('7') || digits.startsWith('8'))) {
        return '+7' + digits.slice(1);
      }
      if (digits.length === 10) return '+7' + digits;
      if (String(input).trim().startsWith('+')) return '+' + digits;
      return digits ? '+' + digits : '';
    }

    function getCheckoutData() {
      const phoneRaw = (el('checkout-phone').value || '').trim();
      const phone = normalizePhone(phoneRaw);
      const address = (el('checkout-address').value || '').trim();
      const comment = (el('checkout-comment').value || '').trim();
      const promo = (el('checkout-promo').value || '').trim().toUpperCase();
      checkoutState = { phone: phoneRaw, address, comment, promo };
      saveState();
      return { phoneRaw, phone, address, comment, promo };
    }

    function validateCheckout(data) {
      const errs = [];
      if (!data.phone) errs.push('Укажите корректный телефон для связи.');
      if (data.address.length < 5) errs.push('Пожалуйста, укажите адрес доставки.');
      return errs;
    }

    function showCheckoutErrors(errors) {
      const box = el('checkout-errors');
      if (!errors || !errors.length) {
        box.style.display = 'none';
        box.textContent = '';
        return;
      }
      box.style.display = 'block';
      box.textContent = errors.join(' ');
    }

    function applyPromo(total, code) {
      if (!code) return { total, applied: null };
      const promo = PROMO_CODES[code];
      if (!promo) return { total, applied: null };
      let newTotal = total;
      if (promo.type === 'percent') newTotal = total * (1 - promo.value / 100);
      if (promo.type === 'fixed') newTotal = Math.max(0, total - promo.value);
      return { total: ROUND(newTotal), applied: promo };
    }

    function sendOrder() {
      if (!cart.length) return;
      const contact = getCheckoutData();
      const errors = validateCheckout(contact);
      if (errors.length) {
        showCheckoutErrors(errors);
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
        }
        return;
      }
      showCheckoutErrors([]);

      const payload = {
        type: 'cart',
        source: 'miniapp',
        currency: CURRENCY,
        items: [],
        total: 0,
        contact: {
          phone: contact.phone,
          phone_raw: contact.phoneRaw,
          address: contact.address,
          comment: contact.comment,
          promo: contact.promo,
        },
        meta: {
          ts: Date.now(),
          schema_ver: PAYLOAD_SCHEMA_VERSION,
        }
      };

      let grand = 0;
      cart.forEach(i => {
        const price = calculatePrice(i.id, i.variant, i.qty);
        grand += price.finalPrice;
        payload.items.push({
          id: i.id,
          name: i.name,
          group: i.group,
          variant: i.variant,
          qty: i.qty,
          unit_price_base: price.basePrice / Math.max(i.qty, 1),
          discount_rate: price.discountRate,
          unit_price: price.finalPrice / Math.max(i.qty, 1),
          line_total: price.finalPrice,
        });
      });

      const promoRes = applyPromo(grand, contact.promo ? contact.promo.toUpperCase() : '');
      payload.total = promoRes.total;
      if (promoRes.applied) payload.promo_applied = promoRes.applied;

      if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        payload.telegram = { platform: tg.platform, init_data: !!tg.initData };
        const u = tg.initDataUnsafe && tg.initDataUnsafe.user;
        if (u) {
          payload.telegram.user = {
            id: u.id,
            username: u.username,
            first_name: u.first_name,
            last_name: u.last_name,
          };
        }
      }

      axios.post(BACKEND + '/order', payload)
        .then(function () {
          if (window.Telegram && window.Telegram.WebApp) {
            if (window.Telegram.WebApp.showAlert) {
              window.Telegram.WebApp.showAlert('Спасибо! Ваш заказ принят. Мы свяжемся по телефону для подтверждения.');
            }
            if (window.Telegram.WebApp.HapticFeedback) {
              window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }
            cart = [];
            saveState();
            updateCartUI();
            closeCartModal();
            if (window.Telegram.WebApp.close) {
              window.Telegram.WebApp.close();
            }
          } else {
            alert('Ваш заказ принят');
            cart = [];
            saveState();
            updateCartUI();
            closeCartModal();
          }
        })
        .catch(function () {
          if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.showAlert) {
            window.Telegram.WebApp.showAlert('Не удалось отправить заказ. Проверьте интернет и попробуйте ещё раз.');
          } else {
            alert('Ошибка при отправке заказа');
          }
          if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
          }
        });
    }
  </script>
</body>
</html>
