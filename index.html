<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>–°—ã—Ä–æ–º–∞–Ω–∏—è ¬∑ –ú–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #0f172a; /* slate-900 */
      --hint-color: #64748b; /* slate-500 */
      --link-color: #2481cc;
      --button-color: #2481cc;
      --button-text-color: #ffffff;
      --secondary-bg-color: #f8fafc; /* slate-50 */
      --header-bg-color: #ffffff;
      --section-bg-color: #ffffff;
      --border-color: #e2e8f0; /* slate-200 */
      --error-color: #e11d48; /* rose-600 */
      --success-color: #16a34a; /* green-600 */
      --warning-color: #ca8a04; /* yellow-600 */
      --radius: 14px;
      --shadow: 0 8px 28px rgba(2, 6, 23, 0.08);
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
      font-family: var(--font); font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* App layout */
    #app { display: grid; grid-template-rows: auto auto 1fr auto; min-height: 100vh; }

    header {
      position: sticky; top: 0; z-index: 20; background: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color); padding: 10px; backdrop-filter: saturate(180%) blur(6px);
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .user-profile { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--secondary-bg-color); display: grid; place-items: center; overflow: hidden; border: 1px solid var(--border-color); }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-name { font-weight: 600; font-size: 14px; }

    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 10px; }
    .input {
      width: 100%; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 12px;
      background: var(--secondary-bg-color); color: var(--text-color); font-size: 16px;
    }
    .select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--secondary-bg-color); color: var(--text-color); font-size: 14px; }

    /* Category chips */
    .chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: none; }
    .chips::-webkit-scrollbar { display: none; }
    .chip { border: 1px solid var(--border-color); background: var(--section-bg-color); color: var(--text-color);
      padding: 8px 12px; border-radius: 999px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: transform .08s ease-in-out, background .2s;
    }
    .chip:active { transform: scale(0.98); }
    .chip.active { background: var(--button-color); color: var(--button-text-color); border-color: transparent; }

    main { padding: 12px; padding-bottom: 92px; }

    /* Product grid */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(168px,1fr)); gap: 14px; }
    .card { border: 1px solid var(--border-color); border-radius: var(--radius); background: var(--section-bg-color);
      padding: 12px; box-shadow: var(--shadow); cursor: pointer; display: grid; gap: 8px; align-content: start; transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 12px 36px rgba(2, 6, 23, 0.13); }
    .ico { font-size: 46px; text-align: center; }
    .name { font-weight: 600; font-size: 14px; min-height: 38px; text-align: center; }
    .meta { display: flex; justify-content: center; gap: 8px; align-items: center; color: var(--hint-color); font-size: 12px; }
    .price { text-align: center; font-weight: 700; }

    /* Sticky cart button */
    .cart-footer { position: sticky; bottom: 0; z-index: 30; background: var(--header-bg-color);
      border-top: 1px solid var(--border-color); padding: 10px; }
    .btn { padding: 12px 18px; border: 0; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; transition: filter .15s ease, transform .06s ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--button-color); color: var(--button-text-color); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--secondary-bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
    .btn-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    /* Dialogs */
    dialog { border: 1px solid var(--border-color); border-radius: 16px; padding: 0; background: var(--section-bg-color); color: var(--text-color);
      width: 92vw; max-width: 560px; max-height: 86vh; overflow: hidden; box-shadow: 0 18px 42px rgba(2,6,23,.28);
    }
    dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
    .modal-header { padding: 14px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 18px; }
    .modal-close { background: none; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 26px; color: var(--hint-color); cursor: pointer; display: grid; place-items: center; }
    .modal-close:hover { background: var(--secondary-bg-color); }
    .modal-body { padding: 14px; overflow-y: auto; max-height: calc(86vh - 56px); display: grid; gap: 12px; }

    /* Forms */
    .form { display: grid; gap: 12px; }
    .form-row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .form-group { display: grid; gap: 6px; }
    label { font-size: 13px; color: var(--hint-color); }
    .field, select.field { padding: 12px 12px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--secondary-bg-color); color: var(--text-color); font-size: 16px; }
    .help { color: var(--hint-color); font-size: 12px; }
    .muted { color: var(--hint-color); }
    .center { text-align: center; }

    /* Cart */
    .cart-list { display: grid; gap: 10px; }
    .cart-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--section-bg-color); }
    .cart-ico { font-size: 28px; width: 32px; text-align: center; }
    .cart-info { display: grid; gap: 4px; }
    .cart-name { font-weight: 600; }
    .cart-variant { font-size: 12px; color: var(--hint-color); }
    .cart-controls { display: flex; align-items: center; gap: 8px; }
    .qty { display: inline-flex; align-items: center; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .qty button { width: 34px; height: 34px; border: 0; background: var(--secondary-bg-color); cursor: pointer; font-size: 20px; }
    .qty span { min-width: 34px; text-align: center; display: inline-block; }
    .line { display: flex; justify-content: space-between; align-items: baseline; }
    .line small { color: var(--hint-color); }
    .hr { height: 1px; background: var(--border-color); margin: 6px 0; }

    .summary { display: grid; gap: 6px; font-size: 15px; }
    .summary .total { font-size: 18px; font-weight: 800; }

    .notice { padding: 10px; border-radius: 10px; background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; font-size: 13px; }
    .success { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
    .error { background: #fff1f2; color: #9f1239; border-color: #fecdd3; }

    .kicker { font-size: 12px; text-transform: uppercase; letter-spacing: .08em; color: var(--hint-color); }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>
      <div class="searchbar">
        <input type="search" id="search-input" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶" />
        <label style="display:flex;align-items:center;gap:8px; white-space:nowrap;">
          <input type="checkbox" id="only-cheese-checkbox" /> –¢–æ–ª—å–∫–æ —Å—ã—Ä—ã
        </label>
      </div>
      <div class="chips" id="category-chips"></div>
    </header>

    <div id="filters" class="row" style="padding: 0 12px 8px 12px;">
      <select id="sort-select" class="select">
        <option value="default">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
        <option value="price-asc">–¶–µ–Ω–∞ ‚Üë</option>
        <option value="price-desc">–¶–µ–Ω–∞ ‚Üì</option>
        <option value="name-asc">–ù–∞–∑–≤–∞–Ω–∏–µ A‚Üí–Ø</option>
        <option value="name-desc">–ù–∞–∑–≤–∞–Ω–∏–µ –Ø‚ÜíA</option>
      </select>
      <span class="help" id="result-count"></span>
    </div>

    <main>
      <div id="product-grid" class="product-grid"></div>
    </main>

    <footer class="cart-footer">
      <button id="open-cart-btn" class="btn btn-primary" disabled>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</button>
    </footer>
  </div>

  <!-- Product modal -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title"></h2>
      <button class="modal-close" onclick="closeProductModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="center"><div class="ico" id="product-modal-ico"></div></div>
      <p class="help center" id="product-modal-description"></p>

      <div class="form">
        <div class="form-group">
          <label for="product-variant-select">–í–∞—Ä–∏–∞–Ω—Ç</label>
          <select id="product-variant-select" class="field"></select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="product-qty-input">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
            <input type="number" id="product-qty-input" class="field" value="1" min="1" step="1" />
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-secondary" id="product-inc-qty" type="button">+ –µ—â—ë</button>
          </div>
        </div>
        <div class="notice" id="discount-hint" style="display:none"></div>
        <div class="line"><span class="kicker">–ö –æ–ø–ª–∞—Ç–µ</span> <div class="price" id="product-modal-price">0 ‚ÇΩ</div></div>
        <button class="btn btn-primary" id="add-to-cart-btn" type="button">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      </div>
    </div>
  </dialog>

  <!-- Cart modal -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <button class="modal-close" onclick="closeCartModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div id="cart-modal-body"></div>
      <div class="hr"></div>
      <div class="summary" id="cart-summary"></div>
      <div class="row">
        <button class="btn btn-danger" id="clear-cart-btn" type="button">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-primary" id="checkout-btn" type="button">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>
  </dialog>

  <!-- Checkout modal -->
  <dialog id="checkout-modal">
    <div class="modal-header">
      <h2>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
      <button class="modal-close" onclick="closeCheckoutModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="notice" id="checkout-note">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏. –ú—ã —Å–≤—è–∂–µ–º—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</div>
      <form id="checkout-form" class="form">
        <div class="form-group">
          <label for="customer-name">–ò–º—è</label>
          <input id="customer-name" class="field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ê–Ω–Ω–∞" autocomplete="name" />
        </div>
        <div class="form-group">
          <label for="customer-phone">–¢–µ–ª–µ—Ñ–æ–Ω <span class="muted">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input id="customer-phone" class="field" placeholder="+7 9XX XXX-XX-XX" inputmode="tel" autocomplete="tel" required />
          <div class="help">–§–æ—Ä–º–∞—Ç: +7 9‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢-‚Ä¢‚Ä¢-‚Ä¢‚Ä¢</div>
        </div>
        <div class="form-group">
          <label for="customer-address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="muted">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input id="customer-address" class="field" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥/—ç—Ç–∞–∂/–∫–≤" autocomplete="street-address" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="payment-method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
            <select id="payment-method" class="field">
              <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
              <option value="card">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É/–°–ë–ü</option>
            </select>
          </div>
          <div class="form-group">
            <label for="delivery-time">–í—Ä–µ–º—è</label>
            <select id="delivery-time" class="field">
              <option value="asap">–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ</option>
              <option value="today-evening">–°–µ–≥–æ–¥–Ω—è –≤–µ—á–µ—Ä–æ–º</option>
              <option value="tomorrow">–ó–∞–≤—Ç—Ä–∞</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="order-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input id="order-comment" class="field" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 10 –º–∏–Ω—É—Ç, –Ω–µ –∑–≤–æ–Ω–∏—Ç—å –≤ –¥–æ–º–æ—Ñ–æ–Ω‚Ä¶" />
        </div>
        <div class="summary">
          <div class="line"><span>–¢–æ–≤–∞—Ä–æ–≤</span><strong id="summary-items"></strong></div>
          <div class="line"><span>–°—É–º–º–∞</span><strong id="summary-total"></strong></div>
          <div class="line">
            <small>–ù–∞–∂–∏–º–∞—è ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</small>
          </div>
          <button class="btn btn-primary" id="place-order-btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
          <div class="notice success" id="submit-success" style="display:none;">–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –°–ø–∞—Å–∏–±–æ üåø</div>
          <div class="notice error" id="submit-error" style="display:none;">–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.</div>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    // =====================
    // CONFIGURATION
    // =====================
    const APP_NAME = '–°—ã—Ä–æ–º–∞–Ω–∏—è';
    const CURRENCY = 'RUB';
    const ROUND = Math.round;
    const fmtPrice = new Intl.NumberFormat('ru-RU');

    // Discount thresholds per single-cheese product (applied per product by total grams in cart)
    const DISCOUNT_THRESHOLDS = [
      { g: 1000, rate: 0.15 },
      { g: 700, rate: 0.10 },
      { g: 500, rate: 0.05 }
    ];

    const ONLY_CHEESE_FILTER_DEFAULT = false;
    const PAYLOAD_SCHEMA_VERSION = 'v2';

    // Submission mode: 'telegram' | 'webhook' | 'both'
    const SUBMIT_MODE = 'telegram';

    // If you want to send to your webhook (Puzzlebot / —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±—ç–∫–µ–Ω–¥), —É–∫–∞–∂–∏—Ç–µ URL –Ω–∏–∂–µ.
    // –ü—Ä–∏–º–µ—Ä –ø—Ä–∏—ë–º–∞: POST JSON body, –±–µ–∑ CORS –≤ Telegram WebView.
    const WEBHOOK_URL = '';
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏/—Ç–æ–∫–µ–Ω—ã, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≤–µ–±—Ö—É–∫–µ.
    const WEBHOOK_HEADERS = { /* 'X-Secret': '...' */ };

    // =====================
    // CATALOG DATA
    // =====================
    const PRODUCTS = [
      // --- –°—ã—Ä—ã ---
      { id: 'panir-classic', name: '–ü–∞–Ω–∏—Ä –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat: '–°—ã—Ä—ã', pricePerKg: 1200, ico: 'üßÄ', description: '–ù–µ–∂–Ω—ã–π —Å–≤–µ–∂–∏–π —Å—ã—Ä.' },
      { id: 'panir-herbs', name: '–ü–∞–Ω–∏—Ä –° –∑–µ–ª–µ–Ω—å—é', cat: '–°—ã—Ä—ã', pricePerKg: 1300, ico: 'üåø', description: '–° –∞—Ä–æ–º–∞—Ç–Ω—ã–º–∏ —Ç—Ä–∞–≤–∞–º–∏.' },
      { id: 'panir-spicy', name: '–ü–∞–Ω–∏—Ä –° –ø—Ä—è–Ω–æ—Å—Ç—è–º–∏', cat: '–°—ã—Ä—ã', pricePerKg: 1350, ico: 'üå∂Ô∏è', description: '–° –ø–∏–∫–∞–Ω—Ç–Ω—ã–º–∏ —Å–ø–µ—Ü–∏—è–º–∏.' },
      { id: 'panir-smoked', name: '–ü–∞–Ω–∏—Ä –ö–æ–ø—á—ë–Ω—ã–π', cat: '–°—ã—Ä—ã', pricePerKg: 1400, ico: 'üí®', description: '–° –¥—ã–º–Ω—ã–º –∞—Ä–æ–º–∞—Ç–æ–º.' },
      { id: 'suluguni', name: '–°—É–ª—É–≥—É–Ω–∏', cat: '–°—ã—Ä—ã', pricePerKg: 1400, ico: 'üßÄ', description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥—Ä—É–∑–∏–Ω—Å–∫–∏–π —Å—ã—Ä.' },
      { id: 'suluguni-smoked', name: '–°—É–ª—É–≥—É–Ω–∏ –∫–æ–ø—á—ë–Ω—ã–π', cat: '–°—ã—Ä—ã', pricePerKg: 1550, ico: 'üí®', description: '–ö–æ–ø—á—ë–Ω—ã–π —Å—É–ª—É–≥—É–Ω–∏.' },
      { id: 'imeretian', name: '–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π', cat: '–°—ã—Ä—ã', pricePerKg: 1300, ico: 'üßÄ', description: '–ú—è–≥–∫–∏–π, —Ä–∞—Å—Å—ã–ø—á–∞—Ç—ã–π —Å—ã—Ä.' },
      { id: 'imeretian-dill-garlic', name: '–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π —Å —É–∫—Ä–æ–ø–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º', cat: '–°—ã—Ä—ã', pricePerKg: 1400, ico: 'üßÑ', description: '–° –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º –≤–∫—É—Å–æ–º.' },
      { id: 'halloumi', name: '–•–∞–ª–ª—É–º–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)', cat: '–°—ã—Ä—ã', pricePerKg: 1650, ico: 'üî•', description: '–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –∂–∞—Ä–∫–∏.' },
      { id: 'halloumi-paprika-oregano', name: '–•–∞–ª–ª—É–º–∏ —Å –ø–∞–ø—Ä–∏–∫–æ–π –∏ –æ—Ä–µ–≥–∞–Ω–æ', cat: '–°—ã—Ä—ã', pricePerKg: 1800, ico: 'üå∂Ô∏è', description: '–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏–µ –Ω–æ—Ç–∫–∏.' },
      { id: 'halloumi-tomato-basil-garlic', name: '–•–∞–ª–ª—É–º–∏ —Ç–æ–º–∞—Ç-–±–∞–∑–∏–ª–∏–∫-—á–µ—Å–Ω–æ–∫', cat: '–°—ã—Ä—ã', pricePerKg: 1800, ico: 'üçÖ', description: '–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π –≤–∫—É—Å.' },
      { id: 'halloumi-tomato-paprika', name: '–•–∞–ª–ª—É–º–∏ —Å –≤—è–ª–µ–Ω—ã–º–∏ –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ –∏ –ø–∞–ø—Ä–∏–∫–æ–π', cat: '–°—ã—Ä—ã', pricePerKg: 1800, ico: 'üçÖ', description: '–Ø—Ä–∫–∏–π –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π.' },
      { id: 'kosichka', name: '–ö–æ—Å–∏—á–∫–∞', cat: '–°—ã—Ä—ã', pricePerKg: 1600, ico: 'ü•®', description: '–í —Ñ–æ—Ä–º–µ –ø–ª–µ—Ç–µ–Ω–∫–∏.' },
      { id: 'kosichka-smoked', name: '–ö–æ—Å–∏—á–∫–∞ –∫–æ–ø—á—ë–Ω–∞—è', cat: '–°—ã—Ä—ã', pricePerKg: 1750, ico: 'üí®', description: '–ö–æ–ø—á—ë–Ω–∞—è –∫–æ—Å–∏—á–∫–∞.' },
      { id: 'spicy-klubok', name: '–ü—Ä—è–Ω—ã–π –∫–ª—É–±–æ–∫', cat: '–°—ã—Ä—ã', pricePerUnit: 1680, ico: 'üå∂Ô∏è', description: '–û—Å—Ç—Ä—ã–π —Å—ã—Ä –≤ –≤–∏–¥–µ –∫–ª—É–±–∫–∞.' },
      { id: 'mozzarella', name: '–ú–æ—Ü–∞—Ä–µ–ª–ª–∞', cat: '–°—ã—Ä—ã', pricePerUnit: 1700, ico: 'üßÄ', description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–æ—Ü–∞—Ä–µ–ª–ª–∞.' },
      { id: 'buratta', name: '–ë—É—Ä–∞—Ç—Ç–∞', cat: '–°—ã—Ä—ã', pricePerUnit: 1800, ico: 'üßÄ', description: '–ù–µ–∂–Ω–µ–π—à–∞—è –±—É—Ä–∞—Ç—Ç–∞.' },
      { id: 'stracciatella', name: '–°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞', cat: '–°—ã—Ä—ã', pricePerKg: 1850, ico: 'üßÄ', description: '–°–ª–∏–≤–∫–∏ –∏ –Ω–∏—Ç–∏ –º–æ—Ü–∞—Ä–µ–ª–ª—ã.' },
      { id: 'ricotta', name: '–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞)', cat: '–°—ã—Ä—ã', pricePerKg: 1100, ico: 'ü•õ', description: '–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Ç–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä.' },
      { id: 'ricotta-herbs', name: '–†–∏–∫–æ—Ç—Ç–∞ —Å —É–∫—Ä–æ–ø–æ–º –∏ –∑–µ–ª–µ–Ω—å—é', cat: '–°—ã—Ä—ã', pricePerKg: 1200, ico: 'üåø', description: '–° –∞—Ä–æ–º–∞—Ç–Ω–æ–π –∑–µ–ª–µ–Ω—å—é.' },
      { id: 'caciotta', name: '–ö–∞—á–æ—Ç—Ç–∞', cat: '–°—ã—Ä—ã', pricePerKg: 2150, ico: 'üßÄ', description: '–ú—è–≥–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Å—ã—Ä.' },
      { id: 'caciotta-fenugreek', name: '–ö–∞—á–æ—Ç—Ç–∞ —Å –ø–∞–∂–∏—Ç–Ω–∏–∫–æ–º', cat: '–°—ã—Ä—ã', pricePerKg: 2250, ico: 'üåø', description: '–° –æ—Ä–µ—Ö–æ–≤—ã–º –ø—Ä–∏–≤–∫—É—Å–æ–º.' },
      { id: 'hard-village', name: '–¢–≤—ë—Ä–¥—ã–π –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏', cat: '–°—ã—Ä—ã', pricePerKg: 1400, ico: 'üßÄ', description: '–ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –≤–∫—É—Å.' },
      { id: 'hard-smoked', name: '–¢–≤—ë—Ä–¥—ã–π –∫–æ–ø—á—ë–Ω—ã–π', cat: '–°—ã—Ä—ã', pricePerKg: 1600, ico: 'üí®', description: '–ö–æ–ø—á—ë–Ω—ã–π —Ç–≤—ë—Ä–¥—ã–π —Å—ã—Ä.' },
      { id: 'rolls-olives-walnut', name: '–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–º–∞—Å–ª–∏–Ω—ã, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', cat: '–°—ã—Ä—ã', pricePerKg: 1550, ico: 'ü•ú', description: '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.' },
      { id: 'rolls-apricot-cedar', name: '–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–∫—É—Ä–∞–≥–∞, –∫–µ–¥—Ä–æ–≤—ã–π)', cat: '–°—ã—Ä—ã', pricePerKg: 1550, ico: 'üçë', description: '–°–ª–∞–¥–∫–∏–π –∏ —Å–æ–ª–µ–Ω—ã–π –≤–∫—É—Å.' },
      // --- –ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è ---
      { id: 'milk', name: '–ú–æ–ª–æ–∫–æ', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 100, ico: 'ü•õ', description: '–°–≤–µ–∂–µ–µ –º–æ–ª–æ–∫–æ.' },
      { id: 'milk-topped', name: '–¢–æ–ø–ª—ë–Ω–æ–µ –º–æ–ª–æ–∫–æ', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 200, ico: 'ü•õ', description: '–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ.' },
      { id: 'yogurt', name: '–ô–æ–≥—É—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 230, ico: 'ü•õ', description: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –π–æ–≥—É—Ä—Ç.' },
      { id: 'ryazhenka', name: '–†—è–∂–µ–Ω–∫–∞', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 250, ico: 'ü•õ', description: '–ö–∏—Å–ª–æ–º–æ–ª–æ—á–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫.' },
      { id: 'whey', name: '–°—ã–≤–æ—Ä–æ—Ç–∫–∞', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 50, ico: 'üíß', description: '–ú–æ–ª–æ—á–Ω–∞—è —Å—ã–≤–æ—Ä–æ—Ç–∫–∞.' },
      { id: 'cream', name: '–°–ª–∏–≤–∫–∏', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL: 1200, ico: 'ü•õ', description: '–ñ–∏—Ä–Ω—ã–µ —Å–ª–∏–≤–∫–∏ 33%.' },
      { id: 'tvorog', name: '–¢–≤–æ—Ä–æ–≥', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg: 500, ico: 'ü•õ', description: '–î–æ–º–∞—à–Ω–∏–π —Ç–≤–æ—Ä–æ–≥.' },
      { id: 'butter', name: '–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg: 1800, ico: 'üßà', description: '–í–∫—É—Å–Ω–æ–µ —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ.' },
      { id: 'ghee', name: '–¢–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ (–ì–•–ò)', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg: 2300, ico: 'üßà', description: '–ß–∏—Å—Ç–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ.' },
      { id: 'condensed-milk', name: '–°–≥—É—â–µ–Ω–∫–∞', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg: 850, ico: 'ü•õ', description: '–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Å–≥—É—â–µ–Ω–∫–∞.' },
      { id: 'tvorozhnaya-massa', name: '–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞', cat: '–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg: 700, ico: 'ü•õ', description: '–° –¥–æ–±–∞–≤–∫–∞–º–∏ (–∏–∑—é–º, –∫—É—Ä–∞–≥–∞ –∏ —Ç.–¥.).' },
      // --- –°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞ ---
      { id: 'cookies-tvorog', name: '–ü–µ—á–µ–Ω—å–µ —Ç–≤–æ—Ä–æ–∂–Ω–æ–µ', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 600, ico: 'üç™', description: '–ù–µ–∂–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ.' },
      { id: 'cookies-oat', name: '–ü–µ—á–µ–Ω—å–µ –æ–≤—Å—è–Ω–æ–µ', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 600, ico: 'üç™', description: '–ü–æ–ª–µ–∑–Ω–æ–µ –æ–≤—Å—è–Ω–æ–µ.' },
      { id: 'cookies-nut', name: '–û—Ä–µ—Ö–æ–≤—ã–µ –ø–∞–ª—å—á–∏–∫–∏', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 700, ico: 'üç™', description: '–° —Ö—Ä—É—Å—Ç—è—â–∏–º–∏ –æ—Ä–µ—Ö–∞–º–∏.' },
      { id: 'cookies-carob', name: '–ö—ç—Ä–±–æ–≤—ã–µ –ø–µ—á–µ–Ω—å—è', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 600, ico: 'üç™', description: '–ù–∞ —Å–ª–∞–¥–æ—Å—Ç–∏ –∫—ç—Ä–æ–±–∞.' },
      { id: 'cookies-sandy', name: '–ü–µ—Å–æ—á–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 600, ico: 'üç™', description: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø–µ—Å–æ—á–Ω–æ–µ.' },
      { id: 'muffin-plain', name: '–ö–µ–∫—Å—ã –æ–±—ã—á–Ω—ã–µ', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 500, ico: 'üßÅ', description: '–ü—Ä–æ—Å—Ç—ã–µ –∏ –≤–∫—É—Å–Ω—ã–µ.' },
      { id: 'muffin-carob', name: '–ö–µ–∫—Å—ã –∫—ç—Ä–æ–±–æ–≤—ã–µ', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 550, ico: 'üßÅ', description: '–° –∫—ç—Ä–æ–±–æ–º.' },
      { id: 'muffin-raisin', name: '–ö–µ–∫—Å—ã –∏–∑—é–º', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg: 550, ico: 'üßÅ', description: '–° –∏–∑—é–º–æ–º.' },
      { id: 'muffin-mix-plain-raisin', name: '–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∏–∑—é–º)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 280, ico: 'üßÅ', description: '–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id: 'muffin-mix-plain-carob', name: '–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∫—ç—Ä–æ–±)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 300, ico: 'üßÅ', description: '–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id: 'muffin-mix-raisin-carob', name: '–ö–µ–∫—Å—ã –º–∏–∫—Å (–∏–∑—é–º+–∫—ç—Ä–æ–±)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 300, ico: 'üßÅ', description: '–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id: 'sandesh-orange', name: '–°–∞–Ω–¥–µ—à (–∞–ø–µ–ª—å—Å–∏–Ω)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 250, ico: 'üçÆ', description: '5 —à—Ç.' },
      { id: 'sandesh-walnut', name: '–°–∞–Ω–¥–µ—à (–≥—Ä–µ—Ü. –æ—Ä–µ—Ö)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 250, ico: 'üçÆ', description: '5 —à—Ç.' },
      { id: 'sandesh-carob', name: '–°–∞–Ω–¥–µ—à (–∫—ç—Ä–æ–±)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 250, ico: 'üçÆ', description: '5 —à—Ç.' },
      { id: 'barfi-classic', name: '–ë—É—Ä—Ñ–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 300, ico: 'üçÆ', description: '5 —à—Ç.' },
      { id: 'barfi-hazelnut', name: '–ë—É—Ä—Ñ–∏ —Ñ—É–Ω–¥—É–∫', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 300, ico: 'üçÆ', description: '5 —à—Ç.' },
      { id: 'barfi-sesame', name: '–ë—É—Ä—Ñ–∏ –∫—É–Ω–∂—É—Ç–Ω—ã–π', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 420, ico: 'üçÆ', description: '7 —à—Ç.' },
      { id: 'halva', name: '–•–∞–ª–≤–∞', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 200, ico: 'üçÆ', description: '0.2 –∫–≥' },
      { id: 'potato-cake-5', name: '–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 330, ico: 'üç∞', description: '5 —à—Ç.' },
      { id: 'potato-cake-2', name: '–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 155, ico: 'üç∞', description: '2 —à—Ç.' },
      { id: 'casserole-plain', name: '–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è (–æ–±—ã—á–Ω–∞—è)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 260, ico: 'üçÆ', description: '250 –≥' },
      { id: 'casserole-raisin', name: '–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è (—Å –∏–∑—é–º–æ–º)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 260, ico: 'üçÆ', description: '250 –≥' },
      { id: 'crazy-cake', name: '–ö—Ä–µ–π–∑–∏-–∫–µ–π–∫', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 600, ico: 'üéÇ', description: '1 —à—Ç.' },
      { id: 'coconut-kuchen-1kg', name: '–ö–æ–∫–æ—Å–æ–≤—ã–π –∫—É—Ö–µ–Ω', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 1800, ico: 'üç∞', description: '1 –∫–≥' },
      { id: 'coconut-kuchen-05kg', name: '–ö–æ–∫–æ—Å–æ–≤—ã–π –∫—É—Ö–µ–Ω', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 1000, ico: 'üç∞', description: '0.5 –∫–≥' },
      { id: 'napoleon-1kg', name: '–¢–æ—Ä—Ç ¬´–ù–∞–ø–æ–ª–µ–æ–Ω¬ª', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 1300, ico: 'üéÇ', description: '1+ –∫–≥' },
      { id: 'napoleon-05kg', name: '–¢–æ—Ä—Ç ¬´–ù–∞–ø–æ–ª–µ–æ–Ω¬ª', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 750, ico: 'üéÇ', description: '0.5+ –∫–≥' },
      { id: 'apple-pie', name: '–Ø–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 560, ico: 'ü•ß', description: '900 –≥' },
      { id: 'bliny-10', name: '–ë–ª–∏–Ω—ã', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 330, ico: 'ü•û', description: '10 —à—Ç.' },
      { id: 'bliny-5', name: '–ë–ª–∏–Ω—ã', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 220, ico: 'ü•û', description: '5 —à—Ç.' },
      { id: 'bliny-tvorog-5', name: '–ë–ª–∏–Ω—ã —Ç–≤–æ—Ä–æ–≥/—Ç–≤–æ—Ä–æ–≥-–∏–∑—é–º', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 300, ico: 'ü•û', description: '5 —à—Ç.' },
      { id: 'syrniki-10', name: '–°—ã—Ä–Ω–∏–∫–∏', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 520, ico: 'ü•û', description: '10 —à—Ç.' },
      { id: 'syrniki-5', name: '–°—ã—Ä–Ω–∏–∫–∏', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 280, ico: 'ü•û', description: '5 —à—Ç.' },
      { id: 'chapati-10', name: '–ß–∞–ø–∞—Ç–∏', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 270, ico: 'ü´ì', description: '10 —à—Ç.' },
      { id: 'chapati-wholewheat-10', name: '–ß–∞–ø–∞—Ç–∏ (—Ü/–∑ –º—É–∫–∞)', cat: '–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit: 320, ico: 'ü´ì', description: '10 —à—Ç.' },
    ];

    const VARIANT_RULES = {
      // –°—ã—Ä—ã
      'panir-classic': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'panir-herbs': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'panir-spicy': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'panir-smoked': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'suluguni': { type: 'weight', unit: '–≥', step: 100, min: 100, max: 1000 },
      'suluguni-smoked': { type: 'weight', unit: '–≥', step: 100, min: 100, max: 1000 },
      'imeretian': { type: 'weight', unit: '–≥', step: 100, min: 100, max: 1000 },
      'imeretian-dill-garlic': { type: 'weight', unit: '–≥', step: 100, min: 100, max: 1000 },
      'halloumi': { type: 'fixed', options: ['1 —à—Ç (200 –≥)', '1 —à—Ç (250 –≥)'] },
      'halloumi-paprika-oregano': { type: 'fixed', options: ['1 —à—Ç (200 –≥)', '1 —à—Ç (250 –≥)'] },
      'halloumi-tomato-basil-garlic': { type: 'fixed', options: ['1 —à—Ç (200 –≥)', '1 —à—Ç (250 –≥)'] },
      'halloumi-tomato-paprika': { type: 'fixed', options: ['1 —à—Ç (200 –≥)', '1 —à—Ç (250 –≥)'] },
      'kosichka': { type: 'fixed', options: ['1 —à—Ç (200 –≥)'] },
      'kosichka-smoked': { type: 'fixed', options: ['1 —à—Ç (200 –≥)'] },
      'spicy-klubok': { type: 'fixed', options: ['1 —à—Ç (150 –≥)'] },
      'mozzarella': { type: 'fixed', options: ['1 —à—Ç (200 –≥)'] },
      'buratta': { type: 'fixed', options: ['1 —à—Ç (250 –≥)'] },
      'stracciatella': { type: 'fixed', options: ['200 –≥', '250 –≥', '300 –≥', '500 –≥'] },
      'ricotta': { type: 'fixed', options: ['200 –≥', '250 –≥', '300 –≥', '450 –≥'] },
      'ricotta-herbs': { type: 'fixed', options: ['200 –≥', '250 –≥', '300 –≥', '450 –≥'] },
      'caciotta': { type: 'weight', unit: '–≥', step: 100, min: 200, max: 1000 },
      'caciotta-fenugreek': { type: 'weight', unit: '–≥', step: 100, min: 200, max: 1000 },
      'hard-village': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'hard-smoked': { type: 'fixed', options: ['200 –≥', '300 –≥', '400 –≥', '500 –≥', '1000 –≥'] },
      'rolls-olives-walnut': { type: 'weight', unit: '–≥', step: 50, min: 100, max: 1000 },
      'rolls-apricot-cedar': { type: 'weight', unit: '–≥', step: 50, min: 100, max: 1000 },
      // –ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è
      'milk': { type: 'fixed', options: ['0.5 –ª', '1 –ª'] },
      'milk-topped': { type: 'fixed', options: ['0.5 –ª', '1 –ª'] },
      'yogurt': { type: 'fixed', options: ['0.5 –ª', '1 –ª'] },
      'ryazhenka': { type: 'fixed', options: ['0.5 –ª', '1 –ª'] },
      'whey': { type: 'fixed', options: ['1 –ª'] },
      'cream': { type: 'fixed', options: ['0.2 –ª', '0.5 –ª', '1 –ª'] },
      'tvorog': { type: 'weight', unit: '–≥', step: 500, min: 500, max: 2000 },
      'butter': { type: 'fixed', options: ['1 —à—Ç (200 –≥)'] },
      'ghee': { type: 'fixed', options: ['200 –≥', '500 –≥', '1000 –≥'] },
      'condensed-milk': { type: 'weight', unit: '–≥', step: 100, min: 200, max: 1000 },
      'tvorozhnaya-massa': { type: 'weight', unit: '–≥', step: 100, min: 200, max: 1000 },
      // –°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞
      'cookies-tvorog': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'cookies-oat': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'cookies-nut': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'cookies-carob': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'cookies-sandy': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'muffin-plain': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'muffin-carob': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'muffin-raisin': { type: 'weight', unit: '–≥', step: 250, min: 250, max: 2000 },
      'muffin-mix-plain-raisin': { type: 'fixed', options: ['0.5 –∫–≥'] },
      'muffin-mix-plain-carob': { type: 'fixed', options: ['0.5 –∫–≥'] },
      'muffin-mix-raisin-carob': { type: 'fixed', options: ['0.5 –∫–≥'] },
      'sandesh-orange': { type: 'fixed', options: ['5 —à—Ç'] },
      'sandesh-walnut': { type: 'fixed', options: ['5 —à—Ç'] },
      'sandesh-carob': { type: 'fixed', options: ['5 —à—Ç'] },
      'barfi-classic': { type: 'fixed', options: ['5 —à—Ç'] },
      'barfi-hazelnut': { type: 'fixed', options: ['5 —à—Ç'] },
      'barfi-sesame': { type: 'fixed', options: ['7 —à—Ç'] },
      'halva': { type: 'fixed', options: ['0.2 –∫–≥'] },
      'potato-cake-5': { type: 'fixed', options: ['5 —à—Ç'] },
      'potato-cake-2': { type: 'fixed', options: ['2 —à—Ç'] },
      'casserole-plain': { type: 'fixed', options: ['250 –≥'] },
      'casserole-raisin': { type: 'fixed', options: ['250 –≥'] },
      'crazy-cake': { type: 'fixed', options: ['1 —à—Ç'] },
      'coconut-kuchen-1kg': { type: 'fixed', options: ['1 –∫–≥'] },
      'coconut-kuchen-05kg': { type: 'fixed', options: ['0.5 –∫–≥'] },
      'napoleon-1kg': { type: 'fixed', options: ['1+ –∫–≥'] },
      'napoleon-05kg': { type: 'fixed', options: ['0.5+ –∫–≥'] },
      'apple-pie': { type: 'fixed', options: ['900 –≥'] },
      'bliny-10': { type: 'fixed', options: ['10 —à—Ç'] },
      'bliny-5': { type: 'fixed', options: ['5 —à—Ç'] },
      'bliny-tvorog-5': { type: 'fixed', options: ['5 —à—Ç'] },
      'syrniki-10': { type: 'fixed', options: ['10 —à—Ç'] },
      'syrniki-5': { type: 'fixed', options: ['5 —à—Ç'] },
      'chapati-10': { type: 'fixed', options: ['10 —à—Ç'] },
      'chapati-wholewheat-10': { type: 'fixed', options: ['10 —à—Ç'] },
    };

    // =====================
    // STATE
    // =====================
    let cart = []; // { id, name, cat, variant, qty }
    let currentProduct = null;
    let filteredProducts = [];
    let selectedCategories = new Set();

    // =====================
    // INIT
    // =====================
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      try {
        loadState();
        setupTelegramWebApp();
        renderUserProfile();
        buildCategoryChips();
        setupEventListeners();
        filterAndSearchProducts();
        updateCartUI();
      } catch (e) {
        console.error('Init error', e);
        const grid = document.getElementById('product-grid');
        grid.innerHTML = `<p style="color: var(--error-color); text-align:center; padding: 20px;">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>`;
      }
    }

    function setupTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        const wa = window.Telegram.WebApp;
        wa.ready(); wa.expand();
        applyTheme(wa.themeParams, wa.colorScheme);
        wa.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑').onClick(() => startCheckout()).hide();
      } else {
        // Standalone mode (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
        applyTheme({ bg_color: '#ffffff', text_color: '#0f172a', hint_color: '#64748b', link_color: '#2481cc', button_color: '#2481cc', button_text_color: '#ffffff' }, 'light');
      }
    }

    function applyTheme(themeParams, colorScheme) {
      const root = document.documentElement;
      root.style.setProperty('--bg-color', themeParams.bg_color || '#ffffff');
      root.style.setProperty('--text-color', themeParams.text_color || '#0f172a');
      root.style.setProperty('--hint-color', themeParams.hint_color || '#64748b');
      root.style.setProperty('--link-color', themeParams.link_color || '#2481cc');
      root.style.setProperty('--button-color', themeParams.button_color || '#2481cc');
      root.style.setProperty('--button-text-color', themeParams.button_text_color || '#ffffff');
      const dark = colorScheme === 'dark';
      root.style.setProperty('--secondary-bg-color', dark ? '#0b1220' : '#f8fafc');
      root.style.setProperty('--header-bg-color', dark ? '#0b1220' : '#ffffff');
      root.style.setProperty('--section-bg-color', dark ? '#0b1220' : '#ffffff');
      root.style.setProperty('--border-color', dark ? '#1f2937' : '#e2e8f0');
    }

    function renderUserProfile() {
      const box = document.getElementById('user-profile');
      let user = null;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
        user = window.Telegram.WebApp.initDataUnsafe.user;
      }
      if (user) {
        box.innerHTML = `
          <div class="user-avatar">
            <img src="${user.photo_url || ''}" alt="" onerror="this.remove();" />
            ${user.photo_url ? '' : `<span>${(user.first_name||'?').charAt(0).toUpperCase()}</span>`}
          </div>
          <div class="user-name">${user.first_name || '–ì–æ—Å—Ç—å'}</div>
        `;
      } else {
        box.innerHTML = `<div class="user-name">${APP_NAME}</div>`;
      }
    }

    function buildCategoryChips() {
      const cats = [...new Set(PRODUCTS.map(p => p.cat))].sort();
      const wrap = document.getElementById('category-chips');
      wrap.innerHTML = '';
      const all = document.createElement('button');
      all.className = 'chip active'; all.textContent = '–í—Å–µ';
      all.onclick = () => { selectedCategories.clear(); refreshChipsUI(); filterAndSearchProducts(); };
      wrap.appendChild(all);
      cats.forEach(cat => {
        const chip = document.createElement('button');
        chip.className = 'chip'; chip.dataset.cat = cat; chip.textContent = cat;
        chip.onclick = () => { toggleCategory(cat); };
        wrap.appendChild(chip);
      });
    }

    function refreshChipsUI() {
      document.querySelectorAll('.chip').forEach(el => {
        if (!el.dataset.cat) { // "–í—Å–µ"
          el.classList.toggle('active', selectedCategories.size === 0);
        } else {
          el.classList.toggle('active', selectedCategories.has(el.dataset.cat));
        }
      });
    }

    function toggleCategory(cat) {
      if (selectedCategories.has(cat)) selectedCategories.delete(cat); else selectedCategories.add(cat);
      refreshChipsUI();
      filterAndSearchProducts();
    }

    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', debounce(filterAndSearchProducts, 120));
      document.getElementById('only-cheese-checkbox').checked = ONLY_CHEESE_FILTER_DEFAULT;
      document.getElementById('only-cheese-checkbox').addEventListener('change', filterAndSearchProducts);
      document.getElementById('sort-select').addEventListener('change', filterAndSearchProducts);
      document.getElementById('open-cart-btn').addEventListener('click', openCartModal);
      document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);
      document.getElementById('product-variant-select').addEventListener('change', updateProductModalPrice);
      document.getElementById('product-qty-input').addEventListener('input', updateProductModalPrice);
      document.getElementById('product-inc-qty').addEventListener('click', () => {
        const el = document.getElementById('product-qty-input'); el.value = Math.max(1, (parseInt(el.value)||1) + 1); updateProductModalPrice();
      });

      // Cart actions
      document.getElementById('clear-cart-btn').addEventListener('click', () => { if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) { cart = []; saveState(); updateCartUI(); renderCartModal(); }});
      document.getElementById('checkout-btn').addEventListener('click', startCheckout);

      // Checkout
      document.getElementById('checkout-form').addEventListener('submit', onPlaceOrderSubmit);

      // Restore customer draft
      const name = localStorage.getItem('syromania-cust-name');
      const phone = localStorage.getItem('syromania-cust-phone');
      const addr = localStorage.getItem('syromania-cust-addr');
      if (name) document.getElementById('customer-name').value = name;
      if (phone) document.getElementById('customer-phone').value = phone;
      if (addr) document.getElementById('customer-address').value = addr;
      document.getElementById('customer-name').addEventListener('input', e => localStorage.setItem('syromania-cust-name', e.target.value));
      document.getElementById('customer-phone').addEventListener('input', e => localStorage.setItem('syromania-cust-phone', e.target.value));
      document.getElementById('customer-address').addEventListener('input', e => localStorage.setItem('syromania-cust-addr', e.target.value));
    }

    function loadState() {
      try { cart = JSON.parse(localStorage.getItem('syromania-cart') || '[]'); } catch { cart = []; }
    }
    function saveState() { try { localStorage.setItem('syromania-cart', JSON.stringify(cart)); } catch {}
    }

    // =====================
    // FILTER & RENDER
    // =====================
    function filterAndSearchProducts() {
      const q = (document.getElementById('search-input').value || '').trim().toLowerCase();
      const onlyCheese = document.getElementById('only-cheese-checkbox').checked;
      const sort = document.getElementById('sort-select').value;

      filteredProducts = PRODUCTS.filter(p => {
        const text = (p.name + ' ' + (p.description||'')).toLowerCase();
        const matchesQuery = q.length === 0 || text.includes(q);
        const matchesCheese = !onlyCheese || p.cat === '–°—ã—Ä—ã';
        const matchesCats = (selectedCategories.size === 0) || selectedCategories.has(p.cat);
        const hasPrice = p.pricePerKg || p.pricePerL || p.pricePerUnit;
        return matchesQuery && matchesCheese && matchesCats && hasPrice;
      });

      // sort
      if (sort === 'price-asc') filteredProducts.sort((a,b) => getBaseUnitPrice(a) - getBaseUnitPrice(b));
      if (sort === 'price-desc') filteredProducts.sort((a,b) => getBaseUnitPrice(b) - getBaseUnitPrice(a));
      if (sort === 'name-asc') filteredProducts.sort((a,b) => a.name.localeCompare(b.name, 'ru'));
      if (sort === 'name-desc') filteredProducts.sort((a,b) => b.name.localeCompare(a.name, 'ru'));

      // Render
      renderProducts();

      // Result count
      const rc = document.getElementById('result-count');
      rc.textContent = `${filteredProducts.length} –ø–æ–∑.`;
    }

    function getBaseUnitPrice(p) {
      if (p.pricePerKg) return p.pricePerKg; if (p.pricePerL) return p.pricePerL; return p.pricePerUnit || 0;
    }

    function renderProducts() {
      const grid = document.getElementById('product-grid'); grid.innerHTML = '';
      if (filteredProducts.length === 0) { grid.innerHTML = '<p class="center muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'; return; }
      filteredProducts.forEach(p => {
        const card = document.createElement('div'); card.className = 'card'; card.onclick = () => openProductModal(p.id);
        const unit = p.pricePerKg ? '‚ÇΩ/–∫–≥' : p.pricePerL ? '‚ÇΩ/–ª' : '‚ÇΩ';
        const priceText = p.pricePerUnit ? `${fmtPrice.format(p.pricePerUnit)} ‚ÇΩ` : `${fmtPrice.format(getBaseUnitPrice(p))} ${unit}`;
        card.innerHTML = `
          <div class="ico">${p.ico || 'üì¶'}</div>
          <div class="name">${p.name}</div>
          <div class="meta"><span>${p.cat}</span></div>
          <div class="price">${priceText}</div>
        `;
        grid.appendChild(card);
      });
    }

    // =====================
    // PRODUCT MODAL
    // =====================
    function openProductModal(productId) {
      currentProduct = PRODUCTS.find(p => p.id === productId); if (!currentProduct) return;
      const modal = document.getElementById('product-modal');
      document.getElementById('product-modal-title').textContent = currentProduct.name;
      document.getElementById('product-modal-ico').textContent = currentProduct.ico || 'üì¶';
      document.getElementById('product-modal-description').textContent = currentProduct.description || '';
      renderVariantSelector();
      document.getElementById('product-qty-input').value = 1;
      updateProductModalPrice();
      modal.showModal();
    }
    function closeProductModal() { document.getElementById('product-modal').close(); currentProduct = null; }

    function renderVariantSelector() {
      const select = document.getElementById('product-variant-select'); select.innerHTML = '';
      const rule = VARIANT_RULES[currentProduct.id]; if (!rule) { select.innerHTML = '<option>–í–∞—Ä–∏–∞–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</option>'; return; }
      if (rule.type === 'fixed') {
        rule.options.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; select.appendChild(o); });
      } else if (rule.type === 'weight') {
        for (let v = rule.min; v <= rule.max; v += rule.step) { const o = document.createElement('option'); o.value = `${v} ${rule.unit}`; o.textContent = `${v} ${rule.unit}`; select.appendChild(o); }
      }
    }

    function updateProductModalPrice() {
      if (!currentProduct) return;
      const variant = document.getElementById('product-variant-select').value;
      const qty = Math.max(1, parseInt(document.getElementById('product-qty-input').value) || 1);
      const price = calculatePrice(currentProduct.id, variant, qty, { includePending: true });
      document.getElementById('product-modal-price').textContent = formatRUB(price.finalPrice);
      const hint = document.getElementById('discount-hint');
      if (price.nextDiscount) {
        hint.style.display = '';
        hint.textContent = `–°–µ–π—á–∞—Å —Å–∫–∏–¥–∫–∞ ${Math.round(price.discountRate*100)}%. –î–æ–±–∞–≤—å—Ç–µ –µ—â—ë ${price.nextDiscount.remaining} –≥ —ç—Ç–æ–≥–æ —Å—ã—Ä–∞, –∏ —Å–∫–∏–¥–∫–∞ —Å—Ç–∞–Ω–µ—Ç ${Math.round(price.nextDiscount.nextRate*100)}%.`;
      } else if (price.discountRate > 0) {
        hint.style.display = '';
        hint.textContent = `–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ ${Math.round(price.discountRate*100)}%.`;
      } else {
        hint.style.display = 'none';
      }
    }

    // =====================
    // CART
    // =====================
    function addToCart() {
      if (!currentProduct) return;
      const variant = document.getElementById('product-variant-select').value;
      const qty = Math.max(1, parseInt(document.getElementById('product-qty-input').value) || 1);
      const idx = cart.findIndex(x => x.id === currentProduct.id && x.variant === variant);
      if (idx > -1) cart[idx].qty += qty; else cart.push({ id: currentProduct.id, name: currentProduct.name, cat: currentProduct.cat, variant, qty });
      saveState(); updateCartUI(); closeProductModal();
    }

    function updateCartUI() {
      const totalCount = cart.reduce((s,i) => s + i.qty, 0);
      const totalSum = cart.reduce((s,i) => s + calculatePrice(i.id, i.variant, i.qty).finalPrice, 0);
      const btn = document.getElementById('open-cart-btn');
      if (cart.length) { btn.disabled = false; btn.textContent = `–ö–æ—Ä–∑–∏–Ω–∞ (${totalCount}) ¬∑ ${formatRUB(totalSum)}`; }
      else { btn.disabled = true; btn.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'; }

      if (window.Telegram && window.Telegram.WebApp) {
        const mb = window.Telegram.WebApp.MainButton;
        if (cart.length) { mb.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å ¬∑ ${formatRUB(totalSum)}`); mb.show(); }
        else { mb.hide(); }
      }
    }

    function openCartModal() { renderCartModal(); document.getElementById('cart-modal').showModal(); }
    function closeCartModal() { document.getElementById('cart-modal').close(); }

    function renderCartModal() {
      const body = document.getElementById('cart-modal-body'); body.innerHTML = '';
      if (cart.length === 0) { body.innerHTML = '<p class="muted">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>'; updateCartUI(); updateCartSummary(); return; }

      const list = document.createElement('div'); list.className = 'cart-list'; body.appendChild(list);
      cart.forEach((item, index) => {
        const p = getProduct(item.id); const line = document.createElement('div'); line.className = 'cart-item';
        const linePrice = calculatePrice(item.id, item.variant, item.qty);
        const unitLabel = `${formatRUB(Math.max(1, linePrice.basePrice / item.qty))} / –ø–æ–∑.`;
        line.innerHTML = `
          <div class="cart-ico">${p.ico || 'üì¶'}</div>
          <div class="cart-info">
            <div class="cart-name">${item.name}</div>
            <div class="cart-variant">${item.variant}${linePrice.discountRate>0?` ‚Ä¢ —Å–∫–∏–¥–∫–∞ ${Math.round(linePrice.discountRate*100)}%`:''}</div>
            <div class="line"><small>${unitLabel}</small><strong>${formatRUB(linePrice.finalPrice)}</strong></div>
          </div>
          <div class="cart-controls">
            <div class="qty">
              <button onclick="changeItemQty(${index}, -1)">‚àí</button>
              <span>${item.qty}</span>
              <button onclick="changeItemQty(${index}, 1)">+</button>
            </div>
            <button class="btn btn-secondary" onclick="removeItem(${index})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        list.appendChild(line);
      });

      updateCartSummary();
    }

    function updateCartSummary() {
      const sumDiv = document.getElementById('cart-summary');
      const totals = computeTotals();
      sumDiv.innerHTML = `
        <div class="line"><span>–ü–æ–∑–∏—Ü–∏–π</span><strong>${totals.items}</strong></div>
        <div class="line"><span>–°—É–º–º–∞ –±–µ–∑ —Å–∫–∏–¥–æ–∫</span><strong>${formatRUB(totals.base)}</strong></div>
        <div class="line"><span>–°–∫–∏–¥–∫–∞</span><strong>‚àí${formatRUB(totals.discount)}</strong></div>
        <div class="line total"><span>–ò—Ç–æ–≥–æ</span><strong>${formatRUB(totals.final)}</strong></div>
      `;
    }

    function computeTotals() {
      let items = 0, base = 0, final = 0;
      cart.forEach(i => { const pr = calculatePrice(i.id, i.variant, i.qty); items += i.qty; base += pr.basePrice; final += pr.finalPrice; });
      const discount = Math.max(0, base - final);
      return { items, base, discount, final };
    }

    function changeItemQty(index, delta) { cart[index].qty += delta; if (cart[index].qty <= 0) cart.splice(index, 1); saveState(); updateCartUI(); renderCartModal(); }
    function removeItem(index) { cart.splice(index, 1); saveState(); updateCartUI(); renderCartModal(); }

    // =====================
    // PRICING & DISCOUNTS
    // =====================
    function parseVariant(variantString) {
      if (!variantString) return null;
      const m = variantString.match(/(\d+(?:[\.,]\d+)?)\s*(–≥|–∫–≥|–ª|—à—Ç)/i);
      if (m) {
        const value = parseFloat(m[1].replace(',', '.'));
        const u = m[2].toLowerCase();
        if (u === '–≥') return { value, unit: 'g' };
        if (u === '–∫–≥') return { value, unit: 'kg' };
        if (u === '–ª') return { value, unit: 'l' };
        if (u === '—à—Ç') return { value, unit: 'pc' };
      }
      const plus = variantString.match(/(\d+(?:[\.,]\d+)?)\+\s*(–∫–≥|–ª)/i);
      if (plus) { const value = parseFloat(plus[1].replace(',', '.')); const u = plus[2].toLowerCase(); return { value, unit: u === '–∫–≥' ? 'kg' : 'l' }; }
      return null;
    }

    function getProduct(id) { return PRODUCTS.find(p => p.id === id); }

    function priceFor(product, variantParsed) {
      if (!product) return 0;
      if (product.pricePerKg) {
        if (variantParsed.unit === 'g') return (variantParsed.value / 1000) * product.pricePerKg;
        if (variantParsed.unit === 'kg') return variantParsed.value * product.pricePerKg;
        if (variantParsed.unit === 'pc') {
          const w = /\((\d+)\s*–≥\)/.exec(variantParsed.label || '') || /\((\d+)\s*–≥\)/.exec('');
          // fallback handled elsewhere
        }
      } else if (product.pricePerL) {
        if (variantParsed.unit === 'l') return variantParsed.value * product.pricePerL;
      } else if (product.pricePerUnit) { return product.pricePerUnit; }
      return 0;
    }

    function gramsForItem(item) {
      const p = getProduct(item.id); if (!p || p.cat !== '–°—ã—Ä—ã') return 0;
      const parsed = parseVariant(item.variant); if (!parsed) return 0;
      if (parsed.unit === 'g') return parsed.value * item.qty;
      if (parsed.unit === 'kg') return parsed.value * 1000 * item.qty;
      if (parsed.unit === 'pc') {
        const m = item.variant.match(/\((\d+)\s*–≥\)/); if (m) return parseInt(m[1]) * item.qty; return 0;
      }
      return 0;
    }

    function getDiscountRateForProduct(productId, extraGrams = 0) {
      const product = getProduct(productId); if (!product || product.cat !== '–°—ã—Ä—ã') return 0;
      const totalG = cart.filter(i => i.id === productId).reduce((s, i) => s + gramsForItem(i), 0) + (extraGrams || 0);
      let rate = 0; for (const t of DISCOUNT_THRESHOLDS) { if (totalG >= t.g) rate = t.rate; }
      return rate;
    }

    function nextDiscountInfo(productId, extraGrams = 0) {
      const product = getProduct(productId); if (!product || product.cat !== '–°—ã—Ä—ã') return null;
      const currentG = cart.filter(i => i.id === productId).reduce((s,i) => s + gramsForItem(i), 0) + (extraGrams || 0);
      const next = DISCOUNT_THRESHOLDS.find(t => t.g > currentG);
      if (!next) return null;
      const curRate = DISCOUNT_THRESHOLDS.reduce((r,t) => currentG >= t.g ? t.rate : r, 0);
      return { remaining: Math.max(0, next.g - currentG), nextRate: next.rate, curRate };
    }

    function calculatePrice(productId, variant, qty, opts = {}) {
      const product = getProduct(productId); if (!product) return { basePrice: 0, finalPrice: 0, discountRate: 0 };
      const rule = VARIANT_RULES[productId];
      let basePrice = 0;

      if (rule && rule.type === 'fixed' && product.pricePerUnit) {
        basePrice = product.pricePerUnit * qty;
      } else {
        const parsed = parseVariant(variant); if (!parsed) return { basePrice: 0, finalPrice: 0, discountRate: 0 };
        parsed.label = variant;
        if (product.pricePerKg) {
          if (parsed.unit === 'g') basePrice = (parsed.value / 1000) * product.pricePerKg;
          if (parsed.unit === 'kg') basePrice = parsed.value * product.pricePerKg;
          if (parsed.unit === 'pc') {
            const m = variant.match(/\((\d+)\s*–≥\)/); if (m) basePrice = (parseInt(m[1]) / 1000) * product.pricePerKg; else basePrice = 0;
          }
        } else if (product.pricePerL) {
          if (parsed.unit === 'l') basePrice = parsed.value * product.pricePerL; else basePrice = 0;
        } else if (product.pricePerUnit) { basePrice = product.pricePerUnit; }
        basePrice *= qty;
      }

      // discount (per product weight)
      let extraGrams = 0;
      if (opts.includePending) {
        const pv = parseVariant(variant);
        if (pv && product.cat === '–°—ã—Ä—ã') {
          if (pv.unit === 'g') extraGrams = pv.value * qty; else if (pv.unit === 'kg') extraGrams = pv.value * 1000 * qty; else if (pv.unit === 'pc') { const m = variant.match(/\((\d+)\s*–≥\)/); if (m) extraGrams = parseInt(m[1]) * qty; }
        }
      }
      const discountRate = getDiscountRateForProduct(productId, extraGrams);
      const finalPrice = ROUND(basePrice * (1 - discountRate));

      // next discount hint
      let nextDiscount = null;
      if (product.cat === '–°—ã—Ä—ã') nextDiscount = nextDiscountInfo(productId, extraGrams);

      return { basePrice: ROUND(basePrice), finalPrice, discountRate, nextDiscount };
    }

    function formatRUB(n) { return `${fmtPrice.format(Math.max(0, Math.round(n))) } ‚ÇΩ`; }

    // =====================
    // CHECKOUT & SUBMIT
    // =====================
    function startCheckout() {
      closeCartModal();
      renderCheckoutSummary();
      document.getElementById('checkout-modal').showModal();
    }
    function closeCheckoutModal() { document.getElementById('checkout-modal').close(); }

    function renderCheckoutSummary() {
      const totals = computeTotals();
      document.getElementById('summary-items').textContent = `${totals.items} —à—Ç.`;
      document.getElementById('summary-total').textContent = formatRUB(totals.final);
    }

    function onPlaceOrderSubmit(e) {
      e.preventDefault();
      const phone = document.getElementById('customer-phone').value.trim();
      const address = document.getElementById('customer-address').value.trim();
      if (!/^\+?7\s?\d[\d\s\-\(\)]{9,}$/.test(phone)) { showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7 ‚Ä¶'); return; }
      if (address.length < 6) { showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å.'); return; }

      const payload = buildOrderPayload();
      submitOrder(payload);
    }

    function buildOrderPayload() {
      const totals = computeTotals();
      const wa = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      const user = wa && wa.initDataUnsafe ? wa.initDataUnsafe.user : null;

      const customer = {
        name: (document.getElementById('customer-name').value || '').trim(),
        phone: (document.getElementById('customer-phone').value || '').trim(),
        address: (document.getElementById('customer-address').value || '').trim(),
        payment: document.getElementById('payment-method').value,
        delivery_time: document.getElementById('delivery-time').value,
        comment: (document.getElementById('order-comment').value || '').trim(),
      };

      const items = cart.map(i => {
        const p = calculatePrice(i.id, i.variant, i.qty);
        const unitBase = Math.max(1, Math.round(p.basePrice / i.qty));
        const unitFinal = Math.max(1, Math.round(p.finalPrice / i.qty));
        return {
          id: i.id, name: i.name, cat: i.cat, variant: i.variant, qty: i.qty,
          unit_price_base: unitBase, discount_rate: p.discountRate, unit_price: unitFinal, line_total: p.finalPrice,
        };
      });

      const payload = {
        type: 'order', source: 'tg_webapp', currency: CURRENCY,
        shop: { name: APP_NAME },
        items, totals, customer,
        meta: {
          ts: Date.now(), schema_ver: PAYLOAD_SCHEMA_VERSION,
          user: user ? { id: user.id, username: user.username, first_name: user.first_name, last_name: user.last_name, language_code: user.language_code } : null,
          tg_init_data: wa ? wa.initData || null : null
        }
      };
      return payload;
    }

    async function submitOrder(payload) {
      const btn = document.getElementById('place-order-btn');
      const ok = document.getElementById('submit-success');
      const err = document.getElementById('submit-error');
      ok.style.display = 'none'; err.style.display = 'none';
      btn.disabled = true; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞‚Ä¶';

      try {
        // Webhook first (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –∏ —Ä–µ–∂–∏–º –≤–∫–ª—é—á–∞–µ—Ç webhook)
        if (WEBHOOK_URL && (SUBMIT_MODE === 'webhook' || SUBMIT_MODE === 'both')) {
          await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', ...WEBHOOK_HEADERS }, body: JSON.stringify(payload) });
        }

        // Telegram sendData (–¥–ª—è Puzzlebot / –≤–∞—à–µ–≥–æ –±–æ—Ç–∞)
        if (window.Telegram && window.Telegram.WebApp && (SUBMIT_MODE === 'telegram' || SUBMIT_MODE === 'both')) {
          window.Telegram.WebApp.sendData(JSON.stringify(payload));
        } else if (SUBMIT_MODE === 'telegram') {
          // Standalone fallback
          console.log('Order payload (standalone):', payload);
          alert('–†–µ–∂–∏–º Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ Telegram.');
        }

        ok.style.display = '';
        // –û—á–∏—Å—Ç–∏–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        cart = []; saveState(); updateCartUI();
        // –ó–∞–∫—Ä–æ–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
        if (window.Telegram && window.Telegram.WebApp) {
          setTimeout(() => { try { window.Telegram.WebApp.close(); } catch {} }, 600);
        }
      } catch (e) {
        console.error('Submit error', e);
        err.style.display = '';
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑.\n\n–î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏.');
        console.log('Order payload (debug):', payload);
      } finally {
        btn.disabled = false; btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
      }
    }

    function showError(msg) {
      const box = document.getElementById('submit-error');
      box.textContent = msg; box.style.display = '';
      setTimeout(() => { box.style.display = 'none'; }, 4000);
    }

    // =====================
    // UTIL
    // =====================
    function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); }; }
  </script>
</body>
</html>
