diff --git a/index.html b/index.html
index 7f34ac42b318dfdf684a471f8cc73130c5f58d02..68ca65bc88661f47be368712f85440f95a6ada4f 100644
--- a/index.html
+++ b/index.html
@@ -1,503 +1,879 @@
 <!DOCTYPE html>
 <html lang="ru">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
     <title>Сыромания</title>
     <script src="https://telegram.org/js/telegram-web-app.js"></script>
     <style>
         :root {
-            --bg-color: #ffffff;
+            --bg-color: #f5f7fb;
             --text-color: #000000;
-            --hint-color: #999999;
+            --hint-color: #7d8696;
             --link-color: #2481cc;
             --button-color: #2481cc;
             --button-text-color: #ffffff;
-            --secondary-bg-color: #f7f7f7;
+            --secondary-bg-color: #f0f3fa;
             --header-bg-color: #ffffff;
             --section-bg-color: #ffffff;
-            --border-color: #e0e0e0;
+            --border-color: #d8dfeb;
+            --divider-color: rgba(0, 0, 0, 0.08);
+            --shadow-color: rgba(28, 72, 134, 0.15);
+            --chip-bg-color: rgba(36, 129, 204, 0.08);
+            --chip-text-color: #1f2c3d;
+            --chip-active-bg-color: #2481cc;
+            --chip-active-text-color: #ffffff;
+            --surface-elevated-bg-color: #ffffff;
             --error-color: #e74c3c;
             --success-color: #2ecc71;
             --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
         }
 
         body {
             margin: 0;
             padding: 0;
-            background-color: var(--bg-color);
+            min-height: 100vh;
+            background: radial-gradient(circle at top, rgba(36, 129, 204, 0.08), transparent 55%), var(--bg-color);
             color: var(--text-color);
             font-family: var(--font-family);
             font-size: 16px;
             -webkit-font-smoothing: antialiased;
             -moz-osx-font-smoothing: grayscale;
         }
 
         #app {
             display: flex;
             flex-direction: column;
             min-height: 100vh;
         }
 
         header {
             background-color: var(--header-bg-color);
             border-bottom: 1px solid var(--border-color);
-            padding: 10px;
+            padding: 16px 16px 12px;
             flex-shrink: 0;
+            position: sticky;
+            top: 0;
+            z-index: 10;
+            backdrop-filter: blur(6px);
         }
 
         .user-profile {
             display: flex;
             align-items: center;
-            gap: 10px;
-            margin-bottom: 10px;
+            gap: 12px;
+            margin-bottom: 12px;
         }
 
         .user-avatar {
-            width: 32px;
-            height: 32px;
+            width: 40px;
+            height: 40px;
             border-radius: 50%;
             background-color: var(--secondary-bg-color);
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 16px;
             color: var(--hint-color);
             overflow: hidden;
         }
         .user-avatar img {
             width: 100%;
             height: 100%;
             object-fit: cover;
         }
 
         .user-name {
             font-weight: 500;
         }
 
         .search-container {
-            margin-bottom: 10px;
+            margin-bottom: 12px;
         }
 
         #search-input {
             width: 100%;
-            padding: 10px;
+            padding: 12px 14px;
             border: 1px solid var(--border-color);
-            border-radius: 8px;
+            border-radius: 14px;
             background-color: var(--secondary-bg-color);
             color: var(--text-color);
             font-size: 16px;
             box-sizing: border-box;
         }
 
         .filters-container {
             display: flex;
-            gap: 10px;
-            align-items: center;
-            flex-wrap: wrap;
+            flex-direction: column;
+            gap: 12px;
         }
 
-        .filters-container select, .filters-container label {
-            font-size: 14px;
+        #category-filter {
+            display: none;
         }
 
-        #category-filter {
-            padding: 8px;
+        .category-search-container {
+            width: 100%;
+        }
+
+        #category-search {
+            width: 100%;
+            padding: 10px 14px;
             border: 1px solid var(--border-color);
-            border-radius: 8px;
-            background-color: var(--secondary-bg-color);
+            border-radius: 14px;
+            background-color: rgba(255, 255, 255, 0.6);
             color: var(--text-color);
-            flex-grow: 1;
+            font-size: 15px;
+            box-sizing: border-box;
+        }
+
+        .category-chips {
+            display: flex;
+            gap: 8px;
+            overflow-x: auto;
+            padding-bottom: 4px;
+            scrollbar-width: thin;
+        }
+
+        .category-chips::-webkit-scrollbar {
+            height: 6px;
+        }
+
+        .category-chips::-webkit-scrollbar-thumb {
+            background-color: rgba(0, 0, 0, 0.12);
+            border-radius: 4px;
+        }
+
+        .category-chip {
+            border: none;
+            border-radius: 999px;
+            padding: 8px 14px;
+            font-size: 14px;
+            background-color: var(--chip-bg-color);
+            color: var(--chip-text-color);
+            cursor: pointer;
+            transition: transform 0.15s ease, background-color 0.2s ease;
+            white-space: nowrap;
+        }
+
+        .category-chip:hover {
+            transform: translateY(-2px);
+        }
+
+        .category-chip.active {
+            background-color: var(--chip-active-bg-color);
+            color: var(--chip-active-text-color);
+            box-shadow: 0 6px 14px rgba(36, 129, 204, 0.25);
+        }
+
+        .category-chip:focus-visible {
+            outline: 2px solid var(--button-color);
+            outline-offset: 2px;
+        }
+
+        .empty-chip-state {
+            font-size: 14px;
+            color: var(--hint-color);
+            padding: 6px 0;
+        }
+
+        .filters-footer {
+            display: flex;
+            align-items: center;
+            gap: 8px;
+            justify-content: space-between;
+        }
+
+        .reset-filters-btn {
+            background: none;
+            border: none;
+            color: var(--link-color);
+            font-size: 13px;
+            cursor: pointer;
+            padding: 0;
+        }
+        .reset-filters-btn:hover {
+            text-decoration: underline;
         }
 
         #only-cheese-toggle {
             display: flex;
             align-items: center;
-            gap: 5px;
+            gap: 6px;
             cursor: pointer;
             white-space: nowrap;
+            font-size: 14px;
+            color: var(--hint-color);
         }
 
         main {
             flex-grow: 1;
-            padding: 10px;
-            padding-bottom: 80px; /* Space for sticky footer */
+            padding: 16px;
+            padding-bottom: 110px; /* Space for sticky footer */
+            max-width: 980px;
+            width: 100%;
+            margin: 0 auto;
+            box-sizing: border-box;
         }
 
         .product-grid {
+            display: flex;
+            flex-direction: column;
+            gap: 20px;
+        }
+
+        .category-section {
+            background-color: var(--section-bg-color);
+            border: 1px solid var(--border-color);
+            border-radius: 18px;
+            padding: 18px 18px 12px;
+            box-shadow: 0 12px 28px var(--shadow-color);
+        }
+
+        .category-header {
+            display: flex;
+            align-items: center;
+            justify-content: space-between;
+            gap: 12px;
+        }
+
+        .category-title {
+            font-size: 18px;
+            font-weight: 600;
+            margin: 0;
+            background: none;
+            border: none;
+            color: var(--text-color);
+            text-align: left;
+            padding: 0;
+            cursor: pointer;
+        }
+
+        .category-title span {
+            border-bottom: 1px dashed transparent;
+            transition: border-color 0.2s ease;
+        }
+
+        .category-title:hover span {
+            border-color: var(--link-color);
+        }
+
+        .category-count {
+            font-size: 13px;
+            color: var(--hint-color);
+            background-color: var(--secondary-bg-color);
+            border-radius: 999px;
+            padding: 4px 10px;
+        }
+
+        .category-grid {
             display: grid;
-            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
-            gap: 15px;
+            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
+            gap: 14px;
+            margin-top: 16px;
         }
 
         .product-card {
-            border: 1px solid var(--border-color);
-            border-radius: 12px;
-            padding: 12px;
-            background-color: var(--section-bg-color);
+            border: 1px solid rgba(36, 129, 204, 0.1);
+            border-radius: 16px;
+            padding: 16px;
+            background-color: var(--surface-elevated-bg-color);
             cursor: pointer;
-            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
-            text-align: center;
+            transition: transform 0.18s ease, box-shadow 0.18s ease;
             display: flex;
             flex-direction: column;
-            justify-content: space-between;
+            gap: 8px;
+            text-align: left;
+            position: relative;
+            min-height: 160px;
         }
 
         .product-card:hover {
-            transform: translateY(-4px);
-            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
+            transform: translateY(-6px);
+            box-shadow: 0 16px 30px rgba(36, 129, 204, 0.18);
+        }
+
+        .product-card:focus-visible {
+            outline: 2px solid var(--button-color);
+            outline-offset: 3px;
         }
 
         .product-card .ico {
-            font-size: 48px;
-            margin-bottom: 8px;
+            font-size: 42px;
         }
 
         .product-card .name {
-            font-weight: 500;
-            font-size: 14px;
-            margin-bottom: 4px;
-            flex-grow: 1;
+            font-weight: 600;
+            font-size: 15px;
+            margin: 0;
         }
 
-        .product-card .price {
+        .product-card .description {
             color: var(--hint-color);
             font-size: 13px;
+            line-height: 1.4;
+            flex-grow: 1;
+        }
+
+        .product-card .price {
+            color: var(--link-color);
+            font-weight: 600;
+            font-size: 14px;
         }
 
         .cart-footer {
             position: sticky;
             bottom: 0;
-            background-color: var(--header-bg-color);
+            background-color: rgba(255, 255, 255, 0.92);
             border-top: 1px solid var(--border-color);
-            padding: 10px;
+            padding: 16px;
             display: flex;
             justify-content: center;
             align-items: center;
             flex-shrink: 0;
+            box-shadow: 0 -12px 30px rgba(36, 129, 204, 0.1);
+            backdrop-filter: blur(6px);
         }
 
         #open-cart-btn {
-            background-color: var(--button-color);
+            background: linear-gradient(135deg, var(--button-color), #2c97f0);
             color: var(--button-text-color);
-            padding: 12px 24px;
-            border-radius: 24px;
+            padding: 14px 24px;
+            border-radius: 999px;
             cursor: pointer;
             border: none;
             font-size: 16px;
-            font-weight: 500;
+            font-weight: 600;
             width: 100%;
-            max-width: 400px;
-            transition: background-color 0.2s;
+            max-width: 420px;
+            transition: transform 0.15s ease, filter 0.2s ease;
+            box-shadow: 0 16px 24px rgba(36, 129, 204, 0.25);
         }
         #open-cart-btn:hover {
             filter: brightness(110%);
+            transform: translateY(-2px);
         }
         #open-cart-btn:disabled {
-            background-color: var(--hint-color);
+            background: var(--hint-color);
             cursor: not-allowed;
+            box-shadow: none;
+            transform: none;
         }
 
         dialog {
             border: 1px solid var(--border-color);
-            border-radius: 12px;
+            border-radius: 18px;
             padding: 0;
             background-color: var(--section-bg-color);
             color: var(--text-color);
-            width: 90vw;
-            max-width: 400px;
-            max-height: 80vh;
+            width: min(520px, 92vw);
+            max-height: 85vh;
             overflow: hidden;
-            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
+            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.35);
         }
 
         dialog::backdrop {
             background-color: rgba(0,0,0,0.5);
             -webkit-backdrop-filter: blur(4px);
             backdrop-filter: blur(4px);
         }
 
         .modal-header {
-            padding: 15px;
+            padding: 18px;
             border-bottom: 1px solid var(--border-color);
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
 
         .modal-header h2 {
             margin: 0;
             font-size: 18px;
+            font-weight: 600;
         }
 
         .modal-close {
             background: none;
             border: none;
             font-size: 24px;
             cursor: pointer;
             color: var(--hint-color);
             padding: 0;
             line-height: 1;
             border-radius: 50%;
             width: 32px;
             height: 32px;
             display: flex;
             align-items: center;
             justify-content: center;
         }
         .modal-close:hover {
             background-color: var(--secondary-bg-color);
         }
 
         .modal-body {
-            padding: 15px;
+            padding: 18px;
             overflow-y: auto;
-            max-height: 60vh;
+            max-height: 65vh;
+            display: flex;
+            flex-direction: column;
+            gap: 16px;
         }
 
         .modal-body .ico {
             font-size: 64px;
             text-align: center;
-            margin-bottom: 10px;
+            margin-bottom: 4px;
         }
 
         .modal-body .description {
             color: var(--hint-color);
             font-size: 14px;
-            margin-bottom: 15px;
         }
 
         .form-group {
-            margin-bottom: 15px;
+            display: flex;
+            flex-direction: column;
+            gap: 6px;
         }
 
         .form-group label {
-            display: block;
-            margin-bottom: 5px;
             font-size: 14px;
+            font-weight: 500;
+            color: var(--hint-color);
         }
 
-        .form-group select, .form-group input {
+        .form-group select,
+        .form-group input,
+        .form-group textarea {
             width: 100%;
-            padding: 10px;
+            padding: 12px 14px;
             border: 1px solid var(--border-color);
-            border-radius: 8px;
+            border-radius: 12px;
             background-color: var(--secondary-bg-color);
             color: var(--text-color);
-            font-size: 16px;
+            font-size: 15px;
             box-sizing: border-box;
+            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
+        }
+
+        .form-group textarea {
+            min-height: 96px;
+            resize: vertical;
+        }
+
+        .form-group input:focus,
+        .form-group select:focus,
+        .form-group textarea:focus {
+            outline: none;
+            border-color: var(--button-color);
+            box-shadow: 0 0 0 3px rgba(36, 129, 204, 0.15);
+            background-color: #ffffff;
         }
 
         .form-row {
             display: flex;
             gap: 10px;
         }
         .form-row .form-group {
             flex-grow: 1;
         }
 
         .price-display {
-            font-size: 18px;
-            font-weight: 500;
+            font-size: 20px;
+            font-weight: 600;
             text-align: center;
-            margin: 15px 0;
+            margin: 4px 0 8px;
+            color: var(--link-color);
         }
 
         .btn {
-            padding: 12px 20px;
+            padding: 14px 20px;
             border: none;
-            border-radius: 8px;
+            border-radius: 14px;
             font-size: 16px;
-            font-weight: 500;
+            font-weight: 600;
             cursor: pointer;
             width: 100%;
             box-sizing: border-box;
-            transition: background-color 0.2s, transform 0.1s;
+            transition: transform 0.15s ease, filter 0.2s ease;
         }
         .btn:active {
             transform: scale(0.98);
         }
 
         .btn-primary {
-            background-color: var(--button-color);
+            background: linear-gradient(135deg, var(--button-color), #2c97f0);
             color: var(--button-text-color);
+            box-shadow: 0 12px 22px rgba(36, 129, 204, 0.3);
         }
         .btn-primary:hover {
-            filter: brightness(110%);
+            filter: brightness(108%);
         }
 
         .btn-secondary {
             background-color: var(--secondary-bg-color);
             color: var(--text-color);
             border: 1px solid var(--border-color);
         }
         .btn-secondary:hover {
-            background-color: var(--border-color);
+            filter: brightness(105%);
         }
 
-        .cart-item {
+        .btn[disabled] {
+            opacity: 0.6;
+            cursor: not-allowed;
+            transform: none;
+            box-shadow: none;
+        }
+
+        .cart-items {
             display: flex;
-            justify-content: space-between;
-            align-items: center;
-            padding: 10px 0;
-            border-bottom: 1px solid var(--border-color);
+            flex-direction: column;
+            gap: 12px;
         }
 
-        .cart-item:last-child {
-            border-bottom: none;
+        .cart-item {
+            display: flex;
+            justify-content: space-between;
+            align-items: flex-start;
+            gap: 12px;
+            padding: 14px;
+            border: 1px solid rgba(36, 129, 204, 0.12);
+            border-radius: 14px;
+            background-color: var(--secondary-bg-color);
         }
 
         .cart-item-info {
             flex-grow: 1;
-            padding-right: 10px;
+            display: flex;
+            flex-direction: column;
+            gap: 4px;
         }
         .cart-item-name {
-            font-weight: 500;
+            font-weight: 600;
+            font-size: 15px;
         }
         .cart-item-variant {
-            font-size: 14px;
+            font-size: 13px;
             color: var(--hint-color);
         }
         .cart-item-price {
-            font-size: 14px;
+            font-size: 15px;
+            font-weight: 600;
+            color: var(--link-color);
         }
         .discount-hint {
             color: var(--success-color);
             font-size: 12px;
         }
 
         .cart-item-controls {
             display: flex;
             align-items: center;
-            gap: 10px;
+            gap: 8px;
         }
         .qty-control {
             display: flex;
             align-items: center;
             border: 1px solid var(--border-color);
-            border-radius: 8px;
+            border-radius: 999px;
+            overflow: hidden;
+            background-color: var(--section-bg-color);
         }
         .qty-control button {
             background: none;
             border: none;
-            width: 30px;
-            height: 30px;
+            width: 34px;
+            height: 34px;
             cursor: pointer;
             font-size: 18px;
             color: var(--text-color);
             display: flex;
             align-items: center;
             justify-content: center;
-            border-radius: 8px;
         }
         .qty-control button:hover {
             background-color: var(--secondary-bg-color);
         }
         .qty-control span {
-            padding: 0 10px;
-            min-width: 30px;
+            padding: 0 12px;
+            min-width: 36px;
             text-align: center;
+            font-weight: 600;
+        }
+
+        .remove-item-btn {
+            background: none;
+            border: none;
+            width: 32px;
+            height: 32px;
+            border-radius: 50%;
+            cursor: pointer;
+            font-size: 18px;
+            color: var(--hint-color);
+            transition: background-color 0.2s ease, color 0.2s ease;
+        }
+        .remove-item-btn:hover {
+            background-color: rgba(231, 76, 60, 0.1);
+            color: var(--error-color);
         }
 
         .cart-summary {
-            margin-top: 20px;
-            padding-top: 15px;
-            border-top: 2px solid var(--border-color);
+            margin-top: 8px;
+            padding: 14px 16px;
+            border: 1px solid rgba(36, 129, 204, 0.15);
+            border-radius: 16px;
+            background-color: rgba(36, 129, 204, 0.06);
+            display: flex;
+            flex-direction: column;
+            gap: 6px;
+            font-size: 15px;
+        }
+
+        .summary-total {
             font-size: 18px;
-            font-weight: 500;
-            text-align: right;
+            font-weight: 600;
+            color: var(--link-color);
+        }
+
+        .summary-discount {
+            color: var(--success-color);
+            font-size: 14px;
+        }
+
+        #cart-modal-body {
+            display: flex;
+            flex-direction: column;
+            gap: 18px;
+        }
+
+        .checkout-form {
+            display: flex;
+            flex-direction: column;
+            gap: 16px;
+        }
+
+        .checkout-form h3 {
+            margin: 0;
+            font-size: 16px;
+            font-weight: 600;
+        }
+
+        .form-note {
+            font-size: 12px;
+            color: var(--hint-color);
+        }
+
+        .form-hint {
+            font-size: 13px;
+            color: var(--error-color);
+            line-height: 1.4;
+        }
+
+        .form-hint.success {
+            color: var(--success-color);
+        }
+
+        .form-hint.hidden {
+            display: none;
+        }
+
+        .checkout-divider {
+            height: 1px;
+            background-color: var(--divider-color);
+            border: none;
+            margin: 4px 0;
+        }
+
+        .empty-cart {
+            text-align: center;
+            color: var(--hint-color);
+            display: flex;
+            flex-direction: column;
+            align-items: center;
+            gap: 12px;
+            padding: 24px 0;
+        }
+
+        .empty-cart .ico {
+            font-size: 64px;
+        }
+
+        .empty-cart p {
+            margin: 0;
+            font-size: 15px;
+        }
+
+        .visually-hidden {
+            position: absolute;
+            width: 1px;
+            height: 1px;
+            padding: 0;
+            margin: -1px;
+            overflow: hidden;
+            clip: rect(0, 0, 0, 0);
+            white-space: nowrap;
+            border: 0;
+        }
+
+        #only-cheese-checkbox {
+            accent-color: var(--button-color);
+        }
+
+        .empty-state {
+            text-align: center;
+            color: var(--hint-color);
+            padding: 24px 0;
+            font-size: 15px;
+        }
+
+        @media (max-width: 600px) {
+            header {
+                padding: 14px 12px 10px;
+            }
+            main {
+                padding: 12px;
+                padding-bottom: 100px;
+            }
+            .category-section {
+                padding: 14px 14px 10px;
+            }
+            .category-grid {
+                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
+            }
+            .product-card {
+                padding: 14px;
+            }
         }
     </style>
 </head>
 <body>
     <div id="app">
         <header>
             <div class="user-profile" id="user-profile">
                 <!-- Profile will be rendered here -->
             </div>
             <div class="search-container">
-                <input type="search" id="search-input" placeholder="Поиск по названию...">
+                <input type="search" id="search-input" placeholder="Поиск по товарам и описанию...">
             </div>
             <div class="filters-container">
-                <select id="category-filter">
+                <label for="category-filter" class="visually-hidden">Фильтр по категории</label>
+                <select id="category-filter" class="visually-hidden">
                     <option value="">Все категории</option>
                 </select>
-                <label id="only-cheese-toggle">
-                    <input type="checkbox" id="only-cheese-checkbox">
-                    <span>Только сыры</span>
-                </label>
+                <div class="category-search-container">
+                    <input type="search" id="category-search" placeholder="Поиск по категориям...">
+                </div>
+                <div id="category-chips" class="category-chips"></div>
+                <div class="filters-footer">
+                    <label id="only-cheese-toggle">
+                        <input type="checkbox" id="only-cheese-checkbox">
+                        <span>Только сыры</span>
+                    </label>
+                    <button type="button" id="reset-filters-btn" class="reset-filters-btn">Сбросить фильтры</button>
+                </div>
             </div>
         </header>
 
         <main>
             <div id="product-grid" class="product-grid"></div>
         </main>
 
         <footer class="cart-footer">
             <button id="open-cart-btn" disabled>Корзина пуста</button>
         </footer>
     </div>
 
     <dialog id="product-modal">
         <div class="modal-header">
             <h2 id="product-modal-title"></h2>
             <button class="modal-close" onclick="closeProductModal()">&times;</button>
         </div>
         <div class="modal-body">
             <div class="ico" id="product-modal-ico"></div>
             <p class="description" id="product-modal-description"></p>
             <div class="form-group">
                 <label for="product-variant-select">Вариант</label>
                 <select id="product-variant-select"></select>
             </div>
             <div class="form-group">
                 <label for="product-qty-input">Количество</label>
                 <input type="number" id="product-qty-input" value="1" min="1">
             </div>
             <div class="price-display" id="product-modal-price">0 ₽</div>
             <button class="btn btn-primary" id="add-to-cart-btn">Добавить в корзину</button>
         </div>
     </dialog>
 
     <dialog id="cart-modal">
         <div class="modal-header">
             <h2>Корзина</h2>
             <button class="modal-close" onclick="closeCartModal()">&times;</button>
         </div>
         <div class="modal-body" id="cart-modal-body">
             <!-- Cart items will be rendered here -->
         </div>
     </dialog>
 
     <script>
         // --- CONFIGURATION & DATA ---
+        const STATE_STORAGE_KEY = 'syromania-state';
+        const ORDER_FORM_DEFAULT = {
+            name: '',
+            phone: '',
+            address: '',
+            paymentMethod: 'cash',
+            comment: ''
+        };
+        const PAYMENT_METHOD_LABELS = {
+            cash: 'Наличными при получении',
+            card: 'Картой при получении',
+            online: 'Онлайн перевод'
+        };
         const CURRENCY = 'RUB';
         const ROUND = Math.round;
         const DISCOUNT_THRESHOLDS = [{ g: 1000, rate: 0.15 }, { g: 700, rate: 0.10 }, { g: 500, rate: 0.05 }];
         const ONLY_CHEESE_FILTER_DEFAULT = false;
         const PAYLOAD_SCHEMA_VERSION = 'v1';
+        const currencyFormatter = (() => {
+            try {
+                return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: CURRENCY, maximumFractionDigits: 0 });
+            } catch (error) {
+                console.warn('Intl.NumberFormat is not available. Falling back to simple formatting.');
+                return { format: (value) => `${ROUND(value || 0)} ₽` };
+            }
+        })();
+
+        function formatCurrency(value) {
+            try {
+                return currencyFormatter.format(value || 0);
+            } catch (error) {
+                return `${ROUND(value || 0)} ₽`;
+            }
+        }
 
         const PRODUCTS = [
             // Сыры
             { id: 'panir-classic', name: 'Панир Классический', cat: 'Сыры', pricePerKg: 1200, ico: '🧀', description: 'Нежный свежий сыр.' },
             { id: 'panir-herbs', name: 'Панир С зеленью', cat: 'Сыры', pricePerKg: 1300, ico: '🌿', description: 'С ароматными травами.' },
             { id: 'panir-spicy', name: 'Панир С пряностями', cat: 'Сыры', pricePerKg: 1350, ico: '🌶️', description: 'С пикантными специями.' },
             { id: 'panir-smoked', name: 'Панир Копчёный', cat: 'Сыры', pricePerKg: 1400, ico: '💨', description: 'С дымным ароматом.' },
             { id: 'suluguni', name: 'Сулугуни', cat: 'Сыры', pricePerKg: 1400, ico: '🧀', description: 'Классический грузинский сыр.' },
             { id: 'suluguni-smoked', name: 'Сулугуни копчёный', cat: 'Сыры', pricePerKg: 1550, ico: '💨', description: 'Копчёный сулугуни.' },
             { id: 'imeretian', name: 'Имеретинский', cat: 'Сыры', pricePerKg: 1300, ico: '🧀', description: 'Мягкий, рассыпчатый сыр.' },
             { id: 'imeretian-dill-garlic', name: 'Имеретинский с укропом и чесноком', cat: 'Сыры', pricePerKg: 1400, ico: '🧄', description: 'С насыщенным вкусом.' },
             { id: 'halloumi', name: 'Халлуми (классический)', cat: 'Сыры', pricePerKg: 1650, ico: '🔥', description: 'Идеален для жарки.' },
             { id: 'halloumi-paprika-oregano', name: 'Халлуми с паприкой и орегано', cat: 'Сыры', pricePerKg: 1800, ico: '🌶️', description: 'Средиземноморские нотки.' },
             { id: 'halloumi-tomato-basil-garlic', name: 'Халлуми томат-базилик-чеснок', cat: 'Сыры', pricePerKg: 1800, ico: '🍅', description: 'Итальянский вкус.' },
             { id: 'halloumi-tomato-paprika', name: 'Халлуми с вялеными помидорами и паприкой', cat: 'Сыры', pricePerKg: 1800, ico: '🍅', description: 'Яркий и насыщенный.' },
             { id: 'kosichka', name: 'Косичка', cat: 'Сыры', pricePerKg: 1600, ico: '🥨', description: 'В форме плетенки.' },
             { id: 'kosichka-smoked', name: 'Косичка копчёная', cat: 'Сыры', pricePerKg: 1750, ico: '💨', description: 'Копчёная косичка.' },
             { id: 'spicy-klubok', name: 'Пряный клубок', cat: 'Сыры', pricePerUnit: 1680, ico: '🌶️', description: 'Острый сыр в виде клубка.' },
             { id: 'mozzarella', name: 'Моцарелла', cat: 'Сыры', pricePerUnit: 1700, ico: '🧀', description: 'Классическая моцарелла.' },
             { id: 'buratta', name: 'Буратта', cat: 'Сыры', pricePerUnit: 1800, ico: '🧀', description: 'Нежнейшая буратта.' },
             { id: 'stracciatella', name: 'Страчателла', cat: 'Сыры', pricePerKg: 1850, ico: '🧀', description: 'Сливки и нити моцареллы.' },
             { id: 'ricotta', name: 'Творожный сыр (рикотта)', cat: 'Сыры', pricePerKg: 1100, ico: '🥛', description: 'Итальянский творожный сыр.' },
             { id: 'ricotta-herbs', name: 'Рикотта с укропом и зеленью', cat: 'Сыры', pricePerKg: 1200, ico: '🌿', description: 'С ароматной зеленью.' },
             { id: 'caciotta', name: 'Качотта', cat: 'Сыры', pricePerKg: 2150, ico: '🧀', description: 'Мягкий итальянский сыр.' },
             { id: 'caciotta-fenugreek', name: 'Качотта с пажитником', cat: 'Сыры', pricePerKg: 2250, ico: '🌿', description: 'С ореховым привкусом пажитника.' },
@@ -615,207 +991,439 @@
             'barfi-sesame': { type: 'fixed', options: ['7 шт'] },
             'halva': { type: 'fixed', options: ['0.2 кг'] },
             'potato-cake-5': { type: 'fixed', options: ['5 шт'] },
             'potato-cake-2': { type: 'fixed', options: ['2 шт'] },
             'casserole-plain': { type: 'fixed', options: ['250 г'] },
             'casserole-raisin': { type: 'fixed', options: ['250 г'] },
             'crazy-cake': { type: 'fixed', options: ['1 шт'] },
             'coconut-kuchen-1kg': { type: 'fixed', options: ['1 кг'] },
             'coconut-kuchen-05kg': { type: 'fixed', options: ['0.5 кг'] },
             'napoleon-1kg': { type: 'fixed', options: ['1+ кг'] },
             'napoleon-05kg': { type: 'fixed', options: ['0.5+ кг'] },
             'apple-pie': { type: 'fixed', options: ['900 г'] },
             'bliny-10': { type: 'fixed', options: ['10 шт'] },
             'bliny-5': { type: 'fixed', options: ['5 шт'] },
             'bliny-tvorog-5': { type: 'fixed', options: ['5 шт'] },
             'syrniki-10': { type: 'fixed', options: ['10 шт'] },
             'syrniki-5': { type: 'fixed', options: ['5 шт'] },
             'chapati-10': { type: 'fixed', options: ['10 шт'] },
             'chapati-wholewheat-10': { type: 'fixed', options: ['10 шт'] },
         };
 
         // --- STATE MANAGEMENT ---
         let cart = [];
         let currentProduct = null;
         let filteredProducts = [];
+        let orderForm = { ...ORDER_FORM_DEFAULT };
+        let activeCategory = '';
+        let categorySearchTerm = '';
 
         // --- INITIALIZATION ---
         function init() {
             try {
                 loadState();
                 setupEventListeners();
                 setupTelegramWebApp();
+                const cheeseCheckbox = document.getElementById('only-cheese-checkbox');
+                if (cheeseCheckbox) {
+                    cheeseCheckbox.checked = ONLY_CHEESE_FILTER_DEFAULT;
+                }
                 renderUserProfile();
                 populateCategoryFilter();
                 filterAndSearchProducts();
                 updateCartUI();
             } catch (e) {
                 console.error("An error occurred during initialization:", e);
                 const grid = document.getElementById('product-grid');
                 if (grid) {
                     grid.innerHTML = `<p style="color: var(--error-color); text-align: center; padding: 20px;">Произошла ошибка при загрузке приложения. Пожалуйста, попробуйте обновить страницу.</p>`;
                 }
             }
         }
 
         function loadState() {
             try {
-                const savedCart = localStorage.getItem('syromania-cart');
-                if (savedCart) {
-                    cart = JSON.parse(savedCart);
+                const savedStateRaw = localStorage.getItem(STATE_STORAGE_KEY);
+                if (savedStateRaw) {
+                    const savedState = JSON.parse(savedStateRaw);
+                    if (Array.isArray(savedState.cart)) {
+                        cart = savedState.cart;
+                    }
+                    if (savedState.orderForm && typeof savedState.orderForm === 'object') {
+                        orderForm = { ...ORDER_FORM_DEFAULT, ...savedState.orderForm };
+                    }
+                    if (typeof savedState.activeCategory === 'string') {
+                        activeCategory = savedState.activeCategory;
+                    }
+                } else {
+                    const legacyCart = localStorage.getItem('syromania-cart');
+                    if (legacyCart) {
+                        cart = JSON.parse(legacyCart);
+                        localStorage.removeItem('syromania-cart');
+                    }
                 }
             } catch (e) {
-                console.warn("localStorage is not available. Starting with an empty cart.");
+                console.warn("localStorage is not available. Starting with defaults.");
                 cart = [];
+                orderForm = { ...ORDER_FORM_DEFAULT };
+                activeCategory = '';
             }
         }
 
         function saveState() {
             try {
-                localStorage.setItem('syromania-cart', JSON.stringify(cart));
+                const payload = {
+                    cart,
+                    orderForm,
+                    activeCategory
+                };
+                localStorage.setItem(STATE_STORAGE_KEY, JSON.stringify(payload));
             } catch (e) {
                 console.warn("Could not save state to localStorage.");
             }
         }
 
         function setupTelegramWebApp() {
             if (window.Telegram) {
                 const webApp = window.Telegram.WebApp;
                 webApp.ready();
                 webApp.expand();
                 applyTheme(webApp.themeParams, webApp.colorScheme);
-                webApp.MainButton.setText('Отправить заказ').onClick(sendOrder).hide();
+
+                const mainButton = webApp.MainButton;
+                if (mainButton) {
+                    mainButton.setText('Отправить заказ');
+                    mainButton.onClick(sendOrder);
+                    mainButton.hide();
+                }
             } else {
                 console.warn('Telegram WebApp script is not loaded. Running in standalone mode.');
                 applyTheme({ bg_color: '#ffffff', text_color: '#000000', button_color: '#2481cc', button_text_color: '#ffffff' }, 'light');
             }
         }
 
         function applyTheme(themeParams, colorScheme) {
             const root = document.documentElement;
+            const isDark = colorScheme === 'dark';
             root.style.setProperty('--bg-color', themeParams.bg_color || '#ffffff');
             root.style.setProperty('--text-color', themeParams.text_color || '#000000');
             root.style.setProperty('--hint-color', themeParams.hint_color || '#999999');
             root.style.setProperty('--link-color', themeParams.link_color || '#2481cc');
             root.style.setProperty('--button-color', themeParams.button_color || '#2481cc');
             root.style.setProperty('--button-text-color', themeParams.button_text_color || '#ffffff');
-            root.style.setProperty('--secondary-bg-color', colorScheme === 'dark' ? '#1a1a1a' : '#f7f7f7');
-            root.style.setProperty('--header-bg-color', colorScheme === 'dark' ? '#212121' : '#ffffff');
-            root.style.setProperty('--section-bg-color', colorScheme === 'dark' ? '#1a1a1a' : '#ffffff');
-            root.style.setProperty('--border-color', colorScheme === 'dark' ? '#333333' : '#e0e0e0');
+            root.style.setProperty('--secondary-bg-color', isDark ? '#1a1a1a' : '#f0f3fa');
+            root.style.setProperty('--header-bg-color', isDark ? '#212121' : '#ffffff');
+            root.style.setProperty('--section-bg-color', isDark ? '#1a1a1a' : '#ffffff');
+            root.style.setProperty('--surface-elevated-bg-color', isDark ? '#202020' : '#ffffff');
+            root.style.setProperty('--border-color', isDark ? '#333333' : '#d8dfeb');
+            root.style.setProperty('--divider-color', isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(0, 0, 0, 0.08)');
+            root.style.setProperty('--shadow-color', isDark ? 'rgba(0, 0, 0, 0.45)' : 'rgba(28, 72, 134, 0.15)');
+            root.style.setProperty('--chip-bg-color', isDark ? 'rgba(36, 129, 204, 0.25)' : 'rgba(36, 129, 204, 0.08)');
+            root.style.setProperty('--chip-text-color', isDark ? '#f5f7fb' : '#1f2c3d');
+            root.style.setProperty('--chip-active-bg-color', themeParams.button_color || '#2481cc');
+            root.style.setProperty('--chip-active-text-color', themeParams.button_text_color || '#ffffff');
         }
 
         // --- UI & RENDERING ---
         function setupEventListeners() {
-            document.getElementById('search-input').addEventListener('input', filterAndSearchProducts);
-            document.getElementById('category-filter').addEventListener('change', filterAndSearchProducts);
+            document.getElementById('search-input').addEventListener('input', handleProductSearch);
+            document.getElementById('category-filter').addEventListener('change', handleCategoryFilterChange);
             document.getElementById('only-cheese-checkbox').addEventListener('change', filterAndSearchProducts);
             document.getElementById('open-cart-btn').addEventListener('click', openCartModal);
             document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);
             document.getElementById('product-variant-select').addEventListener('change', updateProductModalPrice);
             document.getElementById('product-qty-input').addEventListener('input', updateProductModalPrice);
+
+            const categorySearchInput = document.getElementById('category-search');
+            if (categorySearchInput) {
+                categorySearchInput.addEventListener('input', handleCategorySearch);
+            }
+
+            const categoryChipsContainer = document.getElementById('category-chips');
+            if (categoryChipsContainer) {
+                categoryChipsContainer.addEventListener('click', handleCategoryChipClick);
+            }
+
+            const resetFiltersBtn = document.getElementById('reset-filters-btn');
+            if (resetFiltersBtn) {
+                resetFiltersBtn.addEventListener('click', resetFilters);
+            }
+        }
+
+        function handleProductSearch() {
+            filterAndSearchProducts();
+        }
+
+        function handleCategoryFilterChange(event) {
+            setActiveCategory(event.target.value || '');
+        }
+
+        function handleCategorySearch(event) {
+            categorySearchTerm = event.target.value.trim().toLowerCase();
+            renderCategoryChips();
+            filterAndSearchProducts();
+        }
+
+        function handleCategoryChipClick(event) {
+            const chip = event.target.closest('.category-chip');
+            if (!chip) return;
+            const category = chip.dataset.category || '';
+            if (activeCategory === category) {
+                setActiveCategory('');
+            } else {
+                setActiveCategory(category);
+            }
+        }
+
+        function resetFilters() {
+            const searchInput = document.getElementById('search-input');
+            const categorySearchInput = document.getElementById('category-search');
+            const cheeseCheckbox = document.getElementById('only-cheese-checkbox');
+            if (searchInput) searchInput.value = '';
+            if (categorySearchInput) categorySearchInput.value = '';
+            if (cheeseCheckbox) cheeseCheckbox.checked = ONLY_CHEESE_FILTER_DEFAULT;
+
+            categorySearchTerm = '';
+            setActiveCategory('');
         }
 
         function renderUserProfile() {
             const profileContainer = document.getElementById('user-profile');
             let user = null;
             if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
                 user = window.Telegram.WebApp.initDataUnsafe.user;
             }
 
             if (user) {
                 profileContainer.innerHTML = `
                     <div class="user-avatar">
                         <img src="${user.photo_url}" alt="Avatar" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <span style="display:none;">${user.first_name.charAt(0).toUpperCase()}</span>
                     </div>
                     <div class="user-name">${user.first_name}</div>
                 `;
+                if (!orderForm.name || !orderForm.name.trim()) {
+                    orderForm.name = `${user.first_name || ''} ${user.last_name || ''}`.trim();
+                    saveState();
+                    updateCheckoutValidationHint();
+                }
             } else {
                 profileContainer.style.display = 'none';
             }
         }
 
+        function getAllCategories() {
+            return [...new Set(PRODUCTS.map(p => p.cat))].sort((a, b) => a.localeCompare(b, 'ru'));
+        }
+
+        function setActiveCategory(category) {
+            const normalized = category || '';
+            if (activeCategory !== normalized) {
+                activeCategory = normalized;
+            }
+            saveState();
+
+            const select = document.getElementById('category-filter');
+            if (select && select.value !== normalized) {
+                select.value = normalized;
+            }
+
+            renderCategoryChips();
+            filterAndSearchProducts();
+        }
+
+        function createCategoryChip(label, value) {
+            const button = document.createElement('button');
+            button.type = 'button';
+            button.className = 'category-chip';
+            button.dataset.category = value;
+            button.textContent = label;
+            if ((!value && !activeCategory) || value === activeCategory) {
+                button.classList.add('active');
+            }
+            return button;
+        }
+
+        function renderCategoryChips() {
+            const container = document.getElementById('category-chips');
+            if (!container) return;
+
+            container.innerHTML = '';
+            const categories = getAllCategories();
+            const term = categorySearchTerm.trim();
+            const filtered = term ? categories.filter(cat => cat.toLowerCase().includes(term)) : categories;
+
+            container.appendChild(createCategoryChip('Все', ''));
+
+            if (term && filtered.length === 0) {
+                const empty = document.createElement('div');
+                empty.className = 'empty-chip-state';
+                empty.textContent = 'Категория не найдена';
+                container.appendChild(empty);
+                return;
+            }
+
+            filtered.forEach(cat => container.appendChild(createCategoryChip(cat, cat)));
+            container.scrollLeft = 0;
+        }
+
         function populateCategoryFilter() {
-            const categories = [...new Set(PRODUCTS.map(p => p.cat))].sort();
             const select = document.getElementById('category-filter');
-            categories.forEach(cat => {
+            if (!select) return;
+
+            select.innerHTML = '<option value="">Все категории</option>';
+            getAllCategories().forEach(cat => {
                 const option = document.createElement('option');
                 option.value = cat;
                 option.textContent = cat;
                 select.appendChild(option);
             });
+
+            if (activeCategory) {
+                select.value = activeCategory;
+            }
+
+            renderCategoryChips();
         }
 
         function filterAndSearchProducts() {
-            const searchTerm = document.getElementById('search-input').value.toLowerCase();
-            const selectedCategory = document.getElementById('category-filter').value;
+            const searchInput = document.getElementById('search-input');
+            const searchTerm = (searchInput ? searchInput.value : '').trim().toLowerCase();
             const onlyCheese = document.getElementById('only-cheese-checkbox').checked;
 
             filteredProducts = PRODUCTS.filter(p => {
                 const hasPrice = p.pricePerKg || p.pricePerL || p.pricePerUnit;
                 if (!hasPrice) {
                     console.warn(`TODO_PRICE: Product ${p.id} has no price.`);
                     return false;
                 }
 
-                const matchesSearch = p.name.toLowerCase().includes(searchTerm);
-                const matchesCategory = !selectedCategory || p.cat === selectedCategory;
+                const combinedText = `${p.name} ${p.description || ''} ${p.cat}`.toLowerCase();
+                const matchesSearch = combinedText.includes(searchTerm);
+                const matchesCategory = !activeCategory || p.cat === activeCategory;
+                const matchesCategorySearch = !categorySearchTerm || p.cat.toLowerCase().includes(categorySearchTerm) || (!!activeCategory && p.cat === activeCategory);
                 const matchesCheeseFilter = !onlyCheese || p.cat === 'Сыры';
 
-                return matchesSearch && matchesCategory && matchesCheeseFilter;
+                return matchesSearch && matchesCategory && matchesCheeseFilter && matchesCategorySearch;
             });
 
             renderProducts();
         }
 
         function renderProducts() {
             const grid = document.getElementById('product-grid');
+            if (!grid) return;
+
             grid.innerHTML = '';
             if (filteredProducts.length === 0) {
-                grid.innerHTML = '<p style="text-align:center; color:var(--hint-color);">Ничего не найдено</p>';
+                grid.innerHTML = '<div class="empty-state">Ничего не найдено. Попробуйте изменить фильтры.</div>';
                 return;
             }
-            filteredProducts.forEach(product => {
-                const card = document.createElement('div');
-                card.className = 'product-card';
-                card.onclick = () => openProductModal(product.id);
-
-                const priceText = getPriceText(product);
-                card.innerHTML = `
-                    <div class="ico">${product.ico || '📦'}</div>
-                    <div class="name">${product.name}</div>
-                    <div class="price">${priceText}</div>
-                `;
-                grid.appendChild(card);
+
+            const grouped = filteredProducts.reduce((acc, product) => {
+                if (!acc[product.cat]) {
+                    acc[product.cat] = [];
+                }
+                acc[product.cat].push(product);
+                return acc;
+            }, {});
+
+            const sortedCategories = Object.keys(grouped).sort((a, b) => a.localeCompare(b, 'ru'));
+            sortedCategories.forEach(category => {
+                const section = document.createElement('section');
+                section.className = 'category-section';
+
+                const header = document.createElement('div');
+                header.className = 'category-header';
+
+                const titleButton = document.createElement('button');
+                titleButton.type = 'button';
+                titleButton.className = 'category-title';
+                titleButton.innerHTML = `<span>${category}</span>`;
+                titleButton.addEventListener('click', () => setActiveCategory(category));
+
+                const countBadge = document.createElement('span');
+                countBadge.className = 'category-count';
+                countBadge.textContent = grouped[category].length;
+
+                header.appendChild(titleButton);
+                header.appendChild(countBadge);
+                section.appendChild(header);
+
+                const categoryGrid = document.createElement('div');
+                categoryGrid.className = 'category-grid';
+                grouped[category].forEach(product => {
+                    categoryGrid.appendChild(createProductCard(product));
+                });
+
+                section.appendChild(categoryGrid);
+                grid.appendChild(section);
+            });
+        }
+
+        function createProductCard(product) {
+            const card = document.createElement('div');
+            card.className = 'product-card';
+            card.setAttribute('role', 'button');
+            card.setAttribute('tabindex', '0');
+
+            card.addEventListener('click', () => openProductModal(product.id));
+            card.addEventListener('keydown', event => {
+                if (event.key === 'Enter' || event.key === ' ') {
+                    event.preventDefault();
+                    openProductModal(product.id);
+                }
             });
+
+            const ico = document.createElement('div');
+            ico.className = 'ico';
+            ico.textContent = product.ico || '📦';
+
+            const name = document.createElement('div');
+            name.className = 'name';
+            name.textContent = product.name;
+
+            const description = document.createElement('div');
+            description.className = 'description';
+            description.textContent = product.description || '';
+
+            const price = document.createElement('div');
+            price.className = 'price';
+            price.textContent = getPriceText(product);
+
+            card.appendChild(ico);
+            card.appendChild(name);
+            card.appendChild(description);
+            card.appendChild(price);
+
+            return card;
         }
 
         function getPriceText(product) {
-            if (product.pricePerKg) return `${product.pricePerKg} ₽/кг`;
-            if (product.pricePerL) return `${product.pricePerL} ₽/л`;
-            if (product.pricePerUnit) return `${product.pricePerUnit} ₽`;
+            if (product.pricePerKg) return `${formatCurrency(product.pricePerKg)} / кг`;
+            if (product.pricePerL) return `${formatCurrency(product.pricePerL)} / л`;
+            if (product.pricePerUnit) return formatCurrency(product.pricePerUnit);
             return 'Цена не указана';
         }
 
         // --- PRODUCT MODAL ---
         function openProductModal(productId) {
             currentProduct = PRODUCTS.find(p => p.id === productId);
             if (!currentProduct) return;
 
             const modal = document.getElementById('product-modal');
             document.getElementById('product-modal-title').textContent = currentProduct.name;
             document.getElementById('product-modal-ico').textContent = currentProduct.ico || '📦';
             document.getElementById('product-modal-description').textContent = currentProduct.description || '';
 
             renderVariantSelector();
             updateProductModalPrice();
 
             modal.showModal();
         }
 
         function closeProductModal() {
             document.getElementById('product-modal').close();
             currentProduct = null;
         }
 
         function renderVariantSelector() {
@@ -828,171 +1436,428 @@
                 return;
             }
 
             if (rule.type === 'fixed') {
                 rule.options.forEach(opt => {
                     const option = document.createElement('option');
                     option.value = opt;
                     option.textContent = opt;
                     select.appendChild(option);
                 });
             } else if (rule.type === 'weight') {
                 for (let value = rule.min; value <= rule.max; value += rule.step) {
                     const option = document.createElement('option');
                     option.value = `${value} ${rule.unit}`;
                     option.textContent = `${value} ${rule.unit}`;
                     select.appendChild(option);
                 }
             }
         }
 
         function updateProductModalPrice() {
             if (!currentProduct) return;
             const variant = document.getElementById('product-variant-select').value;
             const qty = parseInt(document.getElementById('product-qty-input').value) || 1;
             const price = calculatePrice(currentProduct.id, variant, qty);
-            document.getElementById('product-modal-price').textContent = `${price.finalPrice} ₽`;
+            document.getElementById('product-modal-price').textContent = formatCurrency(price.finalPrice);
         }
 
         // --- CART LOGIC ---
         function addToCart() {
             if (!currentProduct) return;
 
             const variant = document.getElementById('product-variant-select').value;
             const qty = parseInt(document.getElementById('product-qty-input').value) || 1;
 
             const existingItemIndex = cart.findIndex(item => item.id === currentProduct.id && item.variant === variant);
 
             if (existingItemIndex > -1) {
                 cart[existingItemIndex].qty += qty;
             } else {
                 cart.push({ id: currentProduct.id, name: currentProduct.name, cat: currentProduct.cat, variant, qty });
             }
 
             saveState();
             updateCartUI();
             closeProductModal();
         }
 
-        function updateCartUI() {
-            const totalCount = cart.reduce((sum, item) => sum + item.qty, 0);
-            const totalSum = cart.reduce((sum, item) => {
+        function calculateCartTotals() {
+            return cart.reduce((acc, item) => {
                 const price = calculatePrice(item.id, item.variant, item.qty);
-                return sum + price.finalPrice;
-            }, 0);
+                acc.count += item.qty;
+                acc.finalTotal += price.finalPrice;
+                acc.baseTotal += price.basePrice;
+                acc.discountTotal += price.basePrice - price.finalPrice;
+                return acc;
+            }, { count: 0, finalTotal: 0, baseTotal: 0, discountTotal: 0 });
+        }
+
+        function updateCartUI() {
+            const totals = calculateCartTotals();
+            const totalCount = totals.count;
+            const totalSum = totals.finalTotal;
 
             const cartButton = document.getElementById('open-cart-btn');
             if (cart.length > 0) {
                 cartButton.disabled = false;
-                cartButton.textContent = `Корзина (${totalCount}) - ${totalSum} ₽`;
+                cartButton.textContent = `Корзина (${totalCount}) — ${formatCurrency(totalSum)}`;
             } else {
                 cartButton.disabled = true;
                 cartButton.textContent = 'Корзина пуста';
             }
 
             if (window.Telegram && window.Telegram.WebApp) {
                 const mainButton = window.Telegram.WebApp.MainButton;
                 if (cart.length > 0) {
-                    mainButton.setText(`Отправить заказ ${totalSum} ₽`);
+                    mainButton.setText(`Отправить заказ ${formatCurrency(totalSum)}`);
                     mainButton.show();
                 } else {
                     mainButton.hide();
                 }
             }
+
+            updateCheckoutValidationHint();
         }
 
         function openCartModal() {
             renderCartModal();
-            document.getElementById('cart-modal').showModal();
+            const modal = document.getElementById('cart-modal');
+            if (!modal.open) {
+                modal.showModal();
+            }
+            updateCheckoutValidationHint();
         }
 
         function closeCartModal() {
             document.getElementById('cart-modal').close();
         }
 
         function renderCartModal() {
             const body = document.getElementById('cart-modal-body');
             body.innerHTML = '';
 
             if (cart.length === 0) {
-                body.innerHTML = '<p>Корзина пуста</p>';
+                const empty = document.createElement('div');
+                empty.className = 'empty-cart';
+                empty.innerHTML = `
+                    <div class="ico">🛒</div>
+                    <p>Корзина пуста. Добавьте товары из каталога, чтобы оформить заказ.</p>
+                `;
+                const backButton = document.createElement('button');
+                backButton.className = 'btn btn-secondary';
+                backButton.textContent = 'К покупкам';
+                backButton.addEventListener('click', closeCartModal);
+                empty.appendChild(backButton);
+                body.appendChild(empty);
                 return;
             }
 
-            let totalSum = 0;
+            const itemsContainer = document.createElement('div');
+            itemsContainer.className = 'cart-items';
+
             cart.forEach((item, index) => {
                 const price = calculatePrice(item.id, item.variant, item.qty);
-                totalSum += price.finalPrice;
-
-                const discountRate = getDiscountRateForProduct(item.id);
-                let discountHint = '';
-                if (discountRate > 0) {
-                    discountHint = `<div class="discount-hint">Скидка ${ROUND(discountRate * 100)}% применена</div>`;
-                }
+                const discountAmount = price.basePrice - price.finalPrice;
 
                 const cartItemDiv = document.createElement('div');
                 cartItemDiv.className = 'cart-item';
-                cartItemDiv.innerHTML = `
-                    <div class="cart-item-info">
-                        <div class="cart-item-name">${item.name}</div>
-                        <div class="cart-item-variant">${item.variant}</div>
-                        <div class="cart-item-price">${price.finalPrice} ₽</div>
-                        ${discountHint}
-                    </div>
-                    <div class="cart-item-controls">
-                        <div class="qty-control">
-                            <button onclick="changeItemQty(${index}, -1)">-</button>
-                            <span>${item.qty}</span>
-                            <button onclick="changeItemQty(${index}, 1)">+</button>
-                        </div>
-                    </div>
-                `;
-                body.appendChild(cartItemDiv);
+
+                const info = document.createElement('div');
+                info.className = 'cart-item-info';
+
+                const nameEl = document.createElement('div');
+                nameEl.className = 'cart-item-name';
+                nameEl.textContent = item.name;
+
+                const variantEl = document.createElement('div');
+                variantEl.className = 'cart-item-variant';
+                variantEl.textContent = item.variant;
+
+                const priceEl = document.createElement('div');
+                priceEl.className = 'cart-item-price';
+                priceEl.textContent = formatCurrency(price.finalPrice);
+
+                info.appendChild(nameEl);
+                info.appendChild(variantEl);
+                info.appendChild(priceEl);
+
+                if (discountAmount > 0) {
+                    const discountEl = document.createElement('div');
+                    discountEl.className = 'discount-hint';
+                    discountEl.textContent = `Экономия ${formatCurrency(discountAmount)} (${ROUND(price.discountRate * 100)}%)`;
+                    info.appendChild(discountEl);
+                }
+
+                const controls = document.createElement('div');
+                controls.className = 'cart-item-controls';
+
+                const qtyControl = document.createElement('div');
+                qtyControl.className = 'qty-control';
+
+                const minusBtn = document.createElement('button');
+                minusBtn.setAttribute('type', 'button');
+                minusBtn.textContent = '−';
+                minusBtn.addEventListener('click', () => changeItemQty(index, -1));
+
+                const qtyDisplay = document.createElement('span');
+                qtyDisplay.textContent = item.qty;
+
+                const plusBtn = document.createElement('button');
+                plusBtn.setAttribute('type', 'button');
+                plusBtn.textContent = '+';
+                plusBtn.addEventListener('click', () => changeItemQty(index, 1));
+
+                qtyControl.appendChild(minusBtn);
+                qtyControl.appendChild(qtyDisplay);
+                qtyControl.appendChild(plusBtn);
+
+                const removeBtn = document.createElement('button');
+                removeBtn.setAttribute('type', 'button');
+                removeBtn.className = 'remove-item-btn';
+                removeBtn.setAttribute('aria-label', `Удалить ${item.name}`);
+                removeBtn.textContent = '×';
+                removeBtn.addEventListener('click', () => removeCartItem(index));
+
+                controls.appendChild(qtyControl);
+                controls.appendChild(removeBtn);
+
+                cartItemDiv.appendChild(info);
+                cartItemDiv.appendChild(controls);
+                itemsContainer.appendChild(cartItemDiv);
             });
 
+            body.appendChild(itemsContainer);
+
+            const totals = calculateCartTotals();
             const summaryDiv = document.createElement('div');
             summaryDiv.className = 'cart-summary';
-            summaryDiv.innerHTML = `Итого: ${totalSum} ₽`;
+
+            const totalLine = document.createElement('div');
+            totalLine.className = 'summary-total';
+            totalLine.textContent = `Итого: ${formatCurrency(totals.finalTotal)}`;
+
+            const quantityLine = document.createElement('div');
+            quantityLine.textContent = `Позиции: ${cart.length}, количество: ${totals.count}`;
+
+            summaryDiv.appendChild(totalLine);
+            summaryDiv.appendChild(quantityLine);
+
+            if (totals.discountTotal > 0) {
+                const baseLine = document.createElement('div');
+                baseLine.textContent = `До скидок: ${formatCurrency(totals.baseTotal)}`;
+                summaryDiv.appendChild(baseLine);
+
+                const discountLine = document.createElement('div');
+                discountLine.className = 'summary-discount';
+                discountLine.textContent = `Скидка: −${formatCurrency(totals.discountTotal)}`;
+                summaryDiv.appendChild(discountLine);
+            }
+
             body.appendChild(summaryDiv);
 
+            const divider = document.createElement('hr');
+            divider.className = 'checkout-divider';
+            body.appendChild(divider);
+
+            const checkoutForm = document.createElement('div');
+            checkoutForm.className = 'checkout-form';
+            checkoutForm.innerHTML = `
+                <h3>Данные для заказа</h3>
+                <div class="form-group">
+                    <label for="order-name">Имя *</label>
+                    <input type="text" id="order-name" placeholder="Как к вам обращаться?">
+                </div>
+                <div class="form-group">
+                    <label for="order-phone">Телефон *</label>
+                    <input type="tel" id="order-phone" placeholder="+7 (___) ___-__-__" inputmode="tel">
+                </div>
+                <div class="form-group">
+                    <label for="order-address">Адрес доставки *</label>
+                    <textarea id="order-address" placeholder="Город, улица, дом, подъезд..."></textarea>
+                </div>
+                <div class="form-group">
+                    <label for="order-payment">Способ оплаты *</label>
+                    <select id="order-payment">
+                        <option value="cash">${PAYMENT_METHOD_LABELS.cash}</option>
+                        <option value="card">${PAYMENT_METHOD_LABELS.card}</option>
+                        <option value="online">${PAYMENT_METHOD_LABELS.online}</option>
+                    </select>
+                </div>
+                <div class="form-group">
+                    <label for="order-comment">Комментарий <span class="form-note">(необязательно)</span></label>
+                    <textarea id="order-comment" placeholder="Пожелания к заказу, время доставки и т.д."></textarea>
+                </div>
+            `;
+
+            body.appendChild(checkoutForm);
+
+            const nameInput = checkoutForm.querySelector('#order-name');
+            const phoneInput = checkoutForm.querySelector('#order-phone');
+            const addressInput = checkoutForm.querySelector('#order-address');
+            const paymentSelect = checkoutForm.querySelector('#order-payment');
+            const commentInput = checkoutForm.querySelector('#order-comment');
+
+            nameInput.value = orderForm.name || '';
+            phoneInput.value = orderForm.phone || '';
+            addressInput.value = orderForm.address || '';
+            paymentSelect.value = orderForm.paymentMethod || 'cash';
+            commentInput.value = orderForm.comment || '';
+
+            nameInput.addEventListener('input', event => handleOrderFormChange('name', event.target.value));
+            phoneInput.addEventListener('input', handlePhoneInput);
+            addressInput.addEventListener('input', event => handleOrderFormChange('address', event.target.value));
+            paymentSelect.addEventListener('change', event => handleOrderFormChange('paymentMethod', event.target.value));
+            commentInput.addEventListener('input', event => handleOrderFormChange('comment', event.target.value));
+
+            const hint = document.createElement('div');
+            hint.id = 'checkout-validation-hint';
+            hint.className = 'form-hint hidden';
+            body.appendChild(hint);
+
             const sendOrderBtn = document.createElement('button');
             sendOrderBtn.className = 'btn btn-primary';
+            sendOrderBtn.id = 'cart-send-btn';
             sendOrderBtn.textContent = 'Отправить заказ';
-            sendOrderBtn.onclick = sendOrder;
+            sendOrderBtn.addEventListener('click', sendOrder);
             body.appendChild(sendOrderBtn);
+
+            updateCheckoutValidationHint();
         }
 
         function changeItemQty(index, delta) {
             cart[index].qty += delta;
             if (cart[index].qty <= 0) {
                 cart.splice(index, 1);
             }
             saveState();
             updateCartUI();
             renderCartModal();
         }
 
+        function removeCartItem(index) {
+            cart.splice(index, 1);
+            saveState();
+            updateCartUI();
+            renderCartModal();
+        }
+
+        function handleOrderFormChange(field, value) {
+            orderForm[field] = value;
+            saveState();
+            updateCheckoutValidationHint();
+        }
+
+        function handlePhoneInput(event) {
+            const rawValue = event.target.value || '';
+            const sanitized = rawValue.replace(/[^0-9+()\s-]/g, '');
+            if (sanitized !== rawValue) {
+                event.target.value = sanitized;
+            }
+            handleOrderFormChange('phone', sanitized);
+        }
+
+        function getOrderFormErrors() {
+            const errors = [];
+            const name = (orderForm.name || '').trim();
+            const address = (orderForm.address || '').trim();
+            const paymentMethod = orderForm.paymentMethod;
+            const phoneDigits = (orderForm.phone || '').replace(/\D/g, '');
+
+            if (!cart.length) {
+                errors.push('Добавьте товары в корзину');
+            }
+            if (!name) {
+                errors.push('Укажите ваше имя');
+            }
+            if (phoneDigits.length < 10) {
+                errors.push('Введите корректный номер телефона (минимум 10 цифр)');
+            }
+            if (!address) {
+                errors.push('Заполните адрес доставки');
+            }
+            if (!paymentMethod) {
+                errors.push('Выберите способ оплаты');
+            }
+
+            return errors;
+        }
+
+        function validateOrderForm(showAlert = false) {
+            const errors = getOrderFormErrors().filter(err => err !== 'Добавьте товары в корзину');
+            if (showAlert && errors.length > 0) {
+                alert(`Пожалуйста, заполните обязательные поля:\n\n${errors.map(err => `• ${err}`).join('\n')}`);
+            }
+            return errors.length === 0;
+        }
+
+        function getOrderFormPayload() {
+            const paymentMethod = orderForm.paymentMethod || 'cash';
+            const phoneRaw = (orderForm.phone || '').trim();
+            const phoneNormalized = phoneRaw.replace(/\D/g, '');
+            return {
+                name: (orderForm.name || '').trim(),
+                phone: phoneNormalized,
+                phone_raw: phoneRaw,
+                address: (orderForm.address || '').trim(),
+                payment_method: paymentMethod,
+                payment_method_label: PAYMENT_METHOD_LABELS[paymentMethod] || paymentMethod,
+                comment: (orderForm.comment || '').trim()
+            };
+        }
+
+        function updateCheckoutValidationHint() {
+            const hint = document.getElementById('checkout-validation-hint');
+            const sendBtn = document.getElementById('cart-send-btn');
+            if (!hint && !sendBtn) return;
+
+            const errors = getOrderFormErrors();
+            const cartHasItems = cart.length > 0;
+            if (sendBtn) {
+                sendBtn.disabled = errors.length > 0 || !cartHasItems;
+            }
+
+            if (!hint) return;
+
+            if (errors.length === 0) {
+                const hasData = ['name', 'phone', 'address'].some(field => (orderForm[field] || '').trim().length > 0);
+                if (hasData && cartHasItems) {
+                    hint.textContent = 'Все данные заполнены. Можно оформлять заказ.';
+                    hint.classList.add('success');
+                    hint.classList.remove('hidden');
+                } else {
+                    hint.classList.add('hidden');
+                    hint.classList.remove('success');
+                }
+            } else {
+                const filteredErrors = errors.filter(err => !(err === 'Добавьте товары в корзину' && cartHasItems));
+                hint.innerHTML = filteredErrors.map(err => `• ${err}`).join('<br>');
+                hint.classList.remove('success');
+                hint.classList.remove('hidden');
+            }
+        }
+
         // --- CALCULATIONS ---
         function parseVariant(variantString) {
             const match = variantString.match(/(\d+(?:\.\d+)?)\s*(г|кг|л|шт)/i);
             if (match) {
                 const value = parseFloat(match[1]);
                 let unit = match[2].toLowerCase();
                 if (unit === 'г') return { value, unit: 'g' };
                 if (unit === 'кг') return { value, unit: 'kg' };
                 if (unit === 'л') return { value, unit: 'l' };
                 if (unit === 'шт') return { value, unit: 'pc' };
             }
             const specialMatch = variantString.match(/(\d+(?:\.\d+)?)\+\s*(кг|л)/i);
             if (specialMatch) {
                 const value = parseFloat(specialMatch[1]);
                 const unit = specialMatch[2].toLowerCase();
                 if (unit === 'кг') return { value, unit: 'kg' };
                 if (unit === 'л') return { value, unit: 'l' };
             }
             return null;
         }
 
         function calculatePrice(productId, variant, qty) {
             const product = PRODUCTS.find(p => p.id === productId);
             if (!product) return { basePrice: 0, finalPrice: 0, discountRate: 0 };
 
@@ -1037,78 +1902,144 @@
             const product = PRODUCTS.find(p => p.id === productId);
             if (!product || product.cat !== 'Сыры') return 0;
 
             const totalWeightGrams = cart
                 .filter(item => item.id === productId)
                 .reduce((sum, item) => {
                     const parsed = parseVariant(item.variant);
                     if (parsed && parsed.unit === 'g') return sum + (parsed.value * item.qty);
                     if (parsed && parsed.unit === 'kg') return sum + (parsed.value * 1000 * item.qty);
                     if (parsed && parsed.unit === 'pc') {
                         const weightMatch = item.variant.match(/\((\d+)\s*г\)/);
                         if (weightMatch) return sum + (parseInt(weightMatch[1]) * item.qty);
                     }
                     return sum;
                 }, 0);
 
             let applicableDiscount = 0;
             for (const threshold of DISCOUNT_THRESHOLDS) {
                 if (totalWeightGrams >= threshold.g) {
                     applicableDiscount = threshold.rate;
                 }
             }
             return applicableDiscount;
         }
 
+        function buildCatalogSnapshot() {
+            return PRODUCTS.map(product => ({
+                id: product.id,
+                name: product.name,
+                cat: product.cat,
+                category: product.cat,
+                pricePerKg: product.pricePerKg ?? null,
+                pricePerL: product.pricePerL ?? null,
+                pricePerUnit: product.pricePerUnit ?? null,
+                description: product.description || '',
+                icon: product.ico || ''
+            }));
+        }
+
+        function buildVariantRulesSnapshot() {
+            try {
+                return JSON.parse(JSON.stringify(VARIANT_RULES));
+            } catch (error) {
+                console.warn('Failed to clone variant rules for payload.', error);
+                return VARIANT_RULES;
+            }
+        }
+
+        function buildCartSnapshot() {
+            return cart.map(item => ({ ...item }));
+        }
+
         // --- ORDER SUBMISSION ---
         function sendOrder() {
-            if (cart.length === 0) return;
+            if (cart.length === 0) {
+                alert('Корзина пуста. Добавьте товары перед отправкой.');
+                return;
+            }
+
+            if (!validateOrderForm(true)) {
+                const cartModal = document.getElementById('cart-modal');
+                if (cartModal && !cartModal.open) {
+                    openCartModal();
+                }
+                return;
+            }
+
+            const totals = calculateCartTotals();
+            const customerPayload = getOrderFormPayload();
 
             const payload = {
-                type: "cart",
-                source: "miniapp",
+                type: 'cart',
+                source: 'miniapp',
                 currency: CURRENCY,
+                total: totals.finalTotal,
+                total_formatted: formatCurrency(totals.finalTotal),
                 items: [],
-                total: 0,
                 meta: {
                     ts: Date.now(),
-                    schema_ver: PAYLOAD_SCHEMA_VERSION
+                    schema_ver: PAYLOAD_SCHEMA_VERSION,
+                    catalog_snapshot: buildCatalogSnapshot(),
+                    variant_rules_snapshot: buildVariantRulesSnapshot(),
+                    cart_snapshot: buildCartSnapshot(),
+                    cart_summary: {
+                        items_count: cart.length,
+                        quantity_total: totals.count,
+                        total_final: totals.finalTotal,
+                        total_final_formatted: formatCurrency(totals.finalTotal),
+                        total_base: totals.baseTotal,
+                        total_base_formatted: formatCurrency(totals.baseTotal),
+                        total_discount: totals.discountTotal,
+                        total_discount_formatted: formatCurrency(totals.discountTotal),
+                        effective_discount_rate: totals.baseTotal ? Number(((totals.discountTotal / totals.baseTotal) || 0).toFixed(4)) : 0
+                    },
+                    checkout: customerPayload
                 }
             };
 
-            let grandTotal = 0;
             cart.forEach(item => {
                 const price = calculatePrice(item.id, item.variant, item.qty);
-                grandTotal += price.finalPrice;
-                payload.items.push({
+                const safeQty = item.qty || 1;
+                const line = {
                     id: item.id,
                     name: item.name,
+                    category: item.cat,
                     cat: item.cat,
                     variant: item.variant,
-                    qty: item.qty,
-                    unit_price_base: price.basePrice / item.qty,
+                    quantity: item.qty,
+                    unit_price_base: price.basePrice / safeQty,
+                    unit_price_final: price.finalPrice / safeQty,
+                    line_total: price.finalPrice,
+                    line_total_formatted: formatCurrency(price.finalPrice),
                     discount_rate: price.discountRate,
-                    unit_price: price.finalPrice / item.qty,
-                    line_total: price.finalPrice
-                });
+                    discount_amount: price.basePrice - price.finalPrice,
+                    discount_amount_formatted: formatCurrency(price.basePrice - price.finalPrice)
+                };
+                payload.items.push(line);
             });
-            payload.total = grandTotal;
+
+            payload.customer = customerPayload;
 
             if (window.Telegram && window.Telegram.WebApp) {
                 try {
                     window.Telegram.WebApp.sendData(JSON.stringify(payload));
+                    const cartModal = document.getElementById('cart-modal');
+                    if (cartModal && cartModal.open) {
+                        cartModal.close();
+                    }
                     window.Telegram.WebApp.close();
                 } catch (e) {
-                    console.error("Failed to send data:", e);
+                    console.error('Failed to send data:', e);
                     alert(`Не удалось отправить заказ. Пожалуйста, попробуйте еще раз.\n\nДанные для отладки:\n${JSON.stringify(payload, null, 2)}`);
                 }
             } else {
                 alert(`Данные заказа (вне Telegram):\n\n${JSON.stringify(payload, null, 2)}`);
-                console.log("Order Payload:", payload);
+                console.log('Order Payload:', payload);
             }
         }
 
         // --- START ---
         document.addEventListener('DOMContentLoaded', init);
     </script>
 </body>
 </html>
