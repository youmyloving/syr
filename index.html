<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–°—ã—Ä–æ–º–∞–Ω–∏—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* ===== –¢—ë–ø–ª–∞—è –∫—Ä–µ–º–æ–≤–∞—è —Ç–µ–º–∞ ===== */
    :root{
      --bg-color:#F8EFDA;            /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω */
      --section-bg-color:#FFF8EC;    /* –∫–∞—Ä—Ç–æ—á–∫–∏/–º–æ–¥–∞–ª–∫–∏ */
      --header-bg-color:#F8EFDA;     /* —à–∞–ø–∫–∞/—Ñ—É—Ç–µ—Ä */
      --secondary-bg-color:#F3E7CD;  /* –∏–Ω–ø—É—Ç—ã, –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ñ–æ–Ω */
      --border-color:#E6D8BF;        /* –≥—Ä–∞–Ω–∏—Ü—ã */
      --text-color:#2E2614;          /* —Ç–µ–∫—Å—Ç ‚Äî —Ç—ë–ø–ª—ã–π —Ç—ë–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤—ã–π */
      --hint-color:#8C7A5B;          /* –ø–æ–¥—Å–∫–∞–∑–∫–∏/–º—å—é—Ç–µ–¥ */
      --link-color:#B35C1C;          /* —Å—Å—ã–ª–∫–∏ */
      --button-color:#C7742E;        /* –∞–∫—Ü–µ–Ω—Ç (—Ç–µ—Ä—Ä–∞–∫–æ—Ç–∞) */
      --button-text-color:#ffffff;
      --error-color:#B91C1C;
      --success-color:#2E7D32;
      --radius:14px;
      --shadow:0 8px 24px rgba(0,0,0,.10);
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg-color); color:var(--text-color);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    #app{display:flex; flex-direction:column; min-height:100vh}

    header{
      background:var(--header-bg-color);
      border-bottom:1px solid var(--border-color);
      padding:12px; position:sticky; top:0; z-index:5;
    }

    .user-profile{display:flex; align-items:center; gap:10px; margin-bottom:10px}
    .user-avatar{
      width:32px; height:32px; border-radius:50%; overflow:hidden;
      background:var(--secondary-bg-color); color:var(--hint-color);
      display:grid; place-items:center; font-weight:600;
    }
    .user-avatar img{width:100%; height:100%; object-fit:cover}
    .user-name{font-weight:600}

    .search-container{margin-bottom:10px}
    #search-input{
      width:100%; padding:10px 12px; border-radius:10px;
      background:var(--secondary-bg-color); border:1px solid var(--border-color);
      color:var(--text-color); font-size:16px; box-sizing:border-box;
    }

    .filters-container{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    #category-filter{
      flex:1; padding:10px 12px; border-radius:10px;
      background:var(--secondary-bg-color); border:1px solid var(--border-color);
      color:var(--text-color);
    }
    #only-cheese-toggle{display:flex; align-items:center; gap:6px; user-select:none}

    main{flex:1; padding:12px; padding-bottom:90px}

    .product-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fill,minmax(170px,1fr));
    }

    .product-card{
      background:var(--section-bg-color); border:1px solid var(--border-color);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:10px; display:flex; flex-direction:column; gap:8px; cursor:pointer;
      transition:.15s transform ease, .2s box-shadow ease;
    }
    .product-card:hover{transform:translateY(-2px)}
    .ico{font-size:42px; text-align:center}
    .name{font-weight:600; font-size:14px; min-height:2.4em}
    .price{font-size:13px; color:var(--hint-color)}

    .cart-footer{
      position:sticky; bottom:0; background:var(--header-bg-color);
      border-top:1px solid var(--border-color);
      padding:10px; display:flex; justify-content:center; z-index:5;
    }
    #open-cart-btn{
      width:100%; max-width:420px; padding:12px 22px; border-radius:999px;
      background:var(--button-color); color:var(--button-text-color);
      border:none; font-size:16px; font-weight:700; box-shadow:var(--shadow);
      cursor:pointer; transition:filter .15s ease;
    }
    #open-cart-btn:disabled{opacity:.6; cursor:not-allowed}
    #open-cart-btn:hover{filter:brightness(1.06)}

    dialog{border:1px solid var(--border-color); border-radius:16px; padding:0; background:var(--section-bg-color); color:var(--text-color); width:min(95vw,460px)}
    dialog::backdrop{background:rgba(0,0,0,.45)}

    .modal-header{padding:14px 16px; border-bottom:1px solid var(--border-color); display:flex; align-items:center; gap:10px}
    .modal-header h2{margin:0; font-size:18px}
    .modal-close{margin-left:auto; width:32px; height:32px; border-radius:10px; border:1px solid var(--border-color); background:var(--secondary-bg-color); color:var(--hint-color); cursor:pointer}
    .modal-body{padding:14px 16px; max-height:60vh; overflow:auto}
    .modal-footer{padding:12px 16px; border-top:1px solid var(--border-color); display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap}

    .form-group{margin-bottom:12px}
    .form-group label{display:block; margin-bottom:6px; font-size:13px; color:var(--hint-color)}
    .form-group input, .form-group select, .form-group textarea{
      width:100%; padding:10px 12px; border-radius:10px; background:var(--secondary-bg-color);
      border:1px solid var(--border-color); color:var(--text-color); box-sizing:border-box; font-size:16px;
    }
    .price-display{text-align:center; font-weight:700; margin:12px 0}

    .btn{padding:12px 18px; border-radius:10px; border:1px solid var(--border-color); cursor:pointer; font-weight:700}
    .btn-primary{background:var(--button-color); color:var(--button-text-color); border-color:transparent}
    .btn-secondary{background:var(--secondary-bg-color); color:var(--text-color)}
    .btn-ghost{background:transparent; color:var(--text-color)}
    .btn:active{transform:translateY(1px)}

    .cart-item{display:flex; gap:10px; padding:10px 0; border-bottom:1px solid var(--border-color)}
    .cart-item:last-child{border-bottom:none}
    .cart-item-info{flex:1}
    .cart-item-name{font-weight:700}
    .cart-item-variant{font-size:13px; color:var(--hint-color)}
    .cart-item-price{font-size:14px}
    .discount-hint{color:var(--success-color); font-size:12px}

    .qty-control{display:flex; align-items:center; border:1px solid var(--border-color); border-radius:10px; overflow:hidden}
    .qty-control button{width:34px; height:34px; border:none; background:var(--secondary-bg-color); cursor:pointer}
    .qty-control span{display:inline-block; min-width:34px; text-align:center}

    .cart-summary{margin-top:6px; padding-top:10px; border-top:2px solid var(--border-color); text-align:right; font-weight:800}

    /* Status modal */
    .status-wrap{display:grid; gap:10px; padding:16px; text-align:center}
    .status-ico{font-size:40px}
    .status-title{font-weight:800; font-size:18px}
    .status-text{color:var(--hint-color); font-size:14px}
    .status-actions{display:flex; gap:8px; justify-content:center; padding:10px 16px 16px}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>
      <div class="search-container"><input type="search" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é‚Ä¶"></div>
      <div class="filters-container">
        <select id="category-filter"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
        <label id="only-cheese-toggle"><input type="checkbox" id="only-cheese-checkbox"><span>–¢–æ–ª—å–∫–æ —Å—ã—Ä—ã</span></label>
      </div>
    </header>

    <main><div id="product-grid" class="product-grid"></div></main>

    <footer class="cart-footer"><button id="open-cart-btn" disabled>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</button></footer>
  </div>

  <!-- –ú–æ–¥–∞–ª —Ç–æ–≤–∞—Ä–∞ -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title">‚Äî</h2>
      <button class="modal-close" onclick="closeProductModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="ico" id="product-modal-ico">üßÄ</div>
      <p class="form-group" id="product-modal-description" style="color:var(--hint-color); margin:0 0 10px"></p>

      <div class="form-group">
        <label for="product-variant-select">–í–∞—Ä–∏–∞–Ω—Ç</label>
        <select id="product-variant-select"></select>
      </div>
      <div class="form-group">
        <label for="product-qty-input">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
        <input type="number" id="product-qty-input" value="1" min="1" />
      </div>
      <div class="price-display" id="product-modal-price">0 ‚ÇΩ</div>
      <button class="btn btn-primary" id="add-to-cart-btn">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </dialog>

  <!-- –ú–æ–¥–∞–ª –∫–æ—Ä–∑–∏–Ω—ã + –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
      <button class="modal-close" onclick="closeCartModal()">√ó</button>
    </div>
    <div class="modal-body" id="cart-modal-body"></div>
    <div class="modal-footer">
      <div class="muted" style="color:var(--hint-color)">–°–∫–∏–¥–∫–∏ –Ω–∞ —Å—ã—Ä: ‚â•500 –≥ ‚Äî 5%, ‚â•700 –≥ ‚Äî 10%, ‚â•1000 –≥ ‚Äî 15% (–ø–æ –æ–¥–Ω–æ–º—É –≤–∏–¥—É)</div>
      <button class="btn btn-primary" id="cart-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </dialog>

  <!-- –ú–æ–¥–∞–ª —Å—Ç–∞—Ç—É—Å–∞ (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞) -->
  <dialog id="status-modal">
    <div class="status-wrap">
      <div id="status-ico" class="status-ico">‚úÖ</div>
      <div id="status-title" class="status-title">–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</div>
      <div id="status-text" class="status-text">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</div>
    </div>
    <div class="status-actions">
      <button class="btn btn-primary" id="status-ok">–û–∫</button>
      <button class="btn btn-ghost" id="status-close">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    /* ========= –ö–û–ù–§–ò–ì ========= */
    const CURRENCY='RUB', ROUND=Math.round;
    const DISCOUNT_THRESHOLDS=[{g:1000,rate:0.15},{g:700,rate:0.10},{g:500,rate:0.05}];
    const ONLY_CHEESE_FILTER_DEFAULT=false;
    const PAYLOAD_SCHEMA_VERSION='v1';
    const WEBHOOK_URL='https://puzzlebot-webhook-handler1.onrender.com/';

    /* ========= –î–ê–ù–ù–´–ï ========= */
    const PRODUCTS=[/* —Ç–≤–æ–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */ 
      { id:'panir-classic', name:'–ü–∞–Ω–∏—Ä –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:'–°—ã—Ä—ã', pricePerKg:1200, ico:'üßÄ', description:'–ù–µ–∂–Ω—ã–π —Å–≤–µ–∂–∏–π —Å—ã—Ä.' },
      { id:'panir-herbs', name:'–ü–∞–Ω–∏—Ä –° –∑–µ–ª–µ–Ω—å—é', cat:'–°—ã—Ä—ã', pricePerKg:1300, ico:'üåø', description:'–° –∞—Ä–æ–º–∞—Ç–Ω—ã–º–∏ —Ç—Ä–∞–≤–∞–º–∏.' },
      { id:'panir-spicy', name:'–ü–∞–Ω–∏—Ä –° –ø—Ä—è–Ω–æ—Å—Ç—è–º–∏', cat:'–°—ã—Ä—ã', pricePerKg:1350, ico:'üå∂Ô∏è', description:'–° –ø–∏–∫–∞–Ω—Ç–Ω—ã–º–∏ —Å–ø–µ—Ü–∏—è–º–∏.' },
      { id:'panir-smoked', name:'–ü–∞–Ω–∏—Ä –ö–æ–ø—á—ë–Ω—ã–π', cat:'–°—ã—Ä—ã', pricePerKg:1400, ico:'üí®', description:'–° –¥—ã–º–Ω—ã–º –∞—Ä–æ–º–∞—Ç–æ–º.' },
      { id:'suluguni', name:'–°—É–ª—É–≥—É–Ω–∏', cat:'–°—ã—Ä—ã', pricePerKg:1400, ico:'üßÄ', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥—Ä—É–∑–∏–Ω—Å–∫–∏–π —Å—ã—Ä.' },
      { id:'suluguni-smoked', name:'–°—É–ª—É–≥—É–Ω–∏ –∫–æ–ø—á—ë–Ω—ã–π', cat:'–°—ã—Ä—ã', pricePerKg:1550, ico:'üí®', description:'–ö–æ–ø—á—ë–Ω—ã–π —Å—É–ª—É–≥—É–Ω–∏.' },
      { id:'imeretian', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π', cat:'–°—ã—Ä—ã', pricePerKg:1300, ico:'üßÄ', description:'–ú—è–≥–∫–∏–π, —Ä–∞—Å—Å—ã–ø—á–∞—Ç—ã–π —Å—ã—Ä.' },
      { id:'imeretian-dill-garlic', name:'–ò–º–µ—Ä–µ—Ç–∏–Ω—Å–∫–∏–π —Å —É–∫—Ä–æ–ø–æ–º –∏ —á–µ—Å–Ω–æ–∫–æ–º', cat:'–°—ã—Ä—ã', pricePerKg:1400, ico:'üßÑ', description:'–° –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º –≤–∫—É—Å–æ–º.' },
      { id:'halloumi', name:'–•–∞–ª–ª—É–º–∏ (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π)', cat:'–°—ã—Ä—ã', pricePerKg:1650, ico:'üî•', description:'–ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –∂–∞—Ä–∫–∏.' },
      { id:'halloumi-paprika-oregano', name:'–•–∞–ª–ª—É–º–∏ —Å –ø–∞–ø—Ä–∏–∫–æ–π –∏ –æ—Ä–µ–≥–∞–Ω–æ', cat:'–°—ã—Ä—ã', pricePerKg:1800, ico:'üå∂Ô∏è', description:'–°—Ä–µ–¥–∏–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–∏–µ –Ω–æ—Ç–∫–∏.' },
      { id:'halloumi-tomato-basil-garlic', name:'–•–∞–ª–ª—É–º–∏ —Ç–æ–º–∞—Ç-–±–∞–∑–∏–ª–∏–∫-—á–µ—Å–Ω–æ–∫', cat:'–°—ã—Ä—ã', pricePerKg:1800, ico:'üçÖ', description:'–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π –≤–∫—É—Å.' },
      { id:'halloumi-tomato-paprika', name:'–•–∞–ª–ª—É–º–∏ —Å –≤—è–ª–µ–Ω—ã–º–∏ –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ –∏ –ø–∞–ø—Ä–∏–∫–æ–π', cat:'–°—ã—Ä—ã', pricePerKg:1800, ico:'üçÖ', description:'–Ø—Ä–∫–∏–π –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π.' },
      { id:'kosichka', name:'–ö–æ—Å–∏—á–∫–∞', cat:'–°—ã—Ä—ã', pricePerKg:1600, ico:'ü•®', description:'–í —Ñ–æ—Ä–º–µ –ø–ª–µ—Ç–µ–Ω–∫–∏.' },
      { id:'kosichka-smoked', name:'–ö–æ—Å–∏—á–∫–∞ –∫–æ–ø—á—ë–Ω–∞—è', cat:'–°—ã—Ä—ã', pricePerKg:1750, ico:'üí®', description:'–ö–æ–ø—á—ë–Ω–∞—è –∫–æ—Å–∏—á–∫–∞.' },
      { id:'spicy-klubok', name:'–ü—Ä—è–Ω—ã–π –∫–ª—É–±–æ–∫', cat:'–°—ã—Ä—ã', pricePerUnit:1680, ico:'üå∂Ô∏è', description:'–û—Å—Ç—Ä—ã–π —Å—ã—Ä –≤ –≤–∏–¥–µ –∫–ª—É–±–∫–∞.' },
      { id:'mozzarella', name:'–ú–æ—Ü–∞—Ä–µ–ª–ª–∞', cat:'–°—ã—Ä—ã', pricePerUnit:1700, ico:'üßÄ', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º–æ—Ü–∞—Ä–µ–ª–ª–∞.' },
      { id:'buratta', name:'–ë—É—Ä–∞—Ç—Ç–∞', cat:'–°—ã—Ä—ã', pricePerUnit:1800, ico:'üßÄ', description:'–ù–µ–∂–Ω–µ–π—à–∞—è –±—É—Ä–∞—Ç—Ç–∞.' },
      { id:'stracciatella', name:'–°—Ç—Ä–∞—á–∞—Ç–µ–ª–ª–∞', cat:'–°—ã—Ä—ã', pricePerKg:1850, ico:'üßÄ', description:'–°–ª–∏–≤–∫–∏ –∏ –Ω–∏—Ç–∏ –º–æ—Ü–∞—Ä–µ–ª–ª—ã.' },
      { id:'ricotta', name:'–¢–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä (—Ä–∏–∫–æ—Ç—Ç–∞)', cat:'–°—ã—Ä—ã', pricePerKg:1100, ico:'ü•õ', description:'–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Ç–≤–æ—Ä–æ–∂–Ω—ã–π —Å—ã—Ä.' },
      { id:'ricotta-herbs', name:'–†–∏–∫–æ—Ç—Ç–∞ —Å —É–∫—Ä–æ–ø–æ–º –∏ –∑–µ–ª–µ–Ω—å—é', cat:'–°—ã—Ä—ã', pricePerKg:1200, ico:'üåø', description:'–° –∞—Ä–æ–º–∞—Ç–Ω–æ–π –∑–µ–ª–µ–Ω—å—é.' },
      { id:'caciotta', name:'–ö–∞—á–æ—Ç—Ç–∞', cat:'–°—ã—Ä—ã', pricePerKg:2150, ico:'üßÄ', description:'–ú—è–≥–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π —Å—ã—Ä.' },
      { id:'caciotta-fenugreek', name:'–ö–∞—á–æ—Ç—Ç–∞ —Å –ø–∞–∂–∏—Ç–Ω–∏–∫–æ–º', cat:'–°—ã—Ä—ã', pricePerKg:2250, ico:'üåø', description:'–° –æ—Ä–µ—Ö–æ–≤—ã–º –ø—Ä–∏–≤–∫—É—Å–æ–º –ø–∞–∂–∏—Ç–Ω–∏–∫–∞.' },
      { id:'hard-village', name:'–¢–≤—ë—Ä–¥—ã–π –ø–æ-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏', cat:'–°—ã—Ä—ã', pricePerKg:1400, ico:'üßÄ', description:'–ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –≤–∫—É—Å.' },
      { id:'hard-smoked', name:'–¢–≤—ë—Ä–¥—ã–π –∫–æ–ø—á—ë–Ω—ã–π', cat:'–°—ã—Ä—ã', pricePerKg:1600, ico:'üí®', description:'–ö–æ–ø—á—ë–Ω—ã–π —Ç–≤—ë—Ä–¥—ã–π —Å—ã—Ä.' },
      { id:'rolls-olives-walnut', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–º–∞—Å–ª–∏–Ω—ã, –≥—Ä–µ—Ü–∫–∏–π –æ—Ä–µ—Ö)', cat:'–°—ã—Ä—ã', pricePerKg:1550, ico:'ü•ú', description:'–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.' },
      { id:'rolls-apricot-cedar', name:'–°—ã—Ä–Ω—ã–π —Ä—É–ª–µ—Ç (–∫—É—Ä–∞–≥–∞, –∫–µ–¥—Ä–æ–≤—ã–π)', cat:'–°—ã—Ä—ã', pricePerKg:1550, ico:'üçë', description:'–°–ª–∞–¥–∫–∏–π –∏ —Å–æ–ª–µ–Ω—ã–π –≤–∫—É—Å.' },
      /* ‚Ä¶ –º–æ–ª–æ—á–∫–∞/–≤—ã–ø–µ—á–∫–∞ ‚Ä¶ */
      { id:'milk', name:'–ú–æ–ª–æ–∫–æ', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:100, ico:'ü•õ', description:'–°–≤–µ–∂–µ–µ –º–æ–ª–æ–∫–æ.' },
      { id:'milk-topped', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–æ–ª–æ–∫–æ', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:200, ico:'ü•õ', description:'–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ.' },
      { id:'yogurt', name:'–ô–æ–≥—É—Ä—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:230, ico:'ü•õ', description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π –π–æ–≥—É—Ä—Ç.' },
      { id:'ryazhenka', name:'–†—è–∂–µ–Ω–∫–∞', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:250, ico:'ü•õ', description:'–ö–∏—Å–ª–æ–º–æ–ª–æ—á–Ω—ã–π –Ω–∞–ø–∏—Ç–æ–∫.' },
      { id:'whey', name:'–°—ã–≤–æ—Ä–æ—Ç–∫–∞', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:50, ico:'üíß', description:'–ú–æ–ª–æ—á–Ω–∞—è —Å—ã–≤–æ—Ä–æ—Ç–∫–∞.' },
      { id:'cream', name:'–°–ª–∏–≤–∫–∏', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerL:1200, ico:'ü•õ', description:'–ñ–∏—Ä–Ω—ã–µ —Å–ª–∏–≤–∫–∏ 33%.' },
      { id:'tvorog', name:'–¢–≤–æ—Ä–æ–≥', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg:500, ico:'ü•õ', description:'–î–æ–º–∞—à–Ω–∏–π —Ç–≤–æ—Ä–æ–≥.' },
      { id:'butter', name:'–ú–∞—Å–ª–æ —Å–ª–∏–≤–æ—á–Ω–æ–µ', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg:1800, ico:'üßà', description:'–í–∫—É—Å–Ω–æ–µ —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ.' },
      { id:'ghee', name:'–¢–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ (–ì–•–ò)', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg:2300, ico:'üßà', description:'–ß–∏—Å—Ç–æ–µ —Ç–æ–ø–ª—ë–Ω–æ–µ –º–∞—Å–ª–æ.' },
      { id:'condensed-milk', name:'–°–≥—É—â–µ–Ω–∫–∞', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg:850, ico:'ü•õ', description:'–ù–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è —Å–≥—É—â–µ–Ω–∫–∞.' },
      { id:'tvorozhnaya-massa', name:'–¢–≤–æ—Ä–æ–∂–Ω–∞—è –º–∞—Å—Å–∞', cat:'–ú–æ–ª–æ—á–Ω–∞—è –ø—Ä–æ–¥—É–∫—Ü–∏—è', pricePerKg:700, ico:'ü•õ', description:'–° –¥–æ–±–∞–≤–∫–∞–º–∏ (–∏–∑—é–º, –∫—É—Ä–∞–≥–∞ –∏ —Ç.–¥.).' },
      { id:'cookies-tvorog', name:'–ü–µ—á–µ–Ω—å–µ —Ç–≤–æ—Ä–æ–∂–Ω–æ–µ', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:600, ico:'üç™', description:'–ù–µ–∂–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ.' },
      { id:'cookies-oat', name:'–ü–µ—á–µ–Ω—å–µ –æ–≤—Å—è–Ω–æ–µ', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:600, ico:'üç™', description:'–ü–æ–ª–µ–∑–Ω–æ–µ –æ–≤—Å—è–Ω–æ–µ.' },
      { id:'cookies-nut', name:'–û—Ä–µ—Ö–æ–≤—ã–µ –ø–∞–ª—å—á–∏–∫–∏', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:700, ico:'üç™', description:'–° —Ö—Ä—É—Å—Ç—è—â–∏–º–∏ –æ—Ä–µ—Ö–∞–º–∏.' },
      { id:'cookies-carob', name:'–ö—ç—Ä–±–æ–≤—ã–µ –ø–µ—á–µ–Ω—å—è', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:600, ico:'üç™', description:'–ù–∞ —Å–ª–∞–¥–æ—Å—Ç–∏ –∫—ç—Ä–æ–±–∞.' },
      { id:'cookies-sandy', name:'–ü–µ—Å–æ—á–Ω–æ–µ –ø–µ—á–µ–Ω—å–µ', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:600, ico:'üç™', description:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–µ –ø–µ—Å–æ—á–Ω–æ–µ.' },
      { id:'muffin-plain', name:'–ö–µ–∫—Å—ã –æ–±—ã—á–Ω—ã–µ', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:500, ico:'üßÅ', description:'–ü—Ä–æ—Å—Ç—ã–µ –∏ –≤–∫—É—Å–Ω—ã–µ.' },
      { id:'muffin-carob', name:'–ö–µ–∫—Å—ã –∫—ç—Ä–æ–±–æ–≤—ã–µ', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:550, ico:'üßÅ', description:'–° –∫—ç—Ä–æ–±–æ–º.' },
      { id:'muffin-raisin', name:'–ö–µ–∫—Å—ã –∏–∑—é–º', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerKg:550, ico:'üßÅ', description:'–° –∏–∑—é–º–æ–º.' },
      { id:'muffin-mix-plain-raisin', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∏–∑—é–º)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:280, ico:'üßÅ', description:'–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id:'muffin-mix-plain-carob', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–æ–±—ã—á–Ω—ã–µ+–∫—ç—Ä–æ–±)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:300, ico:'üßÅ', description:'–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id:'muffin-mix-raisin-carob', name:'–ö–µ–∫—Å—ã –º–∏–∫—Å (–∏–∑—é–º+–∫—ç—Ä–æ–±)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:300, ico:'üßÅ', description:'–ú–∏–∫—Å –Ω–∞ 0.5 –∫–≥.' },
      { id:'sandesh-orange', name:'–°–∞–Ω–¥–µ—à (–∞–ø–µ–ª—å—Å–∏–Ω)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:250, ico:'üçÆ', description:'5 —à—Ç.' },
      { id:'sandesh-walnut', name:'–°–∞–Ω–¥–µ—à (–≥—Ä–µ—Ü. –æ—Ä–µ—Ö)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:250, ico:'üçÆ', description:'5 —à—Ç.' },
      { id:'sandesh-carob', name:'–°–∞–Ω–¥–µ—à (–∫—ç—Ä–æ–±)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:250, ico:'üçÆ', description:'5 —à—Ç.' },
      { id:'barfi-classic', name:'–ë—É—Ä—Ñ–∏ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:300, ico:'üçÆ', description:'5 —à—Ç.' },
      { id:'barfi-hazelnut', name:'–ë—É—Ä—Ñ–∏ —Ñ—É–Ω–¥—É–∫', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:300, ico:'üçÆ', description:'5 —à—Ç.' },
      { id:'barfi-sesame', name:'–ë—É—Ä—Ñ–∏ –∫—É–Ω–∂—É—Ç–Ω—ã–π', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:420, ico:'üçÆ', description:'7 —à—Ç.' },
      { id:'halva', name:'–•–∞–ª–≤–∞', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:200, ico:'üçÆ', description:'0.2 –∫–≥' },
      { id:'potato-cake-5', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:330, ico:'üç∞', description:'5 —à—Ç.' },
      { id:'potato-cake-2', name:'–ü–∏—Ä–æ–∂–Ω–æ–µ ¬´–ö–∞—Ä—Ç–æ—à–∫–∞¬ª', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:155, ico:'üç∞', description:'2 —à—Ç.' },
      { id:'casserole-plain', name:'–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è (–æ–±—ã—á–Ω–∞—è)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:260, ico:'üçÆ', description:'250 –≥' },
      { id:'casserole-raisin', name:'–ó–∞–ø–µ–∫–∞–Ω–∫–∞ —Ç–≤–æ—Ä–æ–∂–Ω–∞—è (—Å –∏–∑—é–º–æ–º)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:260, ico:'üçÆ', description:'250 –≥' },
      { id:'crazy-cake', name:'–ö—Ä–µ–π–∑–∏-–∫–µ–π–∫', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:600, ico:'üéÇ', description:'1 —à—Ç.' },
      { id:'coconut-kuchen-1kg', name:'–ö–æ–∫–æ—Å–æ–≤—ã–π –∫—É—Ö–µ–Ω', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:1800, ico:'üç∞', description:'1 –∫–≥' },
      { id:'coconut-kuchen-05kg', name:'–ö–æ–∫–æ—Å–æ–≤—ã–π –∫—É—Ö–µ–Ω', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:1000, ico:'üç∞', description:'0.5 –∫–≥' },
      { id:'napoleon-1kg', name:'–¢–æ—Ä—Ç ¬´–ù–∞–ø–æ–ª–µ–æ–Ω¬ª', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:1300, ico:'üéÇ', description:'1+ –∫–≥' },
      { id:'napoleon-05kg', name:'–¢–æ—Ä—Ç ¬´–ù–∞–ø–æ–ª–µ–æ–Ω¬ª', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:750, ico:'üéÇ', description:'0.5+ –∫–≥' },
      { id:'apple-pie', name:'–Ø–±–ª–æ—á–Ω—ã–π –ø–∏—Ä–æ–≥', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:560, ico:'ü•ß', description:'900 –≥' },
      { id:'bliny-10', name:'–ë–ª–∏–Ω—ã', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:330, ico:'ü•û', description:'10 —à—Ç.' },
      { id:'bliny-5', name:'–ë–ª–∏–Ω—ã', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:220, ico:'ü•û', description:'5 —à—Ç.' },
      { id:'bliny-tvorog-5', name:'–ë–ª–∏–Ω—ã —Ç–≤–æ—Ä–æ–≥/—Ç–≤–æ—Ä–æ–≥-–∏–∑—é–º', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:300, ico:'ü•û', description:'5 —à—Ç.' },
      { id:'syrniki-10', name:'–°—ã—Ä–Ω–∏–∫–∏', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:520, ico:'ü•û', description:'10 —à—Ç.' },
      { id:'syrniki-5', name:'–°—ã—Ä–Ω–∏–∫–∏', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:280, ico:'ü•û', description:'5 —à—Ç.' },
      { id:'chapati-10', name:'–ß–∞–ø–∞—Ç–∏', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:270, ico:'ü´ì', description:'10 —à—Ç.' },
      { id:'chapati-wholewheat-10', name:'–ß–∞–ø–∞—Ç–∏ (—Ü/–∑ –º—É–∫–∞)', cat:'–°–ª–∞–¥–æ—Å—Ç–∏ –∏ –≤—ã–ø–µ—á–∫–∞', pricePerUnit:320, ico:'ü´ì', description:'10 —à—Ç.' },
    ];

    const VARIANT_RULES={/* —Ç–≤–æ–∏ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */ 
      'panir-classic':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'panir-herbs':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'panir-spicy':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'panir-smoked':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'suluguni':{type:'weight',unit:'–≥',step:100,min:100,max:1000},
      'suluguni-smoked':{type:'weight',unit:'–≥',step:100,min:100,max:1000},
      'imeretian':{type:'weight',unit:'–≥',step:100,min:100,max:1000},
      'imeretian-dill-garlic':{type:'weight',unit:'–≥',step:100,min:100,max:1000},
      'halloumi':{type:'fixed',options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)']},
      'halloumi-paprika-oregano':{type:'fixed',options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)']},
      'halloumi-tomato-basil-garlic':{type:'fixed',options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)']},
      'halloumi-tomato-paprika':{type:'fixed',options:['1 —à—Ç (200 –≥)','1 —à—Ç (250 –≥)']},
      'kosichka':{type:'fixed',options:['1 —à—Ç (200 –≥)']},
      'kosichka-smoked':{type:'fixed',options:['1 —à—Ç (200 –≥)']},
      'spicy-klubok':{type:'fixed',options:['1 —à—Ç (150 –≥)']},
      'mozzarella':{type:'fixed',options:['1 —à—Ç (200 –≥)']},
      'buratta':{type:'fixed',options:['1 —à—Ç (250 –≥)']},
      'stracciatella':{type:'fixed',options:['200 –≥','250 –≥','300 –≥','500 –≥']},
      'ricotta':{type:'fixed',options:['200 –≥','250 –≥','300 –≥','450 –≥']},
      'ricotta-herbs':{type:'fixed',options:['200 –≥','250 –≥','300 –≥','450 –≥']},
      'caciotta':{type:'weight',unit:'–≥',step:100,min:200,max:1000},
      'caciotta-fenugreek':{type:'weight',unit:'–≥',step:100,min:200,max:1000},
      'hard-village':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'hard-smoked':{type:'fixed',options:['200 –≥','300 –≥','400 –≥','500 –≥','1000 –≥']},
      'rolls-olives-walnut':{type:'weight',unit:'–≥',step:50,min:100,max:1000},
      'rolls-apricot-cedar':{type:'weight',unit:'–≥',step:50,min:100,max:1000},
      'milk':{type:'fixed',options:['0.5 –ª','1 –ª']},
      'milk-topped':{type:'fixed',options:['0.5 –ª','1 –ª']},
      'yogurt':{type:'fixed',options:['0.5 –ª','1 –ª']},
      'ryazhenka':{type:'fixed',options:['0.5 –ª','1 –ª']},
      'whey':{type:'fixed',options:['1 –ª']},
      'cream':{type:'fixed',options:['0.2 –ª','0.5 –ª','1 –ª']},
      'tvorog':{type:'weight',unit:'–≥',step:500,min:500,max:2000},
      'butter':{type:'fixed',options:['1 —à—Ç (200 –≥)']},
      'ghee':{type:'fixed',options:['200 –≥','500 –≥','1000 –≥']},
      'condensed-milk':{type:'weight',unit:'–≥',step:100,min:200,max:1000},
      'tvorozhnaya-massa':{type:'weight',unit:'–≥',step:100,min:200,max:1000},
      'cookies-tvorog':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'cookies-oat':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'cookies-nut':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'cookies-carob':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'cookies-sandy':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'muffin-plain':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'muffin-carob':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'muffin-raisin':{type:'weight',unit:'–≥',step:250,min:250,max:2000},
      'muffin-mix-plain-raisin':{type:'fixed',options:['0.5 –∫–≥']},
      'muffin-mix-plain-carob':{type:'fixed',options:['0.5 –∫–≥']},
      'muffin-mix-raisin-carob':{type:'fixed',options:['0.5 –∫–≥']},
      'sandesh-orange':{type:'fixed',options:['5 —à—Ç']},
      'sandesh-walnut':{type:'fixed',options:['5 —à—Ç']},
      'sandesh-carob':{type:'fixed',options:['5 —à—Ç']},
      'barfi-classic':{type:'fixed',options:['5 —à—Ç']},
      'barfi-hazelnut':{type:'fixed',options:['5 —à—Ç']},
      'barfi-sesame':{type:'fixed',options:['7 —à—Ç']},
      'halva':{type:'fixed',options:['0.2 –∫–≥']},
      'potato-cake-5':{type:'fixed',options:['5 —à—Ç']},
      'potato-cake-2':{type:'fixed',options:['2 —à—Ç']},
      'casserole-plain':{type:'fixed',options:['250 –≥']},
      'casserole-raisin':{type:'fixed',options:['250 –≥']},
      'crazy-cake':{type:'fixed',options:['1 —à—Ç']},
      'coconut-kuchen-1kg':{type:'fixed',options:['1 –∫–≥']},
      'coconut-kuchen-05kg':{type:'fixed',options:['0.5 –∫–≥']},
      'napoleon-1kg':{type:'fixed',options:['1+ –∫–≥']},
      'napoleon-05kg':{type:'fixed',options:['0.5+ –∫–≥']},
      'apple-pie':{type:'fixed',options:['900 –≥']},
      'bliny-10':{type:'fixed',options:['10 —à—Ç']},
      'bliny-5':{type:'fixed',options:['5 —à—Ç']},
      'bliny-tvorog-5':{type:'fixed',options:['5 —à—Ç']},
      'syrniki-10':{type:'fixed',options:['10 —à—Ç']},
      'syrniki-5':{type:'fixed',options:['5 —à—Ç']},
      'chapati-10':{type:'fixed',options:['10 —à—Ç']},
      'chapati-wholewheat-10':{type:'fixed',options:['10 —à—Ç']},
    };

    /* ========= –°–û–°–¢–û–Ø–ù–ò–ï ========= */
    let cart=[]; let currentProduct=null; let filteredProducts=[];

    /* ========= INIT ========= */
    document.addEventListener('DOMContentLoaded', init);

    function init(){
      loadState();
      setupTelegramWebApp();
      setupEventListeners();
      renderUserProfile();
      populateCategoryFilter();
      filterAndSearchProducts();
      updateCartUI();

      // –∫–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
      document.getElementById('status-ok').addEventListener('click', ()=>closeStatus(true));
      document.getElementById('status-close').addEventListener('click', ()=>closeStatus(false));
    }

    function loadState(){ try{ cart=JSON.parse(localStorage.getItem('syromania-cart')||'[]'); }catch{ cart=[] } }
    function saveState(){ try{ localStorage.setItem('syromania-cart', JSON.stringify(cart)); }catch{} }

    function setupTelegramWebApp(){
      if(window.Telegram){
        const webApp=window.Telegram.WebApp;
        webApp.ready(); webApp.expand();
        applyTheme(webApp.themeParams, webApp.colorScheme);
        webApp.MainButton.setText('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑').onClick(sendOrder).hide();
      }else{
        // standalone
        applyTheme({ bg_color: '#F8EFDA', text_color: '#2E2614', button_color: '#C7742E', button_text_color: '#ffffff' }, 'light');
      }
    }

    function applyTheme(themeParams, scheme){
      const r=document.documentElement;
      r.style.setProperty('--bg-color','#F8EFDA');
      r.style.setProperty('--text-color', themeParams.text_color||'#2E2614');
      r.style.setProperty('--button-color', themeParams.button_color||'#C7742E');
      r.style.setProperty('--button-text-color', themeParams.button_text_color||'#ffffff');
      r.style.setProperty('--secondary-bg-color', scheme==='dark'?'#3a2f19':'#F3E7CD');
      r.style.setProperty('--header-bg-color', scheme==='dark'?'#2f2816':'#F8EFDA');
      r.style.setProperty('--section-bg-color', scheme==='dark'?'#3a2f19':'#FFF8EC');
      r.style.setProperty('--border-color', scheme==='dark'?'#5a4b2b':'#E6D8BF');
      r.style.setProperty('--hint-color', scheme==='dark'?'#bda982':'#8C7A5B');
    }

    /* ========= UI ========= */
    function setupEventListeners(){
      byId('search-input').addEventListener('input', filterAndSearchProducts);
      byId('category-filter').addEventListener('change', filterAndSearchProducts);
      byId('only-cheese-checkbox').addEventListener('change', filterAndSearchProducts);
      byId('open-cart-btn').addEventListener('click', openCartModal);
      byId('add-to-cart-btn').addEventListener('click', addToCart);
      byId('product-variant-select').addEventListener('change', updateProductModalPrice);
      byId('product-qty-input').addEventListener('input', updateProductModalPrice);
      byId('cart-send-btn').addEventListener('click', sendOrder);
    }

    function renderUserProfile(){
      const el=byId('user-profile');
      const user=(window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user)||null;
      if(!user){ el.style.display='none'; return; }
      el.innerHTML=`
        <div class="user-avatar">
          <img src="${user.photo_url||''}" alt="" onerror="this.remove();this.nextElementSibling.style.display='grid'">
          <span style="display:none">${(user.first_name||'?').slice(0,1).toUpperCase()}</span>
        </div>
        <div class="user-name">${escapeHtml(user.first_name||'')}</div>
      `;
    }

    function populateCategoryFilter(){
      const cats=[...new Set(PRODUCTS.map(p=>p.cat))].sort();
      const sel=byId('category-filter'); sel.innerHTML='<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
      cats.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      byId('only-cheese-checkbox').checked=ONLY_CHEESE_FILTER_DEFAULT;
    }

    function filterAndSearchProducts(){
      const q=byId('search-input').value.toLowerCase();
      const selected=byId('category-filter').value;
      const onlyCheese=byId('only-cheese-checkbox').checked;

      filteredProducts=PRODUCTS.filter(p=>{
        const hasPrice = p.pricePerKg || p.pricePerL || p.pricePerUnit;
        if(!hasPrice) return false;
        if(q && !p.name.toLowerCase().includes(q)) return false;
        if(selected && p.cat!==selected) return false;
        if(onlyCheese && p.cat!=='–°—ã—Ä—ã') return false;
        return true;
      });

      renderProducts();
    }

    function renderProducts(){
      const grid=byId('product-grid'); grid.innerHTML='';
      if(!filteredProducts.length){ grid.innerHTML='<p style="text-align:center; color:var(--hint-color)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'; return; }
      filteredProducts.forEach(p=>{
        const card=document.createElement('div'); card.className='product-card'; card.onclick=()=>openProductModal(p.id);
        const priceText = p.pricePerKg? `${p.pricePerKg} ‚ÇΩ/–∫–≥` : p.pricePerL? `${p.pricePerL} ‚ÇΩ/–ª` : `${p.pricePerUnit} ‚ÇΩ`;
        card.innerHTML=`
          <div class="ico">${p.ico||'üõçÔ∏è'}</div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="price">${priceText}</div>
        `;
        grid.appendChild(card);
      });
    }

    /* ========= –ú–û–î–ê–õ –¢–û–í–ê–†–ê ========= */
    function openProductModal(id){
      currentProduct=PRODUCTS.find(p=>p.id===id); if(!currentProduct) return;
      byId('product-modal-title').textContent=currentProduct.name;
      byId('product-modal-ico').textContent=currentProduct.ico||'üì¶';
      byId('product-modal-description').textContent=currentProduct.description||'';
      renderVariantSelector(); updateProductModalPrice();
      byId('product-modal').showModal();
    }
    function closeProductModal(){ byId('product-modal').close(); currentProduct=null; }

    function renderVariantSelector(){
      const sel=byId('product-variant-select'); sel.innerHTML='';
      const rule=VARIANT_RULES[currentProduct.id];
      if(!rule){ sel.innerHTML='<option>–í–∞—Ä–∏–∞–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω</option>'; return; }
      if(rule.type==='fixed'){
        rule.options.forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; sel.appendChild(o); });
      }else if(rule.type==='weight'){
        for(let v=rule.min; v<=rule.max; v+=rule.step){
          const o=document.createElement('option'); o.value=`${v} ${rule.unit}`; o.textContent=`${v} ${rule.unit}`; sel.appendChild(o);
        }
      }
    }

    function updateProductModalPrice(){
      if(!currentProduct) return;
      const variant=byId('product-variant-select').value;
      const qty=parseInt(byId('product-qty-input').value||'1',10);
      const price=calculatePrice(currentProduct.id, variant, qty);
      byId('product-modal-price').textContent = `${price.finalPrice} ‚ÇΩ`;
    }

    /* ========= –ö–û–†–ó–ò–ù–ê ========= */
    function addToCart(){
      if(!currentProduct) return;
      const variant=byId('product-variant-select').value;
      const qty=parseInt(byId('product-qty-input').value||'1',10);
      const idx=cart.findIndex(it=>it.id===currentProduct.id && it.variant===variant);
      if(idx>-1) cart[idx].qty += qty;
      else cart.push({ id:currentProduct.id, name:currentProduct.name, cat:currentProduct.cat, variant, qty });
      saveState(); updateCartUI(); closeProductModal();
    }

    function updateCartUI(){
      const totalCount=cart.reduce((s,i)=>s+i.qty,0);
      const totalSum=cart.reduce((s,i)=>s+calculatePrice(i.id,i.variant,i.qty).finalPrice,0);
      const btn=byId('open-cart-btn');
      if(cart.length){ btn.disabled=false; btn.textContent=`–ö–æ—Ä–∑–∏–Ω–∞ (${totalCount}) ‚Äî ${totalSum} ‚ÇΩ`; }
      else{ btn.disabled=true; btn.textContent='–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'; }

      if(window.Telegram){
        const mb=Telegram.WebApp.MainButton;
        if(cart.length){ mb.setText(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ ${totalSum} ‚ÇΩ`); mb.show(); }
        else mb.hide();
      }
    }

    function openCartModal(){ renderCartModal(); byId('cart-modal').showModal(); }
    function closeCartModal(){ byId('cart-modal').close(); }

    function renderCartModal(){
      const body=byId('cart-modal-body'); body.innerHTML='';
      if(!cart.length){ body.innerHTML='<p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>'; return; }

      let total=0;
      cart.forEach((item,idx)=>{
        const price=calculatePrice(item.id,item.variant,item.qty);
        total+=price.finalPrice;
        const rate=getDiscountRateForProduct(item.id);
        const hint = rate>0 ? `<div class="discount-hint">–°–∫–∏–¥–∫–∞ ${ROUND(rate*100)}% –ø—Ä–∏–º–µ–Ω–µ–Ω–∞</div>` : '';
        const row=document.createElement('div'); row.className='cart-item';
        row.innerHTML=`
          <div class="cart-item-info">
            <div class="cart-item-name">${escapeHtml(item.name)}</div>
            <div class="cart-item-variant">${escapeHtml(item.variant)}</div>
            <div class="cart-item-price">${price.finalPrice} ‚ÇΩ</div>
            ${hint}
          </div>
          <div class="qty-control">
            <button onclick="changeItemQty(${idx},-1)">‚àí</button>
            <span>${item.qty}</span>
            <button onclick="changeItemQty(${idx},1)">+</button>
          </div>
        `;
        body.appendChild(row);
      });

      body.insertAdjacentHTML('beforeend', `<div class="cart-summary">–ò—Ç–æ–≥–æ: ${total} ‚ÇΩ</div>`);

      // === –ë–ª–æ–∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (—Ç–µ–ª–µ—Ñ–æ–Ω/–∞–¥—Ä–µ—Å/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π) ===
      const saved=loadCheckout();
      body.insertAdjacentHTML('beforeend', `
        <hr style="border:none; border-top:1px solid var(--border-color); margin:8px 0 14px 0">
        <div class="form-group">
          <label for="checkout-phone">–¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è —Å–≤—è–∑–∏ <span style="color:var(--hint-color)">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input type="tel" id="checkout-phone" placeholder="+7 999 999-99-99" value="${escapeAttr(saved.phone||'')}" autocomplete="tel" inputmode="tel" />
        </div>
        <div class="form-group">
          <label for="checkout-address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ <span style="color:var(--hint-color)">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
          <input type="text" id="checkout-address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥‚Ä¶" value="${escapeAttr(saved.address||'')}" autocomplete="street-address">
        </div>
        <div class="form-group">
          <label for="checkout-comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–∫–∞–∑—É</label>
          <textarea id="checkout-comment" rows="2" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫ 18:00, –¥–æ–º–æ—Ñ–æ–Ω #123">${escapeHtml(saved.comment||'')}</textarea>
        </div>
        <div class="muted" style="color:var(--hint-color)">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤.</div>
      `);
    }

    function changeItemQty(i, d){
      cart[i].qty+=d; if(cart[i].qty<=0) cart.splice(i,1);
      saveState(); updateCartUI(); renderCartModal();
    }

    /* ========= –†–ê–°–ß–Å–¢–´ ========= */
    function parseVariant(s){
      const m=String(s).match(/(\d+(?:\.\d+)?)\s*(–≥|–∫–≥|–ª|—à—Ç)/i);
      if(m){ const v=parseFloat(m[1]); const u=m[2].toLowerCase();
        return { value:v, unit: u==='–≥'?'g': u==='–∫–≥'?'kg': u==='–ª'?'l':'pc' };
      }
      const sp=String(s).match(/(\d+(?:\.\d+)?)\+\s*(–∫–≥|–ª)/i);
      if(sp){ const v=parseFloat(sp[1]); return { value:v, unit: sp[2].toLowerCase()==='–∫–≥'?'kg':'l' }; }
      return null;
    }
    function calculatePrice(id,variant,qty){
      const p=PRODUCTS.find(x=>x.id===id); if(!p) return {basePrice:0,finalPrice:0,discountRate:0};
      const rule=VARIANT_RULES[id]; let base=0;
      if(rule && rule.type==='fixed' && p.pricePerUnit){
        base=p.pricePerUnit*qty;
      }else{
        const pv=parseVariant(variant); if(!pv) return {basePrice:0,finalPrice:0,discountRate:0};
        if(p.pricePerKg){
          if(pv.unit==='g') base=(pv.value/1000)*p.pricePerKg;
          else if(pv.unit==='kg') base=pv.value*p.pricePerKg;
          else if(pv.unit==='pc'){
            const wm=String(variant).match(/\((\d+)\s*–≥\)/); if(wm){ base=(parseInt(wm[1])/1000)*p.pricePerKg; }
          }
        }else if(p.pricePerL){
          if(pv.unit==='l') base=pv.value*p.pricePerL;
        }else if(p.pricePerUnit){
          base=p.pricePerUnit;
        }
        base*=qty;
      }
      const rate=getDiscountRateForProduct(id);
      return { basePrice:ROUND(base), finalPrice:ROUND(base*(1-rate)), discountRate:rate };
    }
    function getDiscountRateForProduct(id){
      const p=PRODUCTS.find(x=>x.id===id); if(!p || p.cat!=='–°—ã—Ä—ã') return 0;
      const grams=cart.filter(i=>i.id===id).reduce((sum,i)=>{
        const pv=parseVariant(i.variant);
        if(!pv) return sum;
        if(pv.unit==='g') return sum+pv.value*i.qty;
        if(pv.unit==='kg') return sum+(pv.value*1000)*i.qty;
        if(pv.unit==='pc'){ const wm=String(i.variant).match(/\((\d+)\s*–≥\)/); if(wm) return sum+parseInt(wm[1])*i.qty; }
        return sum;
      },0);
      let rate=0; for(const th of DISCOUNT_THRESHOLDS){ if(grams>=th.g) rate=th.rate; } return rate;
    }

    /* ========= –û–§–û–†–ú–õ–ï–ù–ò–ï/–û–¢–ü–†–ê–í–ö–ê ========= */
    function loadCheckout(){ try{ return JSON.parse(localStorage.getItem('syromania-checkout')||'{}'); }catch{ return {} } }
    function saveCheckout(o){ try{ localStorage.setItem('syromania-checkout', JSON.stringify(o)); }catch{} }

    function sendOrder(){
      if(!cart.length) return;

      const phone=(byId('checkout-phone')||{}).value?.trim()||'';
      const address=(byId('checkout-address')||{}).value?.trim()||'';
      const comment=(byId('checkout-comment')||{}).value?.trim()||'';

      if(!/^[\d+\-()\s]{6,}$/.test(phone)){ alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞'); return; }
      if(address.length<4){ alert('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏'); return; }
      saveCheckout({phone,address,comment});

      const payload={
        type:'cart', source:'miniapp', currency:CURRENCY, items:[], total:0,
        contact_phone:phone, delivery_address:address, comment,
        meta:{ ts:Date.now(), schema_ver:PAYLOAD_SCHEMA_VERSION }
      };

      let total=0;
      cart.forEach(it=>{
        const price=calculatePrice(it.id,it.variant,it.qty); total+=price.finalPrice;
        payload.items.push({
          id:it.id, name:it.name, cat:it.cat, variant:it.variant, qty:it.qty,
          unit_price_base: price.basePrice/it.qty,
          discount_rate: price.discountRate,
          unit_price: price.finalPrice/it.qty,
          line_total: price.finalPrice
        });
      });
      payload.total=total;

      // –í–∞–∂–Ω–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä—è–º–æ –Ω–∞ Render, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —ç—Ç–æ –≤ –ª–æ–≥–∞—Ö
      axios.post(WEBHOOK_URL, payload)
        .then(() => {
          showStatus('success','–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!');
        })
        .catch((e) => {
          console.error(e);
          showStatus('error','–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
        });
    }

    function showStatus(type, text){
      const dlg=byId('status-modal');
      byId('status-ico').textContent = type==='success' ? '‚úÖ' : '‚ö†Ô∏è';
      byId('status-title').textContent = type==='success' ? '–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω' : '–û—à–∏–±–∫–∞';
      byId('status-text').textContent = text||'';
      dlg.showModal();
    }

    function closeStatus(alsoCloseApp){
      try{ byId('status-modal').close(); }catch{}
      if(alsoCloseApp && window.Telegram){ try{ Telegram.WebApp.close(); }catch{} }
    }

    /* ========= HELPERS ========= */
    function byId(id){ return document.getElementById(id) }
    function escapeHtml(s=''){return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }
    function escapeAttr(s=''){return String(s).replace(/"/g,'&quot;')}
  </script>
</body>
</html>
