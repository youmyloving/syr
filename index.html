<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Сыромания · Мини‑приложение</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #0f172a; /* slate-900 */
      --hint-color: #64748b; /* slate-500 */
      --link-color: #2481cc;
      --button-color: #2481cc;
      --button-text-color: #ffffff;
      --secondary-bg-color: #f8fafc; /* slate-50 */
      --header-bg-color: #ffffff;
      --section-bg-color: #ffffff;
      --border-color: #e2e8f0; /* slate-200 */
      --error-color: #e11d48; /* rose-600 */
      --success-color: #16a34a; /* green-600 */
      --warning-color: #ca8a04; /* yellow-600 */
      --radius: 14px;
      --shadow: 0 8px 28px rgba(2, 6, 23, 0.08);
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color);
      font-family: var(--font); font-size: 16px; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }

    /* App layout */
    #app { display: grid; grid-template-rows: auto auto 1fr auto; min-height: 100vh; }

    header {
      position: sticky; top: 0; z-index: 20; background: var(--header-bg-color);
      border-bottom: 1px solid var(--border-color); padding: 10px; backdrop-filter: saturate(180%) blur(6px);
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .user-profile { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--secondary-bg-color); display: grid; place-items: center; overflow: hidden; border: 1px solid var(--border-color); }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-name { font-weight: 600; font-size: 14px; }

    .searchbar { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 10px; }
    .input {
      width: 100%; padding: 12px 14px; border: 1px solid var(--border-color); border-radius: 12px;
      background: var(--secondary-bg-color); color: var(--text-color); font-size: 16px;
    }
    .select { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--secondary-bg-color); color: var(--text-color); font-size: 14px; }

    /* Category chips */
    .chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: none; }
    .chips::-webkit-scrollbar { display: none; }
    .chip { border: 1px solid var(--border-color); background: var(--section-bg-color); color: var(--text-color);
      padding: 8px 12px; border-radius: 999px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: transform .08s ease-in-out, background .2s;
    }
    .chip:active { transform: scale(0.98); }
    .chip.active { background: var(--button-color); color: var(--button-text-color); border-color: transparent; }

    main { padding: 12px; padding-bottom: 92px; }

    /* Product grid */
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(168px,1fr)); gap: 14px; }
    .card { border: 1px solid var(--border-color); border-radius: var(--radius); background: var(--section-bg-color);
      padding: 12px; box-shadow: var(--shadow); cursor: pointer; display: grid; gap: 8px; align-content: start; transition: transform .15s ease, box-shadow .15s ease;
    }
    .card:hover { transform: translateY(-3px); box-shadow: 0 12px 36px rgba(2, 6, 23, 0.13); }
    .ico { font-size: 46px; text-align: center; }
    .name { font-weight: 600; font-size: 14px; min-height: 38px; text-align: center; }
    .meta { display: flex; justify-content: center; gap: 8px; align-items: center; color: var(--hint-color); font-size: 12px; }
    .price { text-align: center; font-weight: 700; }

    /* Sticky cart button */
    .cart-footer { position: sticky; bottom: 0; z-index: 30; background: var(--header-bg-color);
      border-top: 1px solid var(--border-color); padding: 10px; }
    .btn { padding: 12px 18px; border: 0; border-radius: 14px; font-size: 16px; font-weight: 600; cursor: pointer; transition: filter .15s ease, transform .06s ease; }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--button-color); color: var(--button-text-color); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-secondary { background: var(--secondary-bg-color); color: var(--text-color); border: 1px solid var(--border-color); }
    .btn-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    /* Dialogs */
    dialog { border: 1px solid var(--border-color); border-radius: 16px; padding: 0; background: var(--section-bg-color); color: var(--text-color);
      width: 92vw; max-width: 560px; max-height: 86vh; overflow: hidden; box-shadow: 0 18px 42px rgba(2,6,23,.28);
    }
    dialog::backdrop { background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
    .modal-header { padding: 14px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { margin: 0; font-size: 18px; }
    .modal-close { background: none; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 26px; color: var(--hint-color); cursor: pointer; display: grid; place-items: center; }
    .modal-close:hover { background: var(--secondary-bg-color); }
    .modal-body { padding: 14px; overflow-y: auto; max-height: calc(86vh - 56px); display: grid; gap: 12px; }

    /* Forms */
    .form { display: grid; gap: 12px; }
    .form-row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .form-group { display: grid; gap: 6px; }
    label { font-size: 13px; color: var(--hint-color); }
    .field, select.field { padding: 12px 12px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--secondary-bg-color); color: var(--text-color); font-size: 16px; }
    .help { color: var(--hint-color); font-size: 12px; }
    .muted { color: var(--hint-color); }
    .center { text-align: center; }

    /* Cart */
    .cart-list { display: grid; gap: 10px; }
    .cart-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: 12px; background: var(--section-bg-color); }
    .cart-ico { font-size: 28px; width: 32px; text-align: center; }
    .cart-info { display: grid; gap: 4px; }
    .cart-name { font-weight: 600; }
    .cart-variant { font-size: 12px; color: var(--hint-color); }
    .cart-controls { display: flex; align-items: center; gap: 8px; }
    .qty { display: inline-flex; align-items: center; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .qty button { width: 34px; height: 34px; border: 0; background: var(--secondary-bg-color); cursor: pointer; font-size: 20px; }
    .qty span { min-width: 34px; text-align: center; display: inline-block; }
    .line { display: flex; justify-content: space-between; align-items: baseline; }
    .line small { color: var(--hint-color); }
    .hr { height: 1px; background: var(--border-color); margin: 6px 0; }

    .summary { display: grid; gap: 6px; font-size: 15px; }
    .summary .total { font-size: 18px; font-weight: 800; }

    .notice { padding: 10px; border-radius: 10px; background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; font-size: 13px; }
    .success { background: #ecfdf5; color: #065f46; border-color: #a7f3d0; }
    .error { background: #fff1f2; color: #9f1239; border-color: #fecdd3; }

    .kicker { font-size: 12px; text-transform: uppercase; letter-spacing: .08em; color: var(--hint-color); }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="user-profile" id="user-profile"></div>
      <div class="searchbar">
        <input type="search" id="search-input" class="input" placeholder="Поиск по названию или описанию…" />
        <label style="display:flex;align-items:center;gap:8px; white-space:nowrap;">
          <input type="checkbox" id="only-cheese-checkbox" /> Только сыры
        </label>
      </div>
      <div class="chips" id="category-chips"></div>
    </header>

    <div id="filters" class="row" style="padding: 0 12px 8px 12px;">
      <select id="sort-select" class="select">
        <option value="default">Сортировка: по популярности</option>
        <option value="price-asc">Цена ↑</option>
        <option value="price-desc">Цена ↓</option>
        <option value="name-asc">Название A→Я</option>
        <option value="name-desc">Название Я→A</option>
      </select>
      <span class="help" id="result-count"></span>
    </div>

    <main>
      <div id="product-grid" class="product-grid"></div>
    </main>

    <footer class="cart-footer">
      <button id="open-cart-btn" class="btn btn-primary" disabled>Корзина пуста</button>
    </footer>
  </div>

  <!-- Product modal -->
  <dialog id="product-modal">
    <div class="modal-header">
      <h2 id="product-modal-title"></h2>
      <button class="modal-close" onclick="closeProductModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="center"><div class="ico" id="product-modal-ico"></div></div>
      <p class="help center" id="product-modal-description"></p>

      <div class="form">
        <div class="form-group">
          <label for="product-variant-select">Вариант</label>
          <select id="product-variant-select" class="field"></select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="product-qty-input">Количество</label>
            <input type="number" id="product-qty-input" class="field" value="1" min="1" step="1" />
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-secondary" id="product-inc-qty" type="button">+ ещё</button>
          </div>
        </div>
        <div class="notice" id="discount-hint" style="display:none"></div>
        <div class="line"><span class="kicker">К оплате</span> <div class="price" id="product-modal-price">0 ₽</div></div>
        <button class="btn btn-primary" id="add-to-cart-btn" type="button">Добавить в корзину</button>
      </div>
    </div>
  </dialog>

  <!-- Cart modal -->
  <dialog id="cart-modal">
    <div class="modal-header">
      <h2>Корзина</h2>
      <button class="modal-close" onclick="closeCartModal()">×</button>
    </div>
    <div class="modal-body">
      <div id="cart-modal-body"></div>
      <div class="hr"></div>
      <div class="summary" id="cart-summary"></div>
      <div class="row">
        <button class="btn btn-danger" id="clear-cart-btn" type="button">Очистить</button>
        <button class="btn btn-primary" id="checkout-btn" type="button">Оформить заказ</button>
      </div>
    </div>
  </dialog>

  <!-- Checkout modal -->
  <dialog id="checkout-modal">
    <div class="modal-header">
      <h2>Оформление заказа</h2>
      <button class="modal-close" onclick="closeCheckoutModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="notice" id="checkout-note">Пожалуйста, укажите контактные данные для доставки. Мы свяжемся для подтверждения.</div>
      <form id="checkout-form" class="form">
        <div class="form-group">
          <label for="customer-name">Имя</label>
          <input id="customer-name" class="field" placeholder="Например, Анна" autocomplete="name" />
        </div>
        <div class="form-group">
          <label for="customer-phone">Телефон <span class="muted">(обязательно)</span></label>
          <input id="customer-phone" class="field" placeholder="+7 9XX XXX-XX-XX" inputmode="tel" autocomplete="tel" required />
          <div class="help">Формат: +7 9•• •••-••-••</div>
        </div>
        <div class="form-group">
          <label for="customer-address">Адрес доставки <span class="muted">(обязательно)</span></label>
          <input id="customer-address" class="field" placeholder="Город, улица, дом, подъезд/этаж/кв" autocomplete="street-address" required />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="payment-method">Способ оплаты</label>
            <select id="payment-method" class="field">
              <option value="cash">Наличные</option>
              <option value="card">Перевод на карту/СБП</option>
            </select>
          </div>
          <div class="form-group">
            <label for="delivery-time">Время</label>
            <select id="delivery-time" class="field">
              <option value="asap">Как можно скорее</option>
              <option value="today-evening">Сегодня вечером</option>
              <option value="tomorrow">Завтра</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="order-comment">Комментарий</label>
          <input id="order-comment" class="field" placeholder="Например: позвонить за 10 минут, не звонить в домофон…" />
        </div>
        <div class="summary">
          <div class="line"><span>Товаров</span><strong id="summary-items"></strong></div>
          <div class="line"><span>Сумма</span><strong id="summary-total"></strong></div>
          <div class="line">
            <small>Нажимая «Отправить заказ», вы подтверждаете корректность данных</small>
          </div>
          <button class="btn btn-primary" id="place-order-btn" type="submit">Отправить заказ</button>
          <div class="notice success" id="submit-success" style="display:none;">Заказ отправлен! Спасибо 🌿</div>
          <div class="notice error" id="submit-error" style="display:none;">Не удалось отправить заказ. Попробуйте ещё раз.</div>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    // =====================
    // CONFIGURATION
    // =====================
    const APP_NAME = 'Сыромания';
    const CURRENCY = 'RUB';
    const ROUND = Math.round;
    const fmtPrice = new Intl.NumberFormat('ru-RU');

    // Discount thresholds per single-cheese product (applied per product by total grams in cart)
    const DISCOUNT_THRESHOLDS = [
      { g: 1000, rate: 0.15 },
      { g: 700, rate: 0.10 },
      { g: 500, rate: 0.05 }
    ];

    const ONLY_CHEESE_FILTER_DEFAULT = false;
    const PAYLOAD_SCHEMA_VERSION = 'v2';

    // Submission mode: 'telegram' | 'webhook' | 'both'
    const SUBMIT_MODE = 'telegram';

    // If you want to send to your webhook (Puzzlebot / собственный бэкенд), укажите URL ниже.
    // Пример приёма: POST JSON body, без CORS в Telegram WebView.
    const WEBHOOK_URL = '';
    // Можно добавить свои заголовки/токены, если нужно авторизоваться на вебхуке.
    const WEBHOOK_HEADERS = { /* 'X-Secret': '...' */ };

    // =====================
    // CATALOG DATA
    // =====================
    const PRODUCTS = [
      // --- Сыры ---
      { id: 'panir-classic', name: 'Панир Классический', cat: 'Сыры', pricePerKg: 1200, ico: '🧀', description: 'Нежный свежий сыр.' },
      { id: 'panir-herbs', name: 'Панир С зеленью', cat: 'Сыры', pricePerKg: 1300, ico: '🌿', description: 'С ароматными травами.' },
      { id: 'panir-spicy', name: 'Панир С пряностями', cat: 'Сыры', pricePerKg: 1350, ico: '🌶️', description: 'С пикантными специями.' },
      { id: 'panir-smoked', name: 'Панир Копчёный', cat: 'Сыры', pricePerKg: 1400, ico: '💨', description: 'С дымным ароматом.' },
      { id: 'suluguni', name: 'Сулугуни', cat: 'Сыры', pricePerKg: 1400, ico: '🧀', description: 'Классический грузинский сыр.' },
      { id: 'suluguni-smoked', name: 'Сулугуни копчёный', cat: 'Сыры', pricePerKg: 1550, ico: '💨', description: 'Копчёный сулугуни.' },
      { id: 'imeretian', name: 'Имеретинский', cat: 'Сыры', pricePerKg: 1300, ico: '🧀', description: 'Мягкий, рассыпчатый сыр.' },
      { id: 'imeretian-dill-garlic', name: 'Имеретинский с укропом и чесноком', cat: 'Сыры', pricePerKg: 1400, ico: '🧄', description: 'С насыщенным вкусом.' },
      { id: 'halloumi', name: 'Халлуми (классический)', cat: 'Сыры', pricePerKg: 1650, ico: '🔥', description: 'Идеален для жарки.' },
      { id: 'halloumi-paprika-oregano', name: 'Халлуми с паприкой и орегано', cat: 'Сыры', pricePerKg: 1800, ico: '🌶️', description: 'Средиземноморские нотки.' },
      { id: 'halloumi-tomato-basil-garlic', name: 'Халлуми томат-базилик-чеснок', cat: 'Сыры', pricePerKg: 1800, ico: '🍅', description: 'Итальянский вкус.' },
      { id: 'halloumi-tomato-paprika', name: 'Халлуми с вялеными помидорами и паприкой', cat: 'Сыры', pricePerKg: 1800, ico: '🍅', description: 'Яркий и насыщенный.' },
      { id: 'kosichka', name: 'Косичка', cat: 'Сыры', pricePerKg: 1600, ico: '🥨', description: 'В форме плетенки.' },
      { id: 'kosichka-smoked', name: 'Косичка копчёная', cat: 'Сыры', pricePerKg: 1750, ico: '💨', description: 'Копчёная косичка.' },
      { id: 'spicy-klubok', name: 'Пряный клубок', cat: 'Сыры', pricePerUnit: 1680, ico: '🌶️', description: 'Острый сыр в виде клубка.' },
      { id: 'mozzarella', name: 'Моцарелла', cat: 'Сыры', pricePerUnit: 1700, ico: '🧀', description: 'Классическая моцарелла.' },
      { id: 'buratta', name: 'Буратта', cat: 'Сыры', pricePerUnit: 1800, ico: '🧀', description: 'Нежнейшая буратта.' },
      { id: 'stracciatella', name: 'Страчателла', cat: 'Сыры', pricePerKg: 1850, ico: '🧀', description: 'Сливки и нити моцареллы.' },
      { id: 'ricotta', name: 'Творожный сыр (рикотта)', cat: 'Сыры', pricePerKg: 1100, ico: '🥛', description: 'Итальянский творожный сыр.' },
      { id: 'ricotta-herbs', name: 'Рикотта с укропом и зеленью', cat: 'Сыры', pricePerKg: 1200, ico: '🌿', description: 'С ароматной зеленью.' },
      { id: 'caciotta', name: 'Качотта', cat: 'Сыры', pricePerKg: 2150, ico: '🧀', description: 'Мягкий итальянский сыр.' },
      { id: 'caciotta-fenugreek', name: 'Качотта с пажитником', cat: 'Сыры', pricePerKg: 2250, ico: '🌿', description: 'С ореховым привкусом.' },
      { id: 'hard-village', name: 'Твёрдый по-деревенски', cat: 'Сыры', pricePerKg: 1400, ico: '🧀', description: 'Насыщенный вкус.' },
      { id: 'hard-smoked', name: 'Твёрдый копчёный', cat: 'Сыры', pricePerKg: 1600, ico: '💨', description: 'Копчёный твёрдый сыр.' },
      { id: 'rolls-olives-walnut', name: 'Сырный рулет (маслины, грецкий орех)', cat: 'Сыры', pricePerKg: 1550, ico: '🥜', description: 'Праздничный вариант.' },
      { id: 'rolls-apricot-cedar', name: 'Сырный рулет (курага, кедровый)', cat: 'Сыры', pricePerKg: 1550, ico: '🍑', description: 'Сладкий и соленый вкус.' },
      // --- Молочная продукция ---
      { id: 'milk', name: 'Молоко', cat: 'Молочная продукция', pricePerL: 100, ico: '🥛', description: 'Свежее молоко.' },
      { id: 'milk-topped', name: 'Топлёное молоко', cat: 'Молочная продукция', pricePerL: 200, ico: '🥛', description: 'Традиционное топлёное.' },
      { id: 'yogurt', name: 'Йогурт классический', cat: 'Молочная продукция', pricePerL: 230, ico: '🥛', description: 'Натуральный йогурт.' },
      { id: 'ryazhenka', name: 'Ряженка', cat: 'Молочная продукция', pricePerL: 250, ico: '🥛', description: 'Кисломолочный напиток.' },
      { id: 'whey', name: 'Сыворотка', cat: 'Молочная продукция', pricePerL: 50, ico: '💧', description: 'Молочная сыворотка.' },
      { id: 'cream', name: 'Сливки', cat: 'Молочная продукция', pricePerL: 1200, ico: '🥛', description: 'Жирные сливки 33%.' },
      { id: 'tvorog', name: 'Творог', cat: 'Молочная продукция', pricePerKg: 500, ico: '🥛', description: 'Домашний творог.' },
      { id: 'butter', name: 'Масло сливочное', cat: 'Молочная продукция', pricePerKg: 1800, ico: '🧈', description: 'Вкусное сливочное масло.' },
      { id: 'ghee', name: 'Топлёное масло (ГХИ)', cat: 'Молочная продукция', pricePerKg: 2300, ico: '🧈', description: 'Чистое топлёное масло.' },
      { id: 'condensed-milk', name: 'Сгущенка', cat: 'Молочная продукция', pricePerKg: 850, ico: '🥛', description: 'Натуральная сгущенка.' },
      { id: 'tvorozhnaya-massa', name: 'Творожная масса', cat: 'Молочная продукция', pricePerKg: 700, ico: '🥛', description: 'С добавками (изюм, курага и т.д.).' },
      // --- Сладости и выпечка ---
      { id: 'cookies-tvorog', name: 'Печенье творожное', cat: 'Сладости и выпечка', pricePerKg: 600, ico: '🍪', description: 'Нежное печенье.' },
      { id: 'cookies-oat', name: 'Печенье овсяное', cat: 'Сладости и выпечка', pricePerKg: 600, ico: '🍪', description: 'Полезное овсяное.' },
      { id: 'cookies-nut', name: 'Ореховые пальчики', cat: 'Сладости и выпечка', pricePerKg: 700, ico: '🍪', description: 'С хрустящими орехами.' },
      { id: 'cookies-carob', name: 'Кэрбовые печенья', cat: 'Сладости и выпечка', pricePerKg: 600, ico: '🍪', description: 'На сладости кэроба.' },
      { id: 'cookies-sandy', name: 'Песочное печенье', cat: 'Сладости и выпечка', pricePerKg: 600, ico: '🍪', description: 'Классическое песочное.' },
      { id: 'muffin-plain', name: 'Кексы обычные', cat: 'Сладости и выпечка', pricePerKg: 500, ico: '🧁', description: 'Простые и вкусные.' },
      { id: 'muffin-carob', name: 'Кексы кэробовые', cat: 'Сладости и выпечка', pricePerKg: 550, ico: '🧁', description: 'С кэробом.' },
      { id: 'muffin-raisin', name: 'Кексы изюм', cat: 'Сладости и выпечка', pricePerKg: 550, ico: '🧁', description: 'С изюмом.' },
      { id: 'muffin-mix-plain-raisin', name: 'Кексы микс (обычные+изюм)', cat: 'Сладости и выпечка', pricePerUnit: 280, ico: '🧁', description: 'Микс на 0.5 кг.' },
      { id: 'muffin-mix-plain-carob', name: 'Кексы микс (обычные+кэроб)', cat: 'Сладости и выпечка', pricePerUnit: 300, ico: '🧁', description: 'Микс на 0.5 кг.' },
      { id: 'muffin-mix-raisin-carob', name: 'Кексы микс (изюм+кэроб)', cat: 'Сладости и выпечка', pricePerUnit: 300, ico: '🧁', description: 'Микс на 0.5 кг.' },
      { id: 'sandesh-orange', name: 'Сандеш (апельсин)', cat: 'Сладости и выпечка', pricePerUnit: 250, ico: '🍮', description: '5 шт.' },
      { id: 'sandesh-walnut', name: 'Сандеш (грец. орех)', cat: 'Сладости и выпечка', pricePerUnit: 250, ico: '🍮', description: '5 шт.' },
      { id: 'sandesh-carob', name: 'Сандеш (кэроб)', cat: 'Сладости и выпечка', pricePerUnit: 250, ico: '🍮', description: '5 шт.' },
      { id: 'barfi-classic', name: 'Бурфи классический', cat: 'Сладости и выпечка', pricePerUnit: 300, ico: '🍮', description: '5 шт.' },
      { id: 'barfi-hazelnut', name: 'Бурфи фундук', cat: 'Сладости и выпечка', pricePerUnit: 300, ico: '🍮', description: '5 шт.' },
      { id: 'barfi-sesame', name: 'Бурфи кунжутный', cat: 'Сладости и выпечка', pricePerUnit: 420, ico: '🍮', description: '7 шт.' },
      { id: 'halva', name: 'Халва', cat: 'Сладости и выпечка', pricePerUnit: 200, ico: '🍮', description: '0.2 кг' },
      { id: 'potato-cake-5', name: 'Пирожное «Картошка»', cat: 'Сладости и выпечка', pricePerUnit: 330, ico: '🍰', description: '5 шт.' },
      { id: 'potato-cake-2', name: 'Пирожное «Картошка»', cat: 'Сладости и выпечка', pricePerUnit: 155, ico: '🍰', description: '2 шт.' },
      { id: 'casserole-plain', name: 'Запеканка творожная (обычная)', cat: 'Сладости и выпечка', pricePerUnit: 260, ico: '🍮', description: '250 г' },
      { id: 'casserole-raisin', name: 'Запеканка творожная (с изюмом)', cat: 'Сладости и выпечка', pricePerUnit: 260, ico: '🍮', description: '250 г' },
      { id: 'crazy-cake', name: 'Крейзи-кейк', cat: 'Сладости и выпечка', pricePerUnit: 600, ico: '🎂', description: '1 шт.' },
      { id: 'coconut-kuchen-1kg', name: 'Кокосовый кухен', cat: 'Сладости и выпечка', pricePerUnit: 1800, ico: '🍰', description: '1 кг' },
      { id: 'coconut-kuchen-05kg', name: 'Кокосовый кухен', cat: 'Сладости и выпечка', pricePerUnit: 1000, ico: '🍰', description: '0.5 кг' },
      { id: 'napoleon-1kg', name: 'Торт «Наполеон»', cat: 'Сладости и выпечка', pricePerUnit: 1300, ico: '🎂', description: '1+ кг' },
      { id: 'napoleon-05kg', name: 'Торт «Наполеон»', cat: 'Сладости и выпечка', pricePerUnit: 750, ico: '🎂', description: '0.5+ кг' },
      { id: 'apple-pie', name: 'Яблочный пирог', cat: 'Сладости и выпечка', pricePerUnit: 560, ico: '🥧', description: '900 г' },
      { id: 'bliny-10', name: 'Блины', cat: 'Сладости и выпечка', pricePerUnit: 330, ico: '🥞', description: '10 шт.' },
      { id: 'bliny-5', name: 'Блины', cat: 'Сладости и выпечка', pricePerUnit: 220, ico: '🥞', description: '5 шт.' },
      { id: 'bliny-tvorog-5', name: 'Блины творог/творог-изюм', cat: 'Сладости и выпечка', pricePerUnit: 300, ico: '🥞', description: '5 шт.' },
      { id: 'syrniki-10', name: 'Сырники', cat: 'Сладости и выпечка', pricePerUnit: 520, ico: '🥞', description: '10 шт.' },
      { id: 'syrniki-5', name: 'Сырники', cat: 'Сладости и выпечка', pricePerUnit: 280, ico: '🥞', description: '5 шт.' },
      { id: 'chapati-10', name: 'Чапати', cat: 'Сладости и выпечка', pricePerUnit: 270, ico: '🫓', description: '10 шт.' },
      { id: 'chapati-wholewheat-10', name: 'Чапати (ц/з мука)', cat: 'Сладости и выпечка', pricePerUnit: 320, ico: '🫓', description: '10 шт.' },
    ];

    const VARIANT_RULES = {
      // Сыры
      'panir-classic': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'panir-herbs': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'panir-spicy': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'panir-smoked': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'suluguni': { type: 'weight', unit: 'г', step: 100, min: 100, max: 1000 },
      'suluguni-smoked': { type: 'weight', unit: 'г', step: 100, min: 100, max: 1000 },
      'imeretian': { type: 'weight', unit: 'г', step: 100, min: 100, max: 1000 },
      'imeretian-dill-garlic': { type: 'weight', unit: 'г', step: 100, min: 100, max: 1000 },
      'halloumi': { type: 'fixed', options: ['1 шт (200 г)', '1 шт (250 г)'] },
      'halloumi-paprika-oregano': { type: 'fixed', options: ['1 шт (200 г)', '1 шт (250 г)'] },
      'halloumi-tomato-basil-garlic': { type: 'fixed', options: ['1 шт (200 г)', '1 шт (250 г)'] },
      'halloumi-tomato-paprika': { type: 'fixed', options: ['1 шт (200 г)', '1 шт (250 г)'] },
      'kosichka': { type: 'fixed', options: ['1 шт (200 г)'] },
      'kosichka-smoked': { type: 'fixed', options: ['1 шт (200 г)'] },
      'spicy-klubok': { type: 'fixed', options: ['1 шт (150 г)'] },
      'mozzarella': { type: 'fixed', options: ['1 шт (200 г)'] },
      'buratta': { type: 'fixed', options: ['1 шт (250 г)'] },
      'stracciatella': { type: 'fixed', options: ['200 г', '250 г', '300 г', '500 г'] },
      'ricotta': { type: 'fixed', options: ['200 г', '250 г', '300 г', '450 г'] },
      'ricotta-herbs': { type: 'fixed', options: ['200 г', '250 г', '300 г', '450 г'] },
      'caciotta': { type: 'weight', unit: 'г', step: 100, min: 200, max: 1000 },
      'caciotta-fenugreek': { type: 'weight', unit: 'г', step: 100, min: 200, max: 1000 },
      'hard-village': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'hard-smoked': { type: 'fixed', options: ['200 г', '300 г', '400 г', '500 г', '1000 г'] },
      'rolls-olives-walnut': { type: 'weight', unit: 'г', step: 50, min: 100, max: 1000 },
      'rolls-apricot-cedar': { type: 'weight', unit: 'г', step: 50, min: 100, max: 1000 },
      // Молочная продукция
      'milk': { type: 'fixed', options: ['0.5 л', '1 л'] },
      'milk-topped': { type: 'fixed', options: ['0.5 л', '1 л'] },
      'yogurt': { type: 'fixed', options: ['0.5 л', '1 л'] },
      'ryazhenka': { type: 'fixed', options: ['0.5 л', '1 л'] },
      'whey': { type: 'fixed', options: ['1 л'] },
      'cream': { type: 'fixed', options: ['0.2 л', '0.5 л', '1 л'] },
      'tvorog': { type: 'weight', unit: 'г', step: 500, min: 500, max: 2000 },
      'butter': { type: 'fixed', options: ['1 шт (200 г)'] },
      'ghee': { type: 'fixed', options: ['200 г', '500 г', '1000 г'] },
      'condensed-milk': { type: 'weight', unit: 'г', step: 100, min: 200, max: 1000 },
      'tvorozhnaya-massa': { type: 'weight', unit: 'г', step: 100, min: 200, max: 1000 },
      // Сладости и выпечка
      'cookies-tvorog': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'cookies-oat': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'cookies-nut': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'cookies-carob': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'cookies-sandy': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'muffin-plain': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'muffin-carob': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'muffin-raisin': { type: 'weight', unit: 'г', step: 250, min: 250, max: 2000 },
      'muffin-mix-plain-raisin': { type: 'fixed', options: ['0.5 кг'] },
      'muffin-mix-plain-carob': { type: 'fixed', options: ['0.5 кг'] },
      'muffin-mix-raisin-carob': { type: 'fixed', options: ['0.5 кг'] },
      'sandesh-orange': { type: 'fixed', options: ['5 шт'] },
      'sandesh-walnut': { type: 'fixed', options: ['5 шт'] },
      'sandesh-carob': { type: 'fixed', options: ['5 шт'] },
      'barfi-classic': { type: 'fixed', options: ['5 шт'] },
      'barfi-hazelnut': { type: 'fixed', options: ['5 шт'] },
      'barfi-sesame': { type: 'fixed', options: ['7 шт'] },
      'halva': { type: 'fixed', options: ['0.2 кг'] },
      'potato-cake-5': { type: 'fixed', options: ['5 шт'] },
      'potato-cake-2': { type: 'fixed', options: ['2 шт'] },
      'casserole-plain': { type: 'fixed', options: ['250 г'] },
      'casserole-raisin': { type: 'fixed', options: ['250 г'] },
      'crazy-cake': { type: 'fixed', options: ['1 шт'] },
      'coconut-kuchen-1kg': { type: 'fixed', options: ['1 кг'] },
      'coconut-kuchen-05kg': { type: 'fixed', options: ['0.5 кг'] },
      'napoleon-1kg': { type: 'fixed', options: ['1+ кг'] },
      'napoleon-05kg': { type: 'fixed', options: ['0.5+ кг'] },
      'apple-pie': { type: 'fixed', options: ['900 г'] },
      'bliny-10': { type: 'fixed', options: ['10 шт'] },
      'bliny-5': { type: 'fixed', options: ['5 шт'] },
      'bliny-tvorog-5': { type: 'fixed', options: ['5 шт'] },
      'syrniki-10': { type: 'fixed', options: ['10 шт'] },
      'syrniki-5': { type: 'fixed', options: ['5 шт'] },
      'chapati-10': { type: 'fixed', options: ['10 шт'] },
      'chapati-wholewheat-10': { type: 'fixed', options: ['10 шт'] },
    };

    // =====================
    // STATE
    // =====================
    let cart = []; // { id, name, cat, variant, qty }
    let currentProduct = null;
    let filteredProducts = [];
    let selectedCategories = new Set();

    // =====================
    // INIT
    // =====================
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      try {
        loadState();
        setupTelegramWebApp();
        renderUserProfile();
        buildCategoryChips();
        setupEventListeners();
        filterAndSearchProducts();
        updateCartUI();
      } catch (e) {
        console.error('Init error', e);
        const grid = document.getElementById('product-grid');
        grid.innerHTML = `<p style="color: var(--error-color); text-align:center; padding: 20px;">Произошла ошибка при загрузке. Обновите страницу.</p>`;
      }
    }

    function setupTelegramWebApp() {
      if (window.Telegram && window.Telegram.WebApp) {
        const wa = window.Telegram.WebApp;
        wa.ready(); wa.expand();
        applyTheme(wa.themeParams, wa.colorScheme);
        wa.MainButton.setText('Отправить заказ').onClick(() => startCheckout()).hide();
      } else {
        // Standalone mode (для тестов)
        applyTheme({ bg_color: '#ffffff', text_color: '#0f172a', hint_color: '#64748b', link_color: '#2481cc', button_color: '#2481cc', button_text_color: '#ffffff' }, 'light');
      }
    }

    function applyTheme(themeParams, colorScheme) {
      const root = document.documentElement;
      root.style.setProperty('--bg-color', themeParams.bg_color || '#ffffff');
      root.style.setProperty('--text-color', themeParams.text_color || '#0f172a');
      root.style.setProperty('--hint-color', themeParams.hint_color || '#64748b');
      root.style.setProperty('--link-color', themeParams.link_color || '#2481cc');
      root.style.setProperty('--button-color', themeParams.button_color || '#2481cc');
      root.style.setProperty('--button-text-color', themeParams.button_text_color || '#ffffff');
      const dark = colorScheme === 'dark';
      root.style.setProperty('--secondary-bg-color', dark ? '#0b1220' : '#f8fafc');
      root.style.setProperty('--header-bg-color', dark ? '#0b1220' : '#ffffff');
      root.style.setProperty('--section-bg-color', dark ? '#0b1220' : '#ffffff');
      root.style.setProperty('--border-color', dark ? '#1f2937' : '#e2e8f0');
    }

    function renderUserProfile() {
      const box = document.getElementById('user-profile');
      let user = null;
      if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
        user = window.Telegram.WebApp.initDataUnsafe.user;
      }
      if (user) {
        box.innerHTML = `
          <div class="user-avatar">
            <img src="${user.photo_url || ''}" alt="" onerror="this.remove();" />
            ${user.photo_url ? '' : `<span>${(user.first_name||'?').charAt(0).toUpperCase()}</span>`}
          </div>
          <div class="user-name">${user.first_name || 'Гость'}</div>
        `;
      } else {
        box.innerHTML = `<div class="user-name">${APP_NAME}</div>`;
      }
    }

    function buildCategoryChips() {
      const cats = [...new Set(PRODUCTS.map(p => p.cat))].sort();
      const wrap = document.getElementById('category-chips');
      wrap.innerHTML = '';
      const all = document.createElement('button');
      all.className = 'chip active'; all.textContent = 'Все';
      all.onclick = () => { selectedCategories.clear(); refreshChipsUI(); filterAndSearchProducts(); };
      wrap.appendChild(all);
      cats.forEach(cat => {
        const chip = document.createElement('button');
        chip.className = 'chip'; chip.dataset.cat = cat; chip.textContent = cat;
        chip.onclick = () => { toggleCategory(cat); };
        wrap.appendChild(chip);
      });
    }

    function refreshChipsUI() {
      document.querySelectorAll('.chip').forEach(el => {
        if (!el.dataset.cat) { // "Все"
          el.classList.toggle('active', selectedCategories.size === 0);
        } else {
          el.classList.toggle('active', selectedCategories.has(el.dataset.cat));
        }
      });
    }

    function toggleCategory(cat) {
      if (selectedCategories.has(cat)) selectedCategories.delete(cat); else selectedCategories.add(cat);
      refreshChipsUI();
      filterAndSearchProducts();
    }

    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', debounce(filterAndSearchProducts, 120));
      document.getElementById('only-cheese-checkbox').checked = ONLY_CHEESE_FILTER_DEFAULT;
      document.getElementById('only-cheese-checkbox').addEventListener('change', filterAndSearchProducts);
      document.getElementById('sort-select').addEventListener('change', filterAndSearchProducts);
      document.getElementById('open-cart-btn').addEventListener('click', openCartModal);
      document.getElementById('add-to-cart-btn').addEventListener('click', addToCart);
      document.getElementById('product-variant-select').addEventListener('change', updateProductModalPrice);
      document.getElementById('product-qty-input').addEventListener('input', updateProductModalPrice);
      document.getElementById('product-inc-qty').addEventListener('click', () => {
        const el = document.getElementById('product-qty-input'); el.value = Math.max(1, (parseInt(el.value)||1) + 1); updateProductModalPrice();
      });

      // Cart actions
      document.getElementById('clear-cart-btn').addEventListener('click', () => { if (confirm('Очистить корзину?')) { cart = []; saveState(); updateCartUI(); renderCartModal(); }});
      document.getElementById('checkout-btn').addEventListener('click', startCheckout);

      // Checkout
      document.getElementById('checkout-form').addEventListener('submit', onPlaceOrderSubmit);

      // Restore customer draft
      const name = localStorage.getItem('syromania-cust-name');
      const phone = localStorage.getItem('syromania-cust-phone');
      const addr = localStorage.getItem('syromania-cust-addr');
      if (name) document.getElementById('customer-name').value = name;
      if (phone) document.getElementById('customer-phone').value = phone;
      if (addr) document.getElementById('customer-address').value = addr;
      document.getElementById('customer-name').addEventListener('input', e => localStorage.setItem('syromania-cust-name', e.target.value));
      document.getElementById('customer-phone').addEventListener('input', e => localStorage.setItem('syromania-cust-phone', e.target.value));
      document.getElementById('customer-address').addEventListener('input', e => localStorage.setItem('syromania-cust-addr', e.target.value));
    }

    function loadState() {
      try { cart = JSON.parse(localStorage.getItem('syromania-cart') || '[]'); } catch { cart = []; }
    }
    function saveState() { try { localStorage.setItem('syromania-cart', JSON.stringify(cart)); } catch {}
    }

    // =====================
    // FILTER & RENDER
    // =====================
    function filterAndSearchProducts() {
      const q = (document.getElementById('search-input').value || '').trim().toLowerCase();
      const onlyCheese = document.getElementById('only-cheese-checkbox').checked;
      const sort = document.getElementById('sort-select').value;

      filteredProducts = PRODUCTS.filter(p => {
        const text = (p.name + ' ' + (p.description||'')).toLowerCase();
        const matchesQuery = q.length === 0 || text.includes(q);
        const matchesCheese = !onlyCheese || p.cat === 'Сыры';
        const matchesCats = (selectedCategories.size === 0) || selectedCategories.has(p.cat);
        const hasPrice = p.pricePerKg || p.pricePerL || p.pricePerUnit;
        return matchesQuery && matchesCheese && matchesCats && hasPrice;
      });

      // sort
      if (sort === 'price-asc') filteredProducts.sort((a,b) => getBaseUnitPrice(a) - getBaseUnitPrice(b));
      if (sort === 'price-desc') filteredProducts.sort((a,b) => getBaseUnitPrice(b) - getBaseUnitPrice(a));
      if (sort === 'name-asc') filteredProducts.sort((a,b) => a.name.localeCompare(b.name, 'ru'));
      if (sort === 'name-desc') filteredProducts.sort((a,b) => b.name.localeCompare(a.name, 'ru'));

      // Render
      renderProducts();

      // Result count
      const rc = document.getElementById('result-count');
      rc.textContent = `${filteredProducts.length} поз.`;
    }

    function getBaseUnitPrice(p) {
      if (p.pricePerKg) return p.pricePerKg; if (p.pricePerL) return p.pricePerL; return p.pricePerUnit || 0;
    }

    function renderProducts() {
      const grid = document.getElementById('product-grid'); grid.innerHTML = '';
      if (filteredProducts.length === 0) { grid.innerHTML = '<p class="center muted">Ничего не найдено</p>'; return; }
      filteredProducts.forEach(p => {
        const card = document.createElement('div'); card.className = 'card'; card.onclick = () => openProductModal(p.id);
        const unit = p.pricePerKg ? '₽/кг' : p.pricePerL ? '₽/л' : '₽';
        const priceText = p.pricePerUnit ? `${fmtPrice.format(p.pricePerUnit)} ₽` : `${fmtPrice.format(getBaseUnitPrice(p))} ${unit}`;
        card.innerHTML = `
          <div class="ico">${p.ico || '📦'}</div>
          <div class="name">${p.name}</div>
          <div class="meta"><span>${p.cat}</span></div>
          <div class="price">${priceText}</div>
        `;
        grid.appendChild(card);
      });
    }

    // =====================
    // PRODUCT MODAL
    // =====================
    function openProductModal(productId) {
      currentProduct = PRODUCTS.find(p => p.id === productId); if (!currentProduct) return;
      const modal = document.getElementById('product-modal');
      document.getElementById('product-modal-title').textContent = currentProduct.name;
      document.getElementById('product-modal-ico').textContent = currentProduct.ico || '📦';
      document.getElementById('product-modal-description').textContent = currentProduct.description || '';
      renderVariantSelector();
      document.getElementById('product-qty-input').value = 1;
      updateProductModalPrice();
      modal.showModal();
    }
    function closeProductModal() { document.getElementById('product-modal').close(); currentProduct = null; }

    function renderVariantSelector() {
      const select = document.getElementById('product-variant-select'); select.innerHTML = '';
      const rule = VARIANT_RULES[currentProduct.id]; if (!rule) { select.innerHTML = '<option>Вариант не определён</option>'; return; }
      if (rule.type === 'fixed') {
        rule.options.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; select.appendChild(o); });
      } else if (rule.type === 'weight') {
        for (let v = rule.min; v <= rule.max; v += rule.step) { const o = document.createElement('option'); o.value = `${v} ${rule.unit}`; o.textContent = `${v} ${rule.unit}`; select.appendChild(o); }
      }
    }

    function updateProductModalPrice() {
      if (!currentProduct) return;
      const variant = document.getElementById('product-variant-select').value;
      const qty = Math.max(1, parseInt(document.getElementById('product-qty-input').value) || 1);
      const price = calculatePrice(currentProduct.id, variant, qty, { includePending: true });
      document.getElementById('product-modal-price').textContent = formatRUB(price.finalPrice);
      const hint = document.getElementById('discount-hint');
      if (price.nextDiscount) {
        hint.style.display = '';
        hint.textContent = `Сейчас скидка ${Math.round(price.discountRate*100)}%. Добавьте ещё ${price.nextDiscount.remaining} г этого сыра, и скидка станет ${Math.round(price.nextDiscount.nextRate*100)}%.`;
      } else if (price.discountRate > 0) {
        hint.style.display = '';
        hint.textContent = `Применена скидка ${Math.round(price.discountRate*100)}%.`;
      } else {
        hint.style.display = 'none';
      }
    }

    // =====================
    // CART
    // =====================
    function addToCart() {
      if (!currentProduct) return;
      const variant = document.getElementById('product-variant-select').value;
      const qty = Math.max(1, parseInt(document.getElementById('product-qty-input').value) || 1);
      const idx = cart.findIndex(x => x.id === currentProduct.id && x.variant === variant);
      if (idx > -1) cart[idx].qty += qty; else cart.push({ id: currentProduct.id, name: currentProduct.name, cat: currentProduct.cat, variant, qty });
      saveState(); updateCartUI(); closeProductModal();
    }

    function updateCartUI() {
      const totalCount = cart.reduce((s,i) => s + i.qty, 0);
      const totalSum = cart.reduce((s,i) => s + calculatePrice(i.id, i.variant, i.qty).finalPrice, 0);
      const btn = document.getElementById('open-cart-btn');
      if (cart.length) { btn.disabled = false; btn.textContent = `Корзина (${totalCount}) · ${formatRUB(totalSum)}`; }
      else { btn.disabled = true; btn.textContent = 'Корзина пуста'; }

      if (window.Telegram && window.Telegram.WebApp) {
        const mb = window.Telegram.WebApp.MainButton;
        if (cart.length) { mb.setText(`Оформить · ${formatRUB(totalSum)}`); mb.show(); }
        else { mb.hide(); }
      }
    }

    function openCartModal() { renderCartModal(); document.getElementById('cart-modal').showModal(); }
    function closeCartModal() { document.getElementById('cart-modal').close(); }

    function renderCartModal() {
      const body = document.getElementById('cart-modal-body'); body.innerHTML = '';
      if (cart.length === 0) { body.innerHTML = '<p class="muted">Корзина пуста</p>'; updateCartUI(); updateCartSummary(); return; }

      const list = document.createElement('div'); list.className = 'cart-list'; body.appendChild(list);
      cart.forEach((item, index) => {
        const p = getProduct(item.id); const line = document.createElement('div'); line.className = 'cart-item';
        const linePrice = calculatePrice(item.id, item.variant, item.qty);
        const unitLabel = `${formatRUB(Math.max(1, linePrice.basePrice / item.qty))} / поз.`;
        line.innerHTML = `
          <div class="cart-ico">${p.ico || '📦'}</div>
          <div class="cart-info">
            <div class="cart-name">${item.name}</div>
            <div class="cart-variant">${item.variant}${linePrice.discountRate>0?` • скидка ${Math.round(linePrice.discountRate*100)}%`:''}</div>
            <div class="line"><small>${unitLabel}</small><strong>${formatRUB(linePrice.finalPrice)}</strong></div>
          </div>
          <div class="cart-controls">
            <div class="qty">
              <button onclick="changeItemQty(${index}, -1)">−</button>
              <span>${item.qty}</span>
              <button onclick="changeItemQty(${index}, 1)">+</button>
            </div>
            <button class="btn btn-secondary" onclick="removeItem(${index})">Удалить</button>
          </div>
        `;
        list.appendChild(line);
      });

      updateCartSummary();
    }

    function updateCartSummary() {
      const sumDiv = document.getElementById('cart-summary');
      const totals = computeTotals();
      sumDiv.innerHTML = `
        <div class="line"><span>Позиций</span><strong>${totals.items}</strong></div>
        <div class="line"><span>Сумма без скидок</span><strong>${formatRUB(totals.base)}</strong></div>
        <div class="line"><span>Скидка</span><strong>−${formatRUB(totals.discount)}</strong></div>
        <div class="line total"><span>Итого</span><strong>${formatRUB(totals.final)}</strong></div>
      `;
    }

    function computeTotals() {
      let items = 0, base = 0, final = 0;
      cart.forEach(i => { const pr = calculatePrice(i.id, i.variant, i.qty); items += i.qty; base += pr.basePrice; final += pr.finalPrice; });
      const discount = Math.max(0, base - final);
      return { items, base, discount, final };
    }

    function changeItemQty(index, delta) { cart[index].qty += delta; if (cart[index].qty <= 0) cart.splice(index, 1); saveState(); updateCartUI(); renderCartModal(); }
    function removeItem(index) { cart.splice(index, 1); saveState(); updateCartUI(); renderCartModal(); }

    // =====================
    // PRICING & DISCOUNTS
    // =====================
    function parseVariant(variantString) {
      if (!variantString) return null;
      const m = variantString.match(/(\d+(?:[\.,]\d+)?)\s*(г|кг|л|шт)/i);
      if (m) {
        const value = parseFloat(m[1].replace(',', '.'));
        const u = m[2].toLowerCase();
        if (u === 'г') return { value, unit: 'g' };
        if (u === 'кг') return { value, unit: 'kg' };
        if (u === 'л') return { value, unit: 'l' };
        if (u === 'шт') return { value, unit: 'pc' };
      }
      const plus = variantString.match(/(\d+(?:[\.,]\d+)?)\+\s*(кг|л)/i);
      if (plus) { const value = parseFloat(plus[1].replace(',', '.')); const u = plus[2].toLowerCase(); return { value, unit: u === 'кг' ? 'kg' : 'l' }; }
      return null;
    }

    function getProduct(id) { return PRODUCTS.find(p => p.id === id); }

    function priceFor(product, variantParsed) {
      if (!product) return 0;
      if (product.pricePerKg) {
        if (variantParsed.unit === 'g') return (variantParsed.value / 1000) * product.pricePerKg;
        if (variantParsed.unit === 'kg') return variantParsed.value * product.pricePerKg;
        if (variantParsed.unit === 'pc') {
          const w = /\((\d+)\s*г\)/.exec(variantParsed.label || '') || /\((\d+)\s*г\)/.exec('');
          // fallback handled elsewhere
        }
      } else if (product.pricePerL) {
        if (variantParsed.unit === 'l') return variantParsed.value * product.pricePerL;
      } else if (product.pricePerUnit) { return product.pricePerUnit; }
      return 0;
    }

    function gramsForItem(item) {
      const p = getProduct(item.id); if (!p || p.cat !== 'Сыры') return 0;
      const parsed = parseVariant(item.variant); if (!parsed) return 0;
      if (parsed.unit === 'g') return parsed.value * item.qty;
      if (parsed.unit === 'kg') return parsed.value * 1000 * item.qty;
      if (parsed.unit === 'pc') {
        const m = item.variant.match(/\((\d+)\s*г\)/); if (m) return parseInt(m[1]) * item.qty; return 0;
      }
      return 0;
    }

    function getDiscountRateForProduct(productId, extraGrams = 0) {
      const product = getProduct(productId); if (!product || product.cat !== 'Сыры') return 0;
      const totalG = cart.filter(i => i.id === productId).reduce((s, i) => s + gramsForItem(i), 0) + (extraGrams || 0);
      let rate = 0; for (const t of DISCOUNT_THRESHOLDS) { if (totalG >= t.g) rate = t.rate; }
      return rate;
    }

    function nextDiscountInfo(productId, extraGrams = 0) {
      const product = getProduct(productId); if (!product || product.cat !== 'Сыры') return null;
      const currentG = cart.filter(i => i.id === productId).reduce((s,i) => s + gramsForItem(i), 0) + (extraGrams || 0);
      const next = DISCOUNT_THRESHOLDS.find(t => t.g > currentG);
      if (!next) return null;
      const curRate = DISCOUNT_THRESHOLDS.reduce((r,t) => currentG >= t.g ? t.rate : r, 0);
      return { remaining: Math.max(0, next.g - currentG), nextRate: next.rate, curRate };
    }

    function calculatePrice(productId, variant, qty, opts = {}) {
      const product = getProduct(productId); if (!product) return { basePrice: 0, finalPrice: 0, discountRate: 0 };
      const rule = VARIANT_RULES[productId];
      let basePrice = 0;

      if (rule && rule.type === 'fixed' && product.pricePerUnit) {
        basePrice = product.pricePerUnit * qty;
      } else {
        const parsed = parseVariant(variant); if (!parsed) return { basePrice: 0, finalPrice: 0, discountRate: 0 };
        parsed.label = variant;
        if (product.pricePerKg) {
          if (parsed.unit === 'g') basePrice = (parsed.value / 1000) * product.pricePerKg;
          if (parsed.unit === 'kg') basePrice = parsed.value * product.pricePerKg;
          if (parsed.unit === 'pc') {
            const m = variant.match(/\((\d+)\s*г\)/); if (m) basePrice = (parseInt(m[1]) / 1000) * product.pricePerKg; else basePrice = 0;
          }
        } else if (product.pricePerL) {
          if (parsed.unit === 'l') basePrice = parsed.value * product.pricePerL; else basePrice = 0;
        } else if (product.pricePerUnit) { basePrice = product.pricePerUnit; }
        basePrice *= qty;
      }

      // discount (per product weight)
      let extraGrams = 0;
      if (opts.includePending) {
        const pv = parseVariant(variant);
        if (pv && product.cat === 'Сыры') {
          if (pv.unit === 'g') extraGrams = pv.value * qty; else if (pv.unit === 'kg') extraGrams = pv.value * 1000 * qty; else if (pv.unit === 'pc') { const m = variant.match(/\((\d+)\s*г\)/); if (m) extraGrams = parseInt(m[1]) * qty; }
        }
      }
      const discountRate = getDiscountRateForProduct(productId, extraGrams);
      const finalPrice = ROUND(basePrice * (1 - discountRate));

      // next discount hint
      let nextDiscount = null;
      if (product.cat === 'Сыры') nextDiscount = nextDiscountInfo(productId, extraGrams);

      return { basePrice: ROUND(basePrice), finalPrice, discountRate, nextDiscount };
    }

    function formatRUB(n) { return `${fmtPrice.format(Math.max(0, Math.round(n))) } ₽`; }

    // =====================
    // CHECKOUT & SUBMIT
    // =====================
    function startCheckout() {
      closeCartModal();
      renderCheckoutSummary();
      document.getElementById('checkout-modal').showModal();
    }
    function closeCheckoutModal() { document.getElementById('checkout-modal').close(); }

    function renderCheckoutSummary() {
      const totals = computeTotals();
      document.getElementById('summary-items').textContent = `${totals.items} шт.`;
      document.getElementById('summary-total').textContent = formatRUB(totals.final);
    }

    function onPlaceOrderSubmit(e) {
      e.preventDefault();
      const phone = document.getElementById('customer-phone').value.trim();
      const address = document.getElementById('customer-address').value.trim();
      if (!/^\+?7\s?\d[\d\s\-\(\)]{9,}$/.test(phone)) { showError('Введите телефон в формате +7 …'); return; }
      if (address.length < 6) { showError('Пожалуйста, укажите полный адрес.'); return; }

      const payload = buildOrderPayload();
      submitOrder(payload);
    }

    function buildOrderPayload() {
      const totals = computeTotals();
      const wa = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      const user = wa && wa.initDataUnsafe ? wa.initDataUnsafe.user : null;

      const customer = {
        name: (document.getElementById('customer-name').value || '').trim(),
        phone: (document.getElementById('customer-phone').value || '').trim(),
        address: (document.getElementById('customer-address').value || '').trim(),
        payment: document.getElementById('payment-method').value,
        delivery_time: document.getElementById('delivery-time').value,
        comment: (document.getElementById('order-comment').value || '').trim(),
      };

      const items = cart.map(i => {
        const p = calculatePrice(i.id, i.variant, i.qty);
        const unitBase = Math.max(1, Math.round(p.basePrice / i.qty));
        const unitFinal = Math.max(1, Math.round(p.finalPrice / i.qty));
        return {
          id: i.id, name: i.name, cat: i.cat, variant: i.variant, qty: i.qty,
          unit_price_base: unitBase, discount_rate: p.discountRate, unit_price: unitFinal, line_total: p.finalPrice,
        };
      });

      const payload = {
        type: 'order', source: 'tg_webapp', currency: CURRENCY,
        shop: { name: APP_NAME },
        items, totals, customer,
        meta: {
          ts: Date.now(), schema_ver: PAYLOAD_SCHEMA_VERSION,
          user: user ? { id: user.id, username: user.username, first_name: user.first_name, last_name: user.last_name, language_code: user.language_code } : null,
          tg_init_data: wa ? wa.initData || null : null
        }
      };
      return payload;
    }

    async function submitOrder(payload) {
      const btn = document.getElementById('place-order-btn');
      const ok = document.getElementById('submit-success');
      const err = document.getElementById('submit-error');
      ok.style.display = 'none'; err.style.display = 'none';
      btn.disabled = true; btn.textContent = 'Отправка…';

      try {
        // Webhook first (если указан и режим включает webhook)
        if (WEBHOOK_URL && (SUBMIT_MODE === 'webhook' || SUBMIT_MODE === 'both')) {
          await fetch(WEBHOOK_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', ...WEBHOOK_HEADERS }, body: JSON.stringify(payload) });
        }

        // Telegram sendData (для Puzzlebot / вашего бота)
        if (window.Telegram && window.Telegram.WebApp && (SUBMIT_MODE === 'telegram' || SUBMIT_MODE === 'both')) {
          window.Telegram.WebApp.sendData(JSON.stringify(payload));
        } else if (SUBMIT_MODE === 'telegram') {
          // Standalone fallback
          console.log('Order payload (standalone):', payload);
          alert('Режим Telegram недоступен. Откройте мини‑приложение из Telegram.');
        }

        ok.style.display = '';
        // Очистим корзину после успешной отправки
        cart = []; saveState(); updateCartUI();
        // Закроем приложение в Telegram
        if (window.Telegram && window.Telegram.WebApp) {
          setTimeout(() => { try { window.Telegram.WebApp.close(); } catch {} }, 600);
        }
      } catch (e) {
        console.error('Submit error', e);
        err.style.display = '';
        alert('Не удалось отправить заказ.\n\nДанные для отладки в консоли.');
        console.log('Order payload (debug):', payload);
      } finally {
        btn.disabled = false; btn.textContent = 'Отправить заказ';
      }
    }

    function showError(msg) {
      const box = document.getElementById('submit-error');
      box.textContent = msg; box.style.display = '';
      setTimeout(() => { box.style.display = 'none'; }, 4000);
    }

    // =====================
    // UTIL
    // =====================
    function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); }; }
  </script>
</body>
</html>
